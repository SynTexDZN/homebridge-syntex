<html>
    <title>Neu Verbinden</title>
    <body>
        <div id="welcome">
            <h1>Gerät Übertragen</h1>
            <p>Übertrage ein Gerät aus einem anderen WLAN Netz</p>
            <div class="main" style="margin-top: 100px; margin-bottom: 132px; display: table">
                <img src="img/wifi.png" style="width: 200px; height: 200px; filter: invert(100%); margin: 0 auto; margin-bottom: 100px; display: block;">
                <input class="gradient-blue" style="margin: 100px auto 100px auto; max-width: 400px!important; display: block" id="search-loop" type="button" value="Nach Geräten suchen .">
                <p>Bitte Verbinde dich<br>mit dem Access Point<br>des Sensors / Schalters<br><br>Dabei müssen sich beide<br>in der Nähe des Routers befinden</p>
            </div>
            <div class="main">
                <div style="display: flex">
                    <input type="button" value="Zurück" onclick="window.location.href='/'">
                    <input style="margin-left: 20px" type="button" value="Gerät Neu Gekauft?" onclick="window.location.href='/setup'">
                </div>
            </div>
        </div>
        <div id="wifiConfig" style="display: none;">
            <h1>Gerät Übertragen</h1>
            <div class="main" style="margin-top: 100px; margin-bottom: 132px; display: table">
                <form onsubmit="event.preventDefault(); sendWifiSettings();">
                    <div id="networks" style="margin-bottom: 100px">
                        <p>Laden ..</p>
                    </div>
                    <input type="password" name="wifipass" placeholder="Netzwerk Passwort" style="margin-bottom: 20px" required>
                    <br>
                    <input type="submit" value="Verbinden">
                </form>
            </div>
            <div class="main">
                <div style="display: flex">
                    <input type="button" value="Zurück" onclick="window.location.href='/'">
                    <input id="scan-btn" class="gradient-blue" style="margin-left: 20px;" type="button" value="Bitte Warten .." onclick="scanWifi()">
                </div>
            </div>
        </div>
        <div id="connecting" style="display: none;">
            <h1>Verbinden</h1>
            <div class="main" style="margin-top: 100px; margin-bottom: 132px; display: table">
                <img src="img/connecting.png" style="width: 200px; height: 200px; filter: invert(100%); margin: 0 auto; margin-bottom: 100px; display: block;">
                <div style="background: rgb(15, 15, 25); width: calc(100% - 100px); margin-top: 0px; margin-bottom: 100px; margin-right: 50px; margin-left: 50px; border-radius: 5px">
                    <div class="progress" style="background: hsl(210, 85%, 65%); width: 0%; height: 10px; border-radius: 5px"></div>
                </div>
                <p>Das Gerät versucht<br>sich im WLAN anzumelden</p>
            </div>
        </div>
        <div id="success" style="display: none;">
            <h1>Daten Übertragen</h1>
            <div class="main" style="margin-top: 100px; margin-bottom: 132px; display: table">
                <img src="img/success.png" style="width: 200px; height: 200px; filter: brightness(4); margin: 0 auto; margin-bottom: 100px; display: block;">
                <input class="gradient-green" style="margin: 100px auto 100px auto; max-width: 400px!important; display: block" id="redirect-countdown" type="button" value="Zum Dashboard ( 5 )" onclick="window.location.href='/'">
                <p>Das Gerät<br>verbindet sich jetzt<br>mit dem WLAN</p>
            </div>
        </div>
    </body>
</html>
<script defer>

function searchLoop()
    {
        setTimeout(function()
        {
            var loop = document.getElementById('search-loop');

            if(loop.value != 'Nach Geräten suchen ...')
            {
                loop.value += '.';
            }
            else
            {
                loop.value = 'Nach Geräten suchen .';
            }

            searchLoop();
        }, 1000);
    }

    searchLoop();

    function redirectCountdown()
    {
        setTimeout(function()
        {
            var countdown = document.getElementById('redirect-countdown');

            if(countdown.value.split('( ')[1].split(' )')[0] > 0)
            {
                countdown.value = 'Zum Dashboard ( ' + (countdown.value.split('( ')[1].split(' )')[0] - 1) + ' )';
                redirectCountdown();
            }
            else
            {
                window.location.href = '/';
            }
        }, 1000);
    }
    
    var ping = false;
    var ip = 'http://192.168.4.1/';
    var url = new URL(window.location.href);
    var ipp = url.searchParams.get("ip");
    var client, client2;
    
    pingESP();
    
    function pingESP()
    {
        if(ping == false)
        {
            var client = new XMLHttpRequest();

            client.timeout = 2000;
        
            client.open('GET', 'http://192.168.4.1/');

            client.onreadystatechange = function()
            {
                if(client.readyState === 4)
                {  
                    if(client.status === 200)
                    {  
                        ping = true;
                        document.getElementById('wifiConfig').style.display = "";
                        setTimeout(function()
                        {
                            scanWifi();
                        }, 2000);
                        document.getElementById('welcome').style.display = "none";
                    }
                    else
                    {  
                        setTimeout(function()
                        {
                            pingESP();
                        }, 2000);
                    }  
                }  
            }

            client.send();
            
            var client2 = new XMLHttpRequest();

            client2.timeout = 2000;
        
            client2.open('GET', 'http://' + ipp + '/');

            client2.onreadystatechange = function()
            {
                if(client2.readyState === 4)
                {  
                    if(client2.status === 200)
                    {  
                        ping = true;
                        ip = 'http://' + ipp + '/';
                        document.getElementById('wifiConfig').style.display = "";
                        setTimeout(function()
                        {
                            scanWifi();
                        }, 2000);
                        document.getElementById('welcome').style.display = "none";
                    }
                    else
                    {  
                        /*
                        setTimeout(function()
                        {
                            pingESP();
                        }, 2000);
                        */
                    }  
                }  
            }

            client2.send();
        }        
    } 
        
    function scanWifi()
    {            
        document.getElementById('scan-btn').value = 'Bitte warten ..'; 
        document.getElementById('networks').innerHTML = '<p>Laden ..</p>';
        
        var client = new XMLHttpRequest();

        client.timeout = 10000;
        
        client.open('GET', ip + 'wifi');

        client.onreadystatechange = function()
        {
            if(client.readyState === 4)
            {  
                if(client.status === 200)
                {  
                    document.getElementById('networks').innerHTML = '';
                
                    var json = JSON.parse(client.responseText);

                    for(var i = 0; i < json.length; i++)
                    {
                        var label = document.createElement('label');
                        var input = document.createElement('input');

                        label.setAttribute('for', json[i]);
                        label.setAttribute('style', 'margin-bottom: 20px');

                        input.setAttribute('type', "radio");
                        input.setAttribute('name', "wifissid");
                        input.setAttribute('value', json[i]);        

                        label.appendChild(input);
                        label.innerHTML += json[i];

                        document.getElementById('networks').appendChild(label);
                    }

                    if(client.responseText == "" || client.responseText == "[]")
                    {
                        document.getElementById('networks').children[0].innerHTML = "Bitte drücke auf 'Suchen'";
                    }
                }
                else
                {
                    document.getElementById('networks').children[0].innerHTML = "Bitte drücke auf 'Suchen'";
                }

                document.getElementById('scan-btn').value = 'Suchen'; 
            }  
        }

        client.send();
    }
    
    var timeRemaining = 0;
    
    function setTimer(time)
    {
        timeRemaining = time - 100;
        
        setTimeout(function()
        {
            document.getElementById('connecting').getElementsByClassName('progress')[0].style.width = (time / 600) + "%";
            setTimer(timeRemaining);
        }, 100);
    }
    
    function sendWifiSettings()
    {
        var client = new XMLHttpRequest();

        client.timeout = 10000;

        var formElement = document.querySelector("form");
        
        client.open('POST', ip + 'settings');

        client.onreadystatechange = function()
        {
            if(client.readyState === 4)
            {  
                if(client.status === 200)
                {
                    document.getElementById('wifiConfig').style.display = "none";
                    document.getElementById('connecting').style.display = "";

                    setTimer(60000);

                    var ping = false;

                    setTimeout(function()
                    {
                        client = new XMLHttpRequest();
        
                        client.open('GET', '/setup');

                        client.onreadystatechange = function()
                        {
                            if(client.readyState === 4)
                            {  
                                if(client.status === 200)
                                {
                                    ping = true;
                                }
                            }
                        }
                        
                        client.send();
                    }, 20000);

                    setTimeout(function()
                    {
                        if(ping == false)
                        {
                            document.getElementById('connecting').getElementsByTagName('p')[0].innerHTML = 'Bitte Verbinde dich<br>mit dem normalen WLAN';
                        }
                    }, 30000);

                    setTimeout(function()
                    {
                        if(success == false)
                        {
                            //TODO: Verbinden Fehlgeschlagen

                            //alert("Error");
                            document.getElementById('error').style.display = "";
                            document.getElementById('connecting').style.display = "none";

                            setTimeout(function()
                            {
                                window.location.href = '/setup';
                            }, 10000); 
                        }
                    }, 60000);

                    console.log(client.responseText);

                    document.getElementById('success').style.display = "";
                    document.getElementById('connecting').style.display = "none";

                    redirectCountdown();           
                }
            }
        };
        
        client.send(new FormData(formElement));
        
        return false;
    }

</script>