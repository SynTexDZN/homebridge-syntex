<html>
    <title>Setup</title>
    <body>
        <div id="welcome">
            <h1>Gerät Hinzufügen</h1>
            <div class="main" style="margin-top: 100px; margin-bottom: 132px; display: table">
                <img class="setup-png" src="img/wifi.png">
                <input class="loading-loop gradient-blue" style="margin: 100px auto 100px auto; max-width: 400px!important; display: block" type="button" value="Nach Geräten suchen .">
                <p>Bitte Verbinde dich<br>mit dem Access Point<br>des Sensors / Schalters<br><br>Dabei müssen sich beide<br>in der Nähe des Routers befinden</p>
            </div>
            <div class="main">
                <div style="display: flex">
                    <input type="button" value="Zurück" onclick="window.location.href='/'">
                    <input style="margin-left: 20px" type="button" value="Gerät Registriert?" onclick="window.location.href='/reconnect'">
                </div>
            </div>
        </div>
        <div id="wifiConfig" style="display: none;">
            <h1>Gerät Hinzufügen</h1>
            <div class="main" style="margin-top: 100px; margin-bottom: 132px; display: table">
                <form onsubmit="event.preventDefault(); sendWifiSettings();">
                    <div id="networks" style="margin-bottom: 100px">
                        <p class="loading-loop">Laden ..</p>
                    </div>
                    <input type="password" name="wifipass" placeholder="Netzwerk Passwort" style="margin-bottom: 20px" required>
                    <br>
                    <input type="submit" value="Verbinden">
                </form>
            </div>
            <div class="main">
                <div style="display: flex">
                    <input type="button" value="Zurück" onclick="window.location.href='/'">
                    <input id="scan-btn loading-loop" class="gradient-blue" style="margin-left: 20px" type="button" value="Bitte Warten .." onclick="scanWifi()">
                </div>
            </div>
        </div>
        <div id="connecting" style="display: none">
            <h1>Verbinden</h1>
            <div class="main" style="margin-top: 100px; margin-bottom: 132px; display: table">
                <img src="img/connecting.png" class="setup-png">
                <div style="background: rgb(15, 15, 25); width: calc(100% - 100px); margin-top: 0px; margin-bottom: 100px; margin-right: 50px; margin-left: 50px; border-radius: 5px">
                    <div class="progress" style="background: hsl(210, 85%, 65%); width: 0%; height: 10px; border-radius: 5px"></div>
                </div>
                <p>Das Gerät versucht<br>sich im WLAN anzumelden</p>
            </div>
        </div>
        <div id="success" style="display: none;">
            <h1>Erfolgreich Verbunden</h1>
            <div class="main" style="margin-top: 100px; margin-bottom: 132px; display: table">
                <img src="img/success.png" class="setup-png">
                <input class="gradient-green" style="margin: 100px auto 100px auto; max-width: 400px!important; display: block" id="redirect-success" type="button" value="Zum Gerät ( 5 )">
                <p>Das Gerät ist<br>jetzt Einsatzbereit</p>
            </div>
        </div>
        <div id="error" style="display: none;">
            <h1>Fehler beim Verbinden</h1>
            <div class="main" style="margin-top: 100px; margin-bottom: 132px; display: table">
                <img src="img/error.png" class="setup-png">
                <input class="gradient-red" style="margin: 100px auto 100px auto; max-width: 400px!important; display: block" id="redirect-error" type="button" onclick="window.location.href='/setup'" value="Zurück ( 5 )">
                <p>Bitte versuche es erneut!<br><br>Dein WLAN-Passwort<br>war nicht korrekt<br>oder etwas anderes<br>ist schief gegangen</p>
            </div>
        </div>
    </body>
</html>
<script defer>

    function redirectCountdown(countdown, url)
    {
        setTimeout(function()
        {
            if(countdown.value.split('( ')[1].split(' )')[0] > 0)
            {
                countdown.value = countdown.value.split('( ')[0] + '( ' + (countdown.value.split('( ')[1].split(' )')[0] - 1) + ' )';

                if(countdown.value.split('( ')[1].split(' )')[0] > 0)
                {
                    redirectCountdown(countdown, url);
                }
                else
                {
                    window.location.href = url;
                }
            }
        }, 1000);
    }

</script>
<script defer>
    
    var ping = false;
    
    setTimeout(function()
    {
        pingESP();
    }, 500);
    
    function pingESP()
    {
        if(ping == false)
        {
            fetchURL('http://192.168.4.1/', 2000).then(function(res) {

                if(res != null)
                {  
                    ping = true;
                    document.getElementById('wifiConfig').style.display = "";
                    setTimeout(function()
                    {
                        scanWifi();
                    }, 2000);
                    document.getElementById('welcome').style.display = "none";
                }
                else
                {  
                    setTimeout(function()
                    {
                        pingESP();
                    }, 2000);
                } 
            });
        }        
    }    

</script>
<script>
        
    function scanWifi()
    {           
        document.getElementById('scan-btn').value = 'Bitte Warten ..'; 
        document.getElementById('networks').innerHTML = '<p>Laden ..</p>';

        fetchURL('http://192.168.4.1/wifi', 10000).then(function(res) {

            if(res != null)
            {  
                document.getElementById('networks').innerHTML = '';
            
                var json = JSON.parse(res);

                for(var i = 0; i < json.length; i++)
                {
                    var label = document.createElement('label');
                    var input = document.createElement('input');

                    label.setAttribute('for', json[i]);
                    label.setAttribute('style', 'margin-bottom: 20px');

                    input.setAttribute('type', "radio");
                    input.setAttribute('name', "wifissid");
                    input.setAttribute('value', json[i]);        

                    label.appendChild(input);
                    label.innerHTML += json[i];

                    document.getElementById('networks').appendChild(label);
                }

                if(res == "" || res == "[]")
                {
                    document.getElementById('networks').innerHTML = "<p>Bitte drücke auf 'Suchen'</p>";
                }
            }
            else
            {
                document.getElementById('networks').innerHTML = "</p>Bitte drücke auf 'Suchen'</p>";
            }

            document.getElementById('scan-btn').value = 'Suchen';
        });
    }
    
    var success = false;
    
    function checkDB(mac)
    {
        fetchURL('/serverside/check-device?mac=' + mac, 10000).then(function(res) {

            if(res != null)
            {  
                console.log(res);
            
                if(res != 'Error')
                {
                    //TODO: Erfolg

                    success = true;

                    document.getElementById('success').style.display = "";
                    document.getElementById('connecting').style.display = "none";

                    redirectCountdown(document.getElementById('redirect-success'), '/device?mac=' + mac);
                    document.getElementById('redirect-success').setAttribute('onclick', "window.location.href='/device?mac=" + mac + "'");  
                }
                else
                {
                    setTimeout(function()
                    {
                        checkDB(mac);
                    }, 2000);
                }
            }
            else
            {
                setTimeout(function()
                {
                    checkDB(mac);
                }, 2000);
            }
        });
    }
    
    var timeRemaining = 0;
    
    function setTimer(time)
    {
        timeRemaining = time - 100;
        
        setTimeout(function()
        {
            document.getElementById('connecting').getElementsByClassName('progress')[0].style.width = (time / 600) + "%";
            setTimer(timeRemaining);
        }, 100);
    }
    
    function sendWifiSettings()
    {
        var formElement = document.querySelector("form");

        fetchURL('http://192.168.4.1/settings', 10000, new FormData(formElement)).then(function(res) {

            if(res != null)
            {
                document.getElementById('wifiConfig').style.display = "none";
                document.getElementById('connecting').style.display = "";

                setTimer(60000);

                var ping = false;

                setTimeout(function()
                {
                    fetchURL('/setup', 10000).then(function(res2) {

                        if(res2 != null)
                        {
                            ping = true;
                        }
                    });
                }, 20000);

                setTimeout(function()
                {
                    if(ping == false)
                    {
                        document.getElementById('connecting').getElementsByTagName('p')[0].innerHTML = 'Bitte Verbinde dich<br>mit dem normalen WLAN';
                    }
                }, 30000);

                setTimeout(function()
                {
                    if(success == false)
                    {
                        //TODO: Verbinden Fehlgeschlagen

                        //alert("Error");
                        document.getElementById('error').style.display = "";
                        document.getElementById('connecting').style.display = "none";

                        redirectCountdown(document.getElementById('redirect-error'), '/setup');
                    }
                }, 60000);

                console.log(res);

                checkDB(res);
            }
        });

        return false;
    }

</script>