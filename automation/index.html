<html>
	<body ontouchstart="">
		<div id="content">
			<title>%general.dashboard%: %menu.automation%</title>
			<script type="module">

				import { PageManager } from '/js/page-manager.js';

				window.PageManager = PageManager;

				if((new URL(window.location.href)).searchParams.get('create') == '')
				{
					PageManager.setHeader('%menu.automation%', '%automation.create%');

					var main = document.createElement('div');

					main.style.display = 'flex';

					main.innerHTML = '<input type="button" value="%menu.back%" onclick="openViewPage(' + "'create'" + ')"><div style="display: block; width: 100%; margin-left: 20px"><input id="save-btn" type="submit" form="create-form" value="%automation.create%"></div>';

					PageManager.setFooter(main);
					PageManager.showFooter();

					PageManager.switchPage('view', 'create', true);
				}
				else
				{
					PageManager.setHeader('%general.dashboard%', '%menu.automation%');
					PageManager.hideFooter();
				}

			</script>
			<div class="main" style="margin-bottom: 100px">
				<div class="main" style="margin-bottom: 20px; display: flex">
					<input class="white" type="button" value="%menu.devices%" onclick="Essentials.leavePage('/')" style="text-transform: uppercase; margin-right: 20px">
					<input class="white" type="button" value="%menu.bridge%" onclick="Essentials.leavePage('/bridge')" style="text-transform: uppercase">
				</div>
				<div class="main" style="margin-top: 10px; display: flex">
					<input class="white" type="button" value="%menu.automation%" onclick="Essentials.leavePage('/automation/')" style="text-transform: uppercase; margin-right: 20px" disabled>
					<input class="white" type="button" value="%menu.log%" onclick="Essentials.leavePage('/log')" style="text-transform: uppercase">
				</div>
			</div>
			<div id="view" style="transition: .2s opacity ease-in-out">
				<div class="main" style="margin-bottom: 100px">
					<div id="toolbar" class="main" style="margin: 100px auto">
						<div id="groups" style="display: flex; width: 100%"><input type="button" onclick="switchGroup('all', false)" group="all" value="%automation.all_automations%" class="white" style="border-left: none; cursor: grab"></div>
						<div style="display: flex; margin-top: 20px">
							<button style="margin-right: 20px" class="image-button" id="view-button" onclick="switchView(this)" view="horizontal"><img style="height: 100%; filter: invert(95%) sepia(10%) hue-rotate(200deg)" src="/img/list3.png"><img style="height: 100%; filter: invert(95%) sepia(10%) hue-rotate(200deg); display: none; transform: scale(.8) rotate(90deg);" src="/img/list3.png"></button>
							<div class="custom-select" style="width: 100%">
								<select id="sort" onchange="sortAutomation()">
									<option img="/img/sort-asc.png" value="alphabetical-asc">%sort.alphabetical%</option>
									<option img="/img/sort-desc.png" value="alphabetical-desc">%sort.alphabetical%</option>
									<option img="/img/sort-asc.png" value="id-asc">%sort.id%</option>
									<option img="/img/sort-desc.png" value="id-desc">%sort.id%</option>
									<option img="/img/sort-asc.png" value="activation-asc">%sort.activation%</option>
									<option img="/img/sort-desc.png" value="activation-desc">%sort.activation%</option>
								</select>
								<script>

									var sort = 'id-asc';

									if(localStorage.getItem('automation-sort') != null)
									{
										sort = localStorage.getItem('automation-sort');
									}

									var select = document.getElementById('sort');

									for(var i = 0; i < select.children.length; i++)
									{
										if(select.children[i].getAttribute('value') == sort)
										{
											select.children[i].setAttribute('selected', '');
										}
									}

								</script>
							</div>
							<button style="margin-left: 20px" class="image-button" id="add-button" onclick="openAddPage()" view="list"><img style="height: 100%; filter: invert(95%) sepia(10%) hue-rotate(200deg)" src="/img/add5.png"></button>
						</div>
					</div>
					<p id="no-automation" style="display: none; margin-top: 100px">%automation.no_automation%</p>
					<p id="no-devices" style="display: none; margin-top: 100px">%automation.no_devices%</p>
					<div id="automation" style="transition: .2s opacity ease-in-out"></div>
				</div>
				<div class="bottom" style="margin: 0 auto; margin-bottom: 50px; width: 100%; max-width: 400px">
					<input id="devices-button-big" class="gradient-orange" type="button" value="%automation.to_devices% >" style="display: none" onclick="Essentials.leavePage('/')">
					<input id="add-button-big" class="gradient-orange" type="button" value="+ %automation.add_automation%" onclick="openAddPage()">
				</div>
			</div>
			<div id="create" style="display: none; transition: .2s opacity ease-in-out">
				<form id="create-form" class="main" onsubmit="event.preventDefault(); createAutomation();">
					<div class="type-container">
						<h2 class="title-container" style="margin-bottom: 40px">%automation.infos%</h2>
						<p><b>%general.id%: <input type="button" style="max-width: 150px" value="0" disabled></b></p>
						<p autofocus style="margin-bottom: 20px"><b>%general.name%: <input pattern="[a-zA-ZäÄöÖüÜ0-9-#()&/ ]+" title="%pattern.letters_numbers_spaces_special%: # / ( )" required name="name" type="text" style="max-width: 325px"></b></p>
					</div>
					<div style="margin-top: 20px" class="type-container">
						<h2 class="title-container" style="margin-bottom: 40px">%automation.trigger%</h2>
						<div id="trigger" style="text-align: center"></div>
					</div>
					<div style="margin-top: 20px" class="type-container">
						<h2 class="title-container" style="margin-bottom: 40px">%automation.condition%</h2>
						<div id="condition" style="text-align: center"></div>
					</div>
					<div style="margin-top: 20px" class="type-container">
						<h2 class="title-container" style="margin-bottom: 40px">%automation.result%</h2>
						<div id="result" style="text-align: center"></div>
					</div>
				</form>
			</div>
			<script type="module">

				import { Query } from '/js/query.js';
				import { Essentials } from '/js/essentials.js';

				Query.SETUP(Essentials);
				Essentials.SETUP(Query, Preloader);
				Replacer.SETUP();

				window.Query = Query;
				window.Essentials = Essentials;

				window.automation = [];
				window.accessories = JSON.parse('<%accessories%>');
				window.services = [];
				
				window.data = {
					motion: {
						active : { text : '%characteristics.motion.active%', color : 'hsl(280, 75%, 55%)' },
						inactive : { text : '%characteristics.motion.inactive%', color : 'hsl(150, 75%, 55%)' }
					},
					occupancy: {
						active : { text : '%characteristics.occupancy.active%', color : 'hsl(280, 75%, 55%)' },
						inactive : { text : '%characteristics.occupancy.inactive%', color : 'hsl(150, 75%, 55%)' }
					},
					smoke: {
						active : { text : '%characteristics.smoke.active%', color : 'hsl(280, 75%, 55%)' },
						inactive : { text : '%characteristics.smoke.inactive%', color : 'hsl(150, 75%, 55%)' }
					},
					contact: {
						active : { text : '%characteristics.contact.active%', color : 'hsl(350, 75%, 55%)' },
						inactive : { text : '%characteristics.contact.inactive%', color : 'hsl(150, 75%, 55%)' }
					},
					outlet: {
						active : { text : '%characteristics.boolean.active%', color : 'hsl(205, 75%, 55%)' },
						inactive : { text : '%characteristics.boolean.inactive%', color : 'rgb(60, 60, 80)' }
					},
					relais: {
						active : { text : '%characteristics.boolean.active%', color : 'hsl(205, 75%, 55%)' },
						inactive : { text : '%characteristics.boolean.inactive%', color : 'rgb(60, 60, 80)' }
					},
					switch: {
						active : { text : '%characteristics.boolean.active%', color : 'hsl(18, 75%, 55%)' },
						inactive : { text : '%characteristics.boolean.inactive%', color : 'rgb(60, 60, 80)' }
					},
					rain: {
						active : { text : '%characteristics.rain.active%', color : 'hsl(220, 75%, 55%)' },
						inactive : { text : '%characteristics.rain.inactive%', color : 'hsl(150, 75%, 55%)' }
					},
					statelessswitch: {
						active : { text : '%characteristics.statelessswitch.active%', color : 'hsl(205, 75%, 55%)' },
						inactive : { text : '%characteristics.statelessswitch.inactive%', color : 'hsl(150, 75%, 55%)' }
					},
					led: {
						active : { text : '%characteristics.boolean.active%', color : 'hsl(18, 75%, 55%)' },
						inactive : { text : '%characteristics.boolean.inactive%', color : 'hsl(205, 75%, 55%)' }
					},
					dimmer: {
						active : { text : '%characteristics.boolean.active%', color : 'hsl(18, 75%, 55%)' },
						inactive : { text : '%characteristics.boolean.inactive%', color : 'hsl(205, 75%, 55%)' }
					},
					rgb: {
						active : { text : '%characteristics.boolean.active%', color : 'hsl(18, 75%, 55%)' },
						inactive : { text : '%characteristics.boolean.inactive%', color : 'hsl(205, 75%, 55%)' }
					},
					rgbw: {
						active : { text : '%characteristics.boolean.active%', color : 'hsl(18, 75%, 55%)' },
						inactive : { text : '%characteristics.boolean.inactive%', color : 'hsl(205, 75%, 55%)' }
					},
					rgbww: {
						active : { text : '%characteristics.boolean.active%', color : 'hsl(18, 75%, 55%)' },
						inactive : { text : '%characteristics.boolean.inactive%', color : 'hsl(205, 75%, 55%)' }
					},
					rgbcw: {
						active : { text : '%characteristics.boolean.active%', color : 'hsl(18, 75%, 55%)' },
						inactive : { text : '%characteristics.boolean.inactive%', color : 'hsl(205, 75%, 55%)' }
					},
					temperature: { text : '°C', colorRange : [220, 0], valueRange : [18, 26] },
					humidity: { text : '%', color : 'hsl(140, 75%, 55%)', colorRange : [0, 280], valueRange : [0, 100] },
					light: { text : '%characteristics.light%', color : 'hsl(40, 85%, 85%)', colorRange : [25, 85], valueRange : [0, 1000] },
					airquality: { text : '%characteristics.airquality%', color : 'hsl(180, 75%, 55%)', colorRange : [180, 0], valueRange : [0, 5] }
				};

				if(localStorage.getItem('automation-view') == 'vertical')
				{
					document.getElementById('toolbar').children[1].children[0].children[0].style.display = 'none';
					document.getElementById('toolbar').children[1].children[0].children[1].style.display = '';
					document.getElementById('toolbar').children[1].children[0].setAttribute('view', 'vertical');
					document.getElementById('automation').className = 'vertical-view';
				}

				Query.complexFetch('/serverside/automation', 5000, 2, {}, false).then(function(a) {

					automation = JSON.parse(a);

					console.log('AUTOMATION', automation);

					if(automation.length > 0)
					{
						sortAutomation(true);
						createGroupPanel();

						document.getElementById('create').getElementsByTagName('input')[0].value = automation[automation.length - 1].id + 1;
					}
					else if(services.length > 0)
					{
						document.getElementById('no-automation').style.display = '';

						Preloader.finish();
					}
					else
					{
						document.getElementById('no-devices').style.display = '';
						document.getElementById('add-button-big').style.display = 'none';
						document.getElementById('devices-button-big').style.display = '';
						document.getElementById('add-button').setAttribute('disabled', '');

						Preloader.finish();
					}
				});

				loadServices();
				
				if(services.length > 0)
				{
					var a = ['trigger', 'condition', 'result'];

					for(var i = 0; i < a.length; i++)
					{
						var addBtn = document.createElement('input');
						
						addBtn.setAttribute('value', '+');
						addBtn.setAttribute('onclick', 'addElement(' + "'" + a[i] + "'" + ')');
						addBtn.setAttribute('type', 'button');
						addBtn.setAttribute('class', 'gradient-blue-green add-entry-button');
						addBtn.setAttribute('style', 'max-width: 150px; margin-bottom: 20px');

						document.getElementById(a[i]).appendChild(addBtn);
					}
					
					addElement('trigger');
					addElement('result');
				}

				loadPluginData();

			</script>
			<script>

				// NOTE: Reload Plugin Data

				window.plugins = {};

				function loadPluginData()
				{
					return new Promise((resolve) => {

						Query.complexFetch('/serverside/plugins', 5000, 2, {}, false).then((p) => {

							try
							{
								plugins = JSON.parse(p);

								resolve(true);
							}
							catch(e)
							{
								console.error(e);

								resolve(false);
							}
						});
					});
				}

			</script>
			<script>

				function switchView(btn)
				{
					if(btn.getAttribute('view') == 'vertical')
					{
						btn.children[0].style.display = '';
						btn.children[1].style.display = 'none';

						document.getElementById('automation').className = '';

						localStorage.setItem('automation-view', 'horizontal');
						btn.setAttribute('view', 'horizontal');
					}
					else if(btn.getAttribute('view') == 'horizontal')
					{
						btn.children[0].style.display = 'none';
						btn.children[1].style.display = '';

						document.getElementById('automation').className = 'vertical-view';

						localStorage.setItem('automation-view', 'vertical');
						btn.setAttribute('view', 'vertical');
					}
				}

				function sortAutomation(init)
				{
					var select = document.getElementById('sort');
					var sort = 'id-asc';

					if(init && localStorage.getItem('automation-sort') != null)
					{
						sort = localStorage.getItem('automation-sort');
					}

					if(!init)
					{
						sort = select.children[select.selectedIndex].getAttribute('value');

						localStorage.setItem('automation-sort', sort);

						document.getElementById('automation').style.opacity = 0;
					}

					if(sort == 'alphabetical-asc')
					{
						automation.sort((a, b) => (a.name > b.name) ? 1 : (b.name > a.name) ? -1 : 0);
					}
					else if(sort == 'alphabetical-desc')
					{
						automation.sort((a, b) => (a.name < b.name) ? 1 : (b.name < a.name) ? -1 : 0);
					}
					else if(sort == 'id-asc')
					{
						automation.sort((a, b) => (a.id > b.id) ? 1 : (b.id > a.id) ? -1 : 0);
					}
					else if(sort == 'id-desc')
					{
						automation.sort((a, b) => (a.id < b.id) ? 1 : (b.id < a.id) ? -1 : 0);
					}
					else if(sort == 'activation-asc')
					{
						automation.sort((a, b) => (a.active == true) ? -1 : 1);
					}
					else if(sort == 'activation-desc')
					{
						automation.sort((a, b) => (a.active == false) ? -1 : 1);
					}

					setTimeout(() => {

						createAutomationPanels();

						setTimeout(() => {

							switchGroup(localStorage.getItem('automation-group') || 'all', true);

							document.getElementById('automation').style.opacity = 1;

						}, 0);

					}, init ? 0 : 300);
				}

			</script>
			<script>

				function createGroupPanel()
				{
					var tmpGroup = [], groups = [];

					for(const i in automation)
					{
						if(automation[i].group && !tmpGroup.includes(automation[i].group.toLowerCase()))
						{
							groups.push(automation[i].group);
							tmpGroup.push(automation[i].group.toLowerCase());
						}
					}

					groups.sort();

					for(const i in groups)
					{
						var group = document.createElement('input');

						group.setAttribute('type', 'button');
						group.setAttribute('onclick', 'switchGroup("' + groups[i].toLowerCase() + '", false)');
						group.setAttribute('group', groups[i].toLowerCase());
						group.setAttribute('value', groups[i]);
						group.setAttribute('class', 'white');
						group.setAttribute('style', 'margin-left: 20px; cursor: grab');
						
						document.getElementById('groups').appendChild(group);
					}

					const groupBar = document.getElementById('groups');

					let pos = { top: 0, left: 0, x: 0, y: 0 };

					const mouseDownHandler = function(e)
					{
						groupBar.style.cursor = 'grabbing';
						groupBar.style.userSelect = 'none';

						pos = {
							left: groupBar.scrollLeft,
							top: groupBar.scrollTop,
							x: e.clientX,
							y: e.clientY,
						};

						document.addEventListener('mousemove', mouseMoveHandler);
						document.addEventListener('mouseup', mouseUpHandler);
					};

					const mouseMoveHandler = function(e)
					{
						const dx = e.clientX - pos.x;
						const dy = e.clientY - pos.y;

						groupBar.scrollTop = pos.top - dy;
						groupBar.scrollLeft = pos.left - dx;
						
						for(var i = 0; i < groupBar.children.length; i++)
						{
							groupBar.children[i].style.pointerEvents = 'none';
						}
					};

					const mouseUpHandler = function()
					{
						groupBar.style.cursor = 'grab';
						groupBar.style.removeProperty('user-select');

						for(var i = 0; i < groupBar.children.length; i++)
						{
							groupBar.children[i].style.pointerEvents = 'all';
						}

						document.removeEventListener('mousemove', mouseMoveHandler);
						document.removeEventListener('mouseup', mouseUpHandler);
					};

					groupBar.addEventListener('mousedown', mouseDownHandler);
				}

				async function switchGroup(group, init)
				{
					if(init || localStorage.getItem('automation-group') != group)
					{
						localStorage.setItem('automation-group', group);

						if(!init)
						{
							document.getElementById('automation').style.opacity = 0;

							await Essentials.newTimeout(300);
						}

						var automationPanels = document.getElementById('automation').children;

						for(var i = 0; i < automationPanels.length; i++)
						{
							automationPanels[i].style.display = 'none';

							if(group == 'all' || automationPanels[i].getAttribute('group') == group)
							{
								automationPanels[i].style.display = '';
							}
						}

						var groupButtons = document.getElementById('groups').children;

						for(var i = 0; i < groupButtons.length; i++)
						{
							if(groupButtons[i].getAttribute('group') == group)
							{
								groupButtons[i].className = 'white group-active';
							}
							else
							{
								groupButtons[i].className = 'white';
							}
						}

						document.getElementById('automation').style.opacity = 1;
					}
				}
			
			</script>
			<script>

				async function openAddPage()
				{
					PageManager.setHeader('%menu.automation%', '%automation.create%', true);

					var main = document.createElement('div');

					main.style.display = 'flex';

					main.innerHTML = '<input type="button" value="%menu.back%" onclick="openViewPage(' + "'create'" + ')"><div style="display: block; width: 100%; margin-left: 20px"><input id="save-btn" type="submit" form="create-form" value="%automation.create%"></div>';

					PageManager.setFooter(main);
					PageManager.showFooter(true);

					await PageManager.switchPage('view', 'create', false);

					if((new URL(window.location.href)).searchParams.get('desktopApp') == 'true')
					{
						window.history.pushState(null, null, '/automation/?create&desktopApp=true');
					}
					else
					{
						window.history.pushState(null, null, '/automation/?create');
					}
				}

				async function openViewPage()
				{
					PageManager.setHeader('%general.dashboard%', '%menu.automation%', true);
					PageManager.hideFooter(true);

					await PageManager.switchPage('create', 'view', false);

					if((new URL(window.location.href)).searchParams.get('desktopApp') == 'true')
					{
						window.history.pushState(null, null, '/automation?desktopApp=true');
					}
					else
					{
						window.history.pushState(null, null, '/automation/');
					}
				}

				function createAutomationPanels()
				{
					document.getElementById('automation').innerHTML = '';

					for(var i = 0; i < automation.length; i++)
					{
						var typeContainer = document.createElement('button');

						typeContainer.setAttribute('style', 'height: auto; box-shadow: none');
						typeContainer.setAttribute('class', 'type-container');
						typeContainer.setAttribute('onclick', "Essentials.leavePage('/automation/modify?id=" + automation[i].id + "')");

						if(i == 0)
						{
							typeContainer.style.marginTop = '0';
						}

						if(automation[i].group != null && automation[i].group != '')
						{
							typeContainer.setAttribute('group', automation[i].group.toLowerCase());
						}

						var title = document.createElement('h2');

						title.setAttribute('class', 'title-container');

						title.innerHTML = automation[i].name + ' • ' + (automation[i].active ? '%automation.active%' : '%automation.inactive%');

						typeContainer.appendChild(title);

						var panel = document.createElement('button');
						var column = document.createElement('div');
						var category = document.createElement('div');

						column.className = 'column';

						category.innerHTML = '%automation.trigger%';
						category.className = 'primary';

						column.appendChild(category);

						var container = document.createElement('div');

						container.className = 'secondary';

						for(var j = 0; j < automation[i].trigger.length; j++)
						{
							var row = document.createElement('div');

							row.setAttribute('style', 'word-break: break-all; word-break: break-word');

							if(!automation[i].trigger[j].url && automation[i].trigger[j].name && automation[i].trigger[j].letters)
							{
								var src = Essentials.letterToType(automation[i].trigger[j].letters[0]);

								if(Essentials.letterToType(automation[i].trigger[j].letters[0]) == 'temperature')
								{
									src = 'climate';
								}

								row.innerHTML = '<img class="icon" src="/img/accessory/' + src + '.png">' + automation[i].trigger[j].name/* + ' ' + automation[i].trigger[j].operation + ' ' + val*/;
							}
							else if(automation[i].trigger[j].url)
							{
								row.innerHTML = '<img class="icon" src="/img/link.png">%automation.open_link%';
							}

							container.appendChild(row);

							column.appendChild(container);
						}

						panel.className = 'table';
						panel.appendChild(column);

						if(automation[i].condition && automation[i].condition.length > 0)
						{
							var column = document.createElement('div');
							var category = document.createElement('div');

							column.className = 'column';

							category.innerHTML = '%automation.condition%';
							category.className = 'primary';

							column.appendChild(category);

							var container = document.createElement('div');

							container.className = 'secondary';

							for(var j = 0; j < automation[i].condition.length; j++)
							{
								var row = document.createElement('div');

								row.setAttribute('style', 'word-break: break-all; word-break: break-word');

								if(!automation[i].condition[j].url && automation[i].condition[j].name && automation[i].condition[j].letters)
								{
									var src = Essentials.letterToType(automation[i].condition[j].letters[0]);

									if(Essentials.letterToType(automation[i].condition[j].letters[0]) == 'temperature')
									{
										src = 'climate';
									}

									row.innerHTML = '<img class="icon" src="/img/accessory/' + src + '.png">' + automation[i].condition[j].name/* + ' ' + automation[i].condition[j].operation + ' ' + val*/;
								}
								else if(automation[i].condition[j].url)
								{
									row.innerHTML = '<img class="icon" src="/img/link.png">%automation.open_link%';
								}

								container.appendChild(row);

								column.appendChild(container);
							}

							panel.className = 'table';
							panel.appendChild(column);
						}

						var column = document.createElement('div');
						var category = document.createElement('div');

						column.className = 'column';

						category.innerHTML = '%automation.result%';
						category.className = 'primary';

						column.appendChild(category);

						var container = document.createElement('div');

						container.className = 'secondary';

						for(var j = 0; j < automation[i].result.length; j++)
						{
							var row = document.createElement('div');

							row.setAttribute('style', 'word-break: break-all; word-break: break-word');

							if(!automation[i].result[j].url && automation[i].result[j].name && automation[i].result[j].letters)
							{
								var src = Essentials.letterToType(automation[i].result[j].letters[0]);

								if(Essentials.letterToType(automation[i].result[j].letters[0]) == 'temperature')
								{
									src = 'climate';
								}

								row.innerHTML = '<img class="icon" src="/img/accessory/' + src + '.png">' + automation[i].result[j].name/* + ' ' + automation[i].result[j].operation + ' ' + val*/;
							}
							else if(automation[i].result[j].url)
							{
								row.innerHTML = '<img class="icon" src="/img/link.png">%automation.open_link%';
							}

							container.appendChild(row);

							column.appendChild(container);
						}

						panel.className = 'table';
						panel.appendChild(column);

						typeContainer.appendChild(panel);
						document.getElementById('automation').appendChild(typeContainer);
					}

					Preloader.finish();
				}

				function updateValueInput(select)
				{
					updateOperation(select.parentElement.children[0]);

					var o = select.parentElement.children[0].getElementsByTagName('select')[0].selectedIndex;
					var option = select.parentElement.children[0].getElementsByTagName('select')[0].children[o];

					if(option.hasAttribute('letters') && option.getAttribute('letters')[0] == '3' && select.parentElement.children[1].getElementsByTagName('select')[0].children[select.parentElement.children[1].getElementsByTagName('select')[0].selectedIndex].innerHTML == '%automation.color%')
					{
						select.parentElement.children[2].setAttribute('hidden', '');
						select.parentElement.children[4].setAttribute('hidden', '');
						select.parentElement.children[4].removeAttribute('required');
						select.parentElement.children[2].removeAttribute('required');

						select.parentElement.children[3].style.display = '';
					}
					else if(option.getAttribute('type') == 'boolean')
					{
						select.parentElement.children[2].setAttribute('hidden', '');
						select.parentElement.children[4].removeAttribute('hidden');
						select.parentElement.children[4].setAttribute('required', '');
						select.parentElement.children[2].removeAttribute('required');

						select.parentElement.children[3].style.display = 'none';

						select.parentElement.children[4].getElementsByClassName('select-items')[0].children[0].innerHTML = data[Essentials.letterToType(option.getAttribute('letters')[0])].inactive.text;
						select.parentElement.children[4].getElementsByClassName('select-items')[0].children[1].innerHTML = data[Essentials.letterToType(option.getAttribute('letters')[0])].active.text;
						select.parentElement.children[4].getElementsByClassName('select-selected')[0].innerHTML = select.parentElement.children[4].getElementsByClassName('select-items')[0].getElementsByClassName('same-as-selected')[0].innerHTML;

						var options = select.parentElement.children[4].getElementsByClassName('select-items')[0].children;

						for(var i = 0; i < options.length; i++)
						{
							options[select.parentElement.children[4].getElementsByTagName('select')[0].selectedIndex].click();
						}
					}
					else if(option.getAttribute('type') == 'numeric' || option.getAttribute('type') == 'url')
					{
						select.parentElement.children[4].setAttribute('hidden', '');
						select.parentElement.children[2].removeAttribute('hidden');
						select.parentElement.children[2].setAttribute('required', '');
						select.parentElement.children[4].removeAttribute('required');

						select.parentElement.children[3].style.display = 'none';

						if(option.getAttribute('type') == 'numeric')
						{
							select.parentElement.children[2].setAttribute('placeholder', '%automation.number%');
							select.parentElement.children[2].setAttribute('pattern', '[0-9-]+');
						}
						else if(option.getAttribute('type') == 'url')
						{
							select.parentElement.children[2].setAttribute('placeholder', '%automation.link%');
							select.parentElement.children[2].removeAttribute('pattern');
						}
					}
				}

				function updateLightInputs(select)
				{
					var o = select.getElementsByTagName('select')[0].selectedIndex;
					var option = select.getElementsByTagName('select')[0].children[o];

					if(option.innerHTML == '%automation.switch%')
					{
						select.parentElement.children[2].setAttribute('hidden', '');
						select.parentElement.children[4].removeAttribute('hidden');
						select.parentElement.children[4].setAttribute('required', '');
						select.parentElement.children[2].removeAttribute('required');

						select.parentElement.children[3].style.display = 'none';

						if(option.hasAttribute('letters'))
						{
							select.parentElement.children[4].getElementsByClassName('select-items')[0].children[0].innerHTML = data[Essentials.letterToType(option.getAttribute('letters')[0])].inactive.text;
							select.parentElement.children[4].getElementsByClassName('select-items')[0].children[1].innerHTML = data[Essentials.letterToType(option.getAttribute('letters')[0])].active.text;
							select.parentElement.children[4].getElementsByClassName('select-selected')[0].innerHTML = select.parentElement.children[4].getElementsByClassName('select-items')[0].getElementsByClassName('same-as-selected')[0].innerHTML;
						}
					}
					else if(option.innerHTML == '%automation.color%')
					{
						select.parentElement.children[2].setAttribute('hidden', '');
						select.parentElement.children[4].setAttribute('hidden', '');
						select.parentElement.children[4].removeAttribute('required');
						select.parentElement.children[2].removeAttribute('required');

						select.parentElement.children[3].style.display = 'flex';
					}
				}

				function addElement(type)
				{
					var element = document.createElement('div');
					var p = document.createElement('p');
					var b = document.createElement('b');
					var select = document.createElement('div');

					b.innerHTML = '%automation.device%: ';

					select.className = 'custom-select';
					select.style.marginRight = '20px';
					select.style.width = '100%';

					element.className = 'automation-device-entry';

					var html = '<select name="service" onchange="updateValueInput(this)">';

					if(type == 'result')
					{
						html += '<option img="/img/link.png" type="url">%automation.open_link%</option>';
					}

					for(var i = 0; i < services.length; i++)
					{
						if(services[i].type != 'lcd' && services[i].type != 'bridge' && services[i].type != 'unsupported' && services[i].type != 'removed' && (type == 'result' || (services[i].type != 'statelessswitch' && services[i].type != 'rgb' && services[i].type != 'rgbw')))
						{
							html += '<option name="' + services[i].name + '" letters="' + services[i].letters + '" id="' + services[i].id + '" plugin="' + services[i].plugin + '" img="/img/accessory/' + services[i].type + '.png" type="' + getDataType(services[i].type) + '">' + services[i].name + '</option>';
						}
					}

					html += '</select>';

					select.innerHTML = html;
			   
					var operations = document.createElement('div');

					operations.className = 'custom-select';
					operations.style.width = '100%';
					operations.style.marginRight = '20px';
					operations.innerHTML = '<select onchange="updateLightInputs(this)" name="operation"><option value="=">=</option><option value="switch">%automation.switch%</option><option value="color">%automation.color%</option></select>';

					if(type != 'result')
					{
						operations.innerHTML = '<select onchange="updateLightInputs(this)" name="operation"><option value="=">=</option><option value=">">></option><option value="<"><</option><option value="switch">%automation.switch%</option><option value="color">%automation.color%</option></select>';
					}

					document.getElementById(type).insertBefore(element, document.getElementById(type).getElementsByClassName('add-entry-button')[0]);
				
					element.appendChild(Replacer.createSelectMenu(select));
					element.appendChild(Replacer.createSelectMenu(operations));

					element.innerHTML += '<input placeholder="' + (type == 'result' ? '%automation.link%' : '%automation.number%') + '" title="%pattern.numbers_special%: -" name="value" type="text" style="width: 100%!important">';
					element.innerHTML += '<div class="automation-color-container"><input placeholder="%automation.hue%" title="%pattern.numbers_special%: -" name="value" type="text" style="width: 100%!important"><input placeholder="%automation.saturation%" title="%pattern.numbers_special%: -" name="value" type="text" style="width: 100%!important"><input placeholder="%automation.brightness%" title="%pattern.numbers_special%: -" name="value" type="text" style="width: 100%!important"></div>';

					var value = document.createElement('div');

					value.className = 'custom-select';
					value.style.width = '100%';
					value.style.marginRight = '20px';
					value.innerHTML = '<select name="value"><option selected value="false">false</option><option value="true">true</select>';

					element.appendChild(Replacer.createSelectMenu(value));

					updateValueInput(value);

					element.innerHTML += '<button onclick="removeEntry(this)" class="image-button white" style="width: auto!important"><img class="icon-inverted" style="height: 100%" src="/img/delete.png"></button>';
				}

				async function createAutomation()
				{
					var automationOBJ = {};

					automationOBJ.id = parseInt(document.getElementById('create').getElementsByTagName('input')[0].value);
					automationOBJ.name = document.getElementById('create').getElementsByTagName('input')[1].value;
					automationOBJ.active = true;
					automationOBJ.trigger = [];

					for(var i = 0; i < document.getElementById('trigger').children.length - 1; i++)
					{
						var t = document.getElementById('trigger').children[i], trigger = {};

						for(var j = 0; j < t.children.length; j++)
						{
							var device = t.children[0].getElementsByTagName('select')[0].children[t.children[0].getElementsByTagName('select')[0].selectedIndex];
							var operation = t.children[1].getElementsByTagName('select')[0].children[t.children[1].getElementsByTagName('select')[0].selectedIndex];
							var value = t.children[2];

							if(device.getAttribute('type') == 'url')
							{
								trigger.url = value.value;
							}
							else
							{
								trigger.id = device.getAttribute('id');
								trigger.name = device.getAttribute('name');
								trigger.letters = device.getAttribute('letters');
								trigger.plugin = device.getAttribute('plugin');
								
								if(device.hasAttribute('letters') && device.getAttribute('letters')[0] == '3')
								{
									trigger.operation = '=';

									if(operation.value == 'switch')
									{
										trigger.value = t.children[4].getElementsByTagName('select')[0].children[t.children[4].getElementsByTagName('select')[0].selectedIndex].value;
									}
									else if(operation.value == 'color')
									{
										trigger.value = 'true';

										if(t.children[3].children[0].value != '')
										{
											trigger.hue = t.children[3].children[0].value;
										}

										if(t.children[3].children[1].value != '')
										{
											trigger.saturation = t.children[3].children[1].value;
										}

										if(t.children[3].children[2].value != '')
										{
											trigger.brightness = t.children[3].children[2].value;
										}
									}
								}
								else if(device.getAttribute('type') == 'numeric')
								{
									trigger.operation = operation.value;
									trigger.value = value.value;
								}
								else if(device.getAttribute('type') == 'boolean')
								{
									trigger.operation = operation.value;
									trigger.value = t.children[4].getElementsByTagName('select')[0].children[t.children[4].getElementsByTagName('select')[0].selectedIndex].value;
								}
							}
						}
						
						automationOBJ.trigger.push(trigger);
					}

					if(document.getElementById('condition').childElementCount > 1)
					{
						automationOBJ.condition = [];

						for(var i = 0; i < document.getElementById('condition').children.length - 1; i++)
						{
							var c = document.getElementById('condition').children[i], condition = {};

							for(var j = 0; j < c.children.length; j++)
							{
								var device = c.children[0].getElementsByTagName('select')[0].children[c.children[0].getElementsByTagName('select')[0].selectedIndex];
								var operation = c.children[1].getElementsByTagName('select')[0].children[c.children[1].getElementsByTagName('select')[0].selectedIndex];
								var value = c.children[2];

								if(device.getAttribute('type') == 'url')
								{
									condition.url = value.value;
								}
								else
								{
									condition.id = device.getAttribute('id');
									condition.name = device.getAttribute('name');
									condition.letters = device.getAttribute('letters');
									condition.plugin = device.getAttribute('plugin');
									
									if(device.hasAttribute('letters') && device.getAttribute('letters')[0] == '3')
									{
										condition.operation = '=';

										if(operation.value == 'switch')
										{
											condition.value = c.children[4].getElementsByTagName('select')[0].children[c.children[4].getElementsByTagName('select')[0].selectedIndex].value;
										}
										else if(operation.value == 'color')
										{
											condition.value = 'true';

											if(c.children[3].children[0].value != '')
											{
												condition.hue = c.children[3].children[0].value;
											}

											if(c.children[3].children[1].value != '')
											{
												condition.saturation = c.children[3].children[1].value;
											}

											if(c.children[3].children[2].value != '')
											{
												condition.brightness = c.children[3].children[2].value;
											}
										}
									}
									else if(device.getAttribute('type') == 'numeric')
									{
										condition.operation = operation.value;
										condition.value = value.value;
									}
									else if(device.getAttribute('type') == 'boolean')
									{
										condition.operation = operation.value;
										condition.value = c.children[4].getElementsByTagName('select')[0].children[c.children[4].getElementsByTagName('select')[0].selectedIndex].value;
									}
								}
							}

							automationOBJ.condition.push(condition);
						}
					}

					automationOBJ.result = [];

					for(var i = 0; i < document.getElementById('result').children.length - 1; i++)
					{
						var r = document.getElementById('result').children[i], result = {};

						for(var j = 0; j < r.children.length; j++)
						{
							var device = r.children[0].getElementsByTagName('select')[0].children[r.children[0].getElementsByTagName('select')[0].selectedIndex];
							var operation = r.children[1].getElementsByTagName('select')[0].children[r.children[1].getElementsByTagName('select')[0].selectedIndex];
							var value = r.children[2];

							if(device.getAttribute('type') == 'url')
							{
								result.url = value.value;
							}
							else
							{
								result.id = device.getAttribute('id');
								result.name = device.getAttribute('name');
								result.letters = device.getAttribute('letters');
								result.plugin = device.getAttribute('plugin');
								
								if(device.hasAttribute('letters') && device.getAttribute('letters')[0] == '3')
								{
									result.operation = '=';

									if(operation.value == 'switch')
									{
										result.value = r.children[4].getElementsByTagName('select')[0].children[r.children[4].getElementsByTagName('select')[0].selectedIndex].value;
									}
									else if(operation.value == 'color')
									{
										result.value = 'true';

										if(r.children[3].children[0].value != '')
										{
											result.hue = r.children[3].children[0].value;
										}

										if(r.children[3].children[1].value != '')
										{
											result.saturation = r.children[3].children[1].value;
										}

										if(r.children[3].children[2].value != '')
										{
											result.brightness = r.children[3].children[2].value;
										}
									}
								}
								else if(device.getAttribute('type') == 'numeric')
								{
									result.operation = operation.value;
									result.value = value.value;
								}
								else if(device.getAttribute('type') == 'boolean')
								{
									result.operation = operation.value;
									result.value = r.children[4].getElementsByTagName('select')[0].children[r.children[4].getElementsByTagName('select')[0].selectedIndex].value;
								}
							}
						}

						automationOBJ.result.push(result);
					}

					console.log('SAVE AUTOMATION', automationOBJ);

					var overlays = {
						root : document.getElementById('save-btn'),
						id : 'save',
						pending : { value : '%automation.creating% ..' },
						executeError : { value : '%automation.create_failed%!' },
						connectionError : { value : '%general.bridge_connection_error%!' }
					};

					var created = await Query.complexFetch('/serverside/create-automation', 5000, 2, overlays, false, JSON.stringify(automationOBJ));

					if(created == 'Success')
					{
						for(const id in plugins)
						{
							if(plugins[id].config != null && plugins[id].config.port != null)
							{
								await Query.complexFetch(window.location.protocol +  '//' + window.location.hostname + ':' + plugins[id].config.port + '/reload-automation', 5000, 2, {}, true);
							}
						}
						
						Essentials.showOverlay(document.getElementById('save-btn'), Essentials.createOverlay(3, 'reset-result', '%automation.create_success%!', 'green'));

						var a = await Query.complexFetch('/serverside/automation', 5000, 2, {}, false);

						automation = JSON.parse(a);

						document.getElementById('no-automation').style.display = 'none';

						sortAutomation(true);

						await Essentials.newTimeout(4000);

						openViewPage('create');

						await Essentials.newTimeout(600);

						Essentials.removeOverlays(document.getElementById('save-btn'), true);

						document.getElementById('create').getElementsByTagName('input')[0].value = automation[automation.length - 1].id + 1;
					}
				}

				function loadServices()
				{
					for(var i = 0; i < accessories.length; i++)
					{
						if(accessories[i].plugin.alias == 'SynTex')
						{
							accessories[i].plugin.alias = 'SynTexWebHooks';
						}

						if(accessories[i].services == 'rgbw' || accessories[i].services == 'rgbww' || accessories[i].services == 'rgbcw')
						{
							accessories[i].services = 'rgb';
						}

						if(Array.isArray(accessories[i].services))
						{
							var counter = { type : '', count : 0 };

							for(var j = 0; j < accessories[i].services.length; j++)
							{
								if(accessories[i].services[j] instanceof Object)
								{
									if(counter.type != accessories[i].services[j].type)
									{
										counter.count = 0;
									}

									counter.type = accessories[i].services[j].type;
									
									services.push({ type : accessories[i].services[j].type, name : (accessories[i].services[j].name || accessories[i].name), id : accessories[i].id, letters : Essentials.typeToLetter(accessories[i].services[j].type) + counter.count, plugin : accessories[i].plugin.alias });
								}
								else
								{
									if(counter.type != accessories[i].services[j])
									{
										counter.count = 0;
									}

									counter.type = accessories[i].services[j];

									services.push({ type : accessories[i].services[j], name : accessories[i].name, id : accessories[i].id, letters : Essentials.typeToLetter(accessories[i].services[j]) + counter.count, plugin : accessories[i].plugin.alias });
								}

								counter.count++;
							}
						}
						else if(accessories[i].services instanceof Object)
						{
							services.push({ type : accessories[i].services.type, name : (accessories[i].services.name || accessories[i].name), id : accessories[i].id, letters : Essentials.typeToLetter(accessories[i].services.type) + '0', plugin : accessories[i].plugin.alias });
						}
						else
						{
							services.push({ type : accessories[i].services, name : accessories[i].name, id : accessories[i].id, letters : Essentials.typeToLetter(accessories[i].services) + '0', plugin : accessories[i].plugin.alias });
						}
					}

					services.sort((a, b) => (a.name > b.name) ? 1 : (b.name > a.name) ? -1 : 0);

					console.log('SERVICES', services);
				}

				function getDataType(type)
				{
					if(type == 'temperature' || type == 'humidity' || type == 'light' || type == 'airquality' || type == 'statelessswitch')
					{
						return 'numeric';
					}
					else
					{
						return 'boolean';
					}
				}

				function updateOperation(select)
				{
					var o = select.getElementsByTagName('select')[0].selectedIndex;
					var option = select.getElementsByTagName('select')[0].children[o];
					var options = select.parentElement.children[1].getElementsByClassName('select-items')[0].children;

					var availableOptions = [];

					if(option.hasAttribute('letters') && option.getAttribute('letters')[0] == '3')
					{
						availableOptions = ['%automation.switch%', '%automation.color%'];
					}
					else if(option.getAttribute('type') == 'boolean' || option.getAttribute('type') == 'url')
					{
						availableOptions = ['='];
					}
					else if(option.getAttribute('type') == 'numeric')
					{
						availableOptions = ['=', '&gt;', '&lt;'];
					}

					var setDefault = false;

					if(!availableOptions.includes(select.parentElement.children[1].getElementsByClassName('same-as-selected')[0].innerHTML))
					{
						select.parentElement.children[1].getElementsByClassName('select-selected')[0].innerHTML = availableOptions[0];

						setDefault = true;
					}

					for(var i = 0; i < options.length; i++)
					{
						if(availableOptions.includes(options[i].innerHTML))
						{
							options[i].style.display = '';

							if(setDefault)
							{
								if(options[i].innerHTML == availableOptions[0])
								{
									options[i].classList.add('same-as-selected');

									select.parentElement.children[1].getElementsByTagName('select')[0].selectedIndex = i;
								}
								else
								{
									options[i].classList.remove('same-as-selected');
								}
							}
						}
						else
						{
							options[i].style.display = 'none';
							options[i].classList.remove('same-as-selected');
						}
					}
				}

				function removeEntry(btn)
				{
					btn.parentElement.parentElement.removeChild(btn.parentElement);
				}

			</script>
		</div>
	</body>
</html>