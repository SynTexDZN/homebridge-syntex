<html>
    <title>Kontakt-Sensor</title>
    <body>
        <div id="infos">
            <div class="control-container">
                <input id="status" class="control-panel" type="button" value="LADEN ..">
            </div>
            <h1>Laden ..</h1>
            <div class="main" style="margin-top: 100px; margin-bottom: 132px; display: table"></div>
            <div class="main">
                <input id="restart-btn" style="margin-bottom: 20px;" type="button" value="Gerät Neustarten" onclick="restartDevice()">
                <div style="display: flex">
                    <input type="button" value="Zurück" onclick="window.location.href='/'">
                    <input class="gradient-red" style="margin-left: 20px" type="button" value="Einstellungen" onclick="openSettings()">
                </div>
            </div>
        </div>
        <div id="settings" style="display: none;">
            <h1>Einstellungen</h1>
            <p>Laden ..</p>
            <div class="main" style="margin-top: 100px; margin-bottom: 132px; display: table;"></div>
            <div class="main">
                <input id="reset-btn" style="margin-bottom: 20px" type="button" value="Gerät Zurücksetzen" onclick="resetDevice()">
                <input id="reconnect-btn" style="margin-bottom: 20px;" type="button" value="Gerät Neu Verbinden">
                <div style="display: flex">
                    <input type="button" value="Zurück" onclick="closeSettings()">
                    <input id="save-btn" style="margin-left: 20px;" type="submit" value="Speichern" onclick="saveConfig()">
                </div>
            </div>
        </div>
    </body>
</html>
<script>

    var device = JSON.parse('<%device%>');
    var settings = [];

    if(device.type == 'contact' || device.type == 'motion' || device.type == 'relais' || device.type == 'switch')
    {
        settings.push('LED');
    }

    if(device.type == 'motion')
    {
        settings.push('Delay');
    }

    if(device.type == 'light' || device.type == 'temperature')
    {
        settings.push('Interval');
    }

    if(device.type == 'light')
    {
        settings.push('Scenecontrol');
    }

    console.log(device);

    document.getElementsByTagName('title')[0].innerHTML = device.name;
    document.getElementsByTagName('h1')[0].innerHTML = device.name;

    document.getElementById('infos').getElementsByClassName('main')[0].innerHTML += '<p><b>Mac: </b>' + device.id + '</p>';
    document.getElementById('infos').getElementsByClassName('main')[0].innerHTML += '<p><b>IP: </b>' + device.ip + '</p>';
    document.getElementById('infos').getElementsByClassName('main')[0].innerHTML += '<p><b>Typ: </b>' + device.type + '</p>';
    document.getElementById('infos').getElementsByClassName('main')[0].innerHTML += '<p><b>Version: </b>' + device.version + '</p>';

    for(const i in settings)
    {
        document.getElementById('infos').getElementsByClassName('main')[0].innerHTML += '<p><b>' + settings[i].toUpperCase() + ': </b>' + device[settings[i].toLowerCase()] + '</p>';
    }

    document.getElementById('infos').getElementsByClassName('main')[1].setAttribute('type', device.type);
    document.getElementById('infos').getElementsByClassName('main')[1].setAttribute('version', device.version);

    document.getElementById('reconnect-btn').setAttribute('onclick', "window.location.href='/reconnect?ip=" + device.ip + "&mac=" + device.id + "&type=" + device.type + "'");

    document.getElementById('settings').getElementsByTagName('p')[0].innerHTML = '( ' + device.name + ' )';

    document.getElementById('settings').getElementsByClassName('main')[0].innerHTML += '<p>Name: <input value="' + device.name + '" name="name" type="text" style="max-width: 325px"></p>';

    for(const i in settings)
    {
        document.getElementById('settings').getElementsByClassName('main')[0].innerHTML += '<p>' + settings[i].toUpperCase() + ': <input value="' + device[settings[i].toLowerCase()] + '" name="' + settings[i].toLowerCase() + '" type="text" style="max-width: 150px"></p>';
    }

    document.getElementById('settings').getElementsByClassName('main')[0].setAttribute('mac', device.id);
    document.getElementById('settings').getElementsByClassName('main')[0].setAttribute('ip', device.ip);
    document.getElementById('settings').getElementsByClassName('main')[0].setAttribute('type', device.type);

</script>
<script>

    function openSettings()
    {
        document.getElementById('infos').setAttribute('style', 'display: none');
        document.getElementById('settings').removeAttribute('style');
        document.getElementsByTagName('title')[0].innerHTML = device.name + ' (Einstellungen)';
    }
    
    function closeSettings()
    {
        document.getElementById('infos').removeAttribute('style');
        document.getElementById('settings').setAttribute('style', 'display: none');
        document.getElementsByTagName('title')[0].innerHTML = device.name;
    }
    
    function fetchState()
    {        
        if(device.type == 'contact' || device.type == 'motion' || device.type == 'relais' || device.type == 'switch')
        {
            var client = new XMLHttpRequest();

            client.timeout = 10000;
            
            client.open('GET', window.location.protocol + '//' + window.location.hostname + ':1710/devices?mac=' + device.id);

            client.onreadystatechange = function()
            {
                if(client.readyState === 4)
                {  
                    if(client.status === 200)
                    {
                        if(device.type == 'contact')
                        {
                            if(client.responseText == 'true') 
                            {
                                document.getElementById('status').value = 'ZU';
                                document.getElementById('status').style.backgroundImage = 'linear-gradient(to top, hsl(150, 75%, 45%) 0%, hsl(150, 75%, 55%) 100%)';
                            }
                            else if(client.responseText == 'false')
                            {
                                document.getElementById('status').value = 'GEÖFFNET';
                                document.getElementById('status').style.backgroundImage = 'linear-gradient(to top, hsl(350, 75%, 45%) 0%, hsl(350, 75%, 55%) 100%)';
                            }
                        }
                        else if(device.type == 'motion')
                        {
                            if(client.responseText == 'true') 
                            {
                                document.getElementById('status').value = 'BEWEGUNG';
                                document.getElementById('status').style.backgroundImage = 'linear-gradient(to top, hsl(280, 75%, 45%) 0%, hsl(280, 75%, 55%) 100%)';
                            }
                            else if(client.responseText == 'false')
                            {
                                document.getElementById('status').value = 'BEREIT';
                                document.getElementById('status').style.backgroundImage = 'linear-gradient(to top, hsl(150, 75%, 45%) 0%, hsl(150, 75%, 55%) 100%)';
                            }
                        }
                        else if(device.type == 'relais' || device.type == 'switch')
                        {
                            if(client.responseText == 'true')
                            {
                                document.getElementById('status').value = 'AN';
                                document.getElementById('status').style.backgroundImage = 'linear-gradient(to top, hsl(205, 75%, 45%) 0%, hsl(205, 75%, 55%) 100%)';
                            }
                            else if(client.responseText == 'false')
                            {
                                document.getElementById('status').value = 'AUS';
                                document.getElementById('status').style.backgroundImage = 'linear-gradient(to top, hsl(18, 75%, 45%) 0%, hsl(18, 75%, 55%) 100%)';
                            }
                        }
                        
                        console.log(client.responseText);
                    }
                }
            }
            
            client.send();
        }
        else if(device.type == 'light' || device.type == 'temperature')
        {
            var client = new XMLHttpRequest();

            client.timeout = 10000;
            
            client.open('GET', window.location.protocol + '//' + window.location.hostname + ':1710/devices?mac=' + device.id + '&type=' + device.type);

            client.onreadystatechange = function()
            {
                if(client.readyState === 4)
                {  
                    if(client.status === 200)
                    {
                        if(device.type == 'light')
                        {
                            document.getElementById('status').value = Math.round(client.responseText) + ' LUX' + ' - ' + document.getElementById('status').value.split(' - ')[1];
                        }
                        else if(device.type == 'temperature')
                        {
                            document.getElementById('status').value = ((Math.round(client.responseText * 10.0)) / 10.0) + ' °C' + ' - ' + document.getElementById('status').value.split(' - ')[1];
                        }

                        console.log(client.responseText);
                    }
                }
            }
            
            client.send();
            
            var client2 = new XMLHttpRequest();

            client2.timeout = 10000;
            
            if(device.type == 'light')
            {
                client2.open('GET', window.location.protocol + '//' + window.location.hostname + ':1710/devices?mac=' + device.id + '&type=rain');
            }
            else if(device.type == 'temperature')
            {
                client2.open('GET', window.location.protocol + '//' + window.location.hostname + ':1710/devices?mac=' + device.id + '&type=humidity');
            }

            client2.onreadystatechange = function()
            {
                if(client2.readyState === 4)
                {  
                    if(client2.status === 200)
                    {
                        if(device.type == 'light')
                        {
                            if(client2.responseText == 'false')
                            {
                                document.getElementById('status').value = document.getElementById('status').value.split(' - ')[0] + ' - TROCKEN';
                                document.getElementById('status').style.backgroundImage = 'linear-gradient(to top, hsl(40, 85%, 75%) 0%, hsl(40, 85%, 85%) 100%)';
                            }
                            else if(client2.responseText == 'true')
                            {
                                document.getElementById('status').value = document.getElementById('status').value.split(' - ')[0] + ' - REGEN';
                                document.getElementById('status').style.backgroundImage = 'linear-gradient(to top, hsl(220, 75%, 45%) 0%, hsl(220, 75%, 55%) 100%)';
                            }
                        }
                        else if(device.type == 'temperature')
                        {
                            if(client2.responseText > 40 && client2.responseText < 70)
                            {
                                document.getElementById('status').style.backgroundImage = 'linear-gradient(to top, hsl(150, 75%, 45%) 0%, hsl(150, 75%, 55%) 100%)';
                            }
                            else if(client2.responseText < 20 || client2.responseText > 85)
                            {
                                document.getElementById('status').style.backgroundImage = 'linear-gradient(to top, hsl(0, 75%, 45%) 0%, hsl(0, 75%, 55%) 100%)';
                            }
                            else
                            {
                                document.getElementById('status').style.backgroundImage = 'linear-gradient(to top, hsl(18, 75%, 45%) 0%, hsl(18, 75%, 55%) 100%)';
                            }

                            document.getElementById('status').value = document.getElementById('status').value.split(' - ')[0] + ' - ' + client2.responseText + ' %';
                        }

                        console.log(client2.responseText);
                    }
                }
            }
            
            client2.send();
        }
    }

</script>