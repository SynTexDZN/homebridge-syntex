<html>
    <title>Licht-Sensor</title>
    <body>
        <div id="infos">
            <div class="control-container">
                <input id="light" class="control-panel" type="button" value="LADEN .." id="switch">
            </div>
            <h1>Laden ..</h1>
            <div class="main" style="margin-top: 100px; margin-bottom: 132px; display: table">
                <p><b>MAC: </b>Laden ..</p>
                <p><b>IP: </b>Laden ..</p>
                <p><b>Typ: </b>Laden ..</p>
                <p><b>Version: </b>Laden ..</p>
                <p><b>Interval: </b>Laden ..</p>
                <p><b>Szenenkontrolle: </b>Laden ..</p>
            </div>
            <div class="main">
                <input id="restart-btn" style="margin-bottom: 20px;" type="button" value="Gerät Neustarten" onclick="restartDevice()">
                <div style="display: flex">
                    <input type="button" value="Zurück" onclick="window.location.href='http://syntex.local/'">
                    <input style="margin-left: 20px; background-image: linear-gradient(to right, hsl(200, 85%, 55%) 0%, hsl(220, 95%, 60%) 100%);" type="button" value="Einstellungen" onclick="openSettings()">
                </div>
            </div>
        </div>
        <div id="settings" style="display: none;">
            <h1>Einstellungen</h1>
            <p>Laden ..</p>
            <div class="main" style="margin-top: 100px; margin-bottom: 132px; display: table;">
                <p>Name: <input name="name" type="text" style="max-width: 325px"></p>
                <p>Interval: <input name="interval" type="text" style="max-width: 150px"></p>
                <p>Szenenkontrolle: <input name="scenecontrol" type="text" style="max-width: 150px"></p>
            </div>
            <div class="main">
                <input id="reset-btn" style="margin-bottom: 20px; background-image: linear-gradient(to left, hsl(345, 85%, 55%) 0%, hsl(350, 95%, 60%) 100%);" type="button" value="Gerät Zurücksetzen" onclick="resetDevice()">
                <input id="reconnect-btn" style="margin-bottom: 20px;" type="button" value="Gerät Neu Verbinden">
                <div style="display: flex">
                    <input type="button" value="Zurück" onclick="closeSettings()">
                    <input id="savebtn" style="margin-left: 20px;" type="submit" value="Speichern" onclick="saveConfig()">
                </div>
            </div>
        </div>
    </body>
</html>
<script>

    var device = JSON.parse('<%device%>');
        
    console.log(device);
    
    document.getElementsByTagName('h1')[0].innerHTML = device.name;
    
    document.getElementsByClassName('main')[0].children[0].innerHTML = '<b>MAC: </b>' + device.id;
    document.getElementsByClassName('main')[0].children[1].innerHTML = '<b>IP: </b>' + device.ip;
    document.getElementsByClassName('main')[0].children[2].innerHTML = '<b>Typ: </b>' + device.type;
    document.getElementsByClassName('main')[0].children[3].innerHTML = '<b>Version: </b>' + device.version;
    document.getElementsByClassName('main')[0].children[4].innerHTML = '<b>Interval: </b>' + device.interval / 1000 + ' sek';
    document.getElementsByClassName('main')[0].children[5].innerHTML = '<b>Szenenkontrolle: </b>' + device.scenecontrol;
    
    document.getElementsByClassName('main')[1].setAttribute('type', device.type);
    document.getElementsByClassName('main')[1].setAttribute('version', device.version);
    
    function openSettings()
    {
        document.getElementById('infos').setAttribute('style', 'display: none');
        document.getElementById('settings').removeAttribute('style');
    }
    
    function closeSettings()
    {
        document.getElementById('infos').removeAttribute('style');
        document.getElementById('settings').setAttribute('style', 'display: none');
    }
    
    function fetchState()
    {        
        var client = new XMLHttpRequest();
        
        client.open('GET', 'http://syntex.local:1710/devices?mac=' + device.id + '&type=light');

        client.onreadystatechange = function()
        {
            if(client.readyState === 4)
            {  
                if(client.status === 200)
                {
                    document.getElementById('light').value = Math.round(client.responseText) + ' LUX' + ' - ' + document.getElementById('light').value.split(' - ')[1];
                    console.log(client.responseText);
                }
            }
        }
        
        client.send();
        
        var client2 = new XMLHttpRequest();
        
        client2.open('GET', 'http://syntex.local:1710/devices?mac=' + device.id + '&type=rain');

        client2.onreadystatechange = function()
        {
            if(client2.readyState === 4)
            {  
                if(client2.status === 200)
                {
                    if(client2.responseText == 'false')
                    {
                        document.getElementById('light').value = document.getElementById('light').value.split(' - ')[0] + ' - TROCKEN';
                        document.getElementById('light').style.backgroundImage = 'linear-gradient(to top, hsl(40, 85%, 75%) 0%, hsl(40, 85%, 85%) 100%)';
                    }
                    else if(client2.responseText == 'true')
                    {
                        document.getElementById('light').value = document.getElementById('light').value.split(' - ')[0] + ' - REGEN';
                        document.getElementById('light').style.backgroundImage = 'linear-gradient(to top, hsl(220, 75%, 45%) 0%, hsl(220, 75%, 55%) 100%)';
                    }
                    
                    console.log(client2.responseText);
                }
            }
        }
        
        client2.send();
    }

</script>
<script>

    document.getElementById('settings').getElementsByTagName('p')[0].innerHTML = '( ' + device.name + ' )';
    document.getElementById('settings').getElementsByTagName('input')[0].value = device.name;
    document.getElementById('settings').getElementsByTagName('input')[1].value = device.interval / 1000;
    document.getElementById('settings').getElementsByTagName('input')[2].value = device.scenecontrol;
    
    document.getElementById('settings').getElementsByClassName('main')[0].setAttribute('mac', device.id);
    document.getElementById('settings').getElementsByClassName('main')[0].setAttribute('ip', device.ip);
    document.getElementById('settings').getElementsByClassName('main')[0].setAttribute('type', device.type);
    
    document.getElementById('reconnect-btn').setAttribute('onclick', "window.location.href='http://syntex.local/reconnect?ip=" + device.ip + "'");

</script>