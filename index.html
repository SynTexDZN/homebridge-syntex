<html>
    
    <title>Dashboard: Geräte</title>
    <body>
        <h1 style="margin-bottom: 0; margin-top: 32px">Dashboard</h1>
        <div class="main" style="margin-top: 10px; margin-bottom: 100px; display: table">
            <p style="margin-bottom: 100px; margin-top: 16px">Geräte</p>
            <div class="main" style="margin-top: 10px; margin-bottom: 20px; display: flex">
                <input class="white" type="button" value="Geräte" onclick="window.location.href='/'" style="margin-right: 20px" disabled>
                <input class="white" type="button" value="Bridge" onclick="window.location.href='/bridge'">
            </div>
            <div class="main" style="margin-top: 10px; margin-bottom: 100px; display: flex">
                <input class="white" type="button" value="Log" onclick="window.location.href='/log'">
            </div>
            <div id="widgets" style="display: grid; grid-template-columns: calc(25% - 15px) calc(25% - 15px) calc(25% - 15px) calc(25% - 15px); grid-gap: 20px">
                <div class="widget">
                    <button class="widget-left" disabled>Geräte</button>
                    <button class="widget-right gradient-blue" disabled>-</button>
                </div>
                <div class="widget">
                    <button class="widget-left" disabled>Updates</button>
                    <button class="widget-right gradient-purple" disabled>-</button>
                </div>
                <div class="widget">
                    <button class="widget-left" disabled>Fehler</button>
                    <button class="widget-right gradient-red" disabled>-</button>
                </div>
                <div class="widget">
                    <button class="widget-left" disabled>Online</button>
                    <button class="widget-right gradient-green" disabled>-</button>
                </div>
            </div>
            <div style="margin: 20px 0; display: grid; grid-template-columns: calc(50% - 10px) calc(50% - 10px); grid-gap: 20px">
                <div>
                    <button id="activate-all" class="gradient-red" onclick="switchAll(this)">Aktiv: Alle Aus</button>
                </div>
                <div>
                    <button id="restart-all" onclick="restartAll(this)">Neustart: Alle</button>
                </div>
            </div>
            <div id="devices" style="margin-top: 100px">
                <h2 style="width: fit-content">• Smart Lock •</h2>
                <div style="display: block; margin-bottom: 20px">
                    <input class="white" type="button" style="text-align: left; padding-left: 15px" onclick="window.location.href=window.location.origin+':8000/smartlock.php'" value="Smart Lock">
                </div>
            </div>
        </div>
        <div class="bottom" style="margin: 0 auto; width: 100%; max-width: 400px">
            <input style="margin-bottom: 20px; display: none" type="button" value="Schnelles Bearbeiten" onclick="window.location.href=window.location.origin+':8000/settings.php'">
            <input class="gradient-blue-green" type="button" value="+ Gerät Hinzufügen" onclick="window.location.href='/setup'">
        </div>
    </body>
</html>
<script>

    var devices = JSON.parse('<%devices%>');
        
    console.log(devices);

    var lastRestart = '<%restart%>';
    var errorCount = '<%errors%>';
    
    document.getElementById('widgets').children[0].getElementsByClassName('widget-right')[0].innerHTML = devices.length;
    document.getElementById('widgets').children[2].getElementsByClassName('widget-right')[0].innerHTML = errorCount;
    document.getElementById('widgets').children[3].getElementsByClassName('widget-right')[0].innerHTML = lastRestart;
    
    var temp = "";
    var counter = 0;
    
    for(const i in devices)
    {
        var device = document.createElement('div');
        
        if(counter == devices.length - 1)
        {
            device.setAttribute('style', 'display: flex');
        }
        else
        {
            device.setAttribute('style', 'display: flex; margin-bottom: 20px');
            counter++;
        }

        if(temp != devices[i].type)
        {
            var title = document.createElement('h2');
            title.setAttribute('style', 'width: fit-content');
            title.innerHTML = '• ' + devices[i].type + ' •';
            
            document.getElementById('devices').appendChild(title);
        }

        var button = document.createElement('input');

        button.setAttribute('type', 'button');
        button.setAttribute('value', devices[i].name);
        button.setAttribute('sensortype', devices[i].type);
        button.setAttribute('version', devices[i].version);
        button.setAttribute('id', devices[i].ip);
        button.setAttribute('class', 'device white');
        button.setAttribute('style', 'text-align: left; padding-left: 18px; position: relative');
        
        var url = '/device?mac=' + devices[i].id;

        button.setAttribute('onclick', "window.location.href='" + url + "'");
        button.setAttribute('name', devices[i].name);

        var container = document.createElement('div');

        container.setAttribute('style', 'display: block; width: 100%');

        container.appendChild(button);
        device.appendChild(container);

        document.getElementById('devices').appendChild(device);
        
        temp = devices[i].type;
    }

</script>
<script>

    var devices = document.getElementsByClassName('device');
    var restartCounter;

    function restartAll(btn)
    {
        if(document.getElementById('restarting-all') == null && document.getElementById('restart-result-all') == null)
        {
            restartCounter = [0, 0];
        
            var overlay = document.createElement('input');

            overlay.setAttribute('type', 'button');
            overlay.setAttribute('id', 'restarting-all');
            overlay.setAttribute('style', 'z-index: 1');
            overlay.setAttribute('value', 'Neustart ..');
            overlay.setAttribute('class', 'overlay gradient-blue loading-loop');

            document.getElementById('restart-all').parentElement.insertBefore(overlay, document.getElementById('restart-all'));

            setTimeout(function()
            {
                document.getElementById('restart-all').style.opacity = 0;
                overlay.style.opacity = 1;
            }, 10);

            for(var i = 0; i < devices.length; i++)
            {
                fetchURL('http://' + devices[i].getAttribute('id') + '/restart', 3000).then(function(res) {

                    restartCounter[res != null ? 0 : 1]++;

                    if(restartCounter[0] + restartCounter[1] >= devices.length)
                    {
                        var rOverlay = document.createElement('input');

                        rOverlay.setAttribute('type', 'button');
                        rOverlay.setAttribute('id', 'restart-result-all');
                        rOverlay.setAttribute('style', 'z-index: 2');
                        rOverlay.setAttribute('value', '(' + restartCounter[0] + '/' + devices.length + ') Geräte Neugestartet!');
                        rOverlay.setAttribute('class', 'overlay gradient-green');

                        document.getElementById('restart-all').parentElement.insertBefore(rOverlay, document.getElementById('restart-all'));

                        setTimeout(function()
                        {
                            overlay.style.opacity = 0;
                            rOverlay.style.opacity = 1;
                        }, 10);

                        setTimeout(function()
                        {
                            rOverlay.style.opacity = 0;
                            document.getElementById('restart-all').style.opacity = 1;
                        }, 5000);

                        setTimeout(function()
                        {
                            document.getElementById('restart-all').parentElement.removeChild(rOverlay);
                            document.getElementById('restart-all').parentElement.removeChild(overlay);
                        }, 5300);
                    }
                });
            }
        }
    }

</script>
<script>
    
    var updatingDevices = [];
    var updateCounter = [0, 0];
    
    function checkUpdate(ip, name, version)
    {
        fetchURL('http://' + ip + '/version', 3000).then(function(res) {

            if(res != null)
            {  
                if(res != version)
                {
                    if(document.getElementById(ip + '-update-result') == null)
                    {
                        var overlay = document.createElement('input');

                        overlay.setAttribute('type', 'button');
                        overlay.setAttribute('id', ip + '-update-result');
                        overlay.setAttribute('style', 'z-index: 3; text-align: left');
                        overlay.setAttribute('value', 'Update Erfolgreich!');
                        overlay.setAttribute('class', 'overlay gradient-green');

                        document.getElementById(ip).parentElement.insertBefore(overlay, document.getElementById(ip));

                        setTimeout(function()
                        {
                            overlay.style.opacity = 1;
                            document.getElementById(ip).style.opacity = 0;
                        }, 10);
                    }
                }
                else
                {
                    if(document.getElementById(ip + '-update-result') == null)
                    {
                        var overlay = document.createElement('input');

                        overlay.setAttribute('type', 'button');
                        overlay.setAttribute('id', ip + '-update-result');
                        overlay.setAttribute('style', 'z-index: 3; text-align: left');
                        overlay.setAttribute('value', 'Update Fehlgeschlagen!');
                        overlay.setAttribute('class', 'overlay gradient-red');

                        document.getElementById(ip).parentElement.insertBefore(overlay, document.getElementById(ip));

                        setTimeout(function()
                        {
                            overlay.style.opacity = 1;
                            document.getElementById(ip).style.opacity = 0;
                        }, 10);
                    }
                }

                setTimeout(function()
                {
                    if(document.getElementById(ip + '-updating') != null)
                    {
                        document.getElementById(ip).parentElement.removeChild(document.getElementById(ip + '-updating'));
                    }
                }, 300);

                setTimeout(function()
                {
                    if(document.getElementById(ip + '-update-result') != null)
                    {
                        document.getElementById(ip + '-update-result').style.opacity = 0;
                        document.getElementById(ip).parentElement.parentElement.getElementsByClassName('update')[0].style.opacity = 0;
                        document.getElementById(ip).style.opacity = 1;

                        setTimeout(function()
                        {
                            document.getElementById(ip).parentElement.parentElement.removeChild(document.getElementById(ip).parentElement.parentElement.getElementsByClassName('update')[0]);
                            document.getElementById(ip).parentElement.removeChild(document.getElementById(ip + '-update-result'));
                        }, 300);
                    }

                    updatingDevices.splice(updatingDevices.indexOf(ip), 1);
                }, 5000);
            }
            
            setTimeout(function()
            {
                pingESP(document.getElementById(ip));
            }, 10000);
        });
    }
        
    function pingESP(device)
    {
        if(updatingDevices.includes(device.getAttribute('id')))
        {
            var version = device.getAttribute('version');
            var ip = device.getAttribute('id');
            var name = device.getAttribute('name');

            checkUpdate(ip, name, version);
        }
        else
        {
            fetchURL('http://' + device.getAttribute('id') + '/', 10000).then(function(res) {

                if(res != null)
                {  
                    if(document.getElementById(device.getAttribute('id') + '-offline') != null)
                    {
                        document.getElementById(device.getAttribute('id') + '-offline').style.opacity = 0;
                        document.getElementById(device.getAttribute('id')).style.opacity = 1;

                        setTimeout(function()
                        {
                            device.parentElement.removeChild(document.getElementById(device.getAttribute('id') + '-offline'));
                        }, 300);
                    }
                }
                else
                {  
                    if(document.getElementById(device.getAttribute('id') + '-offline') == null)
                    {
                        var overlay = document.createElement('input');

                        overlay.setAttribute('type', 'button');
                        overlay.setAttribute('id', device.getAttribute('id') + '-offline');
                        overlay.setAttribute('style', 'z-index: 1; text-align: left');
                        overlay.setAttribute('value', document.getElementById(device.getAttribute('id')).getAttribute('name') + ' ( OFFLINE )');
                        overlay.setAttribute('onclick', device.getAttribute('onclick'));
                        overlay.setAttribute('class', 'overlay gradient-red');

                        document.getElementById(device.getAttribute('id')).parentElement.insertBefore(overlay, document.getElementById(device.getAttribute('id')));

                        setTimeout(function()
                        {
                            overlay.style.opacity = 1;
                            document.getElementById(device.getAttribute('id')).style.opacity = 0;
                        }, 10);
                    }
                }  
                
                setTimeout(function()
                {
                    pingESP(device);
                }, 10000);
            });
        }
    }
    
    setTimeout(function()
    {
        for(var i = 0; i < devices.length; i++)
        {
            pingESP(devices[i]);
        }
    }, 500);

</script>
<script defer>
    
    var updateCount = 0;
    
    async function checkUpdates(device)
    {
        return new Promise(resolve => {
            
            fetchURL('http://syntex.sytes.net/smarthome/check-version?device=' + device.getAttribute('sensortype'), 10000).then(function(res) {

                if(res != null)
                {  
                    console.log(res);

                    if(versionCount(res) > versionCount(device.getAttribute('version')))
                    {
                        var update = document.createElement('input');

                        update.setAttribute('type', 'button');
                        update.setAttribute('value', 'v' + res);
                        update.setAttribute('style', 'max-width: 175px; margin: 0; margin-left: 20px;');
                        update.setAttribute('ip', device.getAttribute('id'));
                        update.setAttribute('onclick', 'updateDevice("' + device.getAttribute('id') + '")');
                        update.setAttribute('class', 'update');

                        device.parentElement.parentElement.appendChild(update);

                        updateCount++;
                    }

                    resolve(true);
                }
                else
                {  
                    resolve(false);
                } 
            });
        });
    }
    
    var count = 0;

    setTimeout(function()
    {
        for(var i = 0; i < devices.length; i++)
        {
            checkUpdates(devices[i]).then(function(res) {

                count++;

                if(count == devices.length)
                {
                    document.getElementById('widgets').children[1].getElementsByClassName('widget-right')[0].innerHTML = updateCount;

                    if(updateCount > 0)
                    {            
                        var update = document.createElement('input');

                        update.setAttribute('type', 'button');
                        update.setAttribute('id', 'update-all');

                        if(updateCount == 1)
                        {
                            update.setAttribute('value', 'Update installieren');
                        }
                        else
                        {
                            update.setAttribute('value', 'Alle Updates installieren');
                        }
                        
                        update.setAttribute('onclick', 'installAllUpdates();');

                        document.getElementsByClassName('main')[0].insertBefore(update, document.getElementById('devices'));
                    }
                }
            });
        }
    }, 500);
    
    async function updateDevice(ip)
    {
        return new Promise(resolve => {

            if(!updatingDevices.includes(ip))
            {
                fetchURL('http://' + ip + '/update', 60000).then(function(res) {

                    if(res != null)
                    {  
                        console.log(res);
                        
                        if(res == 'Success')
                        {
                            updatingDevices.push(ip);

                            if(document.getElementById(ip + '-updating') == null)
                            {
                                var overlay = document.createElement('input');

                                overlay.setAttribute('type', 'button');
                                overlay.setAttribute('id', ip + '-updating');
                                overlay.setAttribute('style', 'z-index: 2; text-align: left');
                                overlay.setAttribute('value', 'Update wird installiert ..');
                                overlay.setAttribute('class', 'overlay gradient-purple loading-loop');

                                document.getElementById(ip).parentElement.insertBefore(overlay, document.getElementById(ip));

                                setTimeout(function()
                                {
                                    overlay.style.opacity = 1;
                                    document.getElementById(ip).style.opacity = 0;
                                }, 10);
                            }
                        }
                    }

                    resolve(res == 'Success' ? true : false);
                });
            }
            else
            {
                resolve(false);
            }
        });
    }

    async function installAllUpdatesOld()
    {
        /*
        if(document.getElementById('updating-all') == null && document.getElementById('update-result-all') == null)
        {
            var devices = document.getElementsByClassName('update');

            updateCounter = [0, 0];

            var overlay = document.createElement('input');

            overlay.setAttribute('type', 'button');
            overlay.setAttribute('id', 'updating-all');
            overlay.setAttribute('style', 'z-index: 1');
            overlay.setAttribute('value', 'Updates werden installiert ..');
            overlay.setAttribute('class', 'overlay gradient-purple loading-loop');

            document.getElementById('update-all').parentElement.insertBefore(overlay, document.getElementById('update-all'));

            setTimeout(function()
            {
                document.getElementById('update-all').style.opacity = 0;
                overlay.style.opacity = 1;
            }, 10);

            for(var i = 0; i < devices.length; i++)
            {
                var ip = devices[i].getAttribute('ip');
                var name = devices[i].getAttribute('name');
                var version = devices[i].getAttribute('version');

                if(await updateDevice(ip) == false)
                {
                    updateCounter[1]++;
                    console.log("Error Offline - " + updateCounter[1]);
                }
                else
                {
                    if(await checkUpdate(ip, name, version))
                    {
                        updateCounter[0]++;
                        console.log("Success Update - " + updateCounter[0]);
                    }
                    else
                    {
                        updateCounter[1]++;
                        console.log("Error Update - " + updateCounter[1]);
                    }
                }
            }
            
            console.log(devices.length);

            //while(updateCounter[0] + updateCounter[1] < devices.length)
            //{}

            console.log("Finished");

            var rOverlay = document.createElement('input');

            rOverlay.setAttribute('type', 'button');
            rOverlay.setAttribute('id', 'update-result-all');
            rOverlay.setAttribute('style', 'z-index: 2');
            rOverlay.setAttribute('value', '(' + updateCounter[0] + '/' + devices.length + ') Geräte Aktualisiert!');
            rOverlay.setAttribute('class', 'overlay gradient-green');

            document.getElementById('update-all').parentElement.insertBefore(rOverlay, document.getElementById('update-all'));

            setTimeout(function()
            {
                overlay.style.opacity = 0;
                rOverlay.style.opacity = 1;
            }, 10);

            setTimeout(function()
            {
                rOverlay.style.opacity = 0;
                document.getElementById('update-all').style.opacity = 1;
            }, 5000);

            setTimeout(function()
            {
                document.getElementById('update-all').parentElement.removeChild(rOverlay);
                document.getElementById('update-all').parentElement.removeChild(overlay);
            }, 5300);
        }
        */
    }

    function installAllUpdates()
    {
        var devices = document.getElementsByClassName('update');

        updateCounter = [0, 0];

        var pendingOverlay = createPendingOverlay('updating-all', 'Updates werden installiert ..');

        pendingOverlay.setAttribute('class', 'overlay gradient-purple loading-loop');

        document.getElementById('update-all').parentElement.insertBefore(pendingOverlay, document.getElementById('update-all'));

        setTimeout(function()
        {
            document.getElementById('update-all').style.opacity = 0;
            pendingOverlay.style.opacity = 1;
        }, 10);

        for(var i = 0; i < devices.length; i++)
        {
            updateDeviceNew(devices[i]).then(function(res) {

                updateCounter[res ? 0 : 1]++;

                if(updateCounter[0] + updateCounter[1] >= devices.length)
                {
                    var responseOverlay = createSuccessOverlay('update-result-all', '(' + updateCounter[0] + '/' + devices.length + ') Geräte Aktualisiert!');

                    if(updateCounter[0] == 0)
                    {
                        responseOverlay.setAttribute('class', 'overlay gradient-red');
                    }
                    
                    document.getElementById('update-all').parentElement.insertBefore(responseOverlay, document.getElementById('update-all'));
                
                    setTimeout(function()
                    {
                        pendingOverlay.style.opacity = 0;
                        responseOverlay.style.opacity = 1;
                    }, 10);

                    setTimeout(function()
                    {
                        responseOverlay.style.opacity = 0;
                        document.getElementById('update-all').style.opacity = 1;
                    }, 5000);

                    setTimeout(function()
                    {
                        document.getElementById('update-all').parentElement.removeChild(pendingOverlay);
                        document.getElementById('update-all').parentElement.removeChild(responseOverlay);
                    }, 5300);
                }
            });
        }
    }

    function checkUpdateNew(ip, version)
    {
        return new Promise(async function(resolve) {

            fetchURL('http://' + ip + '/version', 3000).then(function(res) {

                if(res != null && res == version)
                {  
                    resolve(true);
                }
                else
                {
                    resolve(false);
                }
            });
        });
    }

    function updateDeviceNew(device)
    {
        var pendingOverlay = createPendingOverlay(device.getAttribute('ip') + '-updating', 'Update wird installiert ..');

        pendingOverlay.setAttribute('style', 'z-index: 2; text-align: left');
        pendingOverlay.setAttribute('class', 'overlay gradient-purple loading-loop');

        document.getElementById(device.getAttribute('ip')).parentElement.insertBefore(pendingOverlay, document.getElementById(device.getAttribute('ip')));

        setTimeout(function()
        {
            document.getElementById(device.getAttribute('ip')).style.opacity = 0;
            pendingOverlay.style.opacity = 1;
        }, 10);

        return new Promise(async function(resolve) {

            var res = await fetchURL('http://' + device.getAttribute('ip') + '/update', 10000);
            var response = false;

            if(res != null && res == 'Success')
            {
                await newTimeout(2000);

                if(await checkUpdateNew(device.getAttribute('ip'), device.getAttribute('value').split('v')[1]))
                {
                    response = true;
                }
            }

            setTimeout(function()
            {
                overlay.style.opacity = 1;
                document.getElementById(device.getAttribute('ip')).style.opacity = 0;
            }, 10);

            if(response)
            {
                var responseOverlay = createSuccessOverlay(device.getAttribute('ip') + '-update-result', 'Update Erfolgreich!');
            }
            else
            {
                var responseOverlay = createErrorOverlay(device.getAttribute('ip') + '-update-result', 'Update Fehlgeschlagen!');
            }

            responseOverlay.setAttribute('style', 'z-index: 3; text-align: left');

            document.getElementById(device.getAttribute('ip')).parentElement.insertBefore(responseOverlay, document.getElementById(device.getAttribute('ip')));
                
            setTimeout(function()
            {
                pendingOverlay.style.opacity = 0;
                responseOverlay.style.opacity = 1;
            }, 10);

            setTimeout(function()
            {
                responseOverlay.style.opacity = 0;
                device.style.opacity = 1;
            }, 5000);

            setTimeout(function()
            {
                device.parentElement.removeChild(pendingOverlay);
                device.parentElement.removeChild(responseOverlay);
            }, 5300);

            resolve(response);
        });
    }

    function newTimeout(ms)
    {
        return new Promise(resolve => setTimeout(resolve, ms));
    }

</script>