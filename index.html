<html>
    <title>Dashboard: Geräte</title>
    <body>
        <h1 style="margin-bottom: 0; margin-top: 32px">Dashboard</h1>
        <div class="main" style="margin-top: 10px; margin-bottom: 100px">
            <p style="margin-bottom: 100px; margin-top: 20px">Geräte</p>
            <div class="main" style="margin-top: 10px; margin-bottom: 20px; display: flex">
                <input class="white" type="button" value="Geräte" onclick="window.location.href='/'" style="margin-right: 20px" disabled>
                <input class="white" type="button" value="Bridge" onclick="window.location.href='/bridge'">
            </div>
            <div class="main" style="margin-top: 10px; margin-bottom: 100px; display: flex">
                <input class="white" type="button" value="Automation" onclick="window.location.href='/automations'" style="margin-right: 20px">
                <input class="white" type="button" value="Log" onclick="window.location.href='/log'">
            </div>
            <div id="widgets" style="display: grid; grid-template-columns: calc(25% - 15px) calc(25% - 15px) calc(25% - 15px) calc(25% - 15px); grid-gap: 20px">
                <div class="widget">
                    <button class="widget-left" disabled>Geräte</button>
                    <button class="widget-right gradient-blue" disabled>0</button>
                </div>
                <div class="widget">
                    <button class="widget-left" disabled>Updates</button>
                    <button class="widget-right gradient-purple" disabled>-</button>
                </div>
                <div class="widget">
                    <button class="widget-left" disabled>Offline</button>
                    <button class="widget-right gradient-red" disabled>0</button>
                </div>
                <div class="widget">
                    <button class="widget-left" disabled>Online</button>
                    <button class="widget-right gradient-green" disabled>-</button>
                </div>
            </div>
            <div style="margin: 20px 0; display: grid; grid-template-columns: calc(50% - 10px) calc(50% - 10px); grid-gap: 20px">
                <div>
                    <button class="loading-loop" id="activate-all" onclick="switchAll(this)">Aktiv: Laden ..</button>
                </div>
                <div>
                    <button id="restart-all" onclick="restartAll(this)">Alle Neustarten</button>
                </div>
            </div>
            <div id="devices" style="margin-top: 100px"></div>
        </div>
        <div class="bottom" style="margin: 0 auto; width: 100%; max-width: 400px">
            <input style="margin-bottom: 20px; display: none" type="button" value="Schnelles Bearbeiten" onclick="window.location.href=window.location.protocol +  '//' + window.location.hostname+':8000/settings.php'">
            <input style="margin-bottom: 20px" type="button" value="Schalter Erstellen" onclick="window.location.href='/create'">
            <input class="gradient-blue-green" type="button" value="+ Gerät Hinzufügen" onclick="window.location.href='/setup'">
        </div>
    </body>
</html>
<script>

    var gridView = true;

    var devices = JSON.parse('<%devices%>');
    var offline = [], restarting = [], updating = [];
        
    console.log(devices);

    var temp = "";
    var updateCount = 0;
    var checkedUpdates = 0;
    var activationCounter = { active : 0, disabled : 0 };
    
    document.getElementById('widgets').children[0].getElementsByClassName('widget-right')[0].innerHTML = devices.length - 1;
    document.getElementById('widgets').children[3].getElementsByClassName('widget-right')[0].innerHTML = '<%restart%>';

    if(gridView)
    {
        document.getElementById('devices').className = 'grid-view';
    }
    
    for(const i in devices)
    {
        if(devices[i].id != 'Bridge')
        {
            var device = document.createElement('div');

            device.setAttribute('style', 'display: flex');

            if(devices[i].ip != undefined && devices[i].active != undefined)
            {
                activationCounter[devices[i].active == 1 ? 'active' : 'disabled' ]++;
            }

            if(temp != devices[i].type)
            {
                var title = document.createElement('h2');

                title.setAttribute('style', 'width: fit-content');
                title.innerHTML = '• ' + devices[i].type + ' •';
                
                document.getElementById('devices').appendChild(title);

                var typeContainer = document.createElement('div');

                typeContainer.setAttribute('id', devices[i].type);
                typeContainer.setAttribute('style', 'display: grid; grid-gap: 20px');
                typeContainer.setAttribute('class', 'container');

                /*
                if(numOfType == 1)
                {
                    typeContainer.style.gridTemplateColumns = '100%';
                }
                */
                document.getElementById('devices').appendChild(typeContainer);
            }

            var button = document.createElement('button');

            button.setAttribute('sensortype', devices[i].type);
            button.setAttribute('version', devices[i].version);
            button.setAttribute('id', devices[i].ip);
            button.setAttribute('class', 'device white');
            button.setAttribute('style', 'text-align: left; padding-left: 18px; position: relative');

            button.innerHTML = '<img src="/img/accessory/' + devices[i].type + '.png" style="position: absolute; top: 15px; width: 30%">';
            button.innerHTML += '<div style="position: absolute; bottom: 15px; width: calc(100% - 36px)">' + devices[i].name + '</div>';

            var url = '/device?mac=' + devices[i].id;

            button.setAttribute('onclick', "window.location.href='" + url + "'");
            button.setAttribute('name', devices[i].name);

            var container = document.createElement('div');

            container.setAttribute('style', 'display: block; width: 100%');

            console.log(device, container, button);

            container.appendChild(button);
            device.appendChild(container);

            console.log(devices[i].type, device);

            document.getElementById(devices[i].type).appendChild(device);
            
            temp = devices[i].type;
        }
    }

    if(activationCounter['disabled'] == 0 && activationCounter['active'] >= 0)
    {
        document.getElementById('activate-all').setAttribute('switch', 1);
        document.getElementById('activate-all').setAttribute('class', 'gradient-green');
        document.getElementById('activate-all').innerHTML = 'Aktiv: Alle An';
    }
    else if(activationCounter['disabled'] >= 0 && activationCounter['active'] == 0)
    {
        document.getElementById('activate-all').setAttribute('switch', 0);
        document.getElementById('activate-all').setAttribute('class', 'gradient-red');
        document.getElementById('activate-all').innerHTML = 'Aktiv: Alle Aus';
    }
    else
    {
        document.getElementById('activate-all').setAttribute('switch', 0);
        document.getElementById('activate-all').innerHTML = 'Aktiv: Unterschiedlich';
    }

</script>
<script>

    async function restartAll(btn)
    {
        if(document.getElementById('restart-all-pending') == null && document.getElementById('restart-all-result') == null)
        {
            var restartCounter = { success : 0, error : 0 };
        
            showOverlay(btn, createPendingOverlay('restart-all-pending', 'Neustart ..'));

            for(var i = 0; i < devices.length; i++)
            {
                if(devices[i].ip != undefined && !offline.includes(devices[i].ip))
                {
                    complexFetch('http://' + devices[i].ip + '/restart', 20000, 1, {}, false).then(async function(result) {

                        restartCounter[result != null ? 'success' : 'error']++;

                        if(restartCounter['success'] + restartCounter['error'] >= devices.length - offline.length)
                        {
                            await newTimeout(1000);

                            showOverlay(btn, createSuccessOverlay('restart-all-result', restartCounter['success'] + ' / ' + (devices.length - offline.length) + ' Geräten Neugestartet!'));
                            
                            removeOverlaysDelay(btn, 4000, true);
                        }
                    });
                }
                else if(!offline.includes(devices[i].ip))
                {
                    restartCounter['success']++;
                }
            }
        }
    }

</script>
<script>

    var deviceElements = document.getElementsByClassName('device');
    
    async function pingESP(device)
    {
        var ip = device.getAttribute('id');

        if(ip != 'undefined' && !updating.includes(ip))
        {
            if(await fetchURL('http://' + ip + '/', 20000) != null)
            {  
                setOnline(device);
            }
            else if(!updating.includes(ip))
            {  
                setOffline(device);
            }

            await newTimeout(10000);
            
            pingESP(device);
        }
    }
    
    function setOffline(device)
    {
        var ip = device.getAttribute('id');

        if(!offline.includes(ip))
        {
            var responseOverlay = createErrorOverlay(ip + '-offline', document.getElementById(ip).getAttribute('name') + ' | OFFLINE');

            responseOverlay.setAttribute('style', 'z-index: 1; text-align: left');
            responseOverlay.setAttribute('onclick', device.getAttribute('onclick'));

            device.parentElement.insertBefore(responseOverlay, device);

            setTimeout(function()
            {
                responseOverlay.style.opacity = 1;
            }, 10);

            document.getElementById('widgets').children[2].getElementsByClassName('widget-right')[0].innerHTML++;

            offline.push(ip);
        }
    }

    function setOnline(device)
    {
        var ip = device.getAttribute('id');

        if(offline.includes(ip))
        {
            offline.splice(offline.indexOf(ip), 1);

            document.getElementById(ip + '-offline').style.opacity = 0;
            device.style.opacity = 1;

            setTimeout(function()
            {
                device.parentElement.removeChild(document.getElementById(ip + '-offline'));
            }, 300);

            document.getElementById('widgets').children[2].getElementsByClassName('widget-right')[0].innerHTML--;
        }
    }

    head.load('/js/query.js', function()
    {
        for(var i = 0; i < deviceElements.length; i++)
        {
            pingESP(deviceElements[i]);
            checkUpdates(deviceElements[i]);
        }
    });

</script>
<script defer>
    
    async function checkUpdates(device)
    {
        var newestVersion = await complexFetch('http://syntex.sytes.net/smarthome/check-version?device=' + device.getAttribute('sensortype'), 10000, 3, {}, false);

        if(newestVersion != null && versionCount(newestVersion) > versionCount(device.getAttribute('version')))
        {  
            var update = document.createElement('input');

            update.setAttribute('type', 'button');
            update.setAttribute('value', 'v' + newestVersion);
            update.setAttribute('style', 'max-width: 175px; margin: 0; margin-left: 20px;');
            update.setAttribute('ip', device.getAttribute('id'));
            update.setAttribute('onclick', 'updateDevice(this)');
            update.setAttribute('class', 'update');

            device.parentElement.parentElement.appendChild(update);

            if(document.getElementById('update-all') == null)
            {
                var update = document.createElement('input');

                update.setAttribute('type', 'button');
                update.setAttribute('id', 'update-all');
                update.setAttribute('value', 'Updates Installieren');
                update.setAttribute('onclick', 'installAllUpdates(this)');

                document.getElementsByClassName('main')[0].insertBefore(update, document.getElementById('devices'));
            }

            updateCount++;
        }

        checkedUpdates++;

        if(checkedUpdates == deviceElements.length)
        {
            document.getElementById('widgets').children[1].getElementsByClassName('widget-right')[0].innerHTML = updateCount;
        }
    }
    
    function installAllUpdates(btn)
    {
        var updates = document.getElementsByClassName('update');
        var updateCounter = { success : 0, error : 0 };

        showOverlay(btn, createOverlay(1, 'updating-all', 'Updates werden Installiert ..', 'purple'));

        for(var i = 0; i < updates.length; i++)
        {
            if(!offline.includes(updates[i].getAttribute('ip')))
            {
                updateDevice(updates[i]).then(async function(update) {

                    updateCounter[update == true ? 'success' : 'error']++;

                    if(updateCounter['success'] + updateCounter['error'] >= updateCount)
                    {
                        showOverlay(btn, createOverlay(2, 'update-result-all', updateCounter['success'] + ' / ' + updateCount + ' Geräten Aktualisiert!', updateCounter['success'] == 0 ? 'red' : 'green'));

                        await newTimeout(4000);

                        removeOverlays(btn, updateCounter['error'] == 0 ? false : true);

                        updateCount -= updateCounter['success'];
                    }
                });
            }
            else
            {
                updateCounter['error']++;
            }
        }
    }

    function updateDevice(btn)
    {
        return new Promise(async function(resolve) {

            var response = false;

            if(!updating.includes(btn.getAttribute('ip')))
            {
                updating.push(btn.getAttribute('ip'));

                var device = document.getElementById(btn.getAttribute('ip'));

                var overlays = {
                    root : device,
                    id : btn.getAttribute('ip') + '-update',
                    pending : { value : 'Bitte Warten ..', z : 2, style : 'text-align: left' },
                    success : { value : 'Update wird Installiert ..', color : 'purple', remove : false, z : 3, style : 'text-align: left' },
                    executeError : { value : 'Update Fehlgeschlagen!', z : 3, style : 'text-align: left' },
                    connectionError : { value : 'Keine Verbindung zum Gerät!', z : 3, style : 'text-align: left' }
                };

                var update = await complexFetch('http://' + btn.getAttribute('ip') + '/update', 10000, 3, overlays, false);

                if(update == null)
                {
                    await newTimeout(4000);

                    setOffline(device);
                }
                else if(update == 'Success')
                {
                    setOnline(device);

                    await newTimeout(3000);

                    var overlays = {
                        root : device,
                        id : btn.getAttribute('ip') + '-update-installation',
                        connectionError : { value : 'Keine Verbindung zum Gerät!', z : 4, style : 'text-align: left' }
                    };

                    var update = await complexFetch('http://' + btn.getAttribute('ip') + '/version', 3000, 20, overlays, false);

                    if(update == btn.getAttribute('value').split('v')[1])
                    {
                        var responseOverlay = createOverlay(4, btn.getAttribute('ip') + '-update-installation-result', 'Update Erfolgreich!', 'green');

                        document.getElementById('widgets').children[1].getElementsByClassName('widget-right')[0].innerHTML--;

                        response = true;
                    }
                    else if(update != null)
                    {
                        var responseOverlay = createOverlay(4, btn.getAttribute('ip') + '-update-installation-result', 'Update Fehlgeschlagen!', 'red');
                    }

                    responseOverlay.setAttribute('style', 'z-index: 4; text-align: left');

                    showOverlay(device, responseOverlay);

                    await newTimeout(4000);

                    removeOverlays(device, true);

                    if(update == null)
                    {
                        await newTimeout(300);

                        setOffline(device);
                    }
                }

                if(response == true)
                {
                    btn.style.opacity = 0;

                    if(updateCount == 0)
                    {
                        document.getElementById('update-all').style.opacity = 0;
                    }
                }

                await newTimeout(300);

                if(response == true)
                {
                    btn.style.setProperty('width', '0', 'important');
                    btn.style.paddingLeft = 0;
                    btn.style.paddingRight = 0;
                    btn.style.marginLeft = 0;
                    btn.style.marginRight = 0;
                    btn.style.borderLeftWidth = 0;
                    btn.style.borderRightWidth = 0;

                    if(updateCount == 0)
                    {
                        document.getElementById('update-all').style.setProperty('height', '0', 'important');
                        document.getElementById('update-all').style.paddingTop = 0;
                        document.getElementById('update-all').style.paddingBottom = 0;
                        document.getElementById('update-all').style.marginTop = 0;
                        document.getElementById('update-all').style.marginBottom = 0;
                        document.getElementById('update-all').style.borderTopWidth = 0;
                        document.getElementById('update-all').style.borderBottomWidth = 0;
                    }

                    await newTimeout(300);

                    btn.parentElement.removeChild(btn);

                    if(updateCount == 0)
                    {
                        document.getElementById('update-all').parentElement.removeChild(document.getElementById('update-all'));
                    }
                }

                updating.splice(updating.indexOf(btn.getAttribute('ip')), 1);
            }
            
            resolve(response);
        });
    }

    async function switchAll(btn)
    {
        var settings = [];

        var switchCounter = { success : 0, error : 0 };

        showOverlay(btn, createPendingOverlay('', 'Hochladen ..'));

        for(var i = 0; i < deviceElements.length; i++)
        {
            var settings = {
                mac: deviceElements[i].getAttribute('onclick').split('mac=')[1].split("'")[0],
                active: btn.getAttribute('switch') == 1 ? 0 : 1
            };

            if(deviceElements[i].getAttribute('id') != 'undefined' && await complexFetchPost('/serverside/save-config', 10000, JSON.stringify(settings), 3, {}, false) == 'Success' && !offline.includes(deviceElements[i].getAttribute('id')))
            {
                complexFetch('http://' + deviceElements[i].getAttribute('id') + '/refresh', 10000, 2, {}, false).then(function (refresh) {

                    switchCounter[refresh == 'Success' ? 'success' : 'error']++;

                    if(switchCounter['success'] + switchCounter['error'] >= deviceElements.length)
                    {
                        btn.setAttribute('switch', btn.getAttribute('switch') == 1 ? 0 : 1);
                        btn.setAttribute('class', btn.getAttribute('switch') == 1 ? 'gradient-green' : 'gradient-red');
                        btn.innerHTML = 'Aktiv: Alle ' + (btn.getAttribute('switch') == 1 ? 'An' : 'Aus');

                        removeOverlays(btn, true);
                    }
                });
            }
            else
            {
                switchCounter['error']++;
            }
        }
    }

</script>