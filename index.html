<html>
    <title>Dashboard</title>
    <body>
        <h1 style="margin-bottom: 0;">Dashboard</h1>
        <div class="main" style="margin-top: 10px; margin-bottom: 100px; display: table">
            <p style="margin-bottom: 100px;">Laden ..</p>
            <div class="main" style="margin-top: 10px; margin-bottom: 100px; display: flex">
                <input style="margin-right: 20px;" type="button" value="Ger채te" onclick="window.location.href='http://syntex.local:1711/'" disabled>
                <input style="" type="button" value="Bridge" onclick="window.location.href='http://syntex.local/bridge.php'">
            </div>
            <div id="devices">
                <h2 style="width: fit-content">Smart Lock</h2>
                <div style="display: flex; margin-bottom: 20px">
                    <input type="button" style="text-align: left; padding-left: 15px" onclick="window.location.href='http://syntex.local/smartlock.php" value="Smart Lock">
                </div>
            </div>
        </div>
        <div style="margin: 0 auto; width: 100%; max-width: 400px">
            <input style="margin-bottom: 20px;" type="button" value="Schnelles Bearbeiten" onclick="window.location.href='http://syntex.local/settings.php'">
            <input style="" type="button" value="+ Ger채t Hinzuf체gen" onclick="window.location.href='http://syntex.local:1711/setup'">
        </div>
    </body>
</html>
<script>

    var devices = JSON.parse('<%devices%>');
        
    console.log(devices);
    
    document.getElementsByTagName('p')[0].innerHTML = devices.length + ' Ger채t(e) konfiguriert';
    
    var temp = "";
    var counter = 0;
    
    for(const i in devices)
    {
        var device = document.createElement('div');
        
        if(counter == devices.length - 1)
        {
            device.setAttribute('style', 'display: flex');
        }
        else
        {
            device.setAttribute('style', 'display: flex; margin-bottom: 20px');
            counter++;
        }

        if(temp != devices[i].type)
        {
            var title = document.createElement('h2');
            title.setAttribute('style', 'width: fit-content');
            title.innerHTML = devices[i].type;
            
            document.getElementById('devices').appendChild(title);
        }

        var button = document.createElement('input');
        button.setAttribute('type', 'button');
        button.setAttribute('value', devices[i].name);
        button.setAttribute('sensortype', devices[i].type);
        button.setAttribute('version', devices[i].version);
        button.setAttribute('id', devices[i].ip);
        button.setAttribute('class', 'device');
        button.setAttribute('style', 'text-align: left; padding-left: 15px');
        
        var url = 'http://' + devices[i].ip;
        
        if(devices[i].type != 'relais' && devices[i].type != 'switch' && devices[i].type != 'lock')
        {
            url = 'http://syntex.local/devices/' + devices[i].type + '-sensor.php?mac=' + devices[i].id;
        }
        else if(devices[i].type == 'relais' || devices[i].type == 'switch')
        {
            url = 'http://syntex.local/devices/' + devices[i].type + '.php?mac=' + devices[i].id;
        }
        
        button.setAttribute('onclick', "window.location.href='" + url + "'");
        button.setAttribute('name', devices[i].name);

        device.appendChild(button);

        document.getElementById('devices').appendChild(device);
        
        temp = devices[i].type;
    }

</script>
<script>
    
    var devices = document.getElementsByClassName('device');
    var updatingDevices = [];
    
    function checkUpdate(ip, name, version)
    {
        var client = new XMLHttpRequest();
        
        client.open('GET', 'http://' + ip + '/version');

        client.onreadystatechange = function()
        {
            if(client.readyState === 4)
            {  
                if(client.status === 200)
                {  
                    if(client.responseText != version)
                    {
                        document.getElementById(ip).style.background = 'hsl(150, 75%, 45%)';
                        document.getElementById(ip).value = 'Update Erfolgreich!';
                        document.getElementById(ip).parentElement.removeChild(document.getElementById(ip).parentElement.children[1]);
                    }
                    else
                    {
                        document.getElementById(ip).style.background = 'hsl(350, 85%, 55%)';
                        document.getElementById(ip).value = 'Update Fehlgeschlagen!';
                    }

                    setTimeout(function()
                    {
                        document.getElementById(ip).style.background = 'transparent';
                        document.getElementById(ip).value = name;
                        updatingDevices.splice(updatingDevices.indexOf(ip), 1);
                    }, 5000);

                    setTimeout(function()
                    {
                        pingESP(document.getElementById(ip));
                    }, 10000);
                } 
            }  
        }

        client.send();
    }
        
    function pingESP(device)
    {
        if(updatingDevices.includes(device.getAttribute('id')))
        {
            var version = device.getAttribute('version');
            var ip = device.getAttribute('id');
            var name = device.getAttribute('name');

            checkUpdate(ip, name, version);
        }
        else
        {
            var client = new XMLHttpRequest();
        
            client.open('GET', 'http://' + device.getAttribute('id') + '/');

            client.onreadystatechange = function()
            {
                if(client.readyState === 4)
                {  
                    if(client.status === 200)
                    {  
                        document.getElementById(device.getAttribute('id')).style.background = 'transparent';
                    
                        setTimeout(function()
                        {
                            pingESP(device);
                        }, 10000);
                    }
                    else
                    {  
                        if(document.getElementById(device.getAttribute('id')).style.background == 'transparent' || document.getElementById(device.getAttribute('id')).style.background == "")
                        {
                           document.getElementById(device.getAttribute('id')).style.background = 'hsl(350, 85%, 55%)';
                        }

                        setTimeout(function()
                        {
                            pingESP(device);
                        }, 10000);
                    }  
                }  
            }

            client.send();
        }
    }
    
    for(var i = 0; i < devices.length; i++)
    {
        pingESP(devices[i]);
    }
    
    var updateCount = 0;
    
    async function checkUpdates(device)
    {
        return new Promise(resolve => {
            
            var client = new XMLHttpRequest();
        
            client.open('GET', 'http://syntex.sytes.net/smarthome/check-version?device=' + device.getAttribute('sensortype'));

            client.onreadystatechange = function()
            {
                if(client.readyState === 4)
                {  
                    if(client.status === 200)
                    {  
                        console.log(client.responseText);

                        if(client.responseText > device.getAttribute('version'))
                        {
                            var update = document.createElement('input');

                            update.setAttribute('type', 'button');
                            update.setAttribute('value', 'v' + client.responseText);
                            update.setAttribute('style', 'max-width: 175px; margin: 0; margin-left: 20px;');
                            update.setAttribute('ip', device.getAttribute('id'));
                            update.setAttribute('onclick', 'updateDevice("' + device.getAttribute('id') + '")');
                            update.setAttribute('class', 'update');

                            device.parentElement.appendChild(update);

                            updateCount++;
                        }

                        resolve(true);
                    }
                    else
                    {  
                        resolve(false);
                    }  
                }  
            }

            client.send();
        });
    }
    
    var count = 0;

    for(var i = 0; i < devices.length; i++)
    {
        checkUpdates(devices[i]).then(function(res) {

            count++;

            if(count == devices.length - 1)
            {
                if(updateCount > 0)
                {            
                    var update = document.createElement('input');

                    update.setAttribute('type', 'button');
                    if(updateCount == 1)
                    {
                        update.setAttribute('value', updateCount + ' Update installieren!');
                    }
                    else
                    {
                        update.setAttribute('value', updateCount + ' Updates installieren!');
                    }
                            
                    
                    update.setAttribute('style', 'margin-bottom: 20px; font-size: 14px;');
                    update.setAttribute('onclick', 'installAllUpdates();');

                    document.getElementsByTagName('body')[0].children[2].insertBefore(update, document.getElementsByTagName('body')[0].children[2].children[0]);
                }
            }
        });
    }
    
    function updateDevice(ip)
    {
        if(!updatingDevices.includes(ip))
        {
            var client = new XMLHttpRequest();
        
            client.open('GET', 'http://' + ip + '/update');

            client.onreadystatechange = function()
            {
                if(client.readyState === 4)
                {  
                    if(client.status === 200)
                    {  
                        if(client.responseText == 'Das Update wird installiert ..')
                        {
                            updatingDevices.push(ip);

                            document.getElementById(ip).style.background = 'hsl(270, 85%, 55%)';
                        }
                    }
                }  
            }

            client.send();
        }
    }

    function installAllUpdates()
    {
        var devices = document.getElementsByClassName('update');

        for(var i = 0; i < devices.length; i++)
        {
            var ip = devices[i].getAttribute('ip');
            console.log(ip);
            updateDevice(ip);
        }        
        
        console.log(devices.length);
    }

</script>