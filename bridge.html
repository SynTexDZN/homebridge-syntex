<html>
    <title>Dashboard: Bridge</title>
    <body>
        <h1 style="margin-bottom: 0; margin-top: 32px">Dashboard</h1>
        <div class="main" style="margin-top: 10px; display: table">
            <p style="margin-bottom: 100px; margin-top: 16px">Bridge</p>
            <div class="main" style="margin-top: 10px; margin-bottom: 20px; display: flex">
                <input class="white" type="button" value="Geräte" onclick="window.location.href='/'" style="margin-right: 20px">
                <input class="white" type="button" value="Bridge" onclick="window.location.href='/bridge'" disabled>
            </div>
            <div class="main" style="margin-top: 10px; margin-bottom: 100px; display: flex">
                <input class="white" type="button" value="Log" onclick="window.location.href='/log'">
            </div>
            <div id="infos" style="margin-bottom: 100px">
                <p class="loading-loop"><b>IP: </b>Laden ..</p>
                <p class="loading-loop"><b>Letzter Neustart: </b>Laden ..</p>
                <h2 style="width: fit-content; margin-top: 100px">• SynTex Bridge •</h2>
                <p class="loading-loop"><b>Version: </b>Laden ..</p>
                <p class="loading-loop"><b>Neuste Version: </b>Laden ..</p>
                <h2 style="width: fit-content; margin-top: 100px">• SynTex WebHooks •</h2>
                <p class="loading-loop"><b>Version: </b>Laden ..</p>
                <p class="loading-loop"><b>Neuste Version: </b>Laden ..</p>
            </div>
            <input id="restart-btn" type="button" value="Bridge Neustarten" onclick="restartBridge()">
        </div>
    </body>
</html>
<script>

    var ip = '<%ip%>';
    var lastRestart = '<%restart%>';
    var bridgeVersion = '<%version%>';
    var webhooksVersion = '';

    document.getElementById('infos').children[0].innerHTML = '<p><b>IP: </b>' + ip + '</p>';
    document.getElementById('infos').children[1].innerHTML = '<p><b>Letzter Neustart: </b><br>' + lastRestart + '</p>';
    document.getElementById('infos').children[3].innerHTML = '<p><b>Version: </b>' + bridgeVersion + '</p>';

    setTimeout(function()
    {
        fetchURL('http://syntex.sytes.net/smarthome/check-version?device=syntex', 10000).then(function(res) {

            if(res != null)
            {
                document.getElementById('infos').children[4].innerHTML = '<p><b>Neuste Version: </b>' + res + '</p>';

                var intVersionB = versionCount(bridgeVersion);

                if(versionCount(res) > intVersionB)
                {
                    var updateBTN = document.createElement('input');

                    updateBTN.setAttribute('type', 'button');
                    updateBTN.setAttribute('value', 'Bridge Aktualisieren ( v' + res + ' )');
                    updateBTN.setAttribute('onclick', 'updateBridge()');
                    updateBTN.setAttribute('style', 'margin-top: 20px');
                    updateBTN.setAttribute('id', 'update-btn-bridge');

                    document.getElementsByClassName('main')[0].appendChild(updateBTN);  
                }
            }
            else
            {
                document.getElementById('infos').children[4].innerHTML = '<p><b>Neuste Version: </b>Fehler beim Laden</p>';
            }
        });

        fetchURL(window.location.origin + ':<%wPort%>/version', 10000).then(function(res) {

            if(res != null)
            {
                webhooksVersion = res;

                document.getElementById('infos').children[6].innerHTML = '<p><b>Version: </b>' + webhooksVersion + '</p>';

                fetchURL('http://syntex.sytes.net/smarthome/check-version?device=syntex-webhooks', 10000).then(function(res2) {

                    if(res2 != null)
                    {
                        document.getElementById('infos').children[7].innerHTML = '<p><b>Neuste Version: </b>' + res2 + '</p>';

                        var intVersionW = versionCount(webhooksVersion);

                        if(versionCount(res2) > intVersionW)
                        {
                            var updateBTN = document.createElement('input');

                            updateBTN.setAttribute('type', 'button');
                            updateBTN.setAttribute('value', 'WebHooks Aktualisieren ( v' + res2 + ' )');
                            updateBTN.setAttribute('onclick', 'updateWebhooks()');
                            updateBTN.setAttribute('style', 'margin-top: 20px');
                            updateBTN.setAttribute('id', 'update-btn-webhooks');

                            document.getElementsByClassName('main')[0].appendChild(updateBTN);  
                        }
                    }
                    else
                    {
                        document.getElementById('infos').children[7].innerHTML = '<p><b>Neuste Version: </b>Fehler beim Laden</p>';
                    }
                });
            }
            else
            {
                document.getElementById('infos').children[6].innerHTML = '<p><b>Neuste Version: </b>Fehler beim Laden</p>';
                document.getElementById('infos').children[7].innerHTML = '<p><b>Neuste Version: </b>Fehler beim Laden</p>';
            }
        });
    }, 500);

    function updateBridge()
    {
        if(document.getElementById('updating') == null && document.getElementById('update-result') == null)
        {
            var overlay = document.createElement('input');

            overlay.setAttribute('type', 'button');
            overlay.setAttribute('id', 'updating');
            overlay.setAttribute('style', 'opacity: 0; z-index: 1; letter-spacing: 3px; position: absolute; left: ' + document.getElementById('update-btn-bridge').offsetLeft + 'px; top: ' + document.getElementById('update-btn-bridge').offsetTop + 'px; width: ' + document.getElementById('update-btn-bridge').offsetWidth + 'px!important');
            overlay.setAttribute('value', 'Update Wird Installiert ..');
            overlay.setAttribute('class', 'gradient-purple loading-loop');

            document.getElementById('update-btn-bridge').parentElement.insertBefore(overlay, document.getElementById('update-btn-bridge'));

            setTimeout(function()
            {
                overlay.style.opacity = 1;
                document.getElementById('update-btn-bridge').style.opacity = 0;
            }, 10);

            fetchURL('/update', 120000).then(function(res) {

                if(res != null)
                {
                    if(res == 'Error')
                    {
                        var rOverlay = document.createElement('input');

                        rOverlay.setAttribute('type', 'button');
                        rOverlay.setAttribute('id', 'update-result');
                        rOverlay.setAttribute('style', 'opacity: 0; z-index: 1; letter-spacing: 3px; position: absolute; left: ' + document.getElementById('update-btn-bridge').offsetLeft + 'px; top: ' + document.getElementById('update-btn-bridge').offsetTop + 'px; width: ' + document.getElementById('update-btn-bridge').offsetWidth + 'px!important');
                        rOverlay.setAttribute('value', 'Update Fehlgeschlagen!');
                        rOverlay.setAttribute('class', 'gradient-red');

                        document.getElementById('update-btn-bridge').parentElement.insertBefore(rOverlay, document.getElementById('update-btn-bridge'));

                        setTimeout(function()
                        {
                            rOverlay.style.opacity = 1;
                            overlay.style.opacity = 0;
                        }, 10);
                        
                        setTimeout(function()
                        {
                            rOverlay.style.opacity = 0;
                            document.getElementById('update-btn-bridge').style.opacity = 1;
                        }, 5000);

                        setTimeout(function()
                        {
                            document.getElementById('update-btn-bridge').parentElement.removeChild(rOverlay);
                            document.getElementById('update-btn-bridge').parentElement.removeChild(overlay);
                        }, 5300);
                    }
                    else if(res == 'Success')
                    {
                        var rOverlay = document.createElement('input');

                        rOverlay.setAttribute('type', 'button');
                        rOverlay.setAttribute('id', 'update-result');
                        rOverlay.setAttribute('style', 'opacity: 0; z-index: 1; letter-spacing: 3px; position: absolute; left: ' + document.getElementById('update-btn-bridge').offsetLeft + 'px; top: ' + document.getElementById('update-btn-bridge').offsetTop + 'px; width: ' + document.getElementById('update-btn-bridge').offsetWidth + 'px!important');
                        rOverlay.setAttribute('value', 'Update Erfolgreich!');
                        rOverlay.setAttribute('class', 'gradient-green');

                        document.getElementById('update-btn-bridge').parentElement.insertBefore(rOverlay, document.getElementById('update-btn-bridge'));

                        setTimeout(function()
                        {
                            rOverlay.style.opacity = 1;
                            overlay.style.opacity = 0;
                        }, 10);
                        
                        setTimeout(function()
                        {
                            rOverlay.style.opacity = 0;
                        }, 5000);

                        setTimeout(function()
                        {
                            document.getElementById('update-btn-bridge').parentElement.removeChild(rOverlay);
                            document.getElementById('update-btn-bridge').parentElement.removeChild(overlay);
                            document.getElementById('update-btn-bridge').parentElement.removeChild(document.getElementById('update-btn-bridge'));
                        }, 5300);

                        setTimeout(function()
                        {
                            location.reload();
                        }, 5600);
                    }
                }
                else
                {
                    var rOverlay = document.createElement('input');

                    rOverlay.setAttribute('type', 'button');
                    rOverlay.setAttribute('id', 'update-result');
                    rOverlay.setAttribute('style', 'opacity: 0; z-index: 1; letter-spacing: 3px; position: absolute; left: ' + document.getElementById('update-btn-bridge').offsetLeft + 'px; top: ' + document.getElementById('update-btn-bridge').offsetTop + 'px; width: ' + document.getElementById('update-btn-bridge').offsetWidth + 'px!important');
                    rOverlay.setAttribute('value', 'Keine Verbindung zum Gerät!');
                    rOverlay.setAttribute('class', 'gradient-red');

                    document.getElementById('update-btn-bridge').parentElement.insertBefore(rOverlay, document.getElementById('update-btn-bridge'));

                    setTimeout(function()
                    {
                        rOverlay.style.opacity = 1;
                        overlay.style.opacity = 0;
                    }, 10);
                
                    setTimeout(function()
                    {
                        rOverlay.style.opacity = 0;
                        document.getElementById('update-btn-bridge').style.opacity = 1;
                    }, 5000);

                    setTimeout(function()
                    {
                        document.getElementById('update-btn-bridge').parentElement.removeChild(rOverlay);
                        document.getElementById('update-btn-bridge').parentElement.removeChild(overlay);
                    }, 5300);
                }
            });
        }
    }

    function updateWebhooks()
    {
        if(document.getElementById('updating') == null && document.getElementById('update-result') == null)
        {
            var overlay = document.createElement('input');

            overlay.setAttribute('type', 'button');
            overlay.setAttribute('id', 'updating');
            overlay.setAttribute('style', 'opacity: 0; z-index: 1; letter-spacing: 3px; position: absolute; left: ' + document.getElementById('update-btn-webhooks').offsetLeft + 'px; top: ' + document.getElementById('update-btn-webhooks').offsetTop + 'px; width: ' + document.getElementById('update-btn-webhooks').offsetWidth + 'px!important');
            overlay.setAttribute('value', 'Update Wird Installiert ..');
            overlay.setAttribute('class', 'gradient-purple loading-loop');

            document.getElementById('update-btn-webhooks').parentElement.insertBefore(overlay, document.getElementById('update-btn-webhooks'));

            setTimeout(function()
            {
                overlay.style.opacity = 1;
                document.getElementById('update-btn-webhooks').style.opacity = 0;
            }, 10);

            fetchURL(window.location.origin + ':<%wPort%>/update', 120000).then(function(res) {

                if(res != null)
                {
                    if(res == 'Error')
                    {
                        var rOverlay = document.createElement('input');

                        rOverlay.setAttribute('type', 'button');
                        rOverlay.setAttribute('id', 'update-result');
                        rOverlay.setAttribute('style', 'opacity: 0; z-index: 1; letter-spacing: 3px; position: absolute; left: ' + document.getElementById('update-btn-webhooks').offsetLeft + 'px; top: ' + document.getElementById('update-btn-webhooks').offsetTop + 'px; width: ' + document.getElementById('update-btn-webhooks').offsetWidth + 'px!important');
                        rOverlay.setAttribute('value', 'Update Fehlgeschlagen!');
                        rOverlay.setAttribute('class', 'gradient-red');

                        document.getElementById('update-btn-webhooks').parentElement.insertBefore(rOverlay, document.getElementById('update-btn-webhooks'));

                        setTimeout(function()
                        {
                            rOverlay.style.opacity = 1;
                            overlay.style.opacity = 0;
                        }, 10);
                        
                        setTimeout(function()
                        {
                            rOverlay.style.opacity = 0;
                            document.getElementById('update-btn-webhooks').style.opacity = 1;
                        }, 5000);

                        setTimeout(function()
                        {
                            document.getElementById('update-btn-webhooks').parentElement.removeChild(rOverlay);
                            document.getElementById('update-btn-webhooks').parentElement.removeChild(overlay);
                        }, 5300);
                    }
                    else if(res == 'Success')
                    {
                        var rOverlay = document.createElement('input');

                        rOverlay.setAttribute('type', 'button');
                        rOverlay.setAttribute('id', 'update-result');
                        rOverlay.setAttribute('style', 'opacity: 0; z-index: 1; letter-spacing: 3px; position: absolute; left: ' + document.getElementById('update-btn-webhooks').offsetLeft + 'px; top: ' + document.getElementById('update-btn-webhooks').offsetTop + 'px; width: ' + document.getElementById('update-btn-webhooks').offsetWidth + 'px!important');
                        rOverlay.setAttribute('value', 'Update Erfolgreich!');
                        rOverlay.setAttribute('class', 'gradient-green');

                        document.getElementById('update-btn-webhooks').parentElement.insertBefore(rOverlay, document.getElementById('update-btn-webhooks'));

                        setTimeout(function()
                        {
                            rOverlay.style.opacity = 1;
                            overlay.style.opacity = 0;
                        }, 10);
                        
                        setTimeout(function()
                        {
                            rOverlay.style.opacity = 0;
                        }, 5000);

                        setTimeout(function()
                        {
                            document.getElementById('update-btn-webhooks').parentElement.removeChild(rOverlay);
                            document.getElementById('update-btn-webhooks').parentElement.removeChild(overlay);
                            document.getElementById('update-btn-webhooks').parentElement.removeChild(document.getElementById('update-btn-webhooks'));
                        }, 5300);

                        setTimeout(function()
                        {
                            location.reload();
                        }, 5600);
                    }
                }
                else
                {
                    var rOverlay = document.createElement('input');

                    rOverlay.setAttribute('type', 'button');
                    rOverlay.setAttribute('id', 'update-result');
                    rOverlay.setAttribute('style', 'opacity: 0; z-index: 1; letter-spacing: 3px; position: absolute; left: ' + document.getElementById('update-btn-webhooks').offsetLeft + 'px; top: ' + document.getElementById('update-btn-webhooks').offsetTop + 'px; width: ' + document.getElementById('update-btn-webhooks').offsetWidth + 'px!important');
                    rOverlay.setAttribute('value', 'Keine Verbindung zum Gerät!');
                    rOverlay.setAttribute('class', 'gradient-red');

                    document.getElementById('update-btn-webhooks').parentElement.insertBefore(rOverlay, document.getElementById('update-btn-webhooks'));

                    setTimeout(function()
                    {
                        rOverlay.style.opacity = 1;
                        overlay.style.opacity = 0;
                    }, 10);
                
                    setTimeout(function()
                    {
                        rOverlay.style.opacity = 0;
                        document.getElementById('update-btn-webhooks').style.opacity = 1;
                    }, 5000);

                    setTimeout(function()
                    {
                        document.getElementById('update-btn-webhooks').parentElement.removeChild(rOverlay);
                        document.getElementById('update-btn-webhooks').parentElement.removeChild(overlay);
                    }, 5300);
                }
            });
        }
    }
    
    function restartBridge()
    {
        if(document.getElementById('restarting') == null && document.getElementById('restart-result') == null)
        {
            var overlay = document.createElement('input');

            overlay.setAttribute('type', 'button');
            overlay.setAttribute('id', 'restarting');
            overlay.setAttribute('style', 'opacity: 0; z-index: 1; letter-spacing: 3px; position: absolute; left: ' + document.getElementById('restart-btn').offsetLeft + 'px; top: ' + document.getElementById('restart-btn').offsetTop + 'px; width: ' + document.getElementById('restart-btn').offsetWidth + 'px!important');
            overlay.setAttribute('value', 'Neustart ..');
            overlay.setAttribute('class', 'gradient-blue loading-loop');

            document.getElementById('restart-btn').parentElement.insertBefore(overlay, document.getElementById('restart-btn'));

            setTimeout(function()
            {
                overlay.style.opacity = 1;
                document.getElementById('restart-btn').style.opacity = 0;
            }, 10);

            fetchURL('/restart', 10000).then(function(res) {

                if(res == null || res == 'Error')
                {
                    var rOverlay = document.createElement('input');

                    rOverlay.setAttribute('type', 'button');
                    rOverlay.setAttribute('id', 'restart-result');
                    rOverlay.setAttribute('style', 'opacity: 0; z-index: 1; letter-spacing: 3px; position: absolute; left: ' + document.getElementById('restart-btn').offsetLeft + 'px; top: ' + document.getElementById('restart-btn').offsetTop + 'px; width: ' + document.getElementById('restart-btn').offsetWidth + 'px!important');
                    rOverlay.setAttribute('value', 'Neustart Fehlgeschlagen!');
                    rOverlay.setAttribute('class', 'gradient-red');

                    document.getElementById('restart-btn').parentElement.insertBefore(rOverlay, document.getElementById('restart-btn'));

                    setTimeout(function()
                    {
                        rOverlay.style.opacity = 1;
                        overlay.style.opacity = 0;
                    }, 10);
                
                    setTimeout(function()
                    {
                        rOverlay.style.opacity = 0;
                        document.getElementById('restart-btn').style.opacity = 1;
                    }, 5000);

                    setTimeout(function()
                    {
                        document.getElementById('restart-btn').parentElement.removeChild(rOverlay);
                        document.getElementById('restart-btn').parentElement.removeChild(overlay);
                    }, 5300);
                }
                else if(res == 'Success')
                {
                    setTimeout(function()
                    {
                        checkRestart();
                    }, 3000);
                }
            });
        }
    }

    function checkRestart()
    {
        fetchURL('/check-restart', 3000).then(function(res) {

            if(res == null && res == 'false')
            {
                var rOverlay = document.createElement('input');

                rOverlay.setAttribute('type', 'button');
                rOverlay.setAttribute('id', 'restart-result');
                rOverlay.setAttribute('style', 'opacity: 0; z-index: 1; letter-spacing: 3px; position: absolute; left: ' + document.getElementById('restart-btn').offsetLeft + 'px; top: ' + document.getElementById('restart-btn').offsetTop + 'px; width: ' + document.getElementById('restart-btn').offsetWidth + 'px!important');
                rOverlay.setAttribute('value', 'Neustart Erfolgreich!');
                rOverlay.setAttribute('class', 'gradient-green');

                document.getElementById('restart-btn').parentElement.insertBefore(rOverlay, document.getElementById('restart-btn'));

                setTimeout(function()
                {
                    rOverlay.style.opacity = 1;
                    overlay.style.opacity = 0;
                }, 13000);
            
                setTimeout(function()
                {
                    rOverlay.style.opacity = 0;
                    document.getElementById('restart-btn').style.opacity = 1;
                }, 18000);

                setTimeout(function()
                {
                    document.getElementById('restart-btn').parentElement.removeChild(rOverlay);
                    document.getElementById('restart-btn').parentElement.removeChild(overlay);
                }, 18300);
            }
            else
            {
                setTimeout(function()
                {
                    checkRestart();
                }, 500);
            }
        });
    }

</script>