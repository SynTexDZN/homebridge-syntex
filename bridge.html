<html>
    <body id="body">
        <div id="content">
            <title>Dashboard: Bridge</title>
            <h1 style="margin-bottom: 0; margin-top: 32px">Dashboard</h1>
            <div class="main" style="margin-top: 10px">
                <p style="margin-bottom: 100px; margin-top: 20px">Bridge</p>
                <div class="main" style="margin-top: 10px; margin-bottom: 20px; display: flex">
                    <input class="white" type="button" value="GERÄTE" onclick="Essentials.leavePage('/')" style="margin-right: 20px">
                    <input class="white" type="button" value="BRIDGE" onclick="Essentials.leavePage('/bridge')" disabled>
                </div>
                <div class="main" style="margin-top: 10px; display: flex; margin-bottom: 100px">
                    <input class="white" type="button" value="AUTOMATION" id="a" onclick="Essentials.leavePage('/automations')" style="margin-right: 20px">
                    <input class="white" type="button" value="LOG" onclick="Essentials.leavePage('/log')">
                </div>
                <div class="widget" style="margin-left: 0">
                    <button class="widget-left gradient-red" disabled>Wichtig</button>
                    <button class="widget-right" disabled>Bitte schließe während eines Updates oder Neustarts nicht diese Seite</button>
                </div>
                <div id="infos" style="margin: 100px 0"></div>
                <div class="widget" style="margin-left: 0">
                    <button class="widget-left" disabled>IP Adresse</button>
                    <button class="widget-right gradient-blue" disabled>-</button>
                </div>
                <div class="navigation-panel">
                    <div class="sticky-inset">
                        <input id="restart-btn" type="button" value="Bridge Neustarten" onclick="restartBridge(this)" style="transition: all .2s ease-out, margin-bottom 0s">
                    </div>
                </div>
            </div>
            <script type="module">

                import { Query } from '/js/query.js';
                import { Essentials } from '/js/essentials.js';

                Query.SETUP(Essentials);
                Essentials.SETUP(Query);

                window.Query = Query;
                window.Essentials = Essentials;

                window.bridgeIP = '<%ip%>';
                window.bridgeVersion = '<%version%>';
                window.webhooksVersion = ''
                window.newestBVersion = ''
                window.newestWVersion = '';

                window.versions = {};
                window.newestVersions = {};

                window.updating = [];
                window.restarting = false;

                document.getElementsByClassName('widget')[1].getElementsByClassName('widget-right')[0].innerHTML = bridgeIP;
                
                Query.complexFetch('/serverside/plugins', 10000, 3, {}, false).then(function(plugins) {

                    plugins = JSON.parse(plugins);

                    for(var i = 0; i < plugins.length; i++)
                    {
                        console.log(plugins[i]);

                        document.getElementById('infos').innerHTML += '<h2 style="width: fit-content">• ' + (plugins[i].id != 'SynTex' ? plugins[i].id.replace('SynTex', 'SynTex ') : 'SynTex') + ' •</h2>';
                        document.getElementById('infos').innerHTML += '<p class="loading-loop"><b>Version: </b>Laden ..</p>';
                        document.getElementById('infos').innerHTML += '<p class="loading-loop"><b>Neuste Version: </b>Laden ..</p>';
                    }

                    for(var i = 0; i < plugins.length; i++)
                    {
                        Query.complexFetch(window.location.protocol + '//' + window.location.hostname + ':' + plugins[i].port + '/version', 10000, 3, {}, false).then(async function (version) {

                            console.log(plugins, this.plugin, this.counter);

                            if(version != null)
                            {
                                versions[this.plugin] = version;

                                document.getElementById('infos').children[this.counter].innerHTML = '<p><b>Version: </b>' + versions[this.plugin] + '</p>';

                                console.log(document.getElementById('infos').children[this.counter + 1], this.plugin, versions[this.plugin], (this.plugin != 'SynTex' ? this.plugin.replace('SynTex', 'SynTex ') : 'SynTex'));

                                var newestVersion = await fetchPluginUpdates(document.getElementById('infos').children[this.counter + 1], this.plugin, versions[this.plugin], (this.plugin != 'SynTex' ? this.plugin.replace('SynTex', 'SynTex ') : 'SynTex'));

                                console.log(newestVersion);

                                if(newestVersion != null)
                                {
                                    newestVersions[this.plugin] = newestVersion;
                                }
                            }
                            else
                            {
                                document.getElementById('infos').children[this.counter].innerHTML = '<p><b>Version: </b>Fehler beim Laden</p>';
                                document.getElementById('infos').children[this.counter + 1].innerHTML = '<p><b>Neuste Version: </b>Fehler beim Laden</p>';
                            }

                        }.bind({ plugin : plugins[i].id, counter : i * 3 + 1 }));
                    }
                });

            </script>
            <script>

                function fetchPluginUpdates(label, index, version, name)
                {
                    return new Promise(async function(resolve) {

                        var newestVersion = await Query.complexFetch('http://syntex.sytes.net/smarthome/check-version?device=' + index, 10000, 3, {}, false);

                        if(newestVersion != null && newestVersion != '')
                        {
                            label.innerHTML = '<p><b>Neuste Version: </b>' + newestVersion + '</p>';
                            
                            var installedVersion = Essentials.versionCount(version);

                            if(Essentials.versionCount(newestVersion) > installedVersion)
                            {
                                var updateButton = document.createElement('input');

                                updateButton.setAttribute('type', 'button');
                                updateButton.setAttribute('value', name + ' Aktualisieren ( v' + newestVersion + ' )');
                                updateButton.setAttribute('onclick', 'updatePlugin("' + index + '", this)');
                                updateButton.setAttribute('id', 'update-btn-' + index.toLowerCase());
                                updateButton.setAttribute('style', 'margin-bottom: 20px'); 
                                
                                document.getElementsByClassName('navigation-panel')[0].children[0].insertBefore(updateButton, document.getElementById('restart-btn'));

                                //document.getElementsByClassName('navigation-panel')[0].children[0].children[0].style.marginBottom = '20px';
                            }
                        }
                        else
                        {
                            label.innerHTML = '<p><b>Neuste Version: </b>Fehler beim Laden</p>';
                        }

                        resolve(newestVersion);
                    });
                }

                async function updatePlugin(id, btn)
                {
                    console.log('UPDATE PLUGIN', id, btn, restarting, updating);

                    if(!restarting && updating.length == 0)
                    {
                        var overlays = {
                            root : btn,
                            id : 'update',
                            pending : { value : 'Update wird Installiert ..', color : 'purple' },
                            executeError : { value : 'Update Fehlgeschlagen!' },
                            connectionError : { value : 'Keine Verbindung zur Bridge!' }
                        };

                        updating.push(id);

                        console.log(newestVersions[id]);

                        if(await Query.complexFetch('/serverside/update?version=' + newestVersions[id], 120000, 3, overlays, false) == 'Success')
                        {
                            await Essentials.newTimeout(3000);

                            if(await Essentials.checkRestart('/serverside/check-restart'))
                            {
                                //document.getElementById('infos').children[1].innerHTML = '<b>Version: </b>Laden ..';

                                Essentials.showOverlay(btn, Essentials.createSuccessOverlay('update-result', 'Update Erfolgreich!'));

                                versions[id] = await Query.complexFetch('/serverside/version', 10000, 10, {}, false);

                                document.getElementById('infos').children[1].innerHTML = '<b>Version: </b>' + versions[id];

                                await Essentials.newTimeout(4000);

                                Essentials.removeOverlays(btn, false);

                                await Essentials.newTimeout(300);
                                /*
                                if(Essentials.versionCount(newestVersions[id]) <= Essentials.versionCount(versions[id]))
                                {
                                    document.getElementsByClassName('navigation-panel')[0].children[0].children[0].style.marginBottom = '0px';
                                }
                                */
                                updating.splice(updating.indexOf(id), 1);
                            }
                        }
                    }
                }
                /*
                async function updateSynTexBridge(btn)
                {
                    
                }

                async function updateSynTexWebHooks(btn)
                {
                    if(!restarting && !updating['bridge'] && !updating['webhooks'])
                    {
                        var overlays = {
                            root : btn,
                            id : 'update',
                            pending : { value : 'Update wird Installiert ..', color : 'purple' },
                            executeError : { value : 'Update Fehlgeschlagen!' },
                            connectionError : { value : 'Keine Verbindung zur Bridge!' }
                        };

                        updating['bridge'] = true;

                        if(await Query.complexFetch('/serverside/update?version=' + newestBVersion, 120000, 3, overlays, false) == 'Success')
                        {
                            await Essentials.newTimeout(3000);

                            if(await Essentials.checkRestart('/serverside/check-restart'))
                            {
                                document.getElementById('infos').children[1].innerHTML = '<b>Version: </b>Laden ..';

                                Essentials.showOverlay(btn, Essentials.createSuccessOverlay('update-result', 'Update Erfolgreich!'));

                                bridgeVersion = await Query.complexFetch('/serverside/version', 10000, 10, {}, false);

                                document.getElementById('infos').children[1].innerHTML = '<b>Version: </b>' + bridgeVersion;

                                await Essentials.newTimeout(4000);

                                Essentials.removeOverlays(btn, false);

                                await Essentials.newTimeout(300);

                                if(Essentials.versionCount(newestWVersion) <= Essentials.versionCount(webhooksVersion))
                                {
                                    document.getElementsByClassName('navigation-panel')[0].children[0].children[0].style.marginBottom = '0px';
                                }

                                updating['bridge'] = false;
                            }
                        }
                    }
                }
                */
                async function restartBridge(btn)
                {
                    if(!restarting && !updating['bridge'] && !updating['webhooks'])
                    {
                        var overlays = {
                            root : btn,
                            id : 'restart',
                            pending : { value : 'Neustarten ..' },
                            executeError : { value : 'Neustart Fehlgeschlagen!' },
                            connectionError : { value : 'Keine Verbindung zur Bridge!' }
                        };

                        restarting = true;

                        if(await Query.complexFetch('/serverside/restart', 10000, 3, overlays, true) == 'Success')
                        {
                            await Essentials.newTimeout(3000);

                            if(await Essentials.checkRestart('/serverside/check-restart'))
                            {
                                Essentials.showOverlay(btn, Essentials.createSuccessOverlay('restart-result', 'Neustart Erfolgreich!'));

                                await Essentials.newTimeout(4000);

                                Essentials.removeOverlays(btn, true);

                                restarting = false;
                            }
                        }
                    }
                }

            </script>
        </div>
    </body>
</html>