<html>
	<body ontouchstart="">
		<div id="content">
			<title>Dashboard: Bridge</title>
			<script type="module">

				import { PageManager } from '/js/page-manager.js';

				window.PageManager = PageManager;

				PageManager.setHeader('Dashboard', 'Bridge');

				var main = document.createElement('div');

				main.style.display = 'flex';

				main.innerHTML = '<div style="width: 100%"><input id="restart-btn" type="button" value="Bridge Neustarten" onclick="restartBridge(this)" style="transition: all .2s ease-out, margin-bottom 0s"></div><div style="width: 100%; margin-left: 20px"><button onclick="reloadVersions(this)">↻ Neu Laden</button></div>';

				PageManager.setFooter(main);
				PageManager.showFooter();

			</script>
			<div class="main">
				<div class="main" style="margin-bottom: 20px; display: flex">
					<input class="white" type="button" value="GERÄTE" onclick="Essentials.leavePage('/')" style="margin-right: 20px">
					<input class="white" type="button" value="BRIDGE" onclick="Essentials.leavePage('/bridge')" disabled>
				</div>
				<div class="main" style="margin-top: 10px; display: flex; margin-bottom: 100px">
					<input class="white" type="button" value="AUTOMATION" id="a" onclick="Essentials.leavePage('/automation/')" style="margin-right: 20px">
					<input class="white" type="button" value="LOG" onclick="Essentials.leavePage('/log')">
				</div>
				<div class="widget widget-multi" style="margin-left: 0; margin-bottom: 20px">
					<button class="widget-left">IP Adresse</button>
					<button class="widget-right gradient-blue" style="user-select: all">-</button>
				</div>
				<div class="widget widget-multi" style="margin-left: 0; margin-bottom: 20px">
					<button class="widget-left">Mac WLAN<br>Mac LAN</button>
					<button class="widget-right gradient-blue" style="user-select: all">-<br>-</button>
				</div>
				<div class="type-container" style="margin: 100px auto; margin-bottom: 50px">
					<h2 class="title-container">Core</h2>
					<div id="core-plugins"></div>
				</div>
				<div class="type-container" style="margin: 100px auto; margin-top: 50px">
					<h2 class="title-container">Plugins</h2>
					<div id="plugins"></div>
				</div>
				<div class="bottom" style="margin: 0 auto; margin-bottom: 100px; width: 100%; max-width: 400px">
					<input class="gradient-red" type="button" value="» Experten Modus «" onclick="Essentials.leavePage('/debug')">
				</div>
			</div>
			<script type="module">

				import { Query } from '/js/query.js';
				import { Essentials } from '/js/essentials.js';
				import { Expandable } from '/js/expandable-button.js';

				Query.SETUP(Essentials);
				Essentials.SETUP(Query, Preloader);

				window.Query = Query;
				window.Essentials = Essentials;
				window.Expandable = Expandable;

				// NOTE: Mac and IP Widgets

				window.bridgeIP = '<%ip%>';
				window.wlanMac = '<%wlanMac%>';
				window.ethernetMac = '<%ethernetMac%>';

				if(wlanMac != 'null' && ethernetMac != 'null')
				{
					document.getElementsByClassName('widget')[0].getElementsByClassName('widget-right')[0].innerHTML = bridgeIP;
				}

				if(wlanMac != 'null' && ethernetMac != 'null')
				{
					document.getElementsByClassName('widget')[1].getElementsByClassName('widget-right')[0].innerHTML = wlanMac.toUpperCase() + '<br>' + ethernetMac.toUpperCase();
				}
				else if(wlanMac != 'null')
				{
					document.getElementsByClassName('widget')[1].getElementsByClassName('widget-right')[0].innerHTML = wlanMac.toUpperCase() + '<br>-';
				}
				else if(ethernetMac != 'null')
				{
					document.getElementsByClassName('widget')[1].getElementsByClassName('widget-right')[0].innerHTML = '-<br>' + ethernetMac.toUpperCase();
				}

				// NOTE: Load Plugin Versions

				window.tag = '<%tag%>';
				window.plugins = {};
				window.versions = {};
				window.latestVersions = {};

				loadPluginData().then(() => renderGUI());

			</script>
			<script>

				window.restarting = false;
				window.updating = [];

				// NOTE: Reload Plugin Data

				function loadPluginData()
				{
					return new Promise((resolve) => {

						Query.complexFetch('/serverside/plugins', 5000, 2, {}, false).then((p) => {

							try
							{
								plugins = JSON.parse(p);

								resolve(true);
							}
							catch(e)
							{
								console.error(e);

								resolve(false);
							}

							console.log('PLUGINS', plugins);
						});
					});
				}

				// NOTE: Create Version GUI

				function renderGUI()
				{
					var counter = 0;

					for(const id in plugins)
					{
						var title = plugins[id].name != 'SynTex' ? plugins[id].name.replace('SynTex', 'SynTex ') : 'SynTex';
						var newestVersion = 'Fehler beim Laden';

						if(plugins[id].versions[tag] != null || plugins[id].versions['latest'] != null)
						{
							newestVersion = Essentials.versionCount(plugins[id].versions[tag]) > Essentials.versionCount(plugins[id].versions['latest']) ? plugins[id].versions[tag] : plugins[id].versions['latest'];

							latestVersions[id] = newestVersion;
						}

						if(plugins[id].versions['current'] != null)
						{
							versions[id] = plugins[id].versions['current'];
						}
						
						if(document.getElementById(id) == null)
						{
							var container = document.createElement('div');

							container.setAttribute('id', id);

							var innerHTML = '';

							innerHTML += '<button class="plugin-container" style="display: flex; margin-top: ' + (counter == 0 ? '0' : '20px') + '">'
							innerHTML += '<div style="width: calc(100% - 150px)">' + title;
							innerHTML += '<div class="loading-loop expandable-hidden" id="version-' + id + '"><b>Version: </b>' + versions[id] + '</div>';
							innerHTML += '<div class="loading-loop expandable-hidden" id="latest-version-' + id + '" style="margin-bottom: 0"><b>Neuste Version: </b>' + latestVersions[id] + '</div>';
							innerHTML += '</div><div id="update-status-' + id + '" class="update-status loading-loop"></div>';
							innerHTML += '</button>';

							container.innerHTML = innerHTML;

							document.getElementById(id == 'npm' || id == 'homebridge' ? 'core-plugins' : 'plugins').appendChild(container);

							Expandable.createExpandableButton(container.children[0]);

							counter++;
						}
						else
						{
							document.getElementById('version-' + id).innerHTML = '<b>Version: </b>' + versions[id];
							document.getElementById('latest-version-' + id).innerHTML = '<b>Neuste Version: </b>' + latestVersions[id];
						}

						if(versions[id] != null && latestVersions[id] != null && Essentials.versionCount(latestVersions[id]) > Essentials.versionCount(versions[id]))
						{
							if(document.getElementById('update-btn-' + id) == null)
							{
								var updateButton = document.createElement('input');

								updateButton.setAttribute('type', 'button');
								updateButton.setAttribute('value', title + ' Aktualisieren ( v' + latestVersions[id] + ' )');
								updateButton.setAttribute('onclick', 'updatePlugin("' + id + '", this)');
								updateButton.setAttribute('id', 'update-btn-' + id);
								updateButton.setAttribute('style', 'margin-bottom: 20px');

								PageManager.addFooter(updateButton);
								PageManager.showFooter();
							}
							else
							{
								document.getElementById('update-btn-' + id).value = title + ' Aktualisieren ( v' + latestVersions[id] + ' )';
							}

							document.getElementById('update-status-' + id).innerHTML = 'UPDATE';
							document.getElementById('update-status-' + id).style.background = 'hsl(280, 95%, 60%)';
							document.getElementById('update-status-' + id).classList.add('shine');
						}
						else
						{
							if(document.getElementById('update-btn-' + id) != null)
							{
								document.getElementById('update-btn-' + id).parentElement.removeChild(document.getElementById('update-btn-' + id));
							}

							if(versions[id] == null || latestVersions[id] == null)
							{
								document.getElementById('update-status-' + id).innerHTML = 'FEHLER';
								document.getElementById('update-status-' + id).style.background = 'hsl(350, 95%, 60%)';
							}
							else
							{
								document.getElementById('update-status-' + id).innerHTML = 'UP TO DATE';
								document.getElementById('update-status-' + id).style.background = 'hsl(165, 85%, 50%)';
							}

							document.getElementById('update-status-' + id).classList.remove('shine');
						}
					}

					Preloader.finish();
				}

				// NOTE: Restart Bridge

				async function restartBridge(btn)
				{
					if(!restarting && updating.length == 0)
					{
						var overlays = {
							root : btn,
							id : 'restart',
							pending : { value : 'Neustarten ..' },
							executeError : { value : 'Neustart Fehlgeschlagen!' },
							connectionError : { value : 'Keine Verbindung zur Bridge!' }
						};

						restarting = true;

						if(await Query.complexFetch('/serverside/restart', 5000, 2, overlays, true) == 'Success')
						{
							await Essentials.newTimeout(3000);

							if(await Essentials.checkRestart('/serverside/check-restart'))
							{
								Essentials.showOverlay(btn, Essentials.createSuccessOverlay('restart-result', 'Neustart Erfolgreich!'));
							}
							else
							{
								Essentials.showOverlay(btn, Essentials.createErrorOverlay('restart-result', 'Neustart Fehlgeschlagen!'));
							}

							await Essentials.newTimeout(4000);

							Essentials.removeOverlays(btn, true);
						}

						restarting = false;
					}
				}

				// NOTE: Reload Button

				function reloadVersions(btn)
				{
					var overlays = {
						root : btn,
						id : 'reload',
						pending : { value : 'Neu Laden ..' },
						connectionError : { value : 'Keine Verbindung zur Bridge!' }
					};

					for(const id in plugins)
					{
						if(document.getElementById(id) != null)
						{
							document.getElementById('version-' + id).innerHTML = '<b>Version: </b>Laden ..';
							document.getElementById('latest-version-' + id).innerHTML = '<b>Neuste Version: </b>Laden ..';
						}
					}

					Query.complexFetch('/serverside/plugins?reload', 5000, 2, overlays, false).then(async (p) => {

						try
						{
							plugins = JSON.parse(p);

							Essentials.showOverlay(btn, Essentials.createSuccessOverlay('reload', 'Aktualisiert!'));

							renderGUI();
						}
						catch(e)
						{
							Essentials.showOverlay(btn, Essentials.createErrorOverlay('reload', 'Laden Fehlgeschlagen!'));

							console.error(e);
						}

						console.log('PLUGINS', plugins);

						await Essentials.newTimeout(2000);

						Essentials.removeOverlays(btn, true);
					});
				}

				// NOTE: Plugin Update
				
				async function updatePlugin(id, btn)
				{
					if(!restarting && updating.length == 0)
					{
						var overlays = {
							root : btn,
							id : 'update',
							pending : { value : 'Update wird Installiert ..', color : 'purple' },
							executeError : { value : 'Update Fehlgeschlagen!' },
							connectionError : { value : 'Keine Verbindung zur Bridge!' }
						};
						
						updating.push(id);

						await Query.complexFetch('/serverside/update?plugin=' + id + '&version=' + latestVersions[id], 5000, 2, overlays, false);
							
						await Essentials.newTimeout(3000);

						var success = false;
							
						if(await Essentials.checkUpdating('/serverside/update?status')
						&& await Essentials.checkRestart('/serverside/check-restart'))
						{
							document.getElementById('version-' + id).innerHTML = '<b>Version: </b>Laden ..';

							await loadPluginData();

							if(this.plugins[id].versions['current'] != null)
							{
								versions[id] = this.plugins[id].versions['current'];

								document.getElementById('version-' + id.toLowerCase()).innerHTML = '<b>Version: </b>' + versions[id];
							
								if(latestVersions[id] == versions[id])
								{
									Essentials.showOverlay(btn, Essentials.createSuccessOverlay('update-result', 'Update Erfolgreich!'));

									document.getElementById('update-status-' + id).innerHTML = 'UP TO DATE';
									document.getElementById('update-status-' + id).style.background = 'hsl(165, 85%, 50%)';
									document.getElementById('update-status-' + id).classList.remove('shine');

									success = true;
								}
								else
								{
									Essentials.showOverlay(btn, Essentials.createErrorOverlay('update-result', 'Fehler bei der Installation!'));
								}
							}
							else
							{
								document.getElementById('version-' + id.toLowerCase()).innerHTML = '<b>Version: </b>Fehler beim Laden';
								Essentials.showOverlay(btn, Essentials.createErrorOverlay('update-result', 'Fehler bei der Installation!'));
							}
						}
						else
						{
							Essentials.showOverlay(btn, Essentials.createErrorOverlay('update-result', 'Fehler beim Neustart!'));
						}

						updating.splice(updating.indexOf(id), 1);

						await Essentials.newTimeout(4000);

						Essentials.removeOverlays(btn, !success);

						await Essentials.newTimeout(300);

						PageManager.removeFooter('update-btn-' + id);

						//await Essentials.newTimeout(300);

						PageManager.showFooter();
					}
				}
				
			</script>
		</div>
	</body>
</html>