<html>
	<body id="body">
		<div id="content">
			<title>Dashboard: Bridge</title>
			<h1 style="margin-bottom: 0; margin-top: 32px">Dashboard</h1>
			<div class="main" style="margin-top: 10px">
				<p style="margin-bottom: 100px; margin-top: 20px">Bridge</p>
				<div class="main" style="margin-top: 10px; margin-bottom: 20px; display: flex">
					<input class="white" type="button" value="GERÄTE" onclick="Essentials.leavePage('/')" style="margin-right: 20px">
					<input class="white" type="button" value="BRIDGE" onclick="Essentials.leavePage('/bridge')" disabled>
				</div>
				<div class="main" style="margin-top: 10px; display: flex; margin-bottom: 100px">
					<input class="white" type="button" value="AUTOMATION" id="a" onclick="Essentials.leavePage('/automation/')" style="margin-right: 20px">
					<input class="white" type="button" value="LOG" onclick="Essentials.leavePage('/log')">
				</div>
				<div class="widget" style="margin-left: 0">
					<button class="widget-left gradient-red" disabled>Wichtig</button>
					<button class="widget-right" disabled>Bitte schließe während eines Updates oder Neustarts nicht diese Seite</button>
				</div>
				<div style="margin: 100px 0">
					<div id="infos"></div>
				</div>
				<div class="widget" style="margin-left: 0">
					<button class="widget-left" disabled>IP Adresse</button>
					<button class="widget-right gradient-blue" disabled>-</button>
				</div>
				<div class="navigation-panel">
					<div class="sticky-inset">
						<div style="display: flex">
							<input id="restart-btn" type="button" value="Bridge Neustarten" onclick="restartBridge(this)" style="transition: all .2s ease-out, margin-bottom 0s">
							<div style="width: calc(100% + 12px); margin-left: 20px">
								<button onclick="reloadVersions(this)">↻ Neu Laden</button>
							</div>
						</div>
					</div>
				</div>
			</div>
			<script type="module">

				import { Query } from '/js/query.js';
				import { Essentials } from '/js/essentials.js';

				Query.SETUP(Essentials);
				Essentials.SETUP(Query, Preloader);

				window.Query = Query;
				window.Essentials = Essentials;

				window.bridgeIP = '<%ip%>';
				window.updates = '<%updates%>';

				window.versions = {};
				window.latestVersions = {};

				window.updating = [];
				window.plugins = [];
				window.restarting = false;

				document.getElementsByClassName('widget')[1].getElementsByClassName('widget-right')[0].innerHTML = bridgeIP;
				
				Query.complexFetch('/serverside/plugins', 5000, 2, {}, false).then((Plugins) => {

					try
					{
						plugins = JSON.parse(Plugins);
					}
					catch(e)
					{
						plugins = {};

						console.error(e);
					}

					try
					{
						updates = JSON.parse(updates);
					}
					catch(e)
					{
						updates = { plugins : {} };

						console.error(e);
					}

					var counter = 0;

					for(const id in plugins)
					{
						if(updates.plugins[id] != null)
						{
							if(counter == 0)
							{
								document.getElementById('infos').innerHTML += '<h2 style="width: fit-content; margin-top: 0">• ' + (id != 'SynTex' ? id.replace('SynTex', 'SynTex ') : 'SynTex') + ' •</h2>';
							}
							else
							{
								document.getElementById('infos').innerHTML += '<h2 style="width: fit-content">• ' + (id != 'SynTex' ? id.replace('SynTex', 'SynTex ') : 'SynTex') + ' •</h2>';
							}
							
							document.getElementById('infos').innerHTML += '<p id="version-' + id.toLowerCase() + '" class="loading-loop"><b>Version: </b>Laden ..</p>';

							if(updates.plugins != null && updates.plugins[id] != null && updates.plugins[id].latest != null)
							{
								var newestVersion = updates.plugins[id].latest;

								latestVersions[id] = newestVersion;

								document.getElementById('infos').innerHTML += '<p id="latest-version-' + id.toLowerCase() + '" style="margin-bottom: 0"><b>Neuste Version: </b>' + newestVersion + '</p>';
							}
							else
							{
								document.getElementById('infos').innerHTML += '<p id="latest-version-' + id.toLowerCase() + '" style="margin-bottom: 0"><b>Neuste Version: </b>Fehler beim Laden</p>';
							}

							counter++;

							Query.complexFetch(window.location.protocol + '//' + window.location.hostname + ':' + plugins[id].port + '/serverside/version', 10000, 2, {}, false).then(async function (version) {

								if(version != null)
								{
									versions[this.id] = version;

									document.getElementById('version-' + this.id.toLowerCase()).innerHTML = '<b>Version: </b>' + versions[this.id];
								
									if(latestVersions[this.id] != null && Essentials.versionCount(latestVersions[this.id]) > Essentials.versionCount(version))
									{
										var updateButton = document.createElement('input');

										updateButton.setAttribute('type', 'button');
										updateButton.setAttribute('value', (this.id != 'SynTex' ? this.id.replace('SynTex', 'SynTex ') : 'SynTex') + ' Aktualisieren ( v' + latestVersions[this.id] + ' )');
										updateButton.setAttribute('onclick', 'updatePlugin("' + this.id + '", ' + plugins[this.id].port + ', this)');
										updateButton.setAttribute('id', 'update-btn-' + this.id.toLowerCase());
										updateButton.setAttribute('style', 'margin-bottom: 20px'); 
										
										document.getElementsByClassName('navigation-panel')[0].children[0].insertBefore(updateButton, document.getElementsByClassName('navigation-panel')[0].children[0].children[0]);
									}
								}
								else
								{
									document.getElementById('version-' + this.id.toLowerCase()).innerHTML = '<b>Version: </b>Fehler beim Laden';
								}

							}.bind({ id : id }));
						}
					}

					Preloader.finish();
				});

			</script>
			<script>

				async function updatePlugin(id, port, btn)
				{
					if(!restarting && updating.length == 0)
					{
						var overlays = {
							root : btn,
							id : 'update',
							pending : { value : 'Update wird Installiert ..', color : 'purple' },
							executeError : { value : 'Update Fehlgeschlagen!' },
							connectionError : { value : 'Keine Verbindung zur Bridge!' }
						};

						updating.push(id);

						if(await Query.complexFetch(window.location.protocol +  '//' + window.location.hostname + ':' + port + '/serverside/update?version=' + latestVersions[id], 120000, 2, overlays, false) == 'Success')
						{
							await Essentials.newTimeout(3000);

							if(await Essentials.checkRestart(window.location.protocol +  '//' + window.location.hostname + ':' + port + '/serverside/check-restart'))
							{
								document.getElementById('version-' + id.toLowerCase()).innerHTML = '<b>Version: </b>Laden ..';

								Essentials.showOverlay(btn, Essentials.createSuccessOverlay('update-result', 'Update Erfolgreich!'));

								versions[id] = await Query.complexFetch(window.location.protocol +  '//' + window.location.hostname + ':' + port + '/serverside/version', 10000, 10, {}, false);

								document.getElementById('version-' + id.toLowerCase()).innerHTML = '<b>Version: </b>' + versions[id];
							}
							else
							{
								Essentials.showOverlay(btn, Essentials.createErrorSuccessOverlay('update-result', 'Homebridge Startet Nicht!'));
							}

							await Essentials.newTimeout(4000);

							Essentials.removeOverlays(btn, false);

							await Essentials.newTimeout(300);
							
							updating.splice(updating.indexOf(id), 1);
						}
					}
				}
				
				async function restartBridge(btn)
				{
					if(!restarting && updating.length == 0)
					{
						var overlays = {
							root : btn,
							id : 'restart',
							pending : { value : 'Neustarten ..' },
							executeError : { value : 'Neustart Fehlgeschlagen!' },
							connectionError : { value : 'Keine Verbindung zur Bridge!' }
						};

						restarting = true;

						if(await Query.complexFetch('/serverside/restart', 5000, 2, overlays, true) == 'Success')
						{
							await Essentials.newTimeout(3000);

							if(await Essentials.checkRestart('/serverside/check-restart'))
							{
								Essentials.showOverlay(btn, Essentials.createSuccessOverlay('restart-result', 'Neustart Erfolgreich!'));
							}
							else
							{
								Essentials.showOverlay(btn, Essentials.createErrorOverlay('restart-result', 'Neustart Fehlgeschlagen!'));
							}

							await Essentials.newTimeout(4000);

							Essentials.removeOverlays(btn, true);

							restarting = false;
						}
					}
				}

				function reloadVersions(btn)
				{
					var overlays = {
						root : btn,
						id : 'reload',
						pending : { value : 'Neu Laden ..' },
						connectionError : { value : 'Keine Verbindung zur Bridge!' }
					};

					Query.complexFetch('/serverside/reload-updates?plugins', 5000, 2, overlays, false).then(async (response) => {
						
						try
						{
							response = JSON.parse(response);

							for(const id in response.plugins)
							{
								latestVersions[id] = response.plugins[id].latest;

								if(document.getElementById('latest-version-' + id.toLowerCase()) != null)
								{
									document.getElementById('latest-version-' + id.toLowerCase()).innerHTML = '<b>Neuste Version: </b>' + response.plugins[id].latest;
								}

								if(latestVersions[id] != null && versions[id] != null && Essentials.versionCount(latestVersions[id]) > Essentials.versionCount(versions[id]))
								{
									if(document.getElementById('update-btn-' + id.toLocaleLowerCase()) == null)
									{
										if(plugins[id] != null)
										{
											var updateButton = document.createElement('input');

											updateButton.setAttribute('type', 'button');
											updateButton.setAttribute('value', (id != 'SynTex' ? id.replace('SynTex', 'SynTex ') : 'SynTex') + ' Aktualisieren ( v' + latestVersions[id] + ' )');
											updateButton.setAttribute('onclick', 'updatePlugin("' + id + '", ' + plugins[id].port + ', this)');
											updateButton.setAttribute('id', 'update-btn-' + id.toLowerCase());
											updateButton.setAttribute('style', 'margin-bottom: 20px'); 
											
											document.getElementsByClassName('navigation-panel')[0].children[0].insertBefore(updateButton, document.getElementsByClassName('navigation-panel')[0].children[0].children[0]);
										}
									}
									else
									{
										document.getElementById('update-btn-' + id.toLocaleLowerCase()).value = (id != 'SynTex' ? id.replace('SynTex', 'SynTex ') : 'SynTex') + ' Aktualisieren ( v' + latestVersions[id] + ' )';
									}
								}
							}

							Essentials.showOverlay(btn, Essentials.createSuccessOverlay('reload', 'Aktualisiert!'));
						}
						catch(e)
						{
							console.error(e);

							Essentials.showOverlay(btn, Essentials.createErrorOverlay('reload', 'Neu Laden Fehlgeschlagen!'));
						}

						await Essentials.newTimeout(2000);

						Essentials.removeOverlays(btn, true);
					});
				}

			</script>
		</div>
	</body>
</html>