<html>
    <title>Dashboard: Bridge</title>
    <body>
        <h1 style="margin-bottom: 0; margin-top: 32px">Dashboard</h1>
        <div class="main" style="margin-top: 10px; display: table">
            <p style="margin-bottom: 100px; margin-top: 16px">Bridge</p>
            <div class="main" style="margin-top: 10px; margin-bottom: 20px; display: flex">
                <input class="white" type="button" value="Geräte" onclick="window.location.href='/'" style="margin-right: 20px">
                <input class="white" type="button" value="Bridge" onclick="window.location.href='/bridge'" disabled>
            </div>
            <div class="main" style="margin-top: 10px; margin-bottom: 100px; display: flex">
                <input class="white" type="button" value="Log" onclick="window.location.href='/log'">
            </div>
            <div class="widget" style="margin-left: 0">
                <button class="widget-left" disabled>IP Adresse</button>
                <button class="widget-right gradient-blue" disabled>-</button>
            </div>
            <div id="infos" style="margin: 100px 0">
                <h2 style="width: fit-content">• SynTex Bridge •</h2>
                <p class="loading-loop"><b>Version: </b>Laden ..</p>
                <p class="loading-loop"><b>Neuste Version: </b>Laden ..</p>
                <h2 style="width: fit-content; margin-top: 100px">• SynTex WebHooks •</h2>
                <p class="loading-loop"><b>Version: </b>Laden ..</p>
                <p class="loading-loop"><b>Neuste Version: </b>Laden ..</p>
            </div>
            <div class="widget" style="margin-left: 0; margin-bottom: 20px">
                <button class="widget-left gradient-red" disabled>Wichtig</button>
                <button class="widget-right" disabled>Bitte schließe während eines Updates oder Neustarts nicht diese Seite</button>
            </div>
            <input id="restart-btn" type="button" value="Bridge Neustarten" onclick="restartBridge(this)">
        </div>
    </body>
</html>
<script>

    var bridgeIP = '<%ip%>';
    var bridgeVersion = '<%version%>';
    var webhooksVersion = '';
    var newestBVersion = '';
    var newestWVersion = '';

    document.getElementsByClassName('widget')[0].getElementsByClassName('widget-right')[0].innerHTML = bridgeIP;
    document.getElementById('infos').children[1].innerHTML = '<p><b>Version: </b>' + bridgeVersion + '</p>';

    function fetchPluginUpdates(label, name, version)
    {
        return new Promise(async function(resolve) {

            var newestVersion = await fetchURL('http://syntex.sytes.net/smarthome/check-version?device=' + name, 10000);

            if(newestVersion != null)
            {
                label.innerHTML = '<p><b>Neuste Version: </b>' + newestVersion + '</p>';

                var installedVersion = versionCount(version);

                if(versionCount(newestVersion) > installedVersion)
                {
                    var updateButton = document.createElement('input');

                    updateButton.setAttribute('type', 'button');
                    updateButton.setAttribute('value', 'Bridge Aktualisieren ( v' + newestVersion + ' )');
                    updateButton.setAttribute('onclick', 'updateBridge(this)');
                    updateButton.setAttribute('style', 'margin-top: 20px');
                    updateButton.setAttribute('id', 'update-btn-bridge');

                    document.getElementsByClassName('main')[0].appendChild(updateButton);
                }
            }
            else
            {
                label.innerHTML = '<p><b>Neuste Version: </b>Fehler beim Laden</p>';
            }

            resolve(newestVersion);
        });
    }

    setTimeout(function()
    {
        fetchPluginUpdates(document.getElementById('infos').children[2], 'syntex', bridgeVersion).then(function(version) {

            if(version != null)
            {
                newestBVersion = version;
            }
        });

        fetchURL(window.location.origin + ':<%wPort%>/version', 10000).then(function(version) {

            if(version != null)
            {
                webhooksVersion = version;

                document.getElementById('infos').children[4].innerHTML = '<p><b>Version: </b>' + webhooksVersion + '</p>';

                fetchPluginUpdates(document.getElementById('infos').children[5], 'syntex', bridgeVersion).then(function(version) {

                    if(version != null)
                    {
                        newestWVersion = version;
                    }
                });
            }
            else
            {
                document.getElementById('infos').children[4].innerHTML = '<p><b>Version: </b>Fehler beim Laden</p>';
                document.getElementById('infos').children[5].innerHTML = '<p><b>Neuste Version: </b>Fehler beim Laden</p>';
            }
        });
    }, 500);

    function updateBridge(btn)
    {
        if(document.getElementById('updating') == null && document.getElementById('update-result') == null)
        {
            var pendingOverlay = createOverlay(1, 'updating', 'Update wird Installiert ..', 'purple');

            btn.parentElement.insertBefore(pendingOverlay, btn);

            setTimeout(function()
            {
                btn.style.opacity = 0;
                pendingOverlay.style.opacity = 1;
            }, 10);

            fetchURL('/update?version=' + newestBVersion, 120000).then(function(res) {

                if(res != null)
                {
                    if(res == 'Error')
                    {
                        var responseOverlay = createErrorOverlay('update-result', 'Update Fehlgeschlagen!');

                        btn.parentElement.insertBefore(responseOverlay, btn);

                        setTimeout(function()
                        {
                            pendingOverlay.style.opacity = 0;
                            responseOverlay.style.opacity = 1;
                        }, 10);
                        
                        setTimeout(function()
                        {
                            responseOverlay.style.opacity = 0;
                            btn.style.opacity = 1;
                        }, 4000);

                        setTimeout(function()
                        {
                            btn.parentElement.removeChild(pendingOverlay);
                            btn.parentElement.removeChild(responseOverlay);
                        }, 4300);
                    }
                    else if(res == 'Success')
                    {
                        setTimeout(function()
                        {
                            checkRestart().then(function(res) {

                                if(res)
                                {
                                    var responseOverlay = createSuccessOverlay('update-result', 'Update Erfolgreich!');

                                    btn.parentElement.insertBefore(responseOverlay, btn);

                                    setTimeout(function()
                                    {
                                        pendingOverlay.style.opacity = 0;
                                        responseOverlay.style.opacity = 1;
                                    }, 10);
                                    
                                    setTimeout(function()
                                    {
                                        responseOverlay.style.opacity = 0;
                                    }, 4000);

                                    setTimeout(function()
                                    {
                                        btn.parentElement.removeChild(responseOverlay);
                                        btn.parentElement.removeChild(pendingOverlay);
                                        btn.parentElement.removeChild(btn);
                                    }, 4300);

                                    setTimeout(function()
                                    {
                                        location.reload();
                                    }, 4600);
                                }
                            });
                        }, 3000);
                    }
                }
                else
                {
                    var responseOverlay = createErrorOverlay('update-result', 'Keine Verbindung zum Gerät!');

                    btn.parentElement.insertBefore(responseOverlay, btn);

                    setTimeout(function()
                    {
                        pendingOverlay.style.opacity = 0;
                        responseOverlay.style.opacity = 1;
                    }, 10);
                
                    setTimeout(function()
                    {
                        responseOverlay.style.opacity = 0;
                        btn.style.opacity = 1;
                    }, 4000);

                    setTimeout(function()
                    {
                        btn.parentElement.removeChild(responseOverlay);
                        btn.parentElement.removeChild(pendingOverlay);
                    }, 4300);
                }
            });
        }
    }

    function updateWebhooks(btn)
    {
        if(document.getElementById('updating') == null && document.getElementById('update-result') == null)
        {
            var pendingOverlay = createOverlay(1, 'updating', 'Update wird Installiert ..', 'purple');

            btn.parentElement.insertBefore(pendingOverlay, btn);

            setTimeout(function()
            {
                btn.style.opacity = 0;
                pendingOverlay.style.opacity = 1;
            }, 10);

            fetchURL(window.location.origin + ':<%wPort%>/update?version=' + newestWVersion, 120000).then(function(res) {

                if(res != null)
                {
                    if(res == 'Error')
                    {
                        var responseOverlay = createErrorOverlay('update-result', 'Update Fehlgeschlagen!');

                        btn.parentElement.insertBefore(responseOverlay, btn);

                        setTimeout(function()
                        {
                            pendingOverlay.style.opacity = 0;
                            responseOverlay.style.opacity = 1;
                        }, 10);
                        
                        setTimeout(function()
                        {
                            responseOverlay.style.opacity = 0;
                            btn.style.opacity = 1;
                        }, 4000);

                        setTimeout(function()
                        {
                            btn.parentElement.removeChild(pendingOverlay);
                            btn.parentElement.removeChild(responseOverlay);
                        }, 4300);
                    }
                    else if(res == 'Success')
                    {
                        setTimeout(function()
                        {
                            checkRestart().then(function(res) {

                                if(res)
                                {
                                    var responseOverlay = createSuccessOverlay('update-result', 'Update Erfolgreich!');

                                    btn.parentElement.insertBefore(responseOverlay, btn);

                                    setTimeout(function()
                                    {
                                        pendingOverlay.style.opacity = 0;
                                        responseOverlay.style.opacity = 1;
                                    }, 10);
                                    
                                    setTimeout(function()
                                    {
                                        responseOverlay.style.opacity = 0;
                                    }, 4000);

                                    setTimeout(function()
                                    {
                                        btn.parentElement.removeChild(pendingOverlay);
                                        btn.parentElement.removeChild(responseOverlay);
                                        btn.parentElement.removeChild(btn);
                                    }, 4300);

                                    setTimeout(function()
                                    {
                                        location.reload();
                                    }, 4600);
                                }
                            });
                        }, 3000);
                    }
                }
                else
                {
                    var responseOverlay = createErrorOverlay('update-result', 'Keine Verbindung zum Gerät!');

                    btn.parentElement.insertBefore(responseOverlay, btn);

                    setTimeout(function()
                    {
                        pendingOverlay.style.opacity = 0;
                        responseOverlay.style.opacity = 1;
                    }, 10);
                
                    setTimeout(function()
                    {
                        responseOverlay.style.opacity = 0;
                        btn.style.opacity = 1;
                    }, 4000);

                    setTimeout(function()
                    {
                        btn.parentElement.removeChild(pendingOverlay);
                        btn.parentElement.removeChild(responseOverlay);
                    }, 4300);
                }
            });
        }
    }

</script>
<script>
    
    function restartBridge(btn)
    {
        if(document.getElementById('restarting') == null && document.getElementById('restart-result') == null)
        {
            console.log('CREATE OVERLAY');
            var o = createPendingOverlay('restarting', 'Neustart ..');
            console.log(o);
            showOverlay(btn, o);

            fetchURL('/restart', 10000).then(function(restart) {

                if(restart == null || restart == 'Error')
                {
                    //showOverlay(btn, createErrorOverlay('restart-result', 'Neustart Fehlgeschlagen!'));
                    //removeOverlays(btn, 4000);
                }
                else if(restart == 'Success')
                {
                    setTimeout(function()
                    {
                        checkRestart().then(function(restartCheck) {

                            if(restartCheck)
                            {
                                //showOverlay(btn, createSuccessOverlay('restart-result', 'Neustart Erfolgreich!'));
                                //removeOverlays(btn, 4000);
                            
                                setTimeout(function()
                                {
                                    location.reload();
                                }, 4600);
                            }
                        });
                    }, 3000);
                }
            });
        }
    }

</script>