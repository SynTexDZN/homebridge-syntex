<html>
	<body ontouchstart="">
		<div id="content">
			<title>%menu.debug%: %menu.settings%</title>
			<script type="module">

				import { PageManager } from '/js/page-manager.js';

				window.PageManager = PageManager;

				PageManager.setHeader('%menu.debug%', '%menu.settings%');

				var main = document.createElement('div');

				main.style.display = 'flex';

				main.innerHTML = '<input type="button" value="%menu.back%" onclick="Essentials.leavePage(' + "'/bridge'" + ')"><div style="display: block; width: 100%; margin-left: 20px"><input id="save-btn" type="submit" form="config-editor" value="%general.save%"></div>';

				PageManager.setFooter(main);
				PageManager.showFooter();

			</script>
			<div class="main" style="margin-bottom: 100px">
				<form id="config-editor" onsubmit="event.preventDefault(); saveConfig()"></form>
			</div>
			<script type="module">

				import { Query } from '/js/query.js';
				import { Essentials } from '/js/essentials.js';

				Query.SETUP(Essentials);
				Essentials.SETUP(Query, Preloader);

				window.Query = Query;
				window.Essentials = Essentials;

				window.configTemplate = {
					/*port : { default : 1711, type : 'text', name : 'Port' }, // TODO: Add Language Translation
					language : { default : "us", type : 'text', name : 'Sprache' },*/
					debug : { default : false, type : 'button', name : '%debug.settings.debug%' },
					remote : { default : true, type : 'button', name : '%debug.settings.remote%' }/*,
					cacheDirectory : { default : "/var/homebridge/SynTex/settings", type : 'text', name : 'Cache Pfad' },
					logDirectory : { default : "/var/homebridge/SynTex/log", type : 'text', name : 'Log Pfad' },
					automationDirectory : { default : "/var/homebridge/SynTex/automation", type : 'text', name : 'Automation Pfad' }*/
				};

				window.appSettingsTemplate = {
					betaPluginVersions : { default : false, type : 'button', name : '%debug.settings.beta_access%' },
					expertMode : { default : false, type : 'button', name : '%bridge.expert_mode%' },
					topBar : { default : false, type : 'button', name : '%debug.settings.top_bar%' }
				};

				loadBridgeConfig().then((config) => {

					renderGUI(config);

				Preloader.finish();
				});

			</script>
			<script>

				function loadBridgeConfig()
				{
					return new Promise((resolve) => {

						Query.complexFetch('/serverside/config', 5000, 2, {}, false).then((c) => {
							
							try
							{
								config = JSON.parse(c);

								resolve(config);
							}
							catch(e)
							{
								console.error(e);

								resolve(null);
							}
						});
					});
				}

				function renderGUI(config)
				{
					createFormInputs('%debug.settings.bridge_settings%', configTemplate, config);

					try
					{
						createFormInputs('%debug.settings.app_settings%', appSettingsTemplate, AppSettings.getSettings());
					}
					catch(e)
					{
						console.error(e);
					}
				}

				function createFormInputs(title, template, settings)
				{
					var group = document.createElement('div'), groupName = document.createElement('h2');

					group.className = 'type-container';

					groupName.className = 'title-container';
					groupName.innerHTML = title;
					groupName.style.marginBottom = '40px';

					group.appendChild(groupName);

					for(const i in template)
					{
						var container = document.createElement('div'), html = '<p><b>' + template[i].name + ': <input name="' + i + '" type="' + template[i].type + '" ';

						if(template[i].type == 'button')
						{
							html += 'value="' + ((settings[i] || template[i].default) == true ? '%characteristics.boolean.active%' : '%characteristics.boolean.inactive%') + '" orginal-value="' + ((settings[i] || template[i].default) == true ? '%characteristics.boolean.active%' : '%characteristics.boolean.inactive%') + '" class="' + ((settings[i] || template[i].default) == true ? 'white' : 'outline') + '" onclick="switchFormButton(this); Essentials.promoteSubmitButton(this, ' + "'save-btn'" + ')" style="max-width: 150px; border-width: 3px">';
						}
						else
						{
							html += 'value="' + (settings[i] || template[i].default) + '" oninput="Essentials.promoteSubmitButton(this, ' + "'save-btn'" + ')" style="max-width: 325px">';
						}

						html += '</b></p>';

						container.innerHTML = html;

						group.appendChild(container);
					}

					document.getElementById('config-editor').appendChild(group);
				}

				function saveConfig()
				{
					var appSettingsForm = document.getElementsByClassName('type-container')[1].children;

					Essentials.showOverlay(document.getElementById('save-btn'), Essentials.createPendingOverlay('saving', '%device.save% ..'));

					for(var i = 1; i < appSettingsForm.length; i++)
					{
						if(appSettingsForm[i].getElementsByTagName('input')[0].getAttribute('type') == 'button')
						{
							AppSettings.setItem(appSettingsForm[i].getElementsByTagName('input')[0].getAttribute('name'), appSettingsForm[i].getElementsByTagName('input')[0].getAttribute('value') == '%characteristics.boolean.active%');
						}
						else
						{
							AppSettings.setItem(appSettingsForm[i].getElementsByTagName('input')[0].getAttribute('name'), appSettingsForm[i].getElementsByTagName('input')[0].getAttribute('value'));
						}
					}

					realTimeUpdate();

					Essentials.showOverlayDelay(document.getElementById('save-btn'), Essentials.createSuccessOverlay('save-result', '%device.saved%!'), 200);

					document.getElementById('save-btn').classList.remove('pulse');

					Essentials.removeOverlaysDelay(document.getElementById('save-btn'), 3800, true);
				}

				function realTimeUpdate()
				{
					if(window.location.protocol != 'https:')
					{
						if(AppSettings.getItem('topBar') == false)
						{
							document.getElementById('top-menu').classList.add('hidden');
						}
						else if(AppSettings.getItem('topBar') == true)
						{
							document.getElementById('top-menu').classList.remove('hidden');
						}
					}
				}

				function switchFormButton(btn)
				{
					if(btn.hasAttribute('class') && btn.getAttribute('class') == 'white')
					{
						btn.setAttribute('class', 'outline');
						btn.setAttribute('value', '%characteristics.boolean.inactive%');
					}
					else
					{
						btn.setAttribute('class', 'white');
						btn.setAttribute('value', '%characteristics.boolean.active%');
					}
				}

			</script>
		</div>
	</body>
</html>