<html>
    <title>Dashboard: Automation</title>
    <body>
        <h1 style="margin-bottom: 0; margin-top: 32px">Dashboard</h1>
        <div class="main" style="margin-top: 10px; margin-bottom: 100px">
            <p style="margin-bottom: 100px; margin-top: 20px">Automation</p>
            <div class="main" style="margin-top: 10px; margin-bottom: 20px; display: flex">
                <input class="white" type="button" value="GERÄTE" onclick="window.location.href='/'" style="margin-right: 20px">
                <input class="white" type="button" value="BRIDGE" onclick="window.location.href='/bridge'">
            </div>
            <div class="main" style="margin-top: 10px; display: flex">
                <input class="white" type="button" value="AUTOMATION" onclick="window.location.href='/automations'" style="margin-right: 20px" disabled>
                <input class="white" type="button" value="LOG" onclick="window.location.href='/log'">
            </div>
        </div>
        <div class="main" id="automations" style="margin-bottom: 100px"></div>
        <div class="bottom" style="margin: 0 auto; width: 100%; max-width: 400px">
            <input class="gradient-orange" type="button" value="+ Automation Hinzufügen" onclick="window.location.href='/automations?new'">
        </div>
    </body>
</html>
<script>

    var data = {
        motion: {
            active : { text : 'Bewegung', color : 'hsl(280, 75%, 55%)' },
            inactive : { text : 'Bereit', color : 'hsl(150, 75%, 55%)' }
        },
        contact: {
            active : { text : 'Geöffnet', color : 'hsl(350, 75%, 55%)' },
            inactive : { text : 'Zu', color : 'hsl(150, 75%, 55%)' }
        },
        relais: {
            active : { text : 'An', color : 'hsl(18, 75%, 55%)' },
            inactive : { text : 'Aus', color : 'hsl(205, 75%, 55%)' }
        },
        switch: {
            active : { text : 'An', color : 'hsl(18, 75%, 55%)' },
            inactive : { text : 'Aus', color : 'hsl(205, 75%, 55%)' }
        },
        rain: {
            active : { text : 'Regen', color : 'hsl(220, 75%, 55%)' },
            inactive : { text : 'Trocken', color : 'hsl(150, 75%, 55%)' }
        },
        statelessswitch: {
            active : { text : 'Aktiv', color : 'hsl(205, 75%, 55%)' },
            inactive : { text : 'Bereit', color : 'hsl(150, 75%, 55%)' }
        },
        temperature: { text : '°C', colorRange : [220, 0], valueRange : [18, 26] },
        humidity: { text : '%', color : 'hsl(140, 75%, 55%)', colorRange : [0, 280], valueRange : [0, 100] },
        light: { text : 'Lux', color : 'hsl(40, 85%, 85%)', colorRange : [25, 85], valueRange : [0, 1000] }
    };

    var automations = [];

    head.load('/js/query.js', async function()
    {
        automations = JSON.parse(await complexFetch('/serverside/automations', 10000, 3, {}, false));

        createAutomationPanels();
    });

    function createAutomationPanels()
    {
        for(var i = 0; i < automations.length; i++)
        {
            var title = document.createElement('h2');

            title.setAttribute('style', 'width: fit-content; margin-top: 0; border: none; padding-left: 16px');
            title.innerHTML = automations[i].name + ' • ' + (automations[i].active ? 'Aktiv' : 'Deaktiviert');

            var titleContainer = document.createElement('div');

            titleContainer.setAttribute('class', 'title-container');

            titleContainer.appendChild(title);

            var typeContainer = document.createElement('button');

            typeContainer.setAttribute('style', 'height: auto; box-shadow: none');
            typeContainer.setAttribute('class', 'type-container');
            typeContainer.appendChild(titleContainer);

            if(i == 0)
            {
                typeContainer.style.marginTop = '0';
            }

            var panel = document.createElement('button');
            var column = document.createElement('div');
            var category = document.createElement('div');

            column.style.display = 'flex';
            column.style.background = 'rgb(60, 60, 75)';

            category.innerHTML = 'AUSLÖSER';
            category.style.minWidth = '120px';
            category.style.maxWidth = '120px';
            category.style.background = 'rgb(80, 80, 90)';
            category.style.padding = '13px 18px 12px 18px';

            column.appendChild(category);

            for(var j = 0; j < automations[i].trigger.length; j++)
            {
                var row = document.createElement('div');
                var src = automations[i].trigger[j].type;
                var val = automations[i].trigger[j].value == 'true' ? data[automations[i].trigger[j].type].active.text : automations[i].trigger[j].value == 'false' ? data[automations[i].trigger[j].type].inactive.text : automations[i].trigger[j].value;

                if(automations[i].trigger[j].type == 'temperature')
                {
                    src = 'climate';
                }

                if(automations[i].trigger[j].name && automations[i].trigger[j].operation && automations[i].trigger[j].value)
                {
                    row.innerHTML = '<img style="filter: invert(85%) sepia(10%) hue-rotate(200deg); height: 20px; margin-right: 10px; position: relative; top: -16px; margin-bottom: -20px" src="/img/accessory/' + src + '.png">' + automations[i].trigger[j].name + ' ' + automations[i].trigger[j].operation + ' ' + val;
                }
            
                row.style.padding = '13px 18px 12px 18px';
                row.style.wordBreak = 'break-all';

                column.appendChild(row);
            }

            panel.appendChild(column);

            if(automations[i].condition && automations[i].condition.length > 0)
            {
                var column = document.createElement('div');
                var category = document.createElement('div');

                column.style.display = 'flex';
                column.style.marginTop = '3px';
                column.style.background = 'rgb(60, 60, 75)';

                category.innerHTML = 'BEDINGUNG';
                category.style.minWidth = '120px';
                category.style.maxWidth = '120px';
                category.style.background = 'rgb(80, 80, 90)';
                category.style.padding = '13px 18px 12px 18px';

                column.appendChild(category);

                for(var j = 0; j < automations[i].condition.length; j++)
                {
                    var row = document.createElement('div');
                    var src = automations[i].condition[j].type;
                    var val = automations[i].condition[j].value == 'true' ? data[automations[i].condition[j].type].active.text : automations[i].condition[j].value == 'false' ? data[automations[i].condition[j].type].inactive.text : automations[i].condition[j].value;

                    if(automations[i].condition[j].type == 'temperature')
                    {
                        src = 'climate';
                    }

                    if(automations[i].condition[j].name && automations[i].condition[j].operation && automations[i].condition[j].value)
                    {
                        row.innerHTML = '<img style="filter: invert(85%) sepia(10%) hue-rotate(200deg); height: 20px; margin-right: 10px; position: relative; top: -16px; margin-bottom: -20px" src="/img/accessory/' + src + '.png">' + automations[i].condition[j].name + ' ' + automations[i].condition[j].operation + ' ' + val;
                    }

                    row.style.padding = '13px 18px 12px 18px';
                    row.style.wordBreak = 'break-all';

                    column.appendChild(row);
                }

                panel.appendChild(column);
            }

            var column = document.createElement('div');
            var category = document.createElement('div');

            column.style.display = 'flex';
            column.style.marginTop = '3px';
            column.style.background = 'rgb(60, 60, 75)';

            category.innerHTML = 'AUSFÜHREN';
            category.style.minWidth = '120px';
            category.style.maxWidth = '120px';
            category.style.background = 'rgb(80, 80, 90)';
            category.style.padding = '13px 18px 12px 18px';

            column.appendChild(category);

            for(var j = 0; j < automations[i].result.length; j++)
            {
                var row = document.createElement('div');
                var src = automations[i].result[j].type;
                var val = automations[i].result[j].value == 'true' ? data[automations[i].result[j].type].active.text : automations[i].result[j].value == 'false' ? data[automations[i].result[j].type].inactive.text : automations[i].result[j].value;

                if(automations[i].result[j].type == 'temperature')
                {
                    src = 'climate';
                }

                if(automations[i].result[j].name && automations[i].result[j].operation && automations[i].result[j].value)
                {
                    row.innerHTML = '<img style="filter: invert(85%) sepia(10%) hue-rotate(200deg); height: 20px; margin-right: 10px; position: relative; top: -16px; margin-bottom: -20px" src="/img/accessory/' + src + '.png">' + automations[i].result[j].name + ' ' + automations[i].result[j].operation + ' ' + val;
                }
                else if(automations[i].result[j].url)
                {
                    row.innerHTML = '<img style="filter: invert(85%) sepia(10%) hue-rotate(200deg); height: 20px; margin-right: 10px; position: relative; top: -16px; margin-bottom: -20px" src="/img/link.png">"' + automations[i].result[j].url + '"';
                }

                row.style.padding = '13px 18px 12px 18px';
                row.style.wordBreak = 'break-all';

                column.appendChild(row);
            }

            panel.appendChild(column);

            panel.setAttribute('style', 'text-align: left; line-height: 25px; padding: 0; pointer-events: none; height: auto; color: rgb(220, 220, 230); overflow: hidden; background: rgb(40, 40, 55)');
            
            typeContainer.appendChild(panel);
            document.getElementById('automations').appendChild(typeContainer);
        }
    }

</script>