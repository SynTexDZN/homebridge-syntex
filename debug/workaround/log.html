<html>
	<body ontouchstart="">
		<div id="content" style="padding-bottom: 50px">
			<title>Dashboard: Log</title>
			<script type="module">

				import { PageManager } from '/js/page-manager.js';

				window.PageManager = PageManager;

				PageManager.setHeader('Dashboard', 'Log');

			</script>
			<div class="main" style="margin-bottom: 100px">
				<div class="main" style="margin-bottom: 20px; display: flex">
					<input class="white" type="button" value="GERÄTE" onclick="Essentials.leavePage('/')" style="margin-right: 20px">
					<input class="white" type="button" value="BRIDGE" onclick="Essentials.leavePage('/bridge')">
				</div>
				<div class="main" style="margin-top: 10px; display: flex">
					<input class="white" type="button" value="AUTOMATION" id="a" onclick="Essentials.leavePage('/automation/')" style="margin-right: 20px">
					<input class="white" type="button" value="LOG" onclick="Essentials.leavePage('/log')" disabled>
				</div>
			</div>
			<div class="main" style="margin-bottom: 100px">
				<div id="widgets" style="margin-bottom: 20px; display: grid; grid-template-columns: calc(33% - 13px) calc(34% - 14px) calc(33% - 13px); grid-gap: 20px">
					<div class="widget">
						<button class="widget-left">Fehler</button>
						<button class="widget-right gradient-red" id="error-widget">-</button>
					</div>
					<div class="widget">
						<button class="widget-left">Warnung</button>
						<button class="widget-right gradient-orange" id="warn-widget">-</button>
					</div>
					<div class="widget">
						<button class="widget-left">Info</button>
						<button class="widget-right gradient-yellow" id="info-widget">-</button>
					</div>
					<div class="widget">
						<button class="widget-left">Lesen</button>
						<button class="widget-right gradient-blue" id="read-widget">-</button>
					</div>
					<div class="widget">
						<button class="widget-left">Update</button>
						<button class="widget-right gradient-cyan" id="update-widget">-</button>
					</div>
					<div class="widget">
						<button class="widget-left">Erfolg</button>
						<button class="widget-right gradient-green" id="success-widget">-</button>
					</div>
				</div>
				<div class="widget" style="display: none">
					<button class="widget-left">Debug</button>
					<button class="widget-right gradient-purple" id="debug-widget">-</button>
				</div>
			</div>
			<form onsubmit="event.preventDefault(); searchLog();" class="main" style="margin-bottom: 32px">
				<div style="margin-bottom: 20px; display: flex">
					<input id="search-params" type="text" placeholder="Such-Parameter" style="margin-right: 20px">
					<input id="search-btn" class="gradient-blue loading-loop" type="submit" value="Suchen" onclick="searchLog()" style="max-width: 200px">
				</div>
				<div style="display: flex" id="filter">
					<input type="button" value="Ohne Filter" onclick="clearSearch()" style="max-width: 200px">
				</div>
			</form>
			<p id="log-counter" class="loading-loop" style="margin-bottom: 100px"><b>Gefundene Elemente: </b>Laden ..</p>
			<div id="log-container" class="main"></div>
			<script type="module">

				// NOTE: Init

				import { Query } from '/js/query.js';
				import { Essentials } from '/js/essentials.js';
				import { Replacer } from '/js/replace-select.js';

				Query.SETUP(Essentials);
				Essentials.SETUP(Query, Preloader);

				window.Query = Query;
				window.Essentials = Essentials;
				window.Replacer = Replacer;

				loadPluginData().then(() => {
					
					renderGUI();
					Preloader.finish();
					loadLogs();
				});

			</script>
			<script>

				// NOTE: Load Plugin Data

				window.plugins = {};

				function loadPluginData()
				{
					return new Promise((resolve) => {

						Query.complexFetch('/serverside/plugins', 5000, 2, {}, false).then((p) => {

							try
							{
								plugins = JSON.parse(p);

								resolve(true);
							}
							catch(e)
							{
								console.error(e);

								resolve(false);
							}
						});
					});
				}

			</script>
			<script>

				// NOTE: Render GUI Elements

				function renderGUI()
				{
					var filter = document.createElement('div');

					filter.className = 'custom-select';
					filter.innerHTML = '<select onchange="searchLog()"><option value="all">Alle Level</option><option value="debug">Debug</option><option value="success">Erfolg</option><option value="update">Update</option><option value="read">Lesen</option><option value="info">Info</option><option value="warn">Warnung</option><option value="error">Fehler</option></select>';
					filter.style.width = '100%';
					filter.style.marginRight = '20px';

					document.getElementById('filter').insertBefore(Replacer.createSelectMenu(filter), document.getElementById('filter').children[0]);

					for(const id in plugins)
					{
						if(plugins[id].config != null && plugins[id].config.logDirectory != null)
						{
							var logContainer = document.createElement('div');

							logContainer.setAttribute('id', id);

							var logTitle = document.createElement('h2');

							logTitle.innerHTML = '• ' + plugins[id].name.replace('SynTex', '') + ' Log •';

							if(plugins[id].name == 'SynTex')
							{
								logTitle.innerHTML = '• Bridge Log •';
							}

							var logWindow = document.createElement('div');

							logWindow.innerHTML = 'Laden ..';
							logWindow.className = 'scrollarea loading-loop';
							logWindow.style.height = '700px';
							logWindow.style.maxHeight = '700px';

							logContainer.appendChild(logTitle);
							logContainer.appendChild(logWindow);

							document.getElementById('log-container').appendChild(logContainer);
						}
					}
				}

			</script>
			<script>

				// NOTE: Load Logs

				window.logs = {};
				window.logCounter = 0;
				window.levelCounter = {
					success : 0,
					update : 0,
					read : 0,
					info : 0,
					warn : 0,
					error : 0,
					debug : 0
				};

				function loadLogs(pluginID)
				{
					return new Promise((resolve) => {

						Query.complexFetch('/serverside/log', 10000, 2, {}, false).then(function(l) {

							try
							{
								logs = JSON.parse(l);

								for(const id in plugins)
								{
									if(plugins[id].config != null && plugins[id].config.logDirectory != null && (pluginID == null || pluginID == plugins[id].alias))
									{
										if(logs[plugins[id].alias] != null)
										{
											logs[plugins[id].alias] = JSON.parse(logs[plugins[id].alias]);

											logCounter += logs[plugins[id].alias].length;

											for(const i in logs[plugins[id].alias])
											{
												if(logs[plugins[id].alias][i].l != null)
												{
													levelCounter[logs[plugins[id].alias][i].l.toLowerCase()]++;
												}
											}

											renderLogs(id, true);

											//renderLogs(document.getElementById(plugins[id].alias), logs[plugins[id].alias], null);
										}
										else if(document.getElementById(id).getElementsByClassName('reload-button')[0] == null)
										{
											var reloadButton = document.createElement('h2');

											reloadButton.innerHTML = '↻ Neu Laden';
											reloadButton.className = 'reload-button';
											reloadButton.setAttribute('style', 'margin-top: -58px; bottom: 321px; height: 58px; font-size: 28px');
											reloadButton.setAttribute('onclick', 'loadLogs("' + plugins[id].alias + '")');

											document.getElementById(id).appendChild(reloadButton);

											setTimeout(() => {

												document.getElementById(id).getElementsByClassName('reload-button')[0].style.opacity = 1;

											}, 0);
										}
									}
								}

								document.getElementById('log-counter').innerHTML = '<b>Gefundene Elemente: </b>' + logCounter;

								document.getElementById('error-widget').innerHTML = levelCounter['error'];
								document.getElementById('warn-widget').innerHTML = levelCounter['warn'];
								document.getElementById('info-widget').innerHTML = levelCounter['info'];
								document.getElementById('read-widget').innerHTML = levelCounter['read'];
								document.getElementById('update-widget').innerHTML = levelCounter['update'];
								document.getElementById('success-widget').innerHTML = levelCounter['success'];

								if(levelCounter['debug'] > 0)
								{
									document.getElementById('debug-widget').parentElement.style.display = '';
									document.getElementById('debug-widget').innerHTML = levelCounter['debug'];
								}
							}
							catch(e)
							{
								console.error(e);
							}

							resolve();
						});
					});
				}

			</script>
			<style>

				.inline-button
				{
					text-align: center;
					padding: 5px;
					position: relative;
					margin-top: -5px;
					margin-bottom: -5px;
					box-sizing: border-box;
					width: auto;
				}

				.log-message
				{
					line-height: 30px;
					padding: 5px 10px;
					border-radius: 0 0 8px 8px;
				}

				.log-title
				{
					display: flex;
					background:rgb(40, 40, 60);
					border-radius: 8px 8px 0 0;
					padding: 10px;
					font-size: 14px;
				}

				.log-title div:first-of-type
				{
					margin-right: auto;
				}

				.log-title div:last-of-type
				{
					margin-left: auto;
					text-align: right;
					width: calc(100% - 140px);
				}

				.log-title div:first-of-type, .log-title div:last-of-type
				{
					height: min-content;
					margin: auto 0;
				}

				@media only screen and (max-width: 1176px)
				{
					.log-title
					{
						border-radius: 15px 15px 0 0;
						font-size: 16px;
						padding: 15px;
					}

					.log-message
					{
						border-radius: 0 0 15px 15px;
						padding: 10px 15px;
					}
				}

			</style>
			<script>

				// NOTE: Create Log Messages

				window.renderedLogs = {};

				function renderLogs(pluginID, clear)
				{
					var weekDays = ['So', 'Mo', 'Di', 'Mi', 'Do', 'Fr', 'Sa'];

					if(renderedLogs[pluginID] == null)
					{
						renderedLogs[pluginID] = 0;
					}

					if(clear)
					{
						document.getElementById(pluginID).getElementsByClassName('scrollarea')[0].innerHTML = '';
					}

					for(var i = 0; i < 20; i++)
					{
						if(logs[plugins[pluginID].alias][renderedLogs[pluginID]] != null)
						{
							var time = new Date(logs[plugins[pluginID].alias][renderedLogs[pluginID]].t * 1000);
							var level = logs[plugins[pluginID].alias][renderedLogs[pluginID]].l;
							var message = logs[plugins[pluginID].alias][renderedLogs[pluginID]].m.replace(new RegExp(/\[/, 'g'), "'").replace(new RegExp(/\]/, 'g'), "'").replace('HomeKit Status von', '');

							var log = document.createElement('div');

							log.className = 'log';

							if(renderedLogs[pluginID] != logs[plugins[pluginID].alias].length - 1)
							{
								log.style.marginBottom = '20px';
							}

							var logTitle = document.createElement('div');

							logTitle.className = 'log-title';

							if(document.getElementById(level.toLowerCase() + '-widget') != null && document.getElementById(level.toLowerCase() + '-widget').classList[1] != null)
							{
								logTitle.classList.add(document.getElementById(level.toLowerCase() + '-widget').classList[1]);
							}

							var logTime = document.createElement('div');

							logTime.innerHTML = weekDays[time.getDay()] + ' ' + ('0' + time.getHours()).slice(-2) + ':' + ('0' + time.getMinutes()).slice(-2) + ':' + ('0' + time.getSeconds()).slice(-2);
							logTime.style.width = '140px';

							logTitle.appendChild(logTime);
							/*
							var logLevel = document.createElement('div');

							logLevel.innerHTML = level.toUpperCase();

							logTitle.appendChild(logLevel);
							*/
							var logSender = document.createElement('div');

							if(message.includes(' ( ') && message.includes(' )'))
							{
								logSender.innerHTML = message.split(' ( ')[1].split(' )')[0];
							}
							else
							{
								logSender.innerHTML = 'Bridge';
							}

							logTitle.appendChild(logSender);

							log.appendChild(logTitle);

							var logMessage = document.createElement('div');

							logMessage.className = 'log-message'
							logMessage.innerHTML = message;

							if(logSender.innerHTML != 'Bridge')
							{
								logMessage.innerHTML = message.replace(' ( ' + logSender.innerHTML + ' )', '');
							}

							log.appendChild(logMessage);
							
							if(clear)
							{
								document.getElementById(pluginID).getElementsByClassName('scrollarea')[0].appendChild(log);
							}
							else
							{
								document.getElementById(pluginID).getElementsByClassName('scrollarea')[0].insertBefore(log, document.getElementById(pluginID).getElementsByClassName('load-more-btn')[0]);
							}

							renderedLogs[pluginID]++;
						}
						else if(document.getElementById(pluginID).getElementsByClassName('load-more-btn')[0] != null)
						{
							document.getElementById(pluginID).getElementsByClassName('load-more-btn')[0].parentElement.removeChild(document.getElementById(pluginID).getElementsByClassName('load-more-btn')[0]);
						}
					}

					if(logs[plugins[pluginID].alias][renderedLogs[pluginID]] != null && logs[plugins[pluginID].alias].length > 20 && document.getElementById(pluginID).getElementsByClassName('load-more-btn')[0] == null)
					{
						var loadMore = document.createElement('div');

						loadMore.innerHTML = '<button class="white" style="margin: 0 auto; min-width: 30%; width: auto!important; padding: 5px 30px" onclick="renderLogs(' + "'" + pluginID + "'" + ')">Mehr Laden</button>';
						loadMore.style.display = 'flex';
						loadMore.className = 'load-more-btn';

						document.getElementById(pluginID).getElementsByClassName('scrollarea')[0].appendChild(loadMore);
					}
				}

			</script>
			<scirpt>



			</scirpt>
			<script>
				/*
				async function clearSearch()
				{
					document.getElementById('search-btn').value = 'Suchen ..';
					document.getElementById('search-params').value = '';
					document.getElementById('search-level').value = '';

					await Essentials.newTimeout(500);

					for(var i = 0; i < Object.keys(logs).length; i++)
					{
						createLog(document.getElementById(Object.keys(logs)[i]), logs[Object.keys(logs)[i]], null);
					}

					document.getElementById('search-btn').value = 'Suchen';
				}

				async function searchLog()
				{
					var params = document.getElementById('search-params').value;
					var level = document.getElementById('search-level').value;
					var search = null;

					counter = 0;
					document.getElementById('search-btn').value = 'Suchen ..';

					await Essentials.newTimeout(500);

					if(level != '' && params != '')
					{
						search = [level, params];
					}
					else if(params != '')
					{
						search = [null, params];
					}
					else if(level != '')
					{
						search = [level, null];
					}

					for(var i = 0; i < Object.keys(logs).length; i++)
					{
						createLog(document.getElementById(Object.keys(logs)[i]), logs[Object.keys(logs)[i]], search);

						var lastChars = (document.getElementById(Object.keys(logs)[i]).innerHTML.slice(-2).match(/\n/g) || []).length;

						if(lastChars > 0)
						{
							document.getElementById(Object.keys(logs)[i]).innerHTML = document.getElementById(Object.keys(logs)[i]).innerHTML.slice(0, -(document.getElementById(Object.keys(logs)[i]).innerHTML.slice(-2).match(/\n/g) || []).length);
						}
					}

					document.getElementById('log-counter').innerHTML = '<b>Gefundene Elemente: </b>' + counter;
					document.getElementById('search-btn').value = 'Suchen';
				}

				function createLog(element, log, show)
				{
					var filterLog = '';

					try
					{
						log = JSON.parse(log);
					}
					catch(e)
					{
						log = [];

						console.error(e);
					}

					for(var i = 0; i < log.length; i++)
					{
						var levels = ['success', 'update', 'read', 'info', 'warn', 'error', 'debug'];
						var level = log[i].l.toUpperCase();
						var time = new Date(log[i].t * 1000);
						var message = log[i].m;
						var displayEntry = false;

						if(show != null)
						{
							if(show[0] != null && show[1] != null)
							{
								if(show[0].toUpperCase() == level && message.toUpperCase().includes(show[1].toUpperCase()))
								{
									displayEntry = true;
								}
							}
							else if(show[0] != null && show[0].toUpperCase() == level)
							{
								displayEntry = true;
							}
							else if(show[1] != null && message.toUpperCase().includes(show[1].toUpperCase()))
							{
								displayEntry = true;
							}
						}
						else
						{
							displayEntry = true;
						}

						if(displayEntry)
						{
							var weekDays = ['So', 'Mo', 'Di', 'Mi', 'Do', 'Fr', 'Sa'];

							filterLog += weekDays[time.getDay()] + ' ' + ('0' + time.getHours()).slice(-2) + ':' + ('0' + time.getMinutes()).slice(-2) + ':' + ('0' + time.getSeconds()).slice(-2) + ' > [' + level + '] ';
							/*
							if(level == 'UPDATE')
							{
								filterLog += ' > ' + message.split('$')[0] + "\n'" + message.split('$')[1] + "' geändert zu '" + message.split('$')[2] + "'";
							}
							else if(level == 'READ')
							{
								filterLog += ' > ' + message.split('$')[0] + "\n'" + message.split('$')[1] + "' Status ist '" + message.split('$')[2] + "'";
							}
							else
							{*//*
								if(message.includes('( ') && message.includes(' )'))
								{
									filterLog += ' > ' + message.split('( ')[1].split(' )')[0] + '\n' + message.replace(new RegExp(/\[/, 'g'), "'").replace(new RegExp(/\]/, 'g'), "'").replace('(' + message.split('(')[1].split(')')[0] + ')', '');
								}
								else
								{
									filterLog += '\n' + message.replace(new RegExp(/\[/, 'g'), "'").replace(new RegExp(/\]/, 'g'), "'");
								}
							//}
							
							counter++;
						}
					}

					element.innerHTML = filterLog;
					document.getElementById('log-counter').innerHTML = '<b>Gefundene Elemente: </b>' + counter;
				}
				*/
			</script>
		</div>
	</body>
</html>