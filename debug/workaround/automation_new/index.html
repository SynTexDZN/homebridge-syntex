<html>
	<body ontouchstart="">
		<div id="content">
			<title>%general.dashboard%: %menu.automation%</title>
			<script type="module">

				if(Essentials.getURLParams('edit') != null)
				{
					PageManager.setHeader('%menu.automation%', Essentials.getURLParams('id') == null ? '%automation.create%' : '%general.loading% ..');

					var main = document.createElement('div');

					main.style.display = 'flex';

					main.innerHTML = '<input type="button" value="%menu.back%" onclick="closeEditor()"><div style="display: block; width: 100%; margin-left: 20px"><input id="save-btn" type="submit" form="editor-form" value="' + (Essentials.getURLParams('id') == null ? '%automation.create%' : '%automation.modify%') + '"></div>';

					PageManager.setFooter(main);
					PageManager.showFooter();
				}
				else
				{
					PageManager.setHeader('%general.dashboard%', '%menu.automation%');
					PageManager.hideFooter();
				}

			</script>
			<div id="main-menu">
				<button class="white" onclick="Essentials.leavePage('/')">%menu.devices%</button>
				<button class="white" onclick="Essentials.leavePage('/bridge')">%menu.bridge%</button>
				<button class="white" onclick="Essentials.leavePage('/automation')" disabled>%menu.automation%</button>
				<button class="white" onclick="Essentials.leavePage('/log')">%menu.log%</button>
			</div>
			<div id="overview" class="page">
				<div class="main" style="margin-bottom: 100px">
					<div id="widgets" class="two">
						<div class="widget">
							<button class="widget-left">%general.count%</button>
							<button class="widget-right gradient-blue" id="widget-counter">0</button>
						</div>
						<div class="widget">
							<button class="widget-left">%automation.active%</button>
							<button class="widget-right gradient-green" id="widget-active">-</button>
						</div>
						<div class="widget hidden">
							<button class="widget-left">%automation.network%</button>
							<button class="widget-right gradient-orange" id="widget-network">-</button>
						</div>
					</div>
					<div id="toolbar">
						<div id="groups">
							<button class="white" style="pointer-events: none">%automation.all_automations%</button>
						</div>
						<div style="display: flex; gap: 20px">
							<button id="view-button" class="image-button" onclick="switchView(this.getAttribute('view'), true)" view="horizontal">
								<img style="height: 100%; filter: invert(95%) sepia(10%) hue-rotate(200deg)" src="/img/list.png">
								<img style="height: 100%; filter: invert(95%) sepia(10%) hue-rotate(200deg); display: none; transform: scale(.8) rotate(90deg);" src="/img/list.png">
							</button>
							<div class="custom-select" style="width: 100%">
								<select id="sort" onchange="switchSort()">
									<option img="/img/sort-asc.png" value="alphabetical-asc">%sort.alphabetical%</option>
									<option img="/img/sort-desc.png" value="alphabetical-desc">%sort.alphabetical%</option>
									<option img="/img/sort-asc.png" value="id-asc">%sort.id%</option>
									<option img="/img/sort-desc.png" value="id-desc">%sort.id%</option>
									<option img="/img/sort-asc.png" value="activation-asc">%sort.activation%</option>
									<option img="/img/sort-desc.png" value="activation-desc">%sort.activation%</option>
								</select>
								<script>
	
									var sort = 'alphabetical-asc', select = document.getElementById('sort');
	
									if(Storage.getItem('automation-sort') != null)
									{
										sort = Storage.getItem('automation-sort');
									}
	
									for(var i = 0; i < select.children.length; i++)
									{
										if(select.children[i].getAttribute('value') == sort)
										{
											select.children[i].setAttribute('selected', '');
										}
									}
	
								</script>
							</div>
							<button id="add-button" class="image-button" onclick="openEditor(false)" view="list">
								<img src="/img/add.png" style="height: 100%; filter: invert(95%) sepia(10%) hue-rotate(200deg)">
							</button>
						</div>
					</div>
					<p id="no-accessories" style="display: none">%automation.no_accessories%</p>
					<p id="no-services" style="display: none">%automation.no_services%</p>
					<p id="no-automation" style="display: none">%automation.no_automation%</p>
					<div id="automation"></div>
				</div>
				<div class="bottom" style="margin: 0 auto; margin-bottom: 50px; width: 100%; max-width: 400px">
					<input id="devices-button-big" class="gradient-orange" type="button" value="%automation.to_devices% >" style="display: none" onclick="Essentials.leavePage('/')">
					<input id="add-button-big" class="gradient-orange" type="button" value="+ %automation.add_automation%" onclick="openEditor(false)">
				</div>
			</div>
			<div id="editor" class="page hidden">
				<form id="editor-form" class="main" onsubmit="event.preventDefault(); sendAutomation()">
					<div class="panel">
						<h2 class="title-container">%automation.infos%</h2>
						<div id="general" class="panel-content padding">
							<p style="margin: 0"><b>%general.id%: <input type="text" style="max-width: 150px; text-align: center" disabled></b></p>
							<p style="margin: 0" autofocus><b>%general.name%: <input pattern="[a-zA-ZäÄöÖüÜß0-9-#()&/ ]+" title="%pattern.letters_numbers_spaces_special%: # / ( )" required name="name" type="text" style="max-width: 325px"></b></p>
							<p style="margin: 0"><b>%general.group%: <input pattern="[a-zA-ZäÄöÖüÜß0-9-#()&/ ]+" title="%pattern.letters_numbers_spaces_special%: # / ( )" name="group" type="text" style="max-width: 325px"></b></p>
							<p style="margin: 0"><b>%automation.active%: <input value="%characteristics.boolean.active%" name="active" type="button" class="white" onclick="Essentials.switchBooleanButton(this)" style="max-width: 150px; border-width: 3px"></b></p>
						</div>
					</div>
					<div class="panel">
						<h2 class="title-container">%automation.trigger%</h2>
						<div id="trigger" class="panel-content">
							<div class="groups"></div>
							<div class="bottom">
								<button type="button" class="gradient-blue-green add-group-button icon-button left center compact" onclick="addGroup()">
									<div class="button-icon">
										<img class="icon-inverted" src="/img/add_light.png">
									</div>
									<div class="button-text">%automation.group%</div>
								</button>
								<button id="group-logic" type="button" class="white" onclick="switchLogic(this)" value="AND">%automation.and%</button>
								<button id="group-options" type="button" class="icon-button right center compact" onclick="openOptions('automation', this)">
									<div class="button-icon">
										<img class="icon-inverted" src="/img/settings.png">
									</div>
									<div class="button-text">%general.options%</div>
								</button>
							</div>
						</div>
					</div>
					<div class="panel">
						<h2 class="title-container">%automation.result%</h2>
						<div id="result" class="panel-content">
							<div class="blocks"></div>
							<button type="button" class="gradient-blue-green add-block-button icon-button left center compact" onclick="addBlock('result', document.getElementById('result').getElementsByClassName('blocks')[0])">
								<div class="button-icon">
									<img class="icon-inverted" src="/img/add_light.png">
								</div>
								<div class="button-text">%automation.block%</div>
							</button>
						</div>
					</div>
				</form>
			</div>
			<script type="module">

				window.data = {};
				window.services = [];

				loadData().then(() => renderGUI());

			</script>
			<script>

				function loadData()
				{
					return new Promise((resolve) => {

						Query.fetchURL('/serverside/automation_new', 3000).then((data) => {

							if(data != null)
							{
								try
								{
									window.data = JSON.parse(data);

									loadGroups();
									loadServices();
								}
								catch(e)
								{
									console.error(e);
								}
							}

							resolve();
						});
					});
				}

				function renderGUI()
				{
					Replacer.SETUP();

					if(data.accessories == null || data.accessories.length == 0)
					{
						if(data.automation == null || data.automation.length == 0)
						{
							document.getElementById('no-accessories').style.removeProperty('display');
						}
						
						document.getElementById('add-button').setAttribute('disabled', '');
					}
					
					if(data.automation == null || data.automation.length == 0)
					{
						if(data.accessories != null && data.accessories.length > 0)
						{
							document.getElementById('no-automation').style.removeProperty('display');
						}

						document.getElementById('view-button').setAttribute('disabled', '');
					}
					
					if(Storage.getItem('automation-view') == 'vertical')
					{
						switchView(Storage.getItem('automation-view'));
					}

					if(groups.length > 0)
					{
						renderGroups();
					}

					if(data.automation != null && data.automation.length > 0
					&& data.accessories != null && data.accessories.length > 0)
					{
						renderAutomation();
					}

					if(data.automation != null && data.automation.length > 0)
					{
						renderWidgets();
					}

					if(Essentials.getURLParams('edit') != null)
					{
						var automation = undefined;

						if(Essentials.getURLParams('id') != null)
						{
							automation = getAutomation(Essentials.getURLParams('id') || undefined);
						}

						openEditor(true, automation);
					}

					Preloader.finish();
				}

			</script>
			<script>

				function loadServices()
				{
					for(const i in data.accessories)
					{
						var plugin = data.accessories[i].plugin.alias;

						if(plugin == 'SynTex')
						{
							plugin = 'SynTexWebHooks';
						}

						for(const j in data.accessories[i].services)
						{
							var service = data.accessories[i].services[j];

							if(service.type != 'lcd' && service.type != 'bridge' && service.type != 'unsupported' && service.type != 'removed')
							{
								if(service.type == 'rgbw' || service.type == 'rgbww' || service.type == 'rgbcw')
								{
									service.type = 'rgb';
								}

								services.push({ ...service, plugin, id : data.accessories[i].id });
							}
						}
					}

					services.sort((a, b) => (a.name > b.name) ? 1 : (b.name > a.name) ? -1 : 0);

					console.log('SERVICES', services);
				}

				window.tempGroups = [];
				window.groups = [];

				function loadGroups()
				{
					var changed = false;

					for(const i in data.automation)
					{
						if(data.automation[i].group != null)
						{
							var groupArray = Array.isArray(data.automation[i].group) ? data.automation[i].group : [ data.automation[i].group ];

							for(const j in groupArray)
							{
								if(!tempGroups.includes(groupArray[j].toLowerCase()))
								{
									groups.push(groupArray[j]);

									tempGroups.push(groupArray[j].toLowerCase());

									changed = true;
								}
							}
						}
					}

					groups.sort();

					return changed;
				}

				function renderAutomation()
				{
					var select = document.getElementById('sort'), sort = select.children[select.selectedIndex].getAttribute('value');

					sortAutomation(sort);

					for(const i in data.automation)
					{
						var button = document.createElement('button');

						button.innerHTML = data.automation[i].name;
						button.id = data.automation[i].id;

						button.onclick = () => openEditor(false, data.automation[i]);

						document.getElementById('automation').appendChild(button);
					}

					switchGroup(true);
				}

				function renderWidgets()
				{
					var count = 0, active = 0;

					for(const i in data.automation)
					{
						if(hasGroup(data.automation[i].id, activeGroup))
						{
							if(data.automation[i].active == true)
							{
								active++;
							}

							count++;
						}
					}

					document.getElementById('widget-counter').innerHTML = count;
					document.getElementById('widget-active').innerHTML = active;
				}

				window.activeGroup = null;

				function renderGroups()
				{
					var allGroups = document.createElement('button');

					allGroups.innerHTML = '%automation.all_automations%';
					allGroups.className = 'white';

					if(activeGroup == null)
					{
						allGroups.classList.add('active');							
					}

					allGroups.setAttribute('type', 'button');

					allGroups.onclick = () => {
						
						activeGroup = null;

						switchGroup(false);
					};

					document.getElementById('groups').innerHTML = '';

					document.getElementById('groups').appendChild(allGroups);

					for(const i in groups)
					{
						var group = document.createElement('button');

						group.innerHTML = groups[i];
						group.className = 'white';

						if(activeGroup != null && activeGroup == groups[i])
						{
							allGroups.classList.add('active');							
						}

						group.onclick = () => {
							
							activeGroup = groups[i].toLowerCase();

							switchGroup(false);
						};

						document.getElementById('groups').appendChild(group);
					}
				}

				function sortAutomation(sort)
				{
					data.automation.sort((a, b) => (a.name > b.name) ? 1 : (b.name > a.name) ? -1 : 0);
					
					if(sort == 'alphabetical-desc')
					{
						data.automation.sort((a, b) => (a.name < b.name) ? 1 : (b.name < a.name) ? -1 : 0);
					}
					
					if(sort == 'activation-asc')
					{
						data.automation.sort((a, b) => (a.active == false && b.active == true) ? 1 : (a.active == true && b.active == false) ? -1 : 0);
					}
					
					if(sort == 'activation-desc')
					{
						data.automation.sort((a, b) => (a.active == true && b.active == false) ? 1 : (a.active == false && b.active == true) ? -1 : 0);
					}

					if(sort == 'id-asc')
					{
						data.automation.sort((a, b) => (a.id > b.id) ? 1 : (b.id > a.id) ? -1 : 0);
					}
					
					if(sort == 'id-desc')
					{
						data.automation.sort((a, b) => (a.id < b.id) ? 1 : (b.id < a.id) ? -1 : 0);
					}
				}
				/*
				function renderGUI(renderAutomation)
				{
					createGroupPanel();

					if(automation.length > 0)
					{
						if(renderAutomation)
						{
							sortAutomation(true);
						}
					}
					else
					{
						document.getElementById('no-accessories').style.display = '';
						document.getElementById('add-button-big').style.display = 'none';
						document.getElementById('devices-button-big').style.display = '';
						document.getElementById('add-button').setAttribute('disabled', '');

						Preloader.finish();
					}
				}
				*/
			</script>
			<script>

				window.logic = ['%automation.and%', '%automation.or%'];

				async function openEditor(init, automation = {})
				{
					PageManager.setHeader('%menu.automation%', automation.id == null ? '%automation.create%' : automation.name, !init);

					var main = document.createElement('div');

					main.style.display = 'flex';

					main.innerHTML = '<input type="button" value="%menu.back%" onclick="closeEditor()"><div style="display: block; width: 100%; margin-left: 20px"><input id="save-btn" type="submit" form="editor-form" value="' + (automation.id == null ? '%automation.create%' : '%automation.modify%') + '"></div>';

					PageManager.setFooter(main);
					PageManager.showFooter(!init);

					await PageManager.switchPage('overview', 'editor', init);

					var url = '/debug/workaround/automation_new/?edit';

					if(automation.id != null)
					{
						url += '&id=' + automation.id;
					}

					if(Essentials.getURLParams('desktopApp') == true)
					{
						url += '&desktopApp=true';
					}

					window.history.pushState(null, null, url);

					document.getElementById('general').getElementsByTagName('input')[0].value = automation.id || getNextID();
					document.getElementById('general').getElementsByTagName('input')[1].value = automation.name || '';
					document.getElementById('general').getElementsByTagName('input')[2].value = automation.group || '';

					Essentials.switchBooleanButton(document.getElementById('general').getElementsByTagName('input')[3], automation.active);

					if(automation.trigger == null || automation.trigger.logic == 'AND')
					{
						document.getElementById('group-logic').innerHTML = window.logic[0].toUpperCase();
						document.getElementById('group-logic').setAttribute('value', 'AND');
					}
					else
					{
						document.getElementById('group-logic').innerHTML = window.logic[1].toUpperCase();
						document.getElementById('group-logic').setAttribute('value', 'OR');
					}
					
					if(automation.options != null)
					{
						document.getElementById('group-options').setAttribute('options', JSON.stringify(automation.options));
					}
					else
					{
						document.getElementById('group-options').removeAttribute('options');
					}

					document.getElementById('trigger').getElementsByClassName('groups')[0].innerHTML = '';

					document.getElementById('result').getElementsByClassName('blocks')[0].innerHTML = '';

					if(automation.id != null)
					{
						for(const i in automation.trigger.groups)
						{
							var group = addGroup(automation.trigger.groups[i]);

							for(const j in automation.trigger.groups[i].blocks)
							{
								if(automation.trigger.groups[i].blocks[j].time != null)
								{
									if(automation.trigger.groups[i].blocks[j].time.begin != null)
									{
										addBlock('trigger', group.getElementsByClassName('blocks')[0], { ...automation.trigger.groups[i].blocks[j], time : automation.trigger.groups[i].blocks[j].time.begin, operation : '>' });
									}

									if(automation.trigger.groups[i].blocks[j].time.end != null)
									{
										addBlock('trigger', group.getElementsByClassName('blocks')[0], { ...automation.trigger.groups[i].blocks[j], time : automation.trigger.groups[i].blocks[j].time.end, operation : '<' });
									}
								}
								else
								{
									addBlock('trigger', group.getElementsByClassName('blocks')[0], automation.trigger.groups[i].blocks[j]);
								}
							}
						}

						for(const i in automation.result)
						{
							addBlock('result', document.getElementById('result').getElementsByClassName('blocks')[0], automation.result[i]);
						}
					}
				}

				async function closeEditor()
				{
					PageManager.setHeader('%general.dashboard%', '%menu.automation%', true);
					PageManager.hideFooter(true);

					await PageManager.switchPage('editor', 'overview', false);

					var url = '/debug/workaround/automation_new/';

					if(Essentials.getURLParams('desktopApp') == true)
					{
						url += '?desktopApp=true';
					}
					
					window.history.pushState(null, null, url);
				}

				function openOptions(type, block)
				{
					var form = document.createElement('form'), options = {};

					if(block.hasAttribute('options'))
					{
						options = JSON.parse(block.getAttribute('options'));
					}

					const createStateLock = () => {

						var label = document.createElement('label'),
							checkbox = document.createElement('input'),
							suffix = document.createElement('div');

						label.className = 'label-input';

						label.setAttribute('for', 'state-lock');

						checkbox.setAttribute('id', 'state-lock');
						checkbox.setAttribute('type', 'checkbox');
						checkbox.setAttribute('name', 'stateLock');

						if((type == 'automation' && options.stateLock != false)
						|| (type == 'block' && options.stateLock == true))
						{
							checkbox.checked = true;
						}

						suffix.innerHTML = '%automation.state_lock_description%';

						label.appendChild(checkbox);
						label.appendChild(suffix);

						return label;
					};

					const createTimeLock = () => {

						var label = document.createElement('label'),
							checkbox = document.createElement('input'),
							timelock = document.createElement('input'),
							suffix = document.createElement('div');

						label.className = 'label-input';

						label.setAttribute('for', 'time-lock');

						checkbox.setAttribute('id', 'time-lock');
						checkbox.setAttribute('type', 'checkbox');
						checkbox.setAttribute('name', 'timeLock');

						timelock.setAttribute('type', 'text');
						timelock.setAttribute('value', '0');

						timelock.style.maxWidth = '150px';

						timelock.oninput = () => {

							checkbox.checked = parseInt(timelock.value) > 0;
						};

						if(options.timeLock != null)
						{
							timelock.setAttribute('value', parseInt(options.timeLock / 1000));

							checkbox.checked = true;
						}

						suffix.innerHTML = '%automation.time_lock_description%';

						label.appendChild(checkbox);
						label.appendChild(timelock);
						label.appendChild(suffix);

						return label;
					};
					
					form.appendChild(createStateLock());
					form.appendChild(createTimeLock());

					var dialogue = {
						title : '%general.options%',
						form, buttons : [
							{
								text : '%general.cancel%',
								close : true
							},
							{
								text : '%general.ok%',
								color : 'green',
								action : () => {

									var options = {};

									for(var i = 0; i < form.children.length; i++)
									{
										var active = form.children[i].getElementsByTagName('input')[0]
											input = form.children[i].getElementsByTagName('input')[1],
											name = active.getAttribute('name');

										if(name == 'timeLock' && active.checked)
										{
											options[name] = parseInt(input.value) * 1000;
										}
										else if(name == 'stateLock')
										{
											if((type == 'automation' && !active.checked)
											|| (type == 'block' && active.checked))
											{
												options[name] = active.checked;
											}
										}
									}

									if(Object.keys(options).length > 0)
									{
										block.setAttribute('options', JSON.stringify(options));
									}
									else
									{
										block.removeAttribute('options');
									}

									Essentials.closeDialogue();
								}
							}
						]
					};

					Essentials.openDialogue(dialogue);
				}

			</script>
			<script>

				function getAutomation(id)
				{
					for(const i in data.automation)
					{
						if(data.automation[i].id == id)
						{
							return data.automation[i];
						}
					}

					return null;
				}

				function getNextID()
				{
					var lastID = -1;

					for(const i in data.automation)
					{
						if(data.automation[i].id > lastID)
						{
							lastID = data.automation[i].id;
						}
					}

					return lastID + 1;
				}

				function hasGroup(id, group)
				{
					var automation = getAutomation(id);

					if(group == null)
					{
						return true;
					}

					if(automation != null && automation.group != null)
					{
						if(Array.isArray(automation.group))
						{
							for(const i in automation.group)
							{
								if(automation.group[i].toLowerCase() == group.toLowerCase())
								{
									return true;
								}
							}
						}
						else if(automation.group.toLowerCase() == group.toLowerCase())
						{
							return true;
						}
					}

					return false;
				}

			</script>
			<script>

				function switchLogic(button)
				{
					button.innerHTML = button.getAttribute('value') == 'AND' ? logic[1].toUpperCase() : logic[0].toUpperCase();

					button.setAttribute('value', button.getAttribute('value') == 'AND' ? 'OR' : 'AND');
				}

				function switchView(view, toggle)
				{
					var button = document.getElementById('view-button');

					if(toggle)
					{
						view = view == 'vertical' ? 'horizontal' : 'vertical';

						Storage.setItem('automation-view', view);
					}

					button.setAttribute('view', view);

					if(view == 'vertical')
					{
						document.getElementById('automation').classList.add('vertical-view');

						button.children[0].style.display = 'none';
						button.children[1].style.removeProperty('display');
					}
					else if(view == 'horizontal')
					{
						document.getElementById('automation').classList.remove('vertical-view');

						button.children[0].style.removeProperty('display');
						button.children[1].style.display = 'none';
					}
				}

				function switchSort()
				{
					var select = document.getElementById('sort'), sort = select.children[select.selectedIndex].getAttribute('value');

					sortAutomation(sort);

					Storage.setItem('automation-sort', sort);

					document.getElementById('automation').style.opacity = 0;

					setTimeout(() => {
						
						for(const i in data.automation)
						{
							document.getElementById('automation').appendChild(document.getElementById(data.automation[i].id));
						}

						setTimeout(() => { document.getElementById('automation').style.opacity = 1 }, 0);

					}, 200);
				}

				function switchGroup(init)
				{
					var automation = document.getElementById('automation').children, groups = document.getElementById('groups').children;

					if(!init)
					{
						Storage.setItem('automation-group', activeGroup);

						document.getElementById('automation').style.opacity = 0;
					}
					else
					{
						activeGroup = Storage.getItem('automation-group');
					}

					setTimeout(() => {
						
						for(var i = 0; i < automation.length; i++)
						{
							if(hasGroup(automation[i].id, activeGroup))
							{
								automation[i].classList.remove('hidden');
							}
							else
							{
								automation[i].classList.add('hidden');
							}
						}

						for(var i = 0; i < groups.length; i++)
						{
							if(groups[i].innerHTML.toLowerCase() == activeGroup || (i == 0 && activeGroup == null))
							{
								groups[i].classList.add('active');
							}
							else
							{
								groups[i].classList.remove('active');
							}
						}

						if(!init)
						{
							renderWidgets();

							setTimeout(() => { document.getElementById('automation').style.opacity = 1 }, 0);
						}
						
					}, init ? 0 : 200);
				}

			</script>
			<script>

				function addGroup(entry)
				{
					var group = document.createElement('div'),
						blocks = document.createElement('div'),
						bottom = document.createElement('div'),
						add = PageBuilder.createIconButton({ text : '%automation.block%', src : '/img/add_light.png', align : 'left' }),
						logic = document.createElement('button'),
						remove = PageBuilder.createIconButton({ text : '%automation.group%', src : '/img/delete.png', align : 'right' });

					group.className = 'group';

					blocks.className = 'blocks';

					bottom.className = 'bottom';

					add.classList.add('gradient-blue-green', 'add-block-button');

					add.onclick = () => addBlock('trigger', blocks);

					logic.innerHTML = entry == null || entry.logic == 'AND' ? window.logic[0].toUpperCase() : window.logic[1].toUpperCase();
					logic.className = 'block-logic white';
					logic.type = 'button';

					logic.setAttribute('value', entry == null || entry.logic == 'AND' ? 'AND' : 'OR');

					logic.onclick = () => switchLogic(logic);

					remove.classList.add('gradient-red', 'remove-group-button');

					remove.onclick = () => document.getElementById('trigger').getElementsByClassName('groups')[0].removeChild(group);
					
					bottom.appendChild(add);
					bottom.appendChild(logic);
					bottom.appendChild(remove);

					group.appendChild(blocks);
					group.appendChild(bottom);

					document.getElementById('trigger').getElementsByClassName('groups')[0].appendChild(group);
				
					return group;
				}

				function addBlock(type, parent, entry)
				{
					var block = document.createElement('div');

					block.className = 'block';

					if(entry != null && entry.options != null)
					{
						block.setAttribute('options', JSON.stringify(entry.options));
					}

					const createService = () => {

						var options = [], found = false;

						var placeholder = {
							text : '%automation.choose_service%',
							type : 'hidden',
							img : '/img/search.png',
							hidden : true
						};

						if(entry == null)
						{
							placeholder.selected = true;
						}
						
						options.push(placeholder);

						if(type == 'trigger')
						{
							var time = {
								text : '%automation.time%',
								type : 'time',
								img : '/img/clock.png'
							};

							if(entry != null && entry.time != null)
							{
								time.selected = true;

								found = true;
							}

							options.push(time);
						}

						if(type == 'result')
						{
							var link = {
								text : '%automation.open_link%',
								type : 'url',
								img : '/img/link.png'
							};

							if(entry != null && entry.url != null)
							{
								link.selected = true;

								found = true;
							}

							options.push(link);
						}

						for(const i in services)
						{
							if(type == 'result' || services[i].type != 'statelessswitch')
							{
								var option = {
									text : services[i].name,
									id : services[i].id,
									letters : services[i].letters,
									type : Essentials.getDataType(services[i].type),
									name : services[i].name,
									plugin : services[i].plugin,
									img : '/img/accessory/' + services[i].type + '.png'
								};

								if(entry != null && services[i].id == entry.id && services[i].letters == entry.letters)
								{
									option.selected = true;

									found = true;
								}

								options.push(option);
							}
						}

						if(!found && entry != null && entry.id != null && entry.letters != null && entry.name != null)
						{
							var placeholder = {
								text : '%automation.deleted_service% (' + entry.name + ')',
								type : 'hidden',
								img : '/img/delete.png',
								id : entry.id,
								name : entry.name,
								letters : entry.letters,
								type : Essentials.getDataType(Essentials.letterToType(entry.letters)),
								selected : true,
								hidden : true
							};

							if(entry.plugin != null)
							{
								placeholder.plugin = entry.plugin;
							}

							options.push(placeholder);
						}

						return PageBuilder.createSelect({ name : 'service', search : true, onchange : () => { updateOperation(); updateComparison() }, options });
					};

					const createOperation = () => {

						var options = [
							{ text : '=', value : '=', name : 'equal' },
							{ text : '%automation.switch%', value : '=', name : 'switch' },
							{ text : '%automation.dimming%', value : '=', name : 'dimming' },
							{ text : '%automation.color%', value : '=', name : 'color' }
						];

						if(type == 'trigger')
						{
							options.push({ text : '<', value : '<', name : 'lower' });
							options.push({ text : '>', value : '>', name : 'greater' });
						}

						return PageBuilder.createSelect({ name : 'operation', onchange : () => updateComparison(), options });
					};

					const createComparison = () => {

						var element = document.createElement('div'), options = [];

						options.push({ text : '%characteristics.boolean.inactive%', value : false });
						options.push({ text : '%characteristics.boolean.active%', value : true });

						var boolean = PageBuilder.createSelect({ name : 'value', options }),
							numeric = document.createElement('input'),
							color = document.createElement('input'),
							time = document.createElement('input');

						numeric.setAttribute('title', '%pattern.numbers_special%: -');
						numeric.setAttribute('name', 'value');
						numeric.setAttribute('type', 'text');

						color.setAttribute('name', 'value');
						color.setAttribute('type', 'color');
						color.setAttribute('value', '#FFFFFF');

						time.setAttribute('name', 'begin');
						time.setAttribute('type', 'time');
						time.setAttribute('value', '00:00');

						element.appendChild(boolean);
						element.appendChild(numeric);
						element.appendChild(color);
						element.appendChild(time);
						
						return element;
					};

					var serviceElement = block.appendChild(createService()),
						operationElement = block.appendChild(createOperation()),
						comparisonElement = block.appendChild(createComparison()),
						controlElement = document.createElement('div'),
						optionButton = document.createElement('button'),
						removeButton = document.createElement('button');

					controlElement.className = 'control';

					optionButton.className = 'image-button white';
					optionButton.type = 'button';

					var optionImage = document.createElement('img');

					optionImage.className = 'icon-inverted';
					optionImage.src = '/img/settings.png';
					optionImage.style.height = '100%';

					optionButton.onclick = () => openOptions('block', block);

					optionButton.appendChild(optionImage);

					removeButton.className = 'image-button white';
					removeButton.type = 'button';

					var removeImage = document.createElement('img');

					removeImage.className = 'icon-inverted';
					removeImage.src = '/img/delete.png';
					removeImage.style.height = '100%';

					removeButton.onclick = () => parent.removeChild(block);

					removeButton.appendChild(removeImage);

					controlElement.appendChild(optionButton);
					controlElement.appendChild(removeButton);

					block.appendChild(controlElement);

					parent.appendChild(block);

					const updateOperation = (entry) => {

						var service = Replacer.getSelect(serviceElement),
							operation = Replacer.getSelect(operationElement),
							selected = service.selected.option, operations = [], index = null;

						if(Essentials.letterToType(selected.getAttribute('letters')) == 'rgb')
						{
							operations = ['%automation.switch%', '%automation.dimming%', '%automation.color%'];
						}
						else if(Essentials.letterToType(selected.getAttribute('letters')) == 'dimmer')
						{
							operations = ['%automation.switch%', '%automation.dimming%'];
						}
						else if(selected.getAttribute('type') == 'boolean' || type == 'result')
						{
							operations = ['='];
						}
						else if(selected.getAttribute('type') == 'numeric' || selected.getAttribute('type') == 'time')
						{
							operations = ['=', '&lt;', '&gt;'];
						}

						for(const i in operation.items)
						{
							if(operations.includes(operation.items[i].text))
							{
								operation.items[i].element.classList.remove('hidden');

								if(index == null)
								{
									index = parseInt(i);
								}
							}
							else
							{
								operation.items[i].element.classList.add('hidden');
							}
						}

						if(entry != null && entry.operation != null)
						{
							if(entry.operation == '=')
							{
								if(entry.state != null && entry.state.hue != null && entry.state.saturation != null && entry.state.brightness != null)
								{
									operation.updateSelected(3);
								}
								else if(entry.state != null && entry.state.brightness != null)
								{
									operation.updateSelected(2);
								}
								else if(Essentials.letterToType(selected.getAttribute('letters')) == 'dimmer'
								|| Essentials.letterToType(selected.getAttribute('letters')) == 'rgb')
								{
									operation.updateSelected(1);
								}
								else
								{
									operation.updateSelected(0);
								}
							}
							else if(entry.operation == '<')
							{
								operation.updateSelected(4);
							}
							else if(entry.operation == '>')
							{
								operation.updateSelected(5);
							}
						}
						else if(index != null && !operations.includes(operation.selected.text))
						{
							operation.updateSelected(index);
						}
					};

					const updateComparison = (entry) => {

						var service = Replacer.getSelect(serviceElement),
							operation = Replacer.getSelect(operationElement),
							comparison = Replacer.getSelect(comparisonElement),
							selected = service.selected.option;

						var preset = servicePresets[Essentials.letterToType(selected.getAttribute('letters'))];

						if(Essentials.letterToType(selected.getAttribute('letters')) == 'rgb'
						|| Essentials.letterToType(selected.getAttribute('letters')) == 'dimmer')
						{
							comparison.updateOption(0, preset.inactive.text);
							comparison.updateOption(1, preset.active.text);

							comparison.updateSelected();
							
							if(entry != null && entry.state != null)
							{
								if(entry.state.value == true)
								{
									comparison.updateSelected(1);
								}
								else
								{
									comparison.updateSelected(0);
								}

								if(entry.state.brightness != null)
								{
									comparisonElement.children[1].value = entry.state.brightness;
								}

								if(entry.state.hue != null && entry.state.saturation != null && entry.state.brightness != null)
								{
									comparisonElement.children[2].value = Essentials.hslToHEX(entry.state.hue, entry.state.saturation, entry.state.brightness / 2);
								}
							}

							if(operation.selected.option.getAttribute('name') == 'switch')
							{
								comparisonElement.children[0].classList.remove('hidden');
								comparisonElement.children[1].classList.add('hidden');
								comparisonElement.children[2].classList.add('hidden');
								comparisonElement.children[3].classList.add('hidden');
							}
							else if(operation.selected.option.getAttribute('name') == 'dimming')
							{
								comparisonElement.children[1].setAttribute('placeholder', '%automation.brightness% (' + preset.text + ')');

								comparisonElement.children[0].classList.add('hidden');
								comparisonElement.children[1].classList.remove('hidden');
								comparisonElement.children[2].classList.add('hidden');
								comparisonElement.children[3].classList.add('hidden');
							}
							else if(operation.selected.option.getAttribute('name') == 'color')
							{
								comparisonElement.children[0].classList.add('hidden');
								comparisonElement.children[1].classList.add('hidden');
								comparisonElement.children[2].classList.remove('hidden');
								comparisonElement.children[3].classList.add('hidden');
							}
						}
						else if(selected.getAttribute('type') == 'boolean')
						{
							comparison.updateOption(0, preset.inactive.text);
							comparison.updateOption(1, preset.active.text);

							comparison.updateSelected();

							if(entry != null && entry.state != null)
							{
								if(entry.state.value == true)
								{
									comparison.updateSelected(1);
								}
								else
								{
									comparison.updateSelected(0);
								}
							}

							comparisonElement.children[0].classList.remove('hidden');
							comparisonElement.children[1].classList.add('hidden');
							comparisonElement.children[2].classList.add('hidden');
							comparisonElement.children[3].classList.add('hidden');
						}
						else if(selected.getAttribute('type') == 'numeric')
						{
							if(entry != null && entry.state != null && entry.state.value != null)
							{
								comparisonElement.children[1].value = entry.state.value;
							}
							
							comparisonElement.children[1].setAttribute('placeholder', (preset.name || '%automation.number%') + ' (' + preset.text + ')');

							comparisonElement.children[0].classList.add('hidden');
							comparisonElement.children[1].classList.remove('hidden');
							comparisonElement.children[2].classList.add('hidden');
							comparisonElement.children[3].classList.add('hidden');
						}
						else if(selected.getAttribute('type') == 'time')
						{
							if(entry != null && entry.time != null && entry.time != null)
							{
								comparisonElement.children[3].value = entry.time;
							}

							comparisonElement.children[0].classList.add('hidden');
							comparisonElement.children[1].classList.add('hidden');
							comparisonElement.children[2].classList.add('hidden');
							comparisonElement.children[3].classList.remove('hidden');
						}
						else if(selected.getAttribute('type') == 'url')
						{
							if(entry != null && entry.url != null)
							{
								comparisonElement.children[1].value = entry.url;
							}

							comparisonElement.children[1].setAttribute('placeholder', '%automation.link%');

							comparisonElement.children[0].classList.add('hidden');
							comparisonElement.children[1].classList.remove('hidden');
							comparisonElement.children[2].classList.add('hidden');
							comparisonElement.children[3].classList.add('hidden');
						}
						else if(selected.getAttribute('type') == 'hidden')
						{
							comparisonElement.children[0].classList.remove('hidden');
							comparisonElement.children[1].classList.add('hidden');
							comparisonElement.children[2].classList.add('hidden');
							comparisonElement.children[3].classList.add('hidden');
						}
					};

					updateOperation(entry);
					updateComparison(entry);
				}

			</script>
			<script>

				function sendAutomation()
				{

				}

			</script>
		</div>
	</body>
</html>