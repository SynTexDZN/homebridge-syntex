<html>
	<body ontouchstart="">
		<div id="content">
			<title>Debug: Graph</title>
			<script type="module">

				PageManager.setHeader('Debug', 'Graph');

				var main = document.createElement('input');

				main.setAttribute('type', 'button');
				main.setAttribute('value', '%menu.back%');
				main.setAttribute('onclick', 'Essentials.leavePage(' + "'/debug'" + ')');

				PageManager.setFooter(main);
				PageManager.showFooter();

			</script>
			<div class="main" style="margin-bottom: 100px">
				<div id="graph-container"></div>
			</div>
			<script type="module">

				import { Graph } from '/js/graph.js';

				Graph.setPadding(80);

				window.Graph = Graph;

                renderGUI();

				Preloader.finish();

			</script>
			<script>

                function renderGUI()
                {
                    createGraph([
                        { id : 'CC:50:E3:E8:43:E6', letters : 'C0' },
                        { id : 'EC:FA:BC:58:A0:DE', letters : 'C0' },
                        { id : 'BC:DD:C2:B6:71:25', letters : 'C0' },
                        { id : 'EC:FA:BC:58:AF:5B', letters : 'C0' },
                        { id : 'knx59', letters : 'C0' },
                        { id : 'knx59', letters : 'C1' },
                        { id : 'knx59', letters : 'C2' },
                        { id : 'knx49', letters : 'C0' },
                        { id : 'knx49', letters : 'C1' }
                    ]);

                    createGraph([
                        { id : 'knx51', letters : 'C0' },
                        { id : 'knx59', letters : 'C0' },
                        { id : 'knx59', letters : 'C1' },
                        { id : 'knx59', letters : 'C2' }
                    ]);

                    createGraph([
                        { id : 'knx51', letters : 'C0' },
                        { id : 'knx49', letters : 'C0' },
                        { id : 'knx49', letters : 'C1' }
                    ]);

                    createGraph([
                        { id : 'knx49', letters : 'C0' },
                        { id : 'knx49', letters : 'C1' }
                    ]);

                    createGraph([
                        { id : 'knx6', letters : 'A1' },
                        { id : 'knx49', letters : 'C0' }
                    ]);

                    createGraph([
                        { id : 'knx60', letters : 'G0' },
                        { id : 'EC:FA:BC:58:AF:5B', letters : 'C0' }
                    ]);
                    
                    createGraph([
                        { id : 'CC:50:E3:E8:3C:52', letters : 'B0' },
                        { id : 'knx30', letters : '80' }
                    ]);
                }

				function createGraph(source)
                {
                    var values = {}, promiseArray = [];

                    for(const i in source)
                    {
                        if(values[source[i].id] == null)
                        {
                            values[source[i].id] = {};
                        }

                        if(values[source[i].id][source[i].letters] == null)
                        {
                            values[source[i].id][source[i].letters] = [];
                        }

                        promiseArray.push(new Promise((resolve) => Query.complexFetch('/serverside/activity?id=' + source[i].id, 30000, 2, {}, false).then((activity) => {

                            activity = JSON.parse(activity);

                            for(const letters in activity)
                            {
                                if(letters == source[i].letters)
                                {
                                    if(activity[letters].update.length > 0)
                                    {
                                        if(Essentials.letterToType(source[i].letters[0]) == 'statelessswitch')
                                        {
                                            for(const u in activity[letters].update)
                                            {
                                                values[source[i].id][source[i].letters].push({ time : activity[letters].update[u].t, value : true });
                                                values[source[i].id][source[i].letters].push({ time : activity[letters].update[u].t, value : false });
                                            }
                                        }
                                        else
                                        {
                                            for(const u in activity[letters].update)
                                            {
                                                var obj = { time : activity[letters].update[u].t }, orginalValues = activity[letters].update[u].v;
                                                var characteristics = ['value', 'hue', 'saturation', 'brightness'];

                                                obj['value'] = orginalValues;

                                                for(const c in characteristics)
                                                {
                                                    if(orginalValues.includes(characteristics[c] + ': '))
                                                    {
                                                        obj[characteristics[c]] = orginalValues.split(characteristics[c] + ': ')[1];
                                                    }
                                                }

                                                for(const c in obj)
                                                {
                                                    if(obj[c].includes(', '))
                                                    {
                                                        obj[c] = obj[c].split(', ')[0];
                                                    }
                                                }

                                                values[source[i].id][source[i].letters].push(obj);
                                            }
                                        }
                                    }
                                }
                            }

                            resolve();
                        })));
                    }

                    Promise.all(promiseArray).then((activity) => {

                        var frame = document.createElement('div'), grid = document.createElement('canvas');
                        var height = 400;

                        frame.className = 'graph';
                        frame.setAttribute('style', 'height: ' + height + 'px');

                        document.getElementById('graph-container').appendChild(frame);

                        grid.setAttribute('class', 'canvas');

                        frame.appendChild(grid);

                        Graph.clearCanvas(grid);
                        Graph.drawGrid(grid, [], 10);

                        var min = 100000, max = -100000;

                        for(const id in values)
                        {
                            for(const letters in values[id])
                            {
                                var type = Essentials.letterToType(letters[0]);
                                var data = Graph.convertActivity({ id, letters, type, canvas : graph, format : (type != 'statelessswitch') ? Essentials.getDataType(type) : 'boolean', interval : (Essentials.getDataType(type) == 'boolean' || type == 'statelessswitch' || type == 'blind') ? 4 : 10 }, values[id][letters], [], []);
                                
                                if(type != 'blind' && type != 'statelessswitch' && Essentials.getDataType(type) != 'boolean')
                                {
                                    if(data.min < min)
                                    {
                                        min = data.min;
                                    }

                                    if(data.max > max)
                                    {
                                        max = data.max;
                                    }
                                }
                            }
                        }

                        var fillMax = {};

                        for(const id in values)
                        {
                            for(const letters in values[id])
                            {
                                var graph = document.createElement('canvas');

                                graph.setAttribute('class', 'canvas');

                                frame.appendChild(graph);
                                
                                var type = Essentials.letterToType(letters[0]);
                                var data = Graph.convertActivity({ id, letters, type, canvas : graph, format : (type != 'statelessswitch') ? Essentials.getDataType(type) : 'boolean', interval : (Essentials.getDataType(type) == 'boolean' || type == 'statelessswitch' || type == 'blind') ? 4 : 10, min, max }, values[id][letters], [], []);
                            
                                var colorFill = [], colorGraph = [];

                                if(Essentials.getDataType(type) == 'numeric' && type != 'blind')
                                {
                                    var serviceState0 = Essentials.getServiceColor({ id, letters, format : { value : 'int' }, state : { value : min } });
                                    var serviceState1 = Essentials.getServiceColor({ id, letters, format : { value : 'int' }, state : { value : (min + min + max) / 3 } });
                                    var serviceState2 = Essentials.getServiceColor({ id, letters, format : { value : 'int' }, state : { value : (min + max) / 2 } });
                                    var serviceState3 = Essentials.getServiceColor({ id, letters, format : { value : 'int' }, state : { value : (min + max + max) / 3 } });
                                    var serviceState4 = Essentials.getServiceColor({ id, letters, format : { value : 'int' }, state : { value : max } });
                                    
                                    if(serviceState4 != null && serviceState4.color != null)
                                    {
                                        colorFill.push('hsla(' + serviceState4.color.split(')')[0].split('hsl(')[1] + ', .3)');
                                        colorGraph.push(serviceState4.color);
                                    }

                                    if(serviceState3 != null && serviceState3.color != null)
                                    {
                                        colorFill.push('hsla(' + serviceState3.color.split(')')[0].split('hsl(')[1] + ', .25)');
                                        colorGraph.push(serviceState3.color);
                                    }

                                    if(serviceState2 != null && serviceState2.color != null)
                                    {
                                        colorFill.push('hsla(' + serviceState2.color.split(')')[0].split('hsl(')[1] + ', .175)');
                                        colorGraph.push(serviceState2.color);
                                    }

                                    if(serviceState1 != null && serviceState1.color != null)
                                    {
                                        colorFill.push('hsla(' + serviceState1.color.split(')')[0].split('hsl(')[1] + ', .1)');
                                        colorGraph.push(serviceState1.color);
                                    }

                                    if(serviceState0 != null && serviceState0.color != null)
                                    {
                                        colorFill.push('hsla(' + serviceState0.color.split(')')[0].split('hsl(')[1] + ', .05)');
                                        colorGraph.push(serviceState0.color);
                                    }
                                }
                                else
                                {
                                    var serviceState = Essentials.getServiceColor({ id, letters, format : { value : 'bool' }, state : { value : type == 'blind' ? 100 : true } });

                                    if(serviceState != null && serviceState.color != null)
                                    {
                                        colorFill.push('hsla(' + serviceState.color.split(')')[0].split('hsl(')[1] + ', .3)');
                                        colorGraph.push(serviceState.color);
                                    }
                                    
                                    colorFill.push('rgba(60, 60, 80, .1)');
                                    colorGraph.push('rgb(60, 60, 80');
                                }

                                Graph.clearCanvas(graph);

                                if(Essentials.getDataType(type) == 'numeric' && type != 'blind')
                                {
                                    for(const i in data.values)
                                    {
                                        if(fillMax[type] == null)
                                        {
                                            fillMax[type] = [];
                                        }

                                        if(data.values[i] != null)
                                        {
                                            if(fillMax[type][parseInt(i)] == null || data.values[i] > fillMax[type][parseInt(i)])
                                            {
                                                fillMax[type][parseInt(i)] = data.values[i];
                                            }
                                        }
                                        else
                                        {
                                            var last = getLastValue(data.values, parseInt(i) - 1), next = getNextValue(data.values, parseInt(i) + 1);
                                            
                                            if(last != null && next != null)
                                            {
                                                var calc = (next.value - last.value) / (next.i - last.i) * (i - last.i) + last.value;

                                                if(fillMax[type][parseInt(i)] == null || calc > fillMax[type][parseInt(i)])
                                                {
                                                    fillMax[type][parseInt(i)] = calc;
                                                }
                                            }
                                        }
                                    }
                                }
                                else
                                {
                                    Graph.drawFill(graph, data.values, colorFill, false);
                                }

                                Graph.drawGraph(graph, data.values, colorGraph, 0);
                            }
                        }

                        for(const type in fillMax)
                        {
                            Graph.drawFill(grid, fillMax[type], colorFill, false);
                        }
                    });
                }

                function getNextValue(values, start)
                {
                    for(var i = start; i < values.length; i++)
                    {
                        if(values[i] != null)
                        {
                            return { i, value : values[i] };
                        }
                    }

                    return null;
                }

                function getLastValue(values, start)
                {
                    for(var i = start; i >= 0; i--)
                    {
                        if(values[i] != null)
                        {
                            return { i, value : values[i] };
                        }
                    }

                    return null;
                }

			</script>
		</div>
	</body>
</html>