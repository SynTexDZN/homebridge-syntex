<script>
    
    var device = JSON.parse('<%device%>');

    var restart = false;
    var updating = false;
    
    function restartDevice(btn)
    {
        if(document.getElementById('restarting') == null && document.getElementById('restart-result') == null )
        {
            restart = true;

            var overlay = document.createElement('input');

            overlay.setAttribute('type', 'button');
            overlay.setAttribute('id', 'restarting');
            overlay.setAttribute('style', 'opacity: 0; z-index: 1; letter-spacing: 3px; position: absolute; left: ' + document.getElementById('restart-btn').offsetLeft + 'px; top: ' + document.getElementById('restart-btn').offsetTop + 'px; width: ' + document.getElementById('restart-btn').offsetWidth + 'px!important');
            overlay.setAttribute('value', 'Neustart ..');
            overlay.setAttribute('class', 'gradient-blue');

            document.getElementById('restart-btn').parentElement.insertBefore(overlay, document.getElementById('restart-btn'));

            setTimeout(function()
            {
                overlay.style.opacity = 1;
                document.getElementById('restart-btn').style.opacity = 0;
            }, 10);
            
            var client = new XMLHttpRequest();

            client.timeout = 10000;
        
            client.open('GET', 'http://' + device.ip + '/restart');

            client.onreadystatechange = function()
            {
                if(client.readyState === 4)
                {  
                    if(client.status !== 200)
                    {
                        var rOverlay = document.createElement('input');

                        rOverlay.setAttribute('type', 'button');
                        rOverlay.setAttribute('id', 'restart-result');
                        rOverlay.setAttribute('style', 'opacity: 0; z-index: 1; letter-spacing: 3px; position: absolute; left: ' + document.getElementById('restart-btn').offsetLeft + 'px; top: ' + document.getElementById('restart-btn').offsetTop + 'px; width: ' + document.getElementById('restart-btn').offsetWidth + 'px!important');
                        rOverlay.setAttribute('value', 'Keine Verbindung zum Gerät!');
                        rOverlay.setAttribute('class', 'gradient-red');

                        document.getElementById('restart-btn').parentElement.insertBefore(rOverlay, document.getElementById('restart-btn'));

                        setTimeout(function()
                        {
                            overlay.style.opacity = 0;
                            rOverlay.style.opacity = 1;
                        }, 10);
                    
                        setTimeout(function()
                        {
                            rOverlay.style.opacity = 0;
                            document.getElementById('restart-btn').style.opacity = 1;
                        }, 5000);

                        setTimeout(function()
                        {
                            document.getElementById('restart-btn').parentElement.removeChild(rOverlay);
                            document.getElementById('restart-btn').parentElement.removeChild(overlay);
                        }, 5300);
                    }
                }
            }
            
            client.send();
        }
    }
    
    function checkUpdate(ip, name, version)
    {
        var client = new XMLHttpRequest();

        client.timeout = 10000;
        
        client.open('GET', 'http://' + ip + '/version');

        client.onreadystatechange = function()
        {
            if(client.readyState === 4)
            {  
                if(client.status === 200)
                {
                    if(client.responseText != version)
                    {
                        var rOverlay = document.createElement('input');

                        rOverlay.setAttribute('type', 'button');
                        rOverlay.setAttribute('id', 'update-result');
                        rOverlay.setAttribute('style', 'opacity: 0; z-index: 1; letter-spacing: 3px; position: absolute; left: ' + document.getElementById('update-btn').offsetLeft + 'px; top: ' + document.getElementById('update-btn').offsetTop + 'px; width: ' + document.getElementById('update-btn').offsetWidth + 'px!important');
                        rOverlay.setAttribute('value', 'Update Erfolgreich!');
                        rOverlay.setAttribute('class', 'gradient-green');

                        document.getElementById('update-btn').parentElement.insertBefore(rOverlay, document.getElementById('update-btn'));

                        setTimeout(function()
                        {
                            rOverlay.style.opacity = 1;
                            document.getElementById('updating').style.opacity = 0;
                        }, 10);
                        
                        setTimeout(function()
                        {
                            rOverlay.style.opacity = 0;
                        }, 5000);

                        setTimeout(function()
                        {
                            document.getElementById('update-btn').parentElement.removeChild(rOverlay);
                            document.getElementById('update-btn').parentElement.removeChild(document.getElementById('updating'));
                            document.getElementById('update-btn').parentElement.removeChild(document.getElementById('update-btn'));
                            document.getElementById('update-btn').parentElement.removeChild(document.getElementById('waiting'));
                        }, 5300);
                    }
                    else
                    {
                        var rOverlay = document.createElement('input');

                        rOverlay.setAttribute('type', 'button');
                        rOverlay.setAttribute('id', 'update-result');
                        rOverlay.setAttribute('style', 'opacity: 0; z-index: 1; letter-spacing: 3px; position: absolute; left: ' + document.getElementById('update-btn').offsetLeft + 'px; top: ' + document.getElementById('update-btn').offsetTop + 'px; width: ' + document.getElementById('update-btn').offsetWidth + 'px!important');
                        rOverlay.setAttribute('value', 'Update Fehlgeschlagen!');
                        rOverlay.setAttribute('class', 'gradient-red');

                        document.getElementById('update-btn').parentElement.insertBefore(rOverlay, document.getElementById('update-btn'));

                        setTimeout(function()
                        {
                            rOverlay.style.opacity = 1;
                            document.getElementById('updating').style.opacity = 0;
                        }, 10);
                        
                        setTimeout(function()
                        {
                            rOverlay.style.opacity = 0;
                            document.getElementById('update-btn').style.opacity = 1;
                        }, 5000);

                        setTimeout(function()
                        {
                            document.getElementById('update-btn').parentElement.removeChild(rOverlay);
                            document.getElementById('update-btn').parentElement.removeChild(document.getElementById('updating'));
                            document.getElementById('update-btn').parentElement.removeChild(document.getElementById('waiting'));
                        }, 5300);
                    }

                    updating = false;

                    setTimeout(function()
                    {
                        location.reload();
                    }, 5600);
                }
            }
        }
        
        client.send();
    }
    
    setTimeout(function()
    {
        pingESP();
    }, 500);
    
    function pingESP()
    {
        if(updating)
        {
            checkUpdate(device.ip, device.name, device.version);
        }
        else
        {
            var client = new XMLHttpRequest();

            client.timeout = 10000;
        
            client.open('GET', 'http://' + device.ip + '/');

            client.onreadystatechange = function()
            {
                if(client.readyState === 4)
                {  
                    if(client.status === 200)
                    {
                        console.log("ESP Gefunden");

                        if(restart == true)
                        {
                            var rOverlay = document.createElement('input');

                            rOverlay.setAttribute('type', 'button');
                            rOverlay.setAttribute('id', 'restart-result');
                            rOverlay.setAttribute('style', 'opacity: 0; z-index: 1; letter-spacing: 3px; position: absolute; left: ' + document.getElementById('restart-btn').offsetLeft + 'px; top: ' + document.getElementById('restart-btn').offsetTop + 'px; width: ' + document.getElementById('restart-btn').offsetWidth + 'px!important');
                            rOverlay.setAttribute('value', 'Neustart Erfolgreich!');
                            rOverlay.setAttribute('class', 'gradient-green');

                            document.getElementById('restart-btn').parentElement.insertBefore(rOverlay, document.getElementById('restart-btn'));

                            setTimeout(function()
                            {
                                rOverlay.style.opacity = 1;
                                document.getElementById('restarting').style.opacity = 0;
                            }, 10);
                        
                            setTimeout(function()
                            {
                                rOverlay.style.opacity = 0;
                                document.getElementById('restart-btn').style.opacity = 1;
                            }, 5000);

                            setTimeout(function()
                            {
                                document.getElementById('restart-btn').parentElement.removeChild(rOverlay);
                                document.getElementById('restart-btn').parentElement.removeChild(document.getElementById('restarting'));
                                document.getElementById('update-btn').parentElement.removeChild(document.getElementById('waiting'));
                            }, 5300);

                            restart = false;
                        }

                        for(var i = 0; i <= 4000; i+=1000)
                        {
                            setTimeout(function()
                            {
                                fetchState();
                            }, i);
                        }

                        setTimeout(function()
                        {
                            pingESP();
                        }, 5000);
                    }
                    else
                    {
                        document.getElementsByClassName('control-panel')[0].style.backgroundImage = 'linear-gradient(to top, hsl(350, 75%, 45%) 0%, hsl(350, 75%, 55%) 100%)';
                        document.getElementsByClassName('control-panel')[0].value = 'OFFLINE';
                        
                        setTimeout(function()
                        {
                            pingESP();
                        }, 500);
                    }
                }
            }
            
            client.send();
        }
    }    
    
    function updateDevice()
    {        
        if(document.getElementById('updating') == null && document.getElementById('waiting') == null && document.getElementById('update-result') == null)
        {
            var wOverlay = document.createElement('input');

            wOverlay.setAttribute('type', 'button');
            wOverlay.setAttribute('id', 'waiting');
            wOverlay.setAttribute('style', 'opacity: 0; z-index: 1; letter-spacing: 3px; position: absolute; left: ' + document.getElementById('update-btn').offsetLeft + 'px; top: ' + document.getElementById('update-btn').offsetTop + 'px; width: ' + document.getElementById('update-btn').offsetWidth + 'px!important');
            wOverlay.setAttribute('value', 'Bitte Warten ..');
            wOverlay.setAttribute('class', 'gradient-blue');

            document.getElementById('update-btn').parentElement.insertBefore(wOverlay, document.getElementById('update-btn'));

            setTimeout(function()
            {
                wOverlay.style.opacity = 1;
                document.getElementById('update-btn').style.opacity = 0;
            }, 10);

            var client = new XMLHttpRequest();

            client.timeout = 10000;
        
            client.open('GET', 'http://' + device.ip + '/update');

            client.onreadystatechange = function()
            {
                if(client.readyState === 4)
                {  
                    if(client.status === 200)
                    {
                        if(client.responseText == 'Das Update wird installiert ..')
                        {
                            updating = true;

                            var overlay = document.createElement('input');

                            overlay.setAttribute('type', 'button');
                            overlay.setAttribute('id', 'updating');
                            overlay.setAttribute('style', 'opacity: 0; z-index: 1; letter-spacing: 3px; position: absolute; left: ' + document.getElementById('update-btn').offsetLeft + 'px; top: ' + document.getElementById('update-btn').offsetTop + 'px; width: ' + document.getElementById('update-btn').offsetWidth + 'px!important');
                            overlay.setAttribute('value', 'Update Wird Installiert ..');
                            overlay.setAttribute('class', 'gradient-purple');

                            document.getElementById('update-btn').parentElement.insertBefore(overlay, document.getElementById('update-btn'));

                            setTimeout(function()
                            {
                                overlay.style.opacity = 1;
                                wOverlay.style.opacity = 0;
                            }, 10);
                        }
                    }
                    else
                    {
                        var rOverlay = document.createElement('input');

                        rOverlay.setAttribute('type', 'button');
                        rOverlay.setAttribute('id', 'update-result');
                        rOverlay.setAttribute('style', 'opacity: 0; z-index: 1; letter-spacing: 3px; position: absolute; left: ' + document.getElementById('update-btn').offsetLeft + 'px; top: ' + document.getElementById('update-btn').offsetTop + 'px; width: ' + document.getElementById('update-btn').offsetWidth + 'px!important');
                        rOverlay.setAttribute('value', 'Keine Verbindung zum Gerät!');
                        rOverlay.setAttribute('class', 'gradient-red');

                        document.getElementById('update-btn').parentElement.insertBefore(rOverlay, document.getElementById('update-btn'));

                        setTimeout(function()
                        {
                            rOverlay.style.opacity = 1;
                            wOverlay.style.opacity = 0;
                        }, 10);
                    
                        setTimeout(function()
                        {
                            rOverlay.style.opacity = 0;
                            document.getElementById('update-btn').style.opacity = 1;
                        }, 5000);

                        setTimeout(function()
                        {
                            document.getElementById('update-btn').parentElement.removeChild(rOverlay);
                            document.getElementById('update-btn').parentElement.removeChild(wOverlay);
                            document.getElementById('update-btn').parentElement.removeChild(overlay);
                        }, 5300);
                    }
                }
            }

            client.send();
        }
    }
    
    function checkUpdates()
    {
        var client = new XMLHttpRequest();

        client.timeout = 10000;
        
        client.open('GET', 'http://syntex.sytes.net/smarthome/check-version?device=' + document.getElementsByClassName('main')[1].getAttribute('type'));

        client.onreadystatechange = function()
        {
            if(client.readyState === 4)
            {  
                if(client.status === 200)
                {
                    if(client.responseText > document.getElementsByClassName('main')[1].getAttribute('version'))
                    {
                        var update = document.createElement('input');

                        update.setAttribute('type', 'button');
                        update.setAttribute('value', 'Update Installieren ( v' + client.responseText + ' )');
                        update.setAttribute('style', 'margin-bottom: 20px;');
                        update.setAttribute('onclick', 'updateDevice()');
                        update.setAttribute('id', 'update-btn');

                        document.getElementsByClassName('main')[1].insertBefore(update, document.getElementById('restart-btn'));
                    }
                }
            }
        }

        client.send();
    }
    
    checkUpdates();

</script>