<html>
	<body ontouchstart="">
		<div id="content">
			<script>

				var resizeTimerOne, resizeTimerTwo;
				var lastWidth = window.innerWidth, lastHeight = window.innerHeight, windowResized = false;

				setInterval(() => {

					if(windowResized)
					{
						windowResized = false;

						for(var i = 0; i < document.getElementsByClassName('control-panel').length; i++)
						{
							resizeFontSizeToFit(document.getElementsByClassName('control-panel')[i].children[0]);
						}
					}

				}, 100);

				window.addEventListener('resize', (e) => {

					if(lastWidth < window.innerWidth || lastWidth > window.innerWidth)
					{
						lastWidth = window.innerWidth;

						windowResized = true;
					}

					if(lastHeight < window.innerHeight || lastHeight > window.innerHeight)
					{
						lastHeight = window.innerHeight;
						
						windowResized = true;
					}

					clearTimeout(resizeTimerOne);
					clearTimeout(resizeTimerTwo);

					resizeTimerOne = setTimeout(() => repaintGraphs(), 250);
					resizeTimerTwo = setTimeout(() => {
						
						if(windowResized)
						{
							windowResized = false;

							for(var i = 0; i < document.getElementsByClassName('control-panel').length; i++)
							{
								resizeFontSizeToFit(document.getElementsByClassName('control-panel')[i].children[0]);
							}
						}

					}, 100);
				});
				
			</script>
			<title class="loading-loop">%general.loading% ..</title>
			<script type="module">

				import { PageManager } from '/js/page-manager.js';

				window.PageManager = PageManager;

				window.device = JSON.parse('<%device%>');

				if((new URL(window.location.href)).searchParams.get('settings') == '')
				{
					PageManager.setHeader('%general.settings%', '( ' + device.name + ' )');

					var main = document.createElement('div');

					main.style.display = 'flex';

					main.innerHTML = '<input type="button" value="%menu.back%" onclick="closeSettings(' + "'settings'" + ')"><div style="display: block; width: 100%; margin-left: 20px"><input id="save-btn" type="submit" form="settings-form-main" value="%general.save%"></div>';

					PageManager.setFooter(main);
					PageManager.showFooter();

					PageManager.switchPage('infos', 'settings', true);
				}
				else
				{
					PageManager.hideHeader();

					var main = document.createElement('div');

					if(device.plugin.alias == 'SynTex')
					{
						main.innerHTML = '<input id="restart-btn" style="margin-bottom: 20px;" type="button" value="%device.restart%" onclick="restartDevice(this)">';
					}

					main.innerHTML += '<div style="display: flex"><input type="button" value="%menu.back%" onclick="Essentials.leavePage(' + "'/'" + ')"><button onclick="openSettings(' + "'infos'" + ')" class="icon-button right split arrow" style="margin-left: 20px"><div class="button-icon red"><img class="icon-inverted" src="/img/settings.png"></div><div class="button-text">%device.modify%</div></button></div>';

					PageManager.setFooter(main);
					PageManager.showFooter();
				}

			</script>
			<div class="main" id="infos" style="transition: .2s opacity ease-in-out">
				<div id="head"></div>
				<div class="control-container"></div>
				<h1 class="loading-loop">%general.loading% ..</h1>
				<div id="info" class="main" style="margin-top: 100px; margin-bottom: 100px"></div>
				<div id="activity"></div>
			</div>
			<div id="settings" style="display: none; transition: .2s opacity ease-in-out">
				<form id="settings-form-main" onsubmit="event.preventDefault(); saveConfig();" class="main">
					<div id="settings-form" style="margin-bottom: 100px">
						<p style="margin-top: 0"><b>%general.name%: <input oninput="Essentials.promoteSubmitButton(this, 'save-btn')" pattern="[a-zA-ZäÄöÖüÜ0-9-#()&/ ]+" title="%pattern.letters_numbers_spaces_special%: # / ( )" required name="name" type="text" style="max-width: 325px"></b></p>
						<p><b>%general.group%: <input oninput="Essentials.promoteSubmitButton(this, 'save-btn')" pattern="[a-zA-ZäÄöÖüÜ0-9-#()&/ ]+" title="%pattern.letters_numbers_spaces_special%: # / ( )" name="group" type="text" style="max-width: 325px"></b></p>
					</div>
					<input id="reset-btn" type="button" value="%device.reset_device%" onclick="resetDevice(this)">
					<input id="reconnect-btn" style="margin-top: 20px" type="button" value="%device.reconnect%">
				</form>
			</div>
			<script type="module">

				import { Query } from '/js/query.js';
				import { Essentials } from '/js/essentials.js';
				import { Presets } from '/js/presets.js';
				import { Graph } from '/js/graph.js';

				Query.SETUP(Essentials);
				Essentials.SETUP(Query, Preloader);
				
				Graph.setPadding(50);

				window.Query = Query;
				window.Essentials = Essentials;
				window.Presets = Presets;
				window.Graph = Graph;

				window.values = {};
				window.typeCounter = {};
				window.counter = Array.isArray(device.services) ? device.services.length : 1;
				window.automation = []
				window.busy = [];
				window.restarting = false
				window.resetting = false
				window.updating = false
				window.saving = false;
				window.settings = [];
				window.activity = [];
				window.services = [];
				window.temp = {};
				window.graphData = {};

				window.data = {
					motion: {
						active : { text : '%characteristics.motion.active%', color : 'hsl(280, 75%, 55%)' },
						inactive : { text : '%characteristics.motion.inactive%', color : 'hsl(150, 75%, 55%)' }
					},
					occupancy: {
						active : { text : '%characteristics.occupancy.active%', color : 'hsl(280, 75%, 55%)' },
						inactive : { text : '%characteristics.occupancy.inactive%', color : 'hsl(150, 75%, 55%)' }
					},
					smoke: {
						active : { text : '%characteristics.smoke.active%', color : 'hsl(280, 75%, 55%)' },
						inactive : { text : '%characteristics.smoke.inactive%', color : 'hsl(150, 75%, 55%)' }
					},
					contact: {
						active : { text : '%characteristics.contact.active%', color : 'hsl(350, 75%, 55%)' },
						inactive : { text : '%characteristics.contact.inactive%', color : 'hsl(150, 75%, 55%)' }
					},
					outlet: {
						active : { text : '%characteristics.boolean.active%', color : 'hsl(205, 75%, 55%)' },
						inactive : { text : '%characteristics.boolean.inactive%', color : 'rgb(60, 60, 80)' }
					},
					relais: {
						active : { text : '%characteristics.boolean.active%', color : 'hsl(205, 75%, 55%)' },
						inactive : { text : '%characteristics.boolean.inactive%', color : 'rgb(60, 60, 80)' }
					},
					switch: {
						active : { text : '%characteristics.boolean.active%', color : 'hsl(18, 75%, 55%)' },
						inactive : { text : '%characteristics.boolean.inactive%', color : 'rgb(60, 60, 80)' }
					},
					rain: {
						active : { text : '%characteristics.rain.active%', color : 'hsl(220, 75%, 55%)' },
						inactive : { text : '%characteristics.rain.inactive%', color : 'hsl(150, 75%, 55%)' }
					},
					statelessswitch: {
						active : { text : '%characteristics.statelessswitch.active%', color : 'hsl(205, 75%, 55%)' },
						inactive : { text : '%characteristics.statelessswitch.inactive%', color : 'hsl(150, 75%, 55%)' }
					},
					led: {
						active : { text : '%characteristics.boolean.active%', color : 'hsl(18, 75%, 55%)' },
						inactive : { text : '%characteristics.boolean.inactive%', color : 'hsl(205, 75%, 55%)' }
					},
					dimmer: {
						active : { text : '%characteristics.boolean.active%', color : 'hsl(18, 75%, 55%)' },
						inactive : { text : '%characteristics.boolean.inactive%', color : 'hsl(205, 75%, 55%)' }
					},
					rgb: {
						active : { text : '%characteristics.boolean.active%', color : 'hsl(18, 75%, 55%)' },
						inactive : { text : '%characteristics.boolean.inactive%', color : 'hsl(205, 75%, 55%)' }
					},
					rgbw: {
						active : { text : '%characteristics.boolean.active%', color : 'hsl(18, 75%, 55%)' },
						inactive : { text : '%characteristics.boolean.inactive%', color : 'hsl(205, 75%, 55%)' }
					},
					rgbww: {
						active : { text : '%characteristics.boolean.active%', color : 'hsl(18, 75%, 55%)' },
						inactive : { text : '%characteristics.boolean.inactive%', color : 'hsl(205, 75%, 55%)' }
					},
					rgbcw: {
						active : { text : '%characteristics.boolean.active%', color : 'hsl(18, 75%, 55%)' },
						inactive : { text : '%characteristics.boolean.inactive%', color : 'hsl(205, 75%, 55%)' }
					},
					temperature: { text : '°C', colorRange : [220, 0], valueRange : [18, 26] },
					humidity: { text : '%', color : 'hsl(140, 75%, 55%)', colorRange : [0, 280], valueRange : [0, 100] },
					light: { text : '%characteristics.light%', color : 'hsl(40, 85%, 85%)', colorRange : [25, 85], valueRange : [0, 1000] },
					airquality: { text : '%characteristics.airquality%', color : 'hsl(180, 75%, 55%)', colorRange : [180, 0], valueRange : [0, 5] }
				};

				window.serviceNames = {
					airquality : '%accessories.airquality%',
					contact : '%accessories.contact%',
					dimmer : '%accessories.dimmer%',
					humidity : '%accessories.humidity%',
					led : '%accessories.led%',
					light : '%accessories.light%',
					motion : '%accessories.motion%',
					occupancy : '%accessories.occupancy%',
					outlet : '%accessories.outlet%',
					rain : '%accessories.rain%',
					relais : '%accessories.relais%',
					rgb : '%accessories.rgb%',
					smoke : '%accessories.smoke%',
					statelessswitch : '%accessories.statelessswitch%',
					switch : '%accessories.switch%',
					temperature : '%accessories.temperature%',
					special : '%accessories.special%',
					unsupported : '%accessories.unsupported%',
					climate : '%accessories.climate%',
					weather : '%accessories.weather%'
				};

				loadServices();

				if(Presets.getPreset(device.plugin.alias) == null || Presets.getPreset(device.plugin.alias).getReconnectURL(device) == null)
				{
					document.getElementById('reconnect-btn').style.display = 'none';
				}

				if(Presets.getPreset(device.plugin.alias) == null || Presets.getPreset(device.plugin.alias).getResetURL(device, { type : Essentials.getType(services) }) == null)
				{
					document.getElementById('reset-btn').style.display = 'none';
				}

				if(services.includes('contact') || services.includes('motion') || services.includes('statelessswitch') || services.includes('temperature') || services.includes('humidity') || services.includes('light') || services.includes('rain'))
				{
					if(device.active != null)
					{
						settings.push({
							index: 'active',
							name: '%device.active%'
						});
					}
				}

				if(services.includes('contact') || services.includes('motion') || services.includes('relais') || services.includes('statelessswitch') || services.includes('lcd'))
				{
					if(device.led != null)
					{
						settings.push({
							index: 'led',
							name: '%device.led%'
						});
					}
				}

				if(services.includes('motion') || services.includes('light') || services.includes('temperature') || services.includes('humidity') || services.includes('lcd'))
				{
					if(device.interval != null)
					{
						settings.push({
							index: 'interval',
							name: services.includes('motion') ? '%device.delay%' : '%device.interval%'
						});
					}
				}

				document.getElementsByTagName('title')[0].innerHTML = device.name;
				document.getElementById('infos').getElementsByTagName('h1')[0].innerHTML = device.name;

				var infos = document.getElementById('info');

				infos.innerHTML += '<p style="user-select: text"><b>%general.id%: </b>' + device.id + '</p>';

				if(device.ip != null)
				{
					infos.innerHTML += '<p style="user-select: text"><b>%general.ip%: </b>' + device.ip + '</p>';
				}

				infos.innerHTML += '<p><b>%general.plugin%: </b>' + device.plugin[device.plugin.name != null ? 'name' : 'alias'] + '</p>';
				
				infos.innerHTML += '<p><b>%device.type%: </b>' + (serviceNames[Essentials.getType(services)] || Essentials.getType(services)) + '</p>';

				if(device.version != null && device.version != '0.0.0')
				{
					infos.innerHTML += '<p id="version-info"><b>%device.version%: </b>' + device.version + '</p>';
				}

				if(device.group != null && device.group != '')
				{
					infos.innerHTML += '<p><b>%general.group%: </b>' + device.group + '</p>';
				}

				for(const i in settings)
				{
					if(settings[i].index == 'interval' && !services.includes('motion'))
					{
						infos.innerHTML += '<p><b>' + settings[i].name + ': </b>' + device[settings[i].index] / 1000 + ' sek' + '</p>';
					}
					else if(settings[i].index == 'interval' && services.includes('motion'))
					{
						infos.innerHTML += '<p><b>' + settings[i].name + ': </b>' + (device[settings[i].index] / 1000 + 1.5) + ' sek' + '</p>';
					}
					else if(settings[i].index == 'led' || settings[i].index == 'active')
					{
						if(device[settings[i].index] == 1)
						{
							infos.innerHTML += '<p><b>' + settings[i].name + ': </b>%characteristics.boolean.active%</p>';
						}
						else
						{
							infos.innerHTML += '<p><b>' + settings[i].name + ': </b>%characteristics.boolean.inactive%</p>';
						}
					}
					else
					{
						infos.innerHTML += '<p><b>' + settings[i].name + ': </b>' + device[settings[i].index] + '</p>';
					}
				}

				document.getElementById('footer-content').setAttribute('type', Essentials.getType(services));
				document.getElementById('footer-content').setAttribute('version', device.version);

				document.getElementById('reconnect-btn').setAttribute('onclick', "Essentials.leavePage('/connect?id=" + device.id + '&ip=' + device.ip + "')");

				var settingsForm = document.getElementById('settings-form');

				if(device.plugin.alias == 'SynTexTuya')
				{
					settingsForm.getElementsByTagName('input')[0].setAttribute('placeholder', '%device.change_in_tuya%');
					settingsForm.getElementsByTagName('input')[0].setAttribute('disabled', '');
				}
				else
				{
					settingsForm.getElementsByTagName('input')[0].setAttribute('value', device.name);
				}

				settingsForm.getElementsByTagName('input')[1].setAttribute('value', device.group || '');

				for(const i in settings)
				{
					if(settings[i].index == 'interval' && !services.includes('motion'))
					{
						settingsForm.innerHTML += '<p><b>' + settings[i].name + ': <input oninput="Essentials.promoteSubmitButton(this, ' + "'save-btn'" + ')" pattern="[0-9]+" title="%pattern.numbers%" required value="' + device[settings[i].index] / 1000 + '" name="' + settings[i].index + '" type="text" style="max-width: 150px"> sek</b></p>';
					}
					else if(settings[i].index == 'interval' && services.includes('motion'))
					{
						settingsForm.innerHTML += '<p><b>' + settings[i].name + ': <input oninput="Essentials.promoteSubmitButton(this, ' + "'save-btn'" + ')" pattern="[0-9]+" title="%pattern.numbers%" required value="' + (device[settings[i].index] / 1000 + 1.5) + '" name="' + settings[i].index + '" type="text" style="max-width: 150px"> sek</b></p>';
					}
					else if(settings[i].index == 'led' || settings[i].index == 'active')
					{
						settingsForm.innerHTML += '<p><b>' + settings[i].name + ': <input value="' + (device[settings[i].index] == 1 ? '%characteristics.boolean.active%' : '%characteristics.boolean.inactive%') + '" orginal-value="' + (device[settings[i].index] == 1 ? '%characteristics.boolean.active%' : '%characteristics.boolean.inactive%') + '" name="' + settings[i].index + '" type="button" class="' + (device[settings[i].index] == 1 ? 'white' : 'outline') + '" onclick="switchFormButton(this); Essentials.promoteSubmitButton(this, ' + "'save-btn'" + ')" style="max-width: 150px; border-width: 3px"></b></p>';
					}
					else
					{
						settingsForm.innerHTML += '<p><b>' + settings[i].name + ': <input oninput="Essentials.promoteSubmitButton(this, ' + "'save-btn'" + ')" required value="' + device[settings[i].index] + '" name="' + settings[i].index + '" type="text" style="max-width: 150px"></b></p>';
					}
				}

				settingsForm.setAttribute('device_id', device.id);
				settingsForm.setAttribute('ip', device.ip);
				settingsForm.setAttribute('type', Essentials.getType(services));

				for(var i = 0; i < counter; i++)
				{
					var type = Array.isArray(device.services) ? device.services[i] : device.services;

					if(type instanceof Object)
					{
						typeCounter[type.type] = typeCounter[type.type] ? typeCounter[type.type] + 1 : 1;
					}
					else
					{
						typeCounter[type] = typeCounter[type] ? typeCounter[type] + 1 : 1;
					}
				}

				var c = counter;

				for(var i = 0; i < Object.keys(typeCounter).length; i++)
				{
					var type = Object.keys(typeCounter)[i];

					if(type != 'lcd' && type != 'removed' && type != 'unsupported' && (type != 'statelessswitch' || services.length == 1))
					{
						for(var j = 0; j < typeCounter[type]; j++)
						{
							var letters = Essentials.typeToLetter(type) + j;
							var statusField = document.createElement('button');
						
							statusField.setAttribute('id', 'status-' + letters);
							statusField.setAttribute('class', 'control-panel loading-loop');
							statusField.setAttribute('type', 'button');

							statusField.innerHTML = '<div class="control-panel-text">%general.loading% ..</div>';

							if(type == 'outlet' || type == 'relais' || type == 'switch' || type == 'rgb' || type == 'rgbw' || type == 'rgbww' || type == 'rgbcw' || type == 'dimmer')
							{
								statusField.style.cursor = 'pointer';
							}
							
							if(type == 'outlet' || type == 'relais' || type == 'switch')
							{
								statusField.setAttribute('onclick', 'controlSwitch(this)');
							}

							if(counter > 1)
							{
								statusField.style.height = '100px';
							}

							if(i == counter - 1) // UGLY: Handle Statusfield Margin
							{
								statusField.style.setProperty('margin-bottom', '0', 'important');
							}

							if(type == 'dimmer' || type == 'rgb' || type == 'rgbw' || type == 'rgbww' || type == 'rgbcw')
							{
								const mouseDownHandler = function(e)
								{
									if(!busy.includes(this.letters))
									{
										controlDimmer(this.letters, Math.round(e.offsetX / this.field.offsetWidth * 100), true);

										document.addEventListener('mousemove', mouseMoveHandler);
										document.addEventListener('mouseup', mouseUpHandler);
									}

								}.bind({ field : statusField, letters });

								const mouseMoveHandler = function(e)
								{
									this.field.style.pointerEvents = 'none';
									this.field.parentElement.style.cursor = 'w-resize';
									this.field.style.setProperty('transition-property', 'none', 'important');

									var percent = Math.min(Math.max(e.offsetX / this.field.offsetWidth * 100, 0), 100);
									var groupBar = this.field.getBoundingClientRect();

									if(e.clientX < groupBar.left)
									{
										percent = 0;
									}
									else if(e.clientX > groupBar.right)
									{
										percent = 100;
									}

									controlDimmer(this.letters, percent, true);

								}.bind({ field : statusField, letters });

								const mouseUpHandler = function(e)
								{
									this.field.style.pointerEvents = 'all';
									this.field.parentElement.style.cursor = 'pointer';
									this.field.style.removeProperty('transition-property');

									var percent = Math.min(Math.max(e.offsetX / this.field.offsetWidth * 100, 0), 100);
									var groupBar = this.field.getBoundingClientRect();
									
									if(e.clientX < groupBar.left)
									{
										percent = 0;
									}
									else if(e.clientX > groupBar.right)
									{
										percent = 100;
									}

									controlDimmer(this.letters, percent);

									Promise.all(promiseArraySlide).then(() => {

										setTimeout(() => busy.splice(busy.indexOf(letters), 1), 300);
									});

									document.removeEventListener('mousemove', mouseMoveHandler);
									document.removeEventListener('mouseup', mouseUpHandler);

								}.bind({ field : statusField, letters });

								statusField.addEventListener('mousedown', mouseDownHandler);

								statusField.addEventListener('touchstart', function(e)
								{
									if(!busy.includes(letters))
									{
										getTouchPosition(this.field, this.letters, e, true);
									}

								}.bind({ field : statusField, letters }));

								statusField.addEventListener('touchmove', function(e)
								{
									if(!busy.includes(letters))
									{
										this.field.style.setProperty('transition-property', 'none', 'important');

										getTouchPosition(this.field, this.letters, e, true);
									}

								}.bind({ field : statusField, letters }));

								statusField.addEventListener('touchend', function(e)
								{
									if(!busy.includes(letters))
									{
										getTouchPosition(this.field, this.letters, e);

										this.field.style.removeProperty('transition-property');

										Promise.all(promiseArraySlide).then(() => {
											
											setTimeout(() => busy.splice(busy.indexOf(letters), 1), 300);
										});
									}

								}.bind({ field : statusField, letters }));
							}

							document.getElementsByClassName('control-container')[0].appendChild(statusField);

							if(type != 'removed')
							{
								var height = 300;
								var frame = document.createElement('div'), canvas = document.createElement('canvas'), grid = document.createElement('canvas');

								frame.className = 'graph';
								frame.setAttribute('style', 'height: ' + height + 'px');

								document.getElementById('activity').appendChild(frame);

								console.debug('SET HEIGHT', height, frame);

								canvas.setAttribute('class', 'canvas');
								canvas.setAttribute('id', 'canvas-' + Essentials.typeToLetter(type) + j);
								canvas.setAttribute('style', 'z-index: 1; opacity: 0');

								canvas.width = document.getElementById('infos').offsetWidth - 4;
								canvas.height = height;

								frame.appendChild(canvas);

								grid.setAttribute('class', 'canvas');
								grid.setAttribute('id', 'canvas-' + type + '-' + j);
								grid.setAttribute('style', 'top: -100%');

								grid.width = document.getElementById('infos').offsetWidth - 4;
								grid.height = height;

								frame.appendChild(grid);

								Graph.drawGrid(grid, [], 10);

								var infoMin = document.createElement('div');

								infoMin.setAttribute('style', 'position: relative; z-index: 1; bottom: calc(100% + 17px); left: 25px; margin-top: -19.2px; color: rgb(150, 150, 170); letter-spacing: 3px; font-weight: 300; opacity: 0; transition: 1s');
								infoMin.setAttribute('class', 'min');
								infoMin.innerHTML = '%device.min%';

								frame.appendChild(infoMin);

								var infoMax = document.createElement('div');

								infoMax.setAttribute('style', 'position: relative; z-index: 1; bottom: calc(100% + ' + (height - 34.5) + 'px); left: 25px; margin-top: -19.2; color: rgb(150, 150, 170); letter-spacing: 3px; font-weight: 300; opacity: 0; transition: 1s');
								infoMax.setAttribute('class', 'max');
								infoMax.innerHTML = '%device.max%';

								frame.appendChild(infoMax);

								var infoType = document.createElement('div');

								infoType.setAttribute('style', 'position: relative; z-index: 1; bottom: calc(100% + ' + (height - 34.5) + 'px); margin-top: -19.2; color: rgb(150, 150, 170); letter-spacing: 3px; text-align: center; font-weight: 300');

								if(type == 'rgb' || type == 'rgbw' || type == 'rgbcw' || type == 'rgbww')
								{
									type = type.toUpperCase();
								}
								else if(type == 'statelessswitch')
								{
									type = 'Stateless Switch';
								}

								var name = type[0].toUpperCase() + type.substring(1), n = [];

								if(typeCounter[type] > 1)
								{
									name = device.name + ' ' + type[0].toUpperCase() + type.substring(1) + ' ' + j;
								}
								else if(counter > 1)
								{
									//name = device.name + ' ' + type[0].toUpperCase() + type.substring(1);
								}

								for(var k = 0; k < device.services.length; k++)
								{
									if(device.services[k] instanceof Object && device.services[k].type == type && device.services[k].name != null)
									{
										n.push(device.services[k].name);
									}
								}

								if(n.length > 0)
								{
									name = n[j];
								}

								if(name.includes(device.name))
								{
									name = name.replace(device.name, '');
								}

								name = name.toUpperCase();

								infoType.innerHTML = name;

								frame.appendChild(infoType);
								
								var infoUpdates = document.createElement('div');

								infoUpdates.setAttribute('style', 'position: relative; z-index: 1; bottom: calc(100% + ' + (height - 34.5) + 'px); left: -25px; margin-top: -19.2; color: rgb(150, 150, 170); letter-spacing: 3px; text-align: right; font-weight: 300; opacity: 0; transition: 1s');
								infoUpdates.setAttribute('class', 'updates');
								infoUpdates.innerHTML = '%device.data%';

								frame.appendChild(infoUpdates);

								var infoUpdate = document.createElement('div');

								infoUpdate.setAttribute('style', 'position: relative; z-index: 1; bottom: calc(100% + 17px); left: -25px; margin-top: -19.2; color: rgb(150, 150, 170); letter-spacing: 3px; text-align: right; font-weight: 300; opacity: 0; transition: 1s');
								infoUpdate.setAttribute('class', 'update');
								infoUpdate.innerHTML = '%device.activity%';

								frame.appendChild(infoUpdate);

								if(!device.plugin.alias.startsWith('SynTex'))
								{
									var notSupportedButton = document.createElement('h2');

									notSupportedButton.innerHTML = '%device.no_data%';
									notSupportedButton.className = 'reload-button';
									notSupportedButton.setAttribute('style', 'margin-top: -480px');

									canvas.parentElement.appendChild(notSupportedButton);

									setTimeout(function()
									{
										this.notSupportedButton.style.opacity = 1;

									}.bind({ notSupportedButton }), 0);
								}
							}
						}
					}
					else
					{
						c -= typeCounter[type];
					}
				}

				if(c > 3)
				{
					document.getElementsByClassName('control-container')[0].classList.add('grid');
				}

				Preloader.finish();

				Query.complexFetch('/serverside/automation', 5000, 2, {}, false).then(function(a) {

					automation = JSON.parse(a);

					loadActivity().then(() => repaintGraphs());
				});

				if(Presets.getPreset(device.plugin.alias) != null && Presets.getPreset(device.plugin.alias).getVersionURL(device) != null)
				{
					checkUpdates();
				}

				if(Presets.getPreset(device.plugin.alias) != null && Presets.getPreset(device.plugin.alias).getPingURL(device) != null)
				{
					pingESP();
				}

				if(device.plugin.alias.startsWith('SynTex'))
				{
					setupViewer();
					setupController();
				}
				else
				{
					fetchState();

					setInterval(() => {

						if(!updating && !saving && !resetting && document.getElementById('settings').hasAttribute('style'))
						{
							fetchState();
						}

					}, 3000);
				}

			</script>
			<script>

				function getTouchPosition(statusField, letters, e, send)
				{
					let touchobj = e.changedTouches[0];

					var groupBar = statusField.getBoundingClientRect();
					var percent = (touchobj.clientX - groupBar.left - 25) / (statusField.offsetWidth - 50) * 100;

					if(touchobj.clientX < groupBar.left || percent < 0)
					{
						percent = 0;
					}
					else if(touchobj.clientX > groupBar.right || percent > 100)
					{
						percent = 100;
					}
						
					controlDimmer(letters, percent, send);

					e.preventDefault();
				}

				window.promiseArraySlide = [];

				function controlDimmer(letters, percent, send)
				{
					if(!send && !busy.includes(letters))
					{
						busy.push(letters);
					}

					percent = Math.round(percent);

					var state = { value : (percent > 0 ? true : false), brightness : percent };

					if(temp[letters] != null)
					{
						state.hue = temp[letters].hue;
						state.saturation = temp[letters].saturation;
					}

					if(device.plugin.alias.startsWith('SynTex'))
					{
						if(!send)
						{
							DeviceController.send(JSON.stringify({ line : 'setState', params : { id : device.id, letters : letters, name : device.name, value : (percent > 0 ? true : false), brightness : percent  } }));
						}
						else
						{
							setControlPanel(letters, state);
						}
					}
					else if(getService(letters) != null && getService(letters).iid != null)
					{
						setControlPanel(letters, state);

						if(!send)
						{
							var url = '/serverside/characteristics?id=' + device.id + '&iid=' + getService(letters).iid['state'] + '&value=' + (percent > 0 ? true : false) + '&brightness=' + percent;
					
							promiseArraySlide.push(Query.complexFetch(url, 10000, 1, {}, false));
						}
					}
				}

				function setControlPanel(letters, state)
				{
					var type = Essentials.letterToType(letters[0]), c = letters[1], color = '', value = '–––';

					if(state != null)
					{
						if(type == 'rgb' || type == 'dimmer')
						{
							if(state.value == false || state.brightness == 0)
							{
								value = '%characteristics.boolean.inactive%';
								color = 'rgb(60, 60, 80)';
							}
							else if(state.value == true)
							{
								value = Math.round(state.brightness) + '%';

								if(Math.round(state.brightness) == 100)
								{
									value = '%characteristics.boolean.active%';
								}
								
								if(type == 'rgb')
								{
									color = 'hsl(' + parseInt(state.hue) + ', ' + parseInt(14 + state.saturation * state.brightness / 100 / 100 * (100 - 14)) + '%, ' + (27 + state.brightness / 100 * (65 - 27)) + '%)';
								}
								else if(type == 'dimmer')
								{
									color = 'hsl(40, ' + parseInt(state.brightness * 0.85) + '%, ' + (25 + parseInt(state.brightness) * 0.5) + '%)';
								}
							}
						}
						else if(typeof state.value == 'boolean')
						{
							if(state.value)
							{
								value = data[type].active.text.toUpperCase();
								color = data[type].active.color;
							}
							else
							{
								value = data[type].inactive.text.toUpperCase();
								color = data[type].inactive.color;
							}
						}
						else if(typeof state.value == 'number')
						{
							color = 'rgb(60, 60, 80)', value = state.value;

							if(type == 'temperature')
							{
								var cRange = data[type].colorRange, vRange = data[type].valueRange;

								value = ((Math.round(state.value * 10.0)) / 10.0) + ' ' + data[type].text.toUpperCase();

								if(state.value < 18)
								{
									color = 'hsl(220, 75%, 55%)';
								}
								else if(state.value > 26)
								{
									color = 'hsl(0, 75%, 55%)';
								}
								else
								{
									color = 'hsl(' + ((state.value - vRange[0]) / (vRange[1] - vRange[0]) * (cRange[1] - cRange[0]) + cRange[0]) + ', 65%, 55%)';
								}
							}
							else if(type == 'humidity')
							{
								var cRange = data[type].colorRange, vRange = data[type].valueRange;

								value = Math.round(state.value) + ' ' + data[type].text.toUpperCase();

								if(state.value > 50)
								{	
									cRange = [280, 0];
								}	

								if(state.value < 45 || state.value > 55)	
								{	
									color = 'hsl(' + ((state.value - vRange[0]) / (vRange[1] - vRange[0]) * (cRange[1] - cRange[0]) + cRange[0]) + ', 65%, 55%)';
								}	
								else	
								{	
									color = data[type].color;	
								}
							}
							else if(type == 'light')
							{
								var cRange = data[type].colorRange, vRange = data[type].valueRange;

								value = Math.round(state.value) + ' ' + data[type].text.toUpperCase();

								if(state.value > 1000)
								{
									color = data[type].color;
								}
								else
								{
									color = 'hsl(40, ' + ((state.value - vRange[0]) / (vRange[1] - vRange[0]) * (cRange[1] - cRange[0] + 25) + cRange[0] - 25) + '%, ' + ((state.value - vRange[0]) / (vRange[1] - vRange[0]) * (cRange[1] - cRange[0]) + cRange[0]) + '%)';
								}
							}
							else if(type == 'airquality')
							{
								var cRange = data[type].colorRange, vRange = data[type].valueRange;

								value = Math.round(state.value) + ' ' + data[type].text.toUpperCase();

								if(state.value > 4)
								{
									color = data[type].color;
								}
								else
								{
									color = 'hsl(' + ((state.value - vRange[0]) / (vRange[1] - vRange[0]) * (cRange[1] - cRange[0]) + cRange[0]) + ', 85%, 65%)';
								}
							}
							else
							{
								value = state.value + ' ' + data[type].active.text.toUpperCase();
							}
						}
					}
					else if(type == 'statelessswitch')	
					{	
						value = data[type].inactive.text.toUpperCase();
						color = data[type].inactive.color;
					}

					if(typeCounter[type] > 1)
					{
						var name = device.name + ' ' + type + ' ' + c;
						var n = [];

						for(var k = 0; k < device.services.length; k++)
						{
							if(device.services[k] instanceof Object && device.services[k].type == type)
							{
								n.push(device.services[k].name);
							}
						}

						if(n.length > 0 && n[c] != null)
						{
							name = n[c];
						}

						if(name.includes(device.name + ' '))
						{
							name = name.replace(device.name + ' ', '');
						}

						document.getElementById('status-' + letters).children[0].innerHTML = name.toUpperCase() + ' [' + value + ']';
					}
					else
					{
						document.getElementById('status-' + letters).children[0].innerHTML = value;
					}

					document.getElementById('status-' + letters).style.setProperty('--content', 'url("/img/accessory/' + type + '.png")');
					document.getElementById('status-' + letters).style.setProperty('--background-color', color);

					if(color.includes('rgb'))
					{
						console.log(color, color.split(', '));

						document.getElementById('status-' + letters).style.setProperty('--box-shadow', 'rgb(' + (parseInt(color.split(', ')[0].split('(')[1]) - 20) + ', ' + (parseInt(color.split(', ')[1]) - 20) + ', ' + (parseInt(color.split(', ')[2]) - 20) + ')');
					}
					else if(color.includes('hsl'))
					{
						document.getElementById('status-' + letters).style.setProperty('--box-shadow', 'hsl(' + color.split(', ')[0].split('(')[1] + ', ' + color.split(', ')[1].split(', ')[0] + ', ' + (parseInt(color.split(', ')[2].split(')')[0]) - 10) + '%)');
					}

					resizeFontSizeToFit(document.getElementById('status-' + letters).children[0]);
				}

			</script>
			<script>

				function resizeFontSizeToFit(element)
				{
					var steps = [{ fontSize : 46, letterSpacing : 20 }, { fontSize : 30, letterSpacing : 15 }, { fontSize : 22, letterSpacing : 10 }];
					var padding = parseInt(getComputedStyle(element.parentElement).paddingLeft) + parseInt(getComputedStyle(element.parentElement).paddingRight);

					element.style.setProperty('padding-left', steps[0].letterSpacing + 'px', 'important');

					element.parentElement.style.setProperty('font-size', steps[0].fontSize + 'px', 'important');
					element.parentElement.style.setProperty('letter-spacing', steps[0].letterSpacing + 'px', 'important');

					for(var i = 0; i < steps.length; i++)
					{
						if(element.offsetHeight > element.parentElement.offsetHeight || element.offsetWidth > element.parentElement.offsetWidth - padding - steps[i].letterSpacing / 2)
						{
							element.style.setProperty('padding-left', steps[i].letterSpacing + 'px', 'important');

							element.parentElement.style.setProperty('font-size', steps[i].fontSize + 'px', 'important');
							element.parentElement.style.setProperty('letter-spacing', steps[i].letterSpacing + 'px', 'important');
						}
					}
				}

			</script>
			<script>

				function loadServices()
				{
					if(Array.isArray(device.services))
					{
						for(var j = 0; j < device.services.length; j++)
						{
							if(device.services[j] instanceof Object)
							{
								services.push(device.services[j].type);
							}
							else
							{
								services.push(device.services[j]);
							}
						}
					}
					else if(device.services instanceof Object)
					{
						services.push(device.services.type);
					}
					else
					{
						services.push(device.services);
					}

					services.sort((a, b) => (a.name > b.name) ? 1 : (b.name > a.name) ? -1 : 0);

					console.log('SERVICES', services);
				}

				async function controlSwitch(button)
				{
					var letters = button.getAttribute('id').split('-')[1];

					if(!busy.includes(letters))
					{
						var value = 'true';

						busy.push(letters);

						if(temp[letters] != null)
						{
							value = temp[letters].value == true ? 'false' : 'true';
						}

						//setControlPanel(letters, { value : (value == 'true') });

						if(device.plugin.alias.startsWith('SynTex'))
						{
							DeviceController.send(JSON.stringify({ line : 'setState', params : { id : device.id, letters : letters, name : device.name, value : value  } }));
						}
						else if(getService(letters) != null && getService(letters).iid != null)
						{
							var url = '/serverside/characteristics?id=' + device.id + '&iid=' + getService(letters).iid['state'] + '&value=' + value;
						
							Query.complexFetch(url, 10000, 1, {}, false).then((result) => busy.splice(busy.indexOf(letters), 1));
						}
					}
				}

			</script>
			<script>

				window.repaintInterval = setInterval(() => {

					for(const letters in graphData)
					{
						if(new Date().getTime() > graphData[letters].nextRefresh)
						{
							graphData[letters].nextRefresh = Graph.getMinuteCycle(graphData[letters].interval) + 60000 * graphData[letters].interval;

							//repaintGraphs();

							calcValues(Essentials.letterToType(letters[0]), letters[1]);

							console.warn(new Date(graphData[letters].nextRefresh));
						}
					}

				}, 1000);

				function loadActivity()
				{
					return new Promise(async (resolve) => {

						activity = JSON.parse(await Query.complexFetch('/serverside/activity?id=' + device.id, 10000, 2, {}, false));

						for(const type in typeCounter)
						{
							if(type != 'lcd' && type != 'removed' && type != 'unsupported' && (type != 'statelessswitch' || services.length == 1))
							{
								for(var j = 0; j < typeCounter[type]; j++)
								{
									var letters = Essentials.typeToLetter(type) + j;

									if(values[letters] == null)
									{
										values[letters] = [];
									}

									for(const lettersA in activity)
									{
										if(lettersA == letters)
										{
											if(activity[lettersA].update.length > 0)
											{
												if(type == 'statelessswitch')
												{
													for(const u in activity[lettersA].update)
													{
														values[letters].push({ time : activity[lettersA].update[u].t, value : true });
														values[letters].push({ time : activity[lettersA].update[u].t, value : false });
													}
												}
												else
												{
													for(const u in activity[lettersA].update)
													{
														var obj = { time : activity[lettersA].update[u].t }, orginalValues = activity[lettersA].update[u].v;
														var characteristics = ['power', 'hue', 'saturation', 'brightness'];

														obj['value'] = orginalValues;

														for(const c in characteristics)
														{
															if(orginalValues.includes(characteristics[c] + ': '))
															{
																if(characteristics[c] == 'power')
																{
																	obj['value'] = orginalValues.split(characteristics[c] + ': ')[1];
																}
																else
																{
																	obj[characteristics[c]] = orginalValues.split(characteristics[c] + ': ')[1];
																}
															}
														}

														for(const c in obj)
														{
															if(obj[c].includes(', '))
															{
																obj[c] = obj[c].split(', ')[0];
															}
														}

														values[letters].push(obj);
													}
												}
											}
										}
									}
								}
							}
						}

						resolve();
					});
				}

				function repaintGraphs(letters)
				{
					if(device.plugin.alias.startsWith('SynTex'))
					{
						for(const type in typeCounter)
						{
							if(type != 'lcd' && type != 'removed' && type != 'unsupported' && (type != 'statelessswitch' || services.length == 1))
							{
								for(var c = 0; c < typeCounter[type]; c++)
								{
									if(letters == null || letters == Essentials.typeToLetter(type) + c)
									{
										calcValues(type, c);
									}
								}
							}
						}

						console.debug('GRAPH DATA', graphData);
					}
					else
					{
						var graphs = document.getElementsByClassName('canvas');

						for(var i = 0; i < graphs.length; i++)
						{
							graphs[i].width = document.getElementById('infos').offsetWidth - 4;

							Graph.drawGrid(graphs[i], [], 10);
						}
					}
				}

				function calcValues(type, c)
				{
					var convertedAutomation = [], automationTriggers = [];
					var letters = Essentials.typeToLetter(type) + c;
					var canvas = document.getElementById('canvas-' + letters);

					canvas.width = document.getElementById('infos').offsetWidth - 4;

					graphData[letters] = Graph.convertActivity({ id : device.id, letters : letters, type : type, format : (type != 'statelessswitch') ? getDataType(type) : 'boolean', interval : (getDataType(type) == 'boolean' || type == 'statelessswitch') ? 4 : 10, canvas : canvas }, values[letters], automation, activity[letters] != null ? activity[letters].success : []);

					Graph.drawGrid(canvas, graphData[letters], 10);

					// NOTE: Convert GraphData Values
					
					for(const i in graphData[letters].sectors)
					{
						var a = null;

						for(const j in graphData[letters].sectors[i])
						{
							if(graphData[letters].sectors[i][j].automation != null)
							{
								a = { percent : (graphData[letters].sectors[i][j].automation - graphData[letters].min) / (graphData[letters].max - graphData[letters].min) * 100, value : graphData[letters].sectors[i][j].automation };
							}
						}

						convertedAutomation.push(a || -1);
					}

					for(const i in automation)
					{
						for(const j in automation[i].trigger)
						{
							if(automation[i].trigger[j].id == device.id && automation[i].trigger[j].letters == letters && (automation[i].trigger[j].value - graphData[letters].min) / (graphData[letters].max - graphData[letters].min) * 100 < 100 && (automation[i].trigger[j].value - graphData[letters].min) / (graphData[letters].max - graphData[letters].min) * 100 > 0)
							{
								if(!automationTriggers.includes({ percent : (automation[i].trigger[j].value - graphData[letters].min) / (graphData[letters].max - graphData[letters].min) * 100, value : automation[i].trigger[j].value }))
								{
									automationTriggers.push({ percent : (automation[i].trigger[j].value - graphData[letters].min) / (graphData[letters].max - graphData[letters].min) * 100, value : automation[i].trigger[j].value });
								}
							}
						}
					}

					automationTriggers.sort((a, b) => { return (a.percent > b.percent) ? -1 : (a.percent < b.percent) ? 1 : 0 });

					// NOTE: Draw Min, Max, Type, Update and Reload Labels

					if(Object.keys(values).length > 0 && values[letters].length > 0)
					{
						if(isNaN(values[letters][0].value) && data[type].active.text != null && data[type].inactive.text != null)
						{
							canvas.parentElement.getElementsByClassName('min')[0].innerHTML = data[type].inactive.text.toUpperCase();
							canvas.parentElement.getElementsByClassName('max')[0].innerHTML = data[type].active.text.toUpperCase();
						}
						else if(data[type].text != null)
						{
							canvas.parentElement.getElementsByClassName('min')[0].innerHTML = '%device.min% • ' + Math.round(graphData[letters].min * 10) / 10 + ' ' + data[type].text.toUpperCase();
							canvas.parentElement.getElementsByClassName('max')[0].innerHTML = '%device.max% • ' + Math.round(graphData[letters].max * 10) / 10 + ' ' + data[type].text.toUpperCase();
						}

						canvas.parentElement.getElementsByClassName('update')[0].innerHTML = ('0' + new Date(values[letters][values[letters].length - 1].time * 1000).getHours()).slice(-2) + ':' + ('0' + new Date(values[letters][values[letters].length - 1].time * 1000).getMinutes()).slice(-2) + ' • %device.activity%';
						canvas.parentElement.getElementsByClassName('updates')[0].innerHTML = values[letters].length + ' • %device.data%';
					
						if(canvas.parentElement.getElementsByTagName('h2').length > 0)
						{
							canvas.parentElement.removeChild(canvas.parentElement.getElementsByTagName('h2')[0]);
						}

						canvas.parentElement.getElementsByClassName('min')[0].style.opacity = 1;
						canvas.parentElement.getElementsByClassName('max')[0].style.opacity = 1;
						canvas.parentElement.getElementsByClassName('update')[0].style.opacity = 1;
						canvas.parentElement.getElementsByClassName('updates')[0].style.opacity = 1;
					}
					else if(canvas.parentElement.getElementsByTagName('h2').length == 0)
					{
						var reloadButton = document.createElement('h2');

						reloadButton.innerHTML = '↻ %general.reload%';
						reloadButton.className = 'reload-button';
						reloadButton.setAttribute('style', 'margin-top: -480px');
						reloadButton.setAttribute('onclick', 'loadActivity().then(() => repaintGraphs("' + letters + '"))');

						canvas.parentElement.appendChild(reloadButton);

						setTimeout(() => { reloadButton.style.opacity = 1 }, 0);
					}

					// NOTE: Set Graph Colors

					var color = 'hsl(200, 98%, 60%)';

					if(data[type].active != null && data[type].active.color != null)
					{
						color = data[type].active.color;
					}

					if(data[type].color != null)
					{
						color = data[type].color;
					}

					var cRange = data[type].colorRange,
						vRange = data[type].valueRange;

					var minColorGraph = color, maxColorGraph = color,
						minColorFill = color, maxColorFill = color;

					if(type == 'temperature')
					{
						if(graphData[letters].min < data[type].valueRange[0])
						{
							graphData[letters].min = data[type].valueRange[0];
						}
						else if(graphData[letters].min > data[type].valueRange[1])
						{
							graphData[letters].min = data[type].valueRange[1];
						}

						if(graphData[letters].max > data[type].valueRange[1])
						{
							graphData[letters].max = data[type].valueRange[1];
						}
						else if(graphData[letters].max < data[type].valueRange[0])
						{
							graphData[letters].max = data[type].valueRange[0];
						}

						minColorFill = 'hsla(' + ((graphData[letters].min - vRange[0]) / (vRange[1] - vRange[0]) * (cRange[1] - cRange[0]) + cRange[0]) + ', 65%, 55%, .1)';
						minColorGraph = 'hsl(' + ((graphData[letters].min - vRange[0]) / (vRange[1] - vRange[0]) * (cRange[1] - cRange[0]) + cRange[0]) + ', 65%, 55%)';
						
						maxColorFill = 'hsla(' + ((graphData[letters].max - vRange[0]) / (vRange[1] - vRange[0]) * (cRange[1] - cRange[0]) + cRange[0]) + ', 65%, 55%, .3)';
						maxColorGraph = 'hsl(' + ((graphData[letters].max - vRange[0]) / (vRange[1] - vRange[0]) * (cRange[1] - cRange[0]) + cRange[0]) + ', 65%, 55%)';
					}
					else if(type == 'humidity')
					{
						if(graphData[letters].min < data[type].valueRange[0])
						{
							graphData[letters].min = data[type].valueRange[0];
						}

						if(graphData[letters].max > data[type].valueRange[1])
						{
							graphData[letters].max = data[type].valueRange[1];
						}

						if(graphData[letters].min > 50)
						{	
							cRange = [data[type].colorRange[1], data[type].colorRange[0]];
						}

						minColorFill = 'hsla(' + ((graphData[letters].min - vRange[0]) / (vRange[1] - vRange[0]) * (cRange[1] - cRange[0]) + cRange[0]) + ', 65%, 55%, .1)';
						minColorGraph = 'hsl(' + ((graphData[letters].min - vRange[0]) / (vRange[1] - vRange[0]) * (cRange[1] - cRange[0]) + cRange[0]) + ', 65%, 55%)';

						if(graphData[letters].max > 50)
						{	
							cRange = [data[type].colorRange[1], data[type].colorRange[0]];
						}
						else
						{
							cRange = [data[type].colorRange[0], data[type].colorRange[1]];
						}

						maxColorFill = 'hsla(' + ((graphData[letters].max - vRange[0]) / (vRange[1] - vRange[0]) * (cRange[1] - cRange[0]) + cRange[0]) + ', 65%, 55%, .3)';
						maxColorGraph = 'hsl(' + ((graphData[letters].max - vRange[0]) / (vRange[1] - vRange[0]) * (cRange[1] - cRange[0]) + cRange[0]) + ', 65%, 55%)';
					}
					else if(type == 'light')
					{
						minColorFill = 'hsla(40, 25%, 25%, .1)';
						minColorGraph = 'hsla(40, 0%, 25%)';

						maxColorFill = 'hsla(40, 85%, 75%, .3)';
						maxColorGraph = 'hsla(40, 85%, 75%)';
					}
					else
					{
						minColorFill = color.replace('hsl', 'hsla').replace(')', ', .1)');
						maxColorFill = color.replace('hsl', 'hsla').replace(')', ', .3)');
					}

					// NOTE: Draw Graph

					Graph.drawAutomation(canvas, automationTriggers);
					Graph.drawFill(canvas, graphData[letters].values, [maxColorFill, minColorFill], 0);
					Graph.drawGraph(canvas, graphData[letters].values, [maxColorGraph, minColorGraph], false);
					Graph.drawEvents(canvas, convertedAutomation, [maxColorGraph, minColorGraph]);

					canvas.style.opacity = 1;
				}

				function getDataType(type)
				{
					if(type == 'temperature' || type == 'humidity' || type == 'light' || type == 'airquality' || type == 'statelessswitch')
					{
						return 'numeric';
					}
					else
					{
						return 'boolean';
					}
				}

			</script>
			<script>

				function switchFormButton(btn)
				{
					if(btn.hasAttribute('class') && btn.getAttribute('class') == 'white')
					{
						btn.setAttribute('class', 'outline');
						btn.setAttribute('value', '%characteristics.boolean.inactive%');
					}
					else
					{
						btn.setAttribute('class', 'white');
						btn.setAttribute('value', '%characteristics.boolean.active%');
					}
				}

				async function openSettings(previous)
				{
					PageManager.setHeader('%general.settings%', '( ' + device.name + ' )', true);

					var main = document.createElement('div');

					main.style.display = 'flex';

					main.innerHTML = '<input type="button" value="%menu.back%" onclick="closeSettings(' + "'settings'" + ')"><div style="display: block; width: 100%; margin-left: 20px"><input id="save-btn" type="submit" form="settings-form-main" value="%device.save%"></div>';

					PageManager.setFooter(main);
					PageManager.showFooter(true);

					await PageManager.switchPage(previous, 'settings', false);

					document.getElementsByTagName('title')[0].innerHTML = device.name + ' (%general.settings%)';

					if((new URL(window.location.href)).searchParams.get('desktopApp') == 'true')
					{
						window.history.pushState(null, null, '?id=' + device.id + '&settings&desktopApp=true');
					}
					else
					{
						window.history.pushState(null, null, '?id=' + device.id + '&settings');
					}
				}
				
				async function closeSettings(previous)
				{
					PageManager.hideHeader(true);

					var main = document.createElement('div');

					if(device.plugin.alias == 'SynTex')
					{
						main.innerHTML = '<input id="restart-btn" style="margin-bottom: 20px;" type="button" value="%device.restart%" onclick="restartDevice(this)">';
					}

					main.innerHTML += '<div style="display: flex"><input type="button" value="%menu.back%" onclick="Essentials.leavePage(' + "'/'" + ')"><button onclick="openSettings(' + "'infos'" + ')" class="icon-button right split arrow" style="margin-left: 20px"><div class="button-icon red"><img class="icon-inverted" src="/img/settings.png"></div><div class="button-text">%device.modify%</div></button></div>';

					PageManager.setFooter(main);
					PageManager.showFooter(true);

					await PageManager.switchPage(previous, 'infos', false);

					document.getElementsByTagName('title')[0].innerHTML = device.name;

					if((new URL(window.location.href)).searchParams.get('desktopApp') == 'true')
					{
						window.history.pushState(null, null, '?id=' + device.id + '&desktopApp=true');
					}
					else
					{
						window.history.pushState(null, null, '?id=' + device.id);
					}

					for(var i = 0; i < document.getElementsByClassName('control-panel').length; i++)
					{
						resizeFontSizeToFit(document.getElementsByClassName('control-panel')[i].children[0]);
					}

					repaintGraphs();
				}

				function getService(letters)
				{
					var c = 0;

					for(const i in device['services'])
					{
						if(device['services'][i].type == Essentials.letterToType(letters[0]))
						{
							if(c == letters[1])
							{
								return device['services'][i];
							}
							else
							{
								c++;
							}
						}
					}

					return null;
				}

				window.DeviceController = null;

				function setupController()
				{
					DeviceController = Query.connectSocket('ws://' + window.location.hostname + ':' + device.plugin.port + '/devices', (data) => {
					
						if(data instanceof Object)
						{
							var letters = Object.keys(data)[0];

							busy.splice(busy.indexOf(letters), 1);
						}
					});
				}

				window.DeviceViewer = null;

				function setupViewer()
				{
					DeviceViewer = Query.connectSocket('ws://' + window.location.hostname + ':' + device.plugin.port + '/devices', (data) => renderNewData(data), null, { line : 'getState', params : { id : device.id } });
				}
				
				function fetchState()
				{
					Query.fetchURL('/serverside/characteristics?id=' + device.id, 10000).then((state) => renderNewData(JSON.parse(state)));
				}

				function renderNewData(data)
				{
					if(data != null)
					{
						for(var i = 0; i < Object.keys(typeCounter).length; i++)
						{
							var type = Object.keys(typeCounter)[i];

							for(var j = 0; j < typeCounter[type]; j++)
							{
								var letters = Essentials.typeToLetter(type) + j;

								if(temp[letters] == null)
								{
									temp[letters] = {};
								}

								if(data[letters] != null)
								{
									for(const j in data[letters])
									{
										if(temp == null || temp[letters][j] != data[letters][j])
										{
											console.log('UPDATE', letters, data[letters]);

											updateValues(letters, data[letters]);

											temp[letters][j] = data[letters][j];
										}
									}
								}
								else if(type != 'lcd' && type != 'removed' && type != 'unsupported' && (type != 'statelessswitch' || services.length == 1))
								{
									setControlPanel(letters, data[letters]);
								}
							}
						}
					}
				}

				function updateValues(letters, state)
				{
					var type = Essentials.letterToType(letters[0]), j = letters[1];
					
					if(state != null)
					{
						if(values[letters] != null)
						{
							var obj = { time : Math.round(new Date().getTime() / 1000) };

							if(state.value != null)
							{
								obj.value = state.value.toString();
							}
							
							if(state.hue != null)
							{
								obj.hue = state.hue.toString();
							}

							if(state.saturation != null)
							{
								obj.saturation = state.saturation.toString();
							}

							if(state.brightness != null)
							{
								obj.brightness = state.brightness.toString();
							}

							values[letters].push(obj);

							if(device.plugin.alias.startsWith('SynTex'))
							{
								setTimeout(() => calcValues(type, j), 300);
							}
						}
					}

					setControlPanel(letters, state);
				}
				
				async function restartDevice(btn)
				{
					if(!restarting && !updating && !saving && !resetting)
					{
						var overlays = {
							root : btn,
							id : 'restart',
							pending : { value : '%general.restarting% ..' },
							connectionError : { value : '%device.device_connection_error%!' }
						};

						restarting = true;

						if(await Query.complexFetch(Presets.getPreset(device.plugin.alias).getRestartURL(device), 20000, 1, overlays, false) == null)
						{
							Essentials.showOverlay(btn, Essentials.createErrorOverlay('restart-result', '%device.device_connection_error%!'));

							await Essentials.newTimeout(4000);

							Essentials.removeOverlays(btn, true);

							await Essentials.newTimeout(300);
						}
					}
				}

				var updatedAfterOffline = true;

				async function pingESP()
				{
					if(document.getElementById('updating') == null && !saving && document.getElementById('settings') != null && document.getElementById('settings').hasAttribute('style'))
					{
						if(await Query.fetchURL(Presets.getPreset(device.plugin.alias).getPingURL(device), 10000) != null)
						{
							console.log('ESP Gefunden');

							if(!updatedAfterOffline)
							{
								for(const type in typeCounter)
								{
									if(type != 'lcd' && type != 'removed' && type != 'unsupported' && (type != 'statelessswitch' || services.length == 1))
									{
										for(var j = 0; j < typeCounter[type]; j++)
										{
											var letters = Essentials.typeToLetter(type) + j;

											if(temp[letters] != null)
											{
												setControlPanel(letters, temp[letters]);
											}
										}
									}
								}

								updatedAfterOffline = true;
							}

							if(restarting == true)
							{
								Essentials.showOverlay(document.getElementById('restart-btn'), Essentials.createSuccessOverlay('restart-result', '%general.restart_success%!'));
								
								await Essentials.newTimeout(4000);
								
								Essentials.removeOverlays(document.getElementById('restart-btn'), true);

								setTimeout(() => { restarting = false }, 300);
							}

							setTimeout(function()
							{
								pingESP();

							}, 5000);
						}
						else
						{
							document.getElementsByClassName('control-panel')[0].style.setProperty('--background-color', 'hsl(350, 75%, 55%)');
							document.getElementsByClassName('control-panel')[0].style.setProperty('--box-shadow', 'hsl(350, 75%, 45%)');
							document.getElementsByClassName('control-panel')[0].children[0].innerHTML = '%general.offline%';

							resizeFontSizeToFit(document.getElementsByClassName('control-panel')[0].children[0]);

							for(var i = 1; i < document.getElementsByClassName('control-panel').length; i++)
							{
								document.getElementsByClassName('control-panel')[i].style.removeProperty('--background-color');
								document.getElementsByClassName('control-panel')[i].style.removeProperty('--box-shadow');
								document.getElementsByClassName('control-panel')[i].children[0].innerHTML = '–––';

								resizeFontSizeToFit(document.getElementsByClassName('control-panel')[i].children[0]);
							}

							updatedAfterOffline = false;

							await Essentials.newTimeout(1000);
							
							pingESP();
						}
					}
					else
					{
						await Essentials.newTimeout(1000);
							
						pingESP();
					}
				}    

				function updateDevice(btn)
				{
					return new Promise(async function(resolve) {

						var response = false;

						if(!updating && !restarting && !saving && !resetting)
						{
							var overlays = {
								root : btn,
								id : 'update',
								pending : { value : '%general.please_wait% ..' },
								success : { value : '%general.updating% ..', color : 'purple', remove : false },
								executeError : { value : '%general.update_failed%!' },
								connectionError : { value : '%device.device_connection_error%!' }
							};

							updating = true;

							if(await Query.complexFetch(Presets.getPreset(device.plugin.alias).getUpdateURL(device, { type : Essentials.getType(services) }), 20000, 1, overlays, true) == 'Success')
							{
								await Essentials.newTimeout(3000);

								var overlays = {
									root : btn,
									id : 'update-installation',
									connectionError : { value : '%device.device_connection_error%!' }
								};

								var update = await Query.complexFetch(Presets.getPreset(device.plugin.alias).getVersionURL(device), 3000, 20, overlays, false);

								if(update == btn.getAttribute('value').split('( v')[1].split(' )')[0])
								{  
									Essentials.showOverlay(btn, Essentials.createOverlay(3, 'update-installation-result', '%general.update_success%!', 'green'));

									response = true;
								}
								else
								{
									Essentials.showOverlay(btn, Essentials.createOverlay(3, 'update-installation-result', '%general.update_failed%!', 'red'));
								}

								document.getElementById('version-info').innerHTML = '<b>%device.version%: </b>' + await Query.complexFetch(Presets.getPreset(device.plugin.alias).getVersionURL(device), 3000, 3, {}, false);

								await Essentials.newTimeout(4000);

								if(update == btn.getAttribute('value').split('( v')[1].split(' )')[0])
								{
									Essentials.removeOverlays(btn, false);

									PageManager.removeFooter('update-btn', true);
								}
								else
								{
									Essentials.removeOverlays(btn, true);
								}
							}

							updating = false;
						}

						resolve(response);
					});
				}

				async function checkUpdates()
				{
					var newestVersion = await Query.complexFetch('http://syntex.sytes.net/smarthome/check-version?device=' + document.getElementById('footer-content').getAttribute('type'), 10000, 2, {}, false);

					if(newestVersion != null && Essentials.versionCount(newestVersion) > Essentials.versionCount(document.getElementById('footer-content').getAttribute('version')))
					{
						var update = document.createElement('input');

						update.setAttribute('type', 'button');
						update.setAttribute('value', '%device.install_update% ( v' + newestVersion + ' )');
						update.setAttribute('style', 'margin-bottom: 20px;');
						update.setAttribute('onclick', 'updateDevice(this)');
						update.setAttribute('id', 'update-btn');

						PageManager.addFooter(update);
						PageManager.showFooter();
					}
				}

				function resetDevice(btn)
				{
					var dialogue = {
                        title : '%general.warning%',
                        subtitle : '%device.reset_confirm%?',
                        buttons : [
                            {
                                text : '%general.cancel%',
                                close : true
                            },
                            {
                                text : '%device.reset%',
                                color : 'red',
                                close : true,
                                action : () => resetConfirm(btn)
                            }
                        ]
                    };

                    Essentials.openDialogue(dialogue);
				}
				
				async function resetConfirm(btn)
				{
					if(!resetting && !updating && !restarting && !saving)
					{
						var overlays = {
							root : btn,
							id : 'reset',
							pending : { value : '%device.resetting% ..', z : 2 },
							executeError : { value : '%device.reset_error%!', z : 3 },
							connectionError : { value : (device.ip == null ? '%general.bridge_connection_error%!' : '%device.device_connection_error%!'), z : 3 }
						};

						var url = Presets.getPreset(device.plugin.alias).getResetURL(device, { type : Essentials.getType(services), url : window.location.protocol + '//' + window.location.hostname + ':' + device.plugin.port });

						resetting = true;

						if(await Query.complexFetch(url, 20000, 1, overlays, true) == 'Success')
						{
							await Essentials.newTimeout(3000);

							Essentials.showOverlay(btn, Essentials.createOverlay(3, 'reset-result', '%device.reset_success%!', 'green'));

							await Query.complexFetch('/serverside/remove-device?id=' + device.id, 20000, 1, {}, false);

							await Essentials.newTimeout(3000);

							Essentials.leavePage('/');
						}
						else
						{
							await Essentials.newTimeout(4010);
							Essentials.removeOverlays(document.getElementById('reset-btn'), true);
						}

						resetting = false;
					}
				}

				async function saveConfig()
				{
					if(!saving && !updating && !restarting && !resetting)
					{
						var settings = {
							id : device.id,
							plugin : device.plugin.alias
						};

						var form = document.getElementById('settings-form');

						for(var i = 0; i < form.childElementCount; i++)
						{
							if(!form.children[i].hasAttribute('type'))
							{
								if(form.children[i].getElementsByTagName('input')[0].getAttribute('name') == 'interval')
								{
									if(!services.includes('motion'))
									{
										settings['interval'] = form.children[i].getElementsByTagName('input')[0].value * 1000;
									}
									else if(services.includes('motion'))
									{
										settings['interval'] = (form.children[i].getElementsByTagName('input')[0].value - 1.5) * 1000;
									}
									else
									{
										settings['interval'] = form.children[i].getElementsByTagName('input')[0].value;
									}
								}
								else if(form.children[i].getElementsByTagName('input')[0].getAttribute('type') == 'button')
								{
									settings[form.children[i].getElementsByTagName('input')[0].getAttribute('name')] = (form.children[i].getElementsByTagName('input')[0].value == '%characteristics.boolean.active%' ? 1 : 0);
								}
								else if(form.children[i].getElementsByTagName('input')[0].getAttribute('type') == 'text' && (form.children[i].getElementsByTagName('input')[0].value != '' || !form.children[i].getElementsByTagName('input')[0].hasAttribute('required')))
								{
									settings[form.children[i].getElementsByTagName('input')[0].getAttribute('name')] = form.children[i].getElementsByTagName('input')[0].value;
								}
							}
						}

						console.log('SAVE DEVIE CONFIG', settings);

						var overlays = {
							root : document.getElementById('save-btn'),
							id : 'saving',
							pending : { value : '%general.uploading% ..', remove : false },
							executeError : { value : '%device.save_error%!' },
							connectionError : { value : '%general.bridge_connection_error%!' }
						};

						saving = true;

						if(await Query.complexFetch('/serverside/save-config', 5000, 2, overlays, true, JSON.stringify(settings)) == 'Success')
						{
							if(Presets.getPreset(device.plugin.alias) != null && Presets.getPreset(device.plugin.alias).getRestartURL(device) != null)
							{
								var overlays = {
									root : document.getElementById('save-btn'),
									id : 'refresh',
									success : { value : '%device.save_success%!' },
									executeError : { value : '%device.save_error%!' },
									connectionError : { value : '%device.saved%!', color : 'yellow' }
								};
								
								await Query.complexFetch(Presets.getPreset(device.plugin.alias).getRestartURL(device), 20000, 1, overlays, true);
							}
							else
							{
								Essentials.showOverlay(document.getElementById('save-btn'), Essentials.createSuccessOverlay('refresh-result', '%device.saved%!'));
							}

							await Essentials.newTimeout(2000);
								
							redirect();
						}
						else if(Presets.getPreset(device.plugin.alias) != null && Presets.getPreset(device.plugin.alias).getPingURL(device) != null)
						{
							saving = false;

							await Essentials.newTimeout(500);

							pingESP();
						}

						saving = false;
					}
				}
				
				function redirect()
				{
					if((new URL(window.location.href)).searchParams.get('desktopApp') == 'true')
					{
						window.history.pushState(null, null, '?id=' + device.id + '&desktopApp=true');
					}
					else
					{
						window.history.pushState(null, null, '?id=' + device.id);
					}
					
					Essentials.leavePage('/device?id=' + device.id)
				}

			</script>
		</div>
	</body>
</html>