<html>
    <title class="loading-loop">Laden ..</title>
    <script>
    
        function drawGraph(canvas, data, clr1, clr2, points)
        {
            var ctx = canvas.getContext('2d');

            ctx.lineWidth = 2;
            ctx.lineCap = 'round';
            ctx.strokeStyle = clr2;

            for(var i = 1; i < data.length; i++)
            {
                if(points)
                {
                    ctx.fillStyle = clr1;
                    ctx.beginPath();
                    ctx.arc((i - 1) * width / (data.length - 1) + padding, height - data[i - 1] * multiplicator - padding - 3, 10, 0, 360);
                    ctx.fill();
                    ctx.closePath();
                    ctx.fillStyle = clr2;
                    ctx.beginPath();
                    ctx.arc((i - 1) * width / (data.length - 1) + padding, height - data[i - 1] * multiplicator - padding - 3, 5, 0, 360);
                    ctx.fill();
                    ctx.closePath();
                }

                ctx.beginPath();
                ctx.moveTo((i - 1) * width / (data.length - 1) + padding, height - data[i - 1] * multiplicator - padding - 3);
                ctx.lineTo(i * width / (data.length - 1) + padding, height - data[i] * multiplicator - padding - 3);
                ctx.stroke();
            }

            if(points)
            {
                ctx.fillStyle = clr1;
                ctx.beginPath();
                ctx.arc((i - 1) * width / (data.length - 1) + padding, height - data[data.length - 1] * multiplicator - padding - 3, 10, 0, 360);
                ctx.fill();
                ctx.closePath();
                ctx.fillStyle = clr2;
                ctx.beginPath();
                ctx.arc((i - 1) * width / (data.length - 1) + padding, height - data[data.length - 1] * multiplicator - padding - 3, 5, 0, 360);
                ctx.fill();
                ctx.closePath();
            }
        }

        function drawFill(canvas, data, clr1, clr2, smoothing)
        {
            var ctx = canvas.getContext('2d');

            var grd = ctx.createLinearGradient(0, 0, 0, height + 100);
            grd.addColorStop(0, clr1);
            grd.addColorStop(1, clr2);

            ctx.fillStyle = grd;

            ctx.beginPath();
            ctx.moveTo(padding, height - padding);
            ctx.lineTo(padding, height - data[0] * multiplicator - padding - 3);

            for(var i = 1; i < data.length; i++)
            {
                if(smoothing == 0)
                {
                    ctx.lineTo(i * width / (data.length - 1) + padding, height - data[i] * multiplicator - padding - 3);
                }
                else
                {
                    ctx.bezierCurveTo(i * width / (data.length - 1) + padding - width / smoothing / (data.length - 1), height - data[i - 1] * multiplicator, i * width / (data.length - 1) + padding - width / smoothing / (data.length - 1), height - data[i] * multiplicator - padding - 3, i * width / (data.length - 1) + padding, height - data[i] * multiplicator - padding - 3);
                }
            }

            ctx.lineTo((data.length - 1) * width / (data.length - 1) + padding, height - padding);

            ctx.closePath();
            ctx.fill();
        }

        function drawGrid(canvas, data, outline)
        {
            var ctx = canvas.getContext('2d');

            ctx.lineCap = 'butt';
            ctx.lineWidth = 1.5;

            for(var i = 0; i < height / 5 + 1; i++)
            {
                ctx.strokeStyle = 'rgb(25, 25, 35)';

                if(i == unterteilungen || i == 0)
                {
                    ctx.strokeStyle = outline;
                }

                ctx.beginPath();
                ctx.moveTo(padding, height - height / unterteilungen * i - padding);
                ctx.lineTo((data.length - 1) * width / (data.length - 1) + padding, height - height / unterteilungen * i - padding);
                ctx.stroke();
            }

            for(var i = 0; i < data.length; i++)
            {
                ctx.strokeStyle = 'rgb(40, 40, 50)';

                if(i == data.length - 1 || i == 0)
                {
                    ctx.strokeStyle = outline;
                }

                ctx.beginPath();
                ctx.moveTo(i * width / (data.length - 1) + padding, 0 - padding);
                ctx.lineTo(i * width / (data.length - 1) + padding, height - padding);
                ctx.stroke();
            }
        }
        
    </script>
    <body>
        <div id="infos">
            <div class="control-container">
                <input id="status" class="control-panel loading-loop" type="button" value="LADEN ..">
            </div>
            <h1 class="loading-loop">Laden ..</h1>
            <div class="main" style="margin-top: 100px; margin-bottom: 100px; display: table"></div>
            <div class="main" style="margin-top: 100px; margin-bottom: 132px; display: table">
                <div style="border-radius: 50px; height: 300px; overflow: overlay; overflow: hidden; border: 2px solid rgb(40, 40, 50); background: rgb(20, 20, 30); box-sizing: border-box;">
                    <canvas class="canvas" style="border-radius: 50px;"></canvas>
                </div>
                <script defer>
    
                    var activity = JSON.parse('<%activity%>');
                    var values = [];
                    var min = 100, max = 0;

                    for(var i = 0; i < activity.length; i++)
                    {
                        if(activity[i].l = 'Update' && !activity[i].m.includes('Rain') && !activity[i].m.includes('Humidity'))
                        {
                            var value = activity[i].m.split('[')[2].split(']')[0];

                            value = value == 'true' ? 1 : value == 'false' ? 0 : value;

                            if(value > max)
                            {
                                max = value;
                            }

                            if(value < min)
                            {
                                min = value;
                            }

                            values.push(value);
                        }
                    }

                    for(const i in values)
                    {
                        values[i] = (values[i] - min * 0.9) / (max * 1.1 - min) * 100;

                        console.log(values[i]);
                    }

                    console.log(min, max);

                    /*
                    var width = canvas.parentElement.offsetWidth, height = canvas.parentElement.offsetHeight;
                    var padding = 0;
                    var max = <?php echo $max + $max / 2; ?>;
                    var multiplicator = 100 / max * height / 100;
                    var unterteilungen = 3;

                    canvas.width = width + padding * 2;
                    canvas.height = height + padding * 2;
                    */

                    var canvas = document.getElementsByClassName('canvas')[0];
                    var padding = 0;
                    var width = canvas.parentElement.offsetWidth - padding * 2, height = canvas.parentElement.offsetHeight - padding * 2;
                    
                    //var multiplicator = 100 / max * height / 100;
                    var multiplicator = 2.5;
                    var unterteilungen = 12;
    
                    canvas.width = width + padding * 2;
                    canvas.height = height + padding * 2;
                    canvas.style.background = 'rgb(20, 20, 30)';
    
                    //window.onload = drawGrid(canvas, values, 'hsla(205, 98%, 60%, 0)');
                    window.onload = drawFill(canvas, values, "hsla(205, 98%, 60%, .3", "hsla(205, 98%, 60%, 0", 0);
                    window.onload = drawGraph(canvas, values, 'hsla(205, 98%, 60%, 0.2)', 'hsla(205, 98%, 60%, 1)', false);
    
                </script>
            </div>
            <div class="main">
                <input id="restart-btn" style="margin-bottom: 20px;" type="button" value="Gerät Neustarten" onclick="restartDevice(this)">
                <div style="display: flex">
                    <input type="button" value="Zurück" onclick="window.location.href='/'">
                    <input class="gradient-red" style="margin-left: 20px" type="button" value="Einstellungen" onclick="openSettings()">
                </div>
            </div>
        </div>
        <div id="settings" style="display: none;">
            <h1>Einstellungen</h1>
            <p class="loading-loop">( Laden .. )</p>
            <form onsubmit="event.preventDefault(); saveConfig();" class="main" style="margin-top: 100px; display: table;">
                <div id="settings-form" style="margin-bottom: 100px">
                    <p><b>Name: <input pattern="[a-zA-Z0-9-#()&/ ]+" title="Bitte benutze nur Buchstaben, Zahlen, Leerzeichen und diese Sonderzeichen: # / ( )" required name="name" type="text" style="max-width: 325px"></b></p>
                </div>
                <div class="widget" id="infobox" style="margin-left: 0; margin-bottom: 20px; display: none">
                    <button class="widget-left gradient-yellow" disabled>Infobox</button>
                    <button class="widget-right" disabled></button>
                </div>
                <input id="reset-btn" style="margin-bottom: 20px" type="button" value="Gerät Zurücksetzen" onclick="resetDevice(this)">
                <input id="reconnect-btn" style="margin-bottom: 20px;" type="button" value="Gerät Neu Verbinden">
                <div style="display: flex">
                    <input type="button" value="Zurück" onclick="closeSettings()">
                    <div style="display: block; width: 100%; margin-left: 20px">
                        <input id="save-btn" type="submit" value="Speichern">
                    </div>
                </div>
            </form>
        </div>
    </body>
</html>
<script>

    var device = JSON.parse('<%device%>');
    var restarting = false, resetting = false, updating = false, saving = false;
    var settings = [];

    if(device.ip == undefined)
    {
        document.getElementById('restart-btn').style.display = 'none';
        document.getElementById('reconnect-btn').style.display = 'none';
    }

    if(device.type != 'relais' && device.type != 'switch' && device.type != 'rgb')
    {
        settings.push({
            index: 'active',
            name: 'Aktiviert'
        });
    }

    if(device.type == 'contact' || device.type == 'motion' || device.type == 'relais' || device.type == 'statelessswitch')
    {
        settings.push({
            index: 'led',
            name: 'LED'
        });
    }

    if(device.type == 'motion' || device.type == 'light' || device.type == 'temperature')
    {
        settings.push({
            index: 'interval',
            name: device.type == 'motion' ? 'Delay' : 'Interval'
        });
    }

    if(device.type == 'light' || device.type == 'temperature' || device.type == 'statelessswitch')
    {
        settings.push({
            index: 'events',
            name: 'Events'
        });
    }

    document.getElementsByTagName('title')[0].innerHTML = device.name;
    document.getElementsByTagName('h1')[0].innerHTML = device.name;

    var infos = document.getElementById('infos').getElementsByClassName('main')[0];

    infos.innerHTML += '<p><b>Mac: </b>' + device.id + '</p>';

    if(device.ip != undefined)
    {
        infos.innerHTML += '<p><b>IP: </b>' + device.ip + '</p>';
    }
    
    infos.innerHTML += '<p><b>Typ: </b>' + device.type + '</p>';

    if(device.version != undefined)
    {
        infos.innerHTML += '<p><b>Version: </b>' + device.version + '</p>';
    }

    for(const i in settings)
    {
        if(settings[i].index == 'interval' && (device.type == 'light' || device.type == 'temperature'))
        {
            infos.innerHTML += '<p><b>' + settings[i].name + ': </b>' + device[settings[i].index] / 1000 + ' sek' + '</p>';
        }
        else if(settings[i].index == 'interval' && (device.type == 'motion'))
        {
            infos.innerHTML += '<p><b>' + settings[i].name + ': </b>' + (device[settings[i].index] / 1000 + 1.5) + ' sek' + '</p>';
        }
        else if(settings[i].index == 'led' || settings[i].index == 'active')
        {
            if(device[settings[i].index] == 1)
            {
                infos.innerHTML += '<p><b>' + settings[i].name + ': </b>An</p>';
            }
            else
            {
                infos.innerHTML += '<p><b>' + settings[i].name + ': </b>Aus</p>';
            }
        }
        else if(settings[i].index == 'events' && device[settings[i].index] == '')
        {
            infos.innerHTML += '<p><b>' + settings[i].name + ': </b>Keine</p>';
        }
        else
        {
            infos.innerHTML += '<p><b>' + settings[i].name + ': </b>' + device[settings[i].index] + '</p>';
        }
    }

    document.getElementById('infos').getElementsByClassName('main')[1].setAttribute('type', device.type);
    document.getElementById('infos').getElementsByClassName('main')[1].setAttribute('version', device.version);

    document.getElementById('reconnect-btn').setAttribute('onclick', "window.location.href='/reconnect?ip=" + device.ip + "&mac=" + device.id + "'");

    document.getElementById('settings').getElementsByTagName('p')[0].innerHTML = '( ' + device.name + ' )';

    var settingsForm = document.getElementById('settings-form');

    settingsForm.getElementsByTagName('input')[0].setAttribute('value', device.name);

    for(const i in settings)
    {
        if((device.type == 'light' || device.type == 'temperature') && settings[i].index == 'interval')
        {
            settingsForm.innerHTML += '<p><b>' + settings[i].name + ': <input pattern="[0-9]+" title="Bitte benutze nur Zahlen" required value="' + device[settings[i].index] / 1000 + '" name="' + settings[i].index + '" type="text" style="max-width: 150px"> sek</b></p>';
        }
        else if((device.type == 'motion') && settings[i].index == 'interval')
        {
            settingsForm.innerHTML += '<p><b>' + settings[i].name + ': <input pattern="[0-9]+" title="Bitte benutze nur Zahlen" required value="' + (device[settings[i].index] / 1000 + 1.5) + '" name="' + settings[i].index + '" type="text" style="max-width: 150px"> sek</b></p>';
        }
        else if(settings[i].index == 'events')
        {
            var events = JSON.parse('[' + device[settings[i].index] + ']');
            var main = document.createElement('div');
            var container = document.createElement('div');
            var controls = document.createElement('div');
            var addBtn = document.createElement('input');

            main.innerHTML = '<p style="margin: 16px 14px 0 auto"><b>' + settings[i].name + ': </b></p>';
            main.setAttribute('style', 'display: flex');

            container.setAttribute('id', 'events');
            container.setAttribute('style', 'max-width: 150px; margin-right: 16px');

            controls.setAttribute('id', 'controls');
            controls.setAttribute('style', 'width: 100px; margin-right: auto');

            addBtn.setAttribute('value', '+');
            addBtn.setAttribute('onclick', 'addEventInput("0")');
            addBtn.setAttribute('type', 'button');
            addBtn.setAttribute('class', 'gradient-blue-green');
            addBtn.setAttribute('id', 'add-event-btn');
            addBtn.setAttribute('style', '');

            main.appendChild(container);
            main.appendChild(controls);
            
            settingsForm.appendChild(main);

            for(const j in events)
            {
                addEventInput(events[j]);
            }

            controls.appendChild(addBtn);
        }
        else if(settings[i].index == 'led' || settings[i].index == 'active')
        {
            settingsForm.innerHTML += '<p><b>' + settings[i].name + ': <input value="' + (device[settings[i].index] == 1 ? 'An' : 'Aus') + '" name="' + settings[i].index + '" type="button" class="' + (device[settings[i].index] == 1 ? 'white' : 'outline') + '" onclick="switchFormButton(this)" style="max-width: 150px; border-width: 3px"></b></p>';
        }
        else
        {
            settingsForm.innerHTML += '<p><b>' + settings[i].name + ': <input required value="' + device[settings[i].index] + '" name="' + settings[i].index + '" type="text" style="max-width: 150px"></b></p>';
        }
    }

    settingsForm.setAttribute('mac', device.id);
    settingsForm.setAttribute('ip', device.ip);
    settingsForm.setAttribute('type', device.type);

    if(device.type == 'temperature' || device.type == 'light' || device.type == 'statelessswitch')
    {
        document.getElementById('infobox').style.display = '';
    }

    if(device.type == 'temperature' || device.type == 'light')
    {
        document.getElementById('infobox').children[1].innerHTML = 'Positive Event Einstellungen werden aktiviert wenn der Wert diese überschreitet<br>Negative wenn er unterschritten wird';
    }

    if(device.type == 'statelessswitch')
    {
        document.getElementById('infobox').children[1].innerHTML = 'Die Event Einstellungen dienen zur Bestimmung der Pins an denen Knöpfe angeschlossen sind';
    }

    function addEventInput(value)
    {
        var input = document.createElement('input');
        var control = document.createElement('input');

        input.setAttribute('value', value);
        input.setAttribute('name', 'events');
        input.setAttribute('type', 'text');
        input.setAttribute('pattern', '-?[0-9]+');
        input.setAttribute('title', 'Bitte benutze nur Zahlen');
        input.setAttribute('required', '');
        input.setAttribute('style', 'margin-bottom: 16px');

        control.setAttribute('value', '-');
        control.setAttribute('type', 'button');
        control.setAttribute('onclick', 'removeEventInput(this)');
        control.setAttribute('style', 'margin-bottom: 16px');

        document.getElementById('events').appendChild(input);

        if(document.getElementById('add-event-btn') == null)
        {
            document.getElementById('controls').appendChild(control);
        }
        else
        {
            document.getElementById('controls').insertBefore(control, document.getElementById('add-event-btn'));
        }
    }

    function removeEventInput(button)
    {
        var i = Array.prototype.indexOf.call(button.parentElement.children, button);

        document.getElementById('events').removeChild(document.getElementById('events').children[i]);
        document.getElementById('controls').removeChild(button);
    }

    function switchFormButton(btn)
    {
        if(btn.hasAttribute('class') && btn.getAttribute('class') == 'white')
        {
            btn.setAttribute('class', 'outline');
            btn.setAttribute('value', 'Aus');
        }
        else
        {
            btn.setAttribute('class', 'white');
            btn.setAttribute('value', 'An');
        }
    }

</script>
<script>

    function openSettings()
    {
        document.getElementById('infos').setAttribute('style', 'display: none');
        document.getElementById('settings').removeAttribute('style');
        document.getElementsByTagName('title')[0].innerHTML = device.name + ' (Einstellungen)';
    }
    
    function closeSettings()
    {
        document.getElementById('infos').removeAttribute('style');
        document.getElementById('settings').setAttribute('style', 'display: none');
        document.getElementsByTagName('title')[0].innerHTML = device.name;
    }
    
    async function fetchState()
    {        
        if(device.type == 'contact' || device.type == 'motion' || device.type == 'relais' || device.type == 'switch' || device.type == 'rgb' || device.type == 'rgbw')
        {
            var state = await fetchURL(window.location.protocol + '//' + window.location.hostname + ':<%wPort%>/devices?mac=' + device.id + '&type=' + device.type, 10000);

            if(state != null && state != 'Error')
            {
                if(device.type == 'contact')
                {
                    if(state == 'false') 
                    {
                        document.getElementById('status').value = 'ZU';
                        document.getElementById('status').style.backgroundImage = 'linear-gradient(to top, hsl(150, 75%, 45%) 0%, hsl(150, 75%, 55%) 100%)';
                    }
                    else if(state == 'true')
                    {
                        document.getElementById('status').value = 'GEÖFFNET';
                        document.getElementById('status').style.backgroundImage = 'linear-gradient(to top, hsl(350, 75%, 45%) 0%, hsl(350, 75%, 55%) 100%)';
                    }
                }
                else if(device.type == 'motion')
                {
                    if(state == 'true') 
                    {
                        document.getElementById('status').value = 'BEWEGUNG';
                        document.getElementById('status').style.backgroundImage = 'linear-gradient(to top, hsl(280, 75%, 45%) 0%, hsl(280, 75%, 55%) 100%)';
                    }
                    else if(state == 'false')
                    {
                        document.getElementById('status').value = 'BEREIT';
                        document.getElementById('status').style.backgroundImage = 'linear-gradient(to top, hsl(150, 75%, 45%) 0%, hsl(150, 75%, 55%) 100%)';
                    }
                }
                else if(device.type == 'relais' || device.type == 'switch')
                {
                    if(state == 'true')
                    {
                        document.getElementById('status').value = 'AN';
                        document.getElementById('status').style.backgroundImage = 'linear-gradient(to top, hsl(205, 75%, 45%) 0%, hsl(205, 75%, 55%) 100%)';
                    }
                    else if(state == 'false')
                    {
                        document.getElementById('status').value = 'AUS';
                        document.getElementById('status').style.backgroundImage = 'linear-gradient(to top, hsl(18, 75%, 45%) 0%, hsl(18, 75%, 55%) 100%)';
                    }
                }
                else if(device.type == 'rgb' || device.type == 'rgbw')
                {
                    if(state.split(':')[0] == 'true')
                    {
                        document.getElementById('status').value = 'AN';
                        document.getElementById('status').style.backgroundImage = 'linear-gradient(to top, rgb(' + state.split(':')[1] + ', ' + state.split(':')[2] + ', ' + state.split(':')[3] + ') 0%, rgb(' + (parseInt(state.split(':')[1]) + 60) + ', ' + (parseInt(state.split(':')[2]) + 60) + ', ' + (parseInt(state.split(':')[3]) + 60) + ') 100%)';
                    }
                    else if(state.split(':')[0] == 'false')
                    {
                        document.getElementById('status').value = 'AUS';
                        document.getElementById('status').style.backgroundImage = 'linear-gradient(to top, hsl(18, 75%, 45%) 0%, hsl(18, 75%, 55%) 100%)';
                    }
                }
                
                console.log(state);
            }
            else if(state == 'Error')
            {
                document.getElementById('status').value = 'KEINE DATEN GEFUNDEN!';
            }
        }
        else if(device.type == 'light' || device.type == 'temperature')
        {
            var state = await fetchURL(window.location.protocol + '//' + window.location.hostname + ':<%wPort%>/devices?mac=' + device.id + '&type=' + device.type, 10000);

            if(state != null)
            {
                if(device.type == 'light')
                {
                    document.getElementById('status').value = Math.round(state) + ' LUX' + ' - ' + document.getElementById('status').value.split(' - ')[1];
                }
                else if(device.type == 'temperature')
                {
                    document.getElementById('status').value = ((Math.round(state * 10.0)) / 10.0) + ' °C' + ' - ' + document.getElementById('status').value.split(' - ')[1];
                }

                console.log(state);
            }
            
            if(device.type == 'light')
            {
                var rainState = await fetchURL(window.location.protocol + '//' + window.location.hostname + ':<%wPort%>/devices?mac=' + device.id + '&type=rain', 10000);

                if(rainState != null)
                {
                    if(rainState == 'false')
                    {
                        document.getElementById('status').value = document.getElementById('status').value.split(' - ')[0] + ' - TROCKEN';
                        document.getElementById('status').style.backgroundImage = 'linear-gradient(to top, hsl(40, 85%, 75%) 0%, hsl(40, 85%, 85%) 100%)';
                    }
                    else if(rainState == 'true')
                    {
                        document.getElementById('status').value = document.getElementById('status').value.split(' - ')[0] + ' - REGEN';
                        document.getElementById('status').style.backgroundImage = 'linear-gradient(to top, hsl(220, 75%, 45%) 0%, hsl(220, 75%, 55%) 100%)';
                    }

                    console.log(rainState);
                }
            }
            else if(device.type == 'temperature')
            {
                var humidityState = await fetchURL(window.location.protocol + '//' + window.location.hostname + ':<%wPort%>/devices?mac=' + device.id + '&type=humidity', 10000);

                if(humidityState != null)
                {
                    if(humidityState > 40 && humidityState < 70)
                    {
                        document.getElementById('status').style.backgroundImage = 'linear-gradient(to top, hsl(150, 75%, 45%) 0%, hsl(150, 75%, 55%) 100%)';
                    }
                    else if(humidityState < 20 || humidityState > 85)
                    {
                        document.getElementById('status').style.backgroundImage = 'linear-gradient(to top, hsl(0, 75%, 45%) 0%, hsl(0, 75%, 55%) 100%)';
                    }
                    else
                    {
                        document.getElementById('status').style.backgroundImage = 'linear-gradient(to top, hsl(18, 75%, 45%) 0%, hsl(18, 75%, 55%) 100%)';
                    }

                    document.getElementById('status').value = document.getElementById('status').value.split(' - ')[0] + ' - ' + Math.round(humidityState) + ' %';

                    console.log(humidityState);
                }
            }
        }
        else if(device.type == 'statelessswitch')
        {
            document.getElementById('status').value = 'BEREIT';
            document.getElementById('status').style.backgroundImage = 'linear-gradient(to top, hsl(150, 75%, 45%) 0%, hsl(150, 75%, 55%) 100%)';
        }
    }

</script>
<script>

    async function restartDevice(btn)
    {
        if(!restarting && !updating && !saving && !resetting)
        {
            var overlays = {
                root : btn,
                id : 'restart',
                pending : { value : 'Neustart ..' },
                connectionError : { value : 'Keine Verbindung zum Gerät!' }
            };

            restarting = true;

            if(await complexFetch('http://' + device.ip + '/restart', 10000, 3, overlays, false) == null)
            {
                showOverlay(btn, createErrorOverlay('restart-result', 'Keine Verbindung zum Gerät!'));

                await newTimeout(4000);

                removeOverlays(btn, true);

                await newTimeout(300);
            }
        }
    }

    setTimeout(async function()
    {
        if(device.ip != undefined)
        {
            pingESP();
            checkUpdates();
        }
        else
        {
            while(1 != 0)
            {
                if(!updating && !saving && !resetting && document.getElementById('settings').hasAttribute('style'))
                {
                    fetchState();
                }

                await newTimeout(1000);
            }
        }
    }, 500);

    async function pingESP()
    {
        if(document.getElementById('updating') == null && !saving && document.getElementById('settings').hasAttribute('style'))
        {
            if(await fetchURL('http://' + device.ip + '/', 10000) != null)
            {
                console.log("ESP Gefunden");

                if(restarting == true)
                {
                    showOverlay(document.getElementById('restart-btn'), createSuccessOverlay('restart-result', 'Neustart Erfolgreich!'));
                    
                    await newTimeout(4000);
                    
                    removeOverlays(document.getElementById('restart-btn'), true);

                    setTimeout(function()
                    {
                        restarting = false;
                    }, 300);
                }

                for(var i = 0; i <= 4000; i += 1000)
                {
                    setTimeout(function()
                    {
                        if(!updating && !saving && !resetting)
                        {
                            fetchState();
                        }
                    }, i);
                }

                setTimeout(function()
                {
                    pingESP();
                }, 5000);
            }
            else
            {
                document.getElementsByClassName('control-panel')[0].style.backgroundImage = 'linear-gradient(to top, hsl(350, 75%, 45%) 0%, hsl(350, 75%, 55%) 100%)';
                document.getElementsByClassName('control-panel')[0].value = 'OFFLINE';

                await newTimeout(500);
                
                pingESP();
            }
        }
        else
        {
            await newTimeout(500);
                
            pingESP();
        }
    }    

    function updateDevice(btn)
    {
        return new Promise(async function(resolve) {

            var response = false;

            if(!updating && !restarting && !saving && !resetting)
            {
                var overlays = {
                    root : btn,
                    id : 'update',
                    pending : { value : 'Bitte Warten ..' },
                    success : { value : 'Update wird Installiert ..', color : 'purple', remove : false },
                    executeError : { value : 'Update Fehlgeschlagen!' },
                    connectionError : { value : 'Keine Verbindung zum Gerät!' }
                };

                updating = true;

                if(await complexFetch('http://' + device.ip + '/update', 10000, 3, overlays, true) == 'Success')
                {
                    await newTimeout(3000);

                    var overlays = {
                        root : btn,
                        id : 'update-installation',
                        connectionError : { value : 'Keine Verbindung zum Gerät!' }
                    };

                    var update = await complexFetch('http://' + device.ip + '/version', 3000, 20, overlays, false);

                    if(update == btn.getAttribute('value').split('( v')[1].split(' )')[0])
                    {  
                        showOverlay(btn, createOverlay(3, 'update-result', 'Update Erfolgreich!', 'green'));

                        response = true;
                    }
                    else
                    {
                        showOverlay(btn, createOverlay(3, 'update-result', 'Update Fehlgeschlagen!', 'red'));
                    }

                    document.getElementById('infos').getElementsByClassName('main')[0].children[3].innerHTML = '<b>Version: </b>' + await complexFetch('http://' + device.ip + '/version', 3000, 3, {}, false);

                    await newTimeout(4000);

                    removeOverlays(btn, update == btn.getAttribute('value').split('( v')[1].split(' )')[0] ? false : true);
                }

                updating = false;
            }

            resolve(response);
        });
    }

</script>
<script defer>

    async function checkUpdates()
    {
        var newestVersion = await complexFetch('http://syntex.sytes.net/smarthome/check-version?device=' + document.getElementsByClassName('main')[1].getAttribute('type'), 10000, 3, {}, false);

        if(newestVersion != null && versionCount(newestVersion) > versionCount(document.getElementsByClassName('main')[1].getAttribute('version')))
        {
            var update = document.createElement('input');

            update.setAttribute('type', 'button');
            update.setAttribute('value', 'Update Installieren ( v' + newestVersion + ' )');
            update.setAttribute('style', 'margin-bottom: 20px;');
            update.setAttribute('onclick', 'updateDevice(this)');
            update.setAttribute('id', 'update-btn');

            document.getElementsByClassName('main')[1].insertBefore(update, document.getElementById('restart-btn'));
        }
    }
    
</script>
<script>

    function resetDevice(btn)
    {
        var overlay = createOverlay(1, 'reset-confirm', 'Löschen Bestätigen?', 'red');

        overlay.setAttribute('onclick', 'resetConfirm(this)');

        showOverlay(btn, overlay);
    }
    
    async function resetConfirm(btn)
    {
        if(!resetting && !updating && !restarting && !saving)
        {
            var overlays = {
                root : btn,
                id : 'update',
                pending : { value : 'Zurücksetzen ..', z : 2 },
                executeError : { value : 'Reset Fehlgeschlagen!', z : 3 },
                connectionError : { value : 'Keine Verbindung ' + (device.ip == undefined ? 'zur Bridge!' : 'zum Gerät!'), z : 3 }
            };

            if(device.ip != undefined)
            {
                var url = 'http://' + device.ip + '/reset';
            }
            else
            {
                var url = '/remove-device?mac=' + device.id + '&type=' + device.type;
            }

            resetting = true;

            if(await complexFetch(url, 10000, 2, overlays, true) == 'Success')
            {
                await newTimeout(3000);

                if(await checkRestart('/check-restart'))
                {
                    showOverlay(btn, createOverlay(3, 'reset-result', 'Reset Erfolgreich!', 'green'));

                    await newTimeout(3000);

                    window.location.href = '/';
                }
            }
            else
            {
                await newTimeout(4010);
                removeOverlays(document.getElementById('reset-btn'), true);
            }

            resetting = false;
        }
    }

    async function saveConfig()
    {
        if(!saving && !updating && !restarting && !resetting)
        {
            var settings = {
                mac: device.id
            };

            var form = document.getElementById('settings-form');

            for(var i = 0; i < form.childElementCount; i++)
            {
                if(!form.children[i].hasAttribute('type'))
                {
                    if(form.children[i].getElementsByTagName('input')[0].getAttribute('name') == 'interval')
                    {
                        if(device.type == 'temperature')
                        {
                            settings['interval'] = form.children[i].getElementsByTagName('input')[0].value * 1000;
                        }
                        else if(device.type == 'motion')
                        {
                            settings['interval'] = (form.children[i].getElementsByTagName('input')[0].value - 1.5) * 1000;
                        }
                        else if(device.type == 'light')
                        {
                            settings['interval'] = form.children[i].getElementsByTagName('input')[0].value * 1000;
                        }
                        else
                        {
                            settings['interval'] = form.children[i].getElementsByTagName('input')[0].value;
                        }
                    }
                    else if(form.children[i].getElementsByTagName('input')[0].getAttribute('name') == 'events')
                    {
                        var concat = '[' + document.getElementById('events').getElementsByTagName('input')[0].value;

                        for(var j = 1; j < document.getElementById('events').getElementsByTagName('input').length; j++)
                        {
                            concat += ',' + document.getElementById('events').getElementsByTagName('input')[j].value;
                        }

                        concat += ']';

                        settings['events'] = JSON.parse(concat);
                    }
                    else if(form.children[i].getElementsByTagName('input')[0].getAttribute('type') == 'button')
                    {
                        settings[form.children[i].getElementsByTagName('input')[0].getAttribute('name')] = (form.children[i].getElementsByTagName('input')[0].value == 'An' ? 1 : 0);
                    }
                    else if(form.children[i].getElementsByTagName('input')[0].getAttribute('type') == 'text')
                    {
                        settings[form.children[i].getElementsByTagName('input')[0].getAttribute('name')] = form.children[i].getElementsByTagName('input')[0].value;
                    }
                }
            }

            console.log(settings);

            var overlays = {
                root : document.getElementById('save-btn'),
                id : 'saving',
                pending : { value : 'Hochladen ..', remove : false },
                executeError : { value : 'Update Fehlgeschlagen!' },
                connectionError : { value : 'Keine Verbindung zur Bridge!' }
            };

            saving = true;

            if(await complexFetchPost('/serverside/save-config', 10000, JSON.stringify(settings), 3, overlays, true) == 'Success')
            {
                var overlays = {
                    root : document.getElementById('save-btn'),
                    id : 'refresh',
                    success : { value : 'Hochgeladen!' },
                    executeError : { value : 'Fehler beim Upload!' },
                    connectionError : { value : 'Gespeichert!', color : 'yellow' }
                };

                await complexFetch('http://' + device.ip + '/refresh', 10000, 3, overlays, true);
                
                await newTimeout(2000);
                    
                redirect();
            }
            else
            {
                saving = false;

                await newTimeout(500);

                pingESP();
            }

            saving = false;
        }
    }
    
    function redirect()
    {
        location.reload();
    }

</script>