<html>
	<head>
		<link rel="stylesheet" type="text/css" href="/style/main.css" media="screen">
	</head>
	<body>
		<div id="content">
			<title>Debug Mode</title>
			<h1 style="margin-bottom: 0; margin-top: 32px">Debug</h1>
			<div id="style" class="main" style="margin-top: 10px; transition: .2s ease-in-out">
				<p style="margin-bottom: 100px; margin-top: 20px">Style</p>
				<div class="main" style="margin-top: 10px; margin-bottom: 20px; display: flex">
					<input class="white" type="button" value="STYLE" onclick="Essentials.switchPage('style', 'style', false)" style="margin-right: 20px" disabled>
					<input class="white" type="button" value="CONFIG" onclick="Essentials.switchPage('style', 'config', false)">
				</div>
				<div class="main" style="margin-top: 10px; margin-bottom: 20px; display: flex">
					<input class="white" type="button" value="BACKUP" onclick="Essentials.switchPage('style', 'backup', false)" style="margin-right: 20px">
					<input class="white" type="button" value="BETA" onclick="Essentials.switchPage('style', 'beta', false)">
				</div>
				<div style="margin: 100px 0">
					<input type="button" value="Button 1">
					<input type="button"  value="Button 2" style="margin-top: 20px" class="gradient-blue-green">
					<input type="text" style="margin-top: 20px">
					<div class="custom-select" style="margin-top: 20px">
						<select>
							<option value="0">1</option>
							<option value="1">2</option>
							<option value="2">3</option>
							<option value="3">4</option>
							<option value="4">5</option>
							<option value="5">6</option>
							<option value="6">7</option>
							<option value="7">8</option>
							<option value="8">9</option>
						</select>
					</div>
				</div>
				<div class="navigation-panel">
					<div class="sticky-inset">
						<input type="button" value="Zurück zum Dashboard" onclick="Essentials.leavePage('/')">
					</div>
				</div>
			</div>
			<div id="config" class="main" style="display: none; opacity: 0; transition: .2s ease-in-out">
				<p style="margin-bottom: 100px; margin-top: 20px">Config</p>
				<div class="main" style="margin-top: 10px; display: flex">
					<input class="white" type="button" value="STYLE" onclick="Essentials.switchPage('config', 'style', false)" style="margin-right: 20px">
					<input class="white" type="button" value="CONFIG" onclick="Essentials.switchPage('config', 'config', false)" disabled>
				</div>
				<div class="main" style="margin-top: 10px; margin-bottom: 20px; display: flex">
					<input class="white" type="button" value="BACKUP" onclick="Essentials.switchPage('config', 'backup', false)" style="margin-right: 20px">
					<input class="white" type="button" value="BETA" onclick="Essentials.switchPage('config', 'beta', false)">
				</div>
				<p style="margin: 100px 0">In der Config Datei<br>sind alle wichtigen Daten<br>über die Bridge gespeichert.<br><br>Mach am besten<br>regelmäßig ein Backup,<br>damit du niemals<br>deine Daten verlierst!</p>
				<textarea style="white-space: break-spaces; max-height: 600px; height: 600px; margin-bottom: 20px" id="config-container" onchange="validateJSON(this)">Laden ..</textarea>
				<div class="navigation-panel">
					<div class="sticky-inset" style="display: grid; grid-gap: 20px">
						<div style="display: flex">
							<input value="Alles Kopieren" type="button" style="margin-right: 20px" onclick="copyConfig()">
							<div style="width: 100%">
								<input id="config-restart" value="Neustart" type="button" onclick="restartBridge(this)">
							</div>
						</div>
						<div style="display: flex">
							<input type="button" value="Zurück zum Dashboard" style="margin-right: 20px" onclick="Essentials.leavePage('/')">
							<div style="width: 100%">
								<input id="config-save" value="Speichern" style="background-color: hsl(200, 85%, 55%)" type="button" onclick="saveConfig(this)">
							</div>
						</div>
					</div>
				</div>
			</div>
			<div id="backup" class="main" style="display: none; opacity: 0; transition: .2s ease-in-out">
				<p style="margin-bottom: 100px; margin-top: 20px">Backup</p>
				<div class="main" style="margin-top: 10px; display: flex">
					<input class="white" type="button" value="STYLE" onclick="Essentials.switchPage('backup', 'style', false)" style="margin-right: 20px">
					<input class="white" type="button" value="CONFIG" onclick="Essentials.switchPage('backup', 'config', false)">
				</div>
				<div class="main" style="margin-top: 10px; margin-bottom: 20px; display: flex">
					<input class="white" type="button" value="BACKUP" onclick="Essentials.switchPage('backup', 'backup', false)" style="margin-right: 20px" disabled>
					<input class="white" type="button" value="BETA" onclick="Essentials.switchPage('backup', 'beta', false)">
				</div>
			</div>
			<div id="beta" class="main" style="display: none; opacity: 0; transition: .2s ease-in-out">
				<p style="margin-bottom: 100px; margin-top: 20px">Beta Programm</p>
				<div class="main" style="margin-top: 10px; display: flex">
					<input class="white" type="button" value="STYLE" onclick="Essentials.switchPage('beta', 'style', false)" style="margin-right: 20px">
					<input class="white" type="button" value="CONFIG" onclick="Essentials.switchPage('beta', 'config', false)">
				</div>
				<div class="main" style="margin-top: 10px; margin-bottom: 20px; display: flex">
					<input class="white" type="button" value="BACKUP" onclick="Essentials.switchPage('beta', 'backup', false)" style="margin-right: 20px">
					<input class="white" type="button" value="BETA" onclick="Essentials.switchPage('beta', 'beta', false)" disabled>
				</div>
				<div style="margin: 100px 0">
					<div id="beta-plugins"></div>
				</div>
				<div class="navigation-panel">
					<div class="sticky-inset">
						<input id="back-btn" type="button" value="Zurück zum Dashboard" onclick="Essentials.leavePage('/')">
					</div>
				</div>
			</div>
			<script type="module">

				import { Query } from '/js/query.js';
				import { Essentials } from '/js/essentials.js';
				import { Replacer } from '/js/replace-select.js';
				import { Preloader } from '/js/loading.js';
	
				Query.SETUP(Essentials);
				Essentials.SETUP(Query, Preloader);
			
				window.Query = Query;
				window.Essentials = Essentials;
				window.Replacer = Replacer;
				window.Preloader = Preloader;

				window.configJSON = '<%configJSON%>';
				window.updates = '<%updates%>';

				window.versions = {};
				window.betaVersions = {};
				window.updating = [];
				window.restarting = false;

				document.getElementById('config-container').value = JSON.stringify(JSON.parse(configJSON), null, '\t');

				if((new URL(window.location.href)).searchParams.get('config') == '')
				{
					Essentials.switchPage('style', 'config', true);
				}
				else if((new URL(window.location.href)).searchParams.get('backup') == '')
				{
					Essentials.switchPage('style', 'backup', true);
				}
				else if((new URL(window.location.href)).searchParams.get('beta') == '')
				{
					Essentials.switchPage('style', 'beta', true);
				}

				Preloader.finish();
			
				Query.complexFetch('/serverside/plugins', 5000, 2, {}, false).then((plugins) => {

					try
					{
						plugins = JSON.parse(plugins);
					}
					catch(e)
					{
						plugins = [];

						console.log(e);
					}

					try
					{
						updates = JSON.parse(updates);
					}
					catch(e)
					{
						updates = {};

						console.log(e);
					}

					console.log(plugins, updates);

					for(var i = 0; i < plugins.length; i++)
					{
						if(i == 0)
						{
							document.getElementById('beta-plugins').innerHTML += '<h2 style="width: fit-content; margin-top: 0">• ' + (plugins[i].id != 'SynTex' ? plugins[i].id.replace('SynTex', 'SynTex ') : 'SynTex') + ' •</h2>';
						}
						else
						{
							document.getElementById('beta-plugins').innerHTML += '<h2 style="width: fit-content">• ' + (plugins[i].id != 'SynTex' ? plugins[i].id.replace('SynTex', 'SynTex ') : 'SynTex') + ' •</h2>';
						}
						
						document.getElementById('beta-plugins').innerHTML += '<p class="loading-loop"><b>Version: </b>Laden ..</p>';

						if(updates.plugins != null && updates.plugins[plugins[i].id] != null && updates.plugins[plugins[i].id].beta != null)
						{
							var newestVersion = updates.plugins[plugins[i].id].beta;

							betaVersions[plugins[i].id] = newestVersion;

							document.getElementById('beta-plugins').innerHTML += '<p style="margin-bottom: 0"><b>Beta Version: </b>' + newestVersion + '</p>';
						}
						else
						{
							document.getElementById('beta-plugins').innerHTML += '<p style="margin-bottom: 0"><b>Beta Version: </b>Fehler beim Laden</p>';
						}

						Query.complexFetch(window.location.protocol + '//' + window.location.hostname + ':' + plugins[i].port + '/serverside/version', 10000, 2, {}, false).then(async function (version) {

							if(version != null)
							{
								versions[this.plugin.id] = version;

								document.getElementById('beta-plugins').children[this.counter].innerHTML = '<b>Version: </b>' + versions[this.plugin.id];
							
								console.log(Essentials.versionCount(betaVersions[this.plugin.id]) > Essentials.versionCount(version), betaVersions[this.plugin.id], version, Essentials.versionCount(betaVersions[this.plugin.id]), Essentials.versionCount(version));

								//console.log(betaVersions[this.plugin.id] != version, betaVersions[this.plugin.id], version);

								if(Essentials.versionCount(betaVersions[this.plugin.id]) != Essentials.versionCount(version))
								{
									var updateButton = document.createElement('input');

									updateButton.setAttribute('type', 'button');
									updateButton.setAttribute('value', (this.plugin.id != 'SynTex' ? this.plugin.id.replace('SynTex', 'SynTex ') : 'SynTex') + ' Aktualisieren ( v' + betaVersions[this.plugin.id] + ' )');
									updateButton.setAttribute('onclick', 'updatePlugin("' + this.plugin.id + '", ' + this.plugin.port + ', ' + this.counter + ', this)'); // TODO
									updateButton.setAttribute('id', 'update-btn-' + this.plugin.id.toLowerCase());
									updateButton.setAttribute('style', 'margin-bottom: 20px'); 
									
									console.log('CREATE BUTTON', document.getElementsByClassName('navigation-panel')[0].children[0], document.getElementsByClassName('navigation-panel')[0].children[0].children[0]);

									document.getElementsByClassName('navigation-panel')[2].children[0].insertBefore(updateButton, document.getElementsByClassName('navigation-panel')[2].children[0].children[0]);
								}
							}
							else
							{
								document.getElementById('beta-plugins').children[this.counter].innerHTML = '<b>Version: </b>Fehler beim Laden';
							}

						}.bind({ plugin : plugins[i], counter : i * 3 + 1 }));
					}

					Preloader.finish();
				});

				</script>
				<script>

				async function updatePlugin(id, port, counter, btn)
				{
					if(!restarting && updating.length == 0)
					{
						var overlays = {
							root : btn,
							id : 'update',
							pending : { value : 'Update wird Installiert ..', color : 'purple' },
							executeError : { value : 'Update Fehlgeschlagen!' },
							connectionError : { value : 'Keine Verbindung zur Bridge!' }
						};

						updating.push(id);

						if(await Query.complexFetch(window.location.protocol +  '//' + window.location.hostname + ':' + port + '/serverside/update?version=' + betaVersions[id], 120000, 2, overlays, false) == 'Success')
						{
							await Essentials.newTimeout(3000);

							if(await Essentials.checkRestart(window.location.protocol +  '//' + window.location.hostname + ':' + port + '/serverside/check-restart'))
							{
								document.getElementById('beta-plugins').children[counter].innerHTML = '<b>Version: </b>Laden ..';

								Essentials.showOverlay(btn, Essentials.createSuccessOverlay('update-result', 'Update Erfolgreich!'));

								versions[id] = await Query.complexFetch(window.location.protocol +  '//' + window.location.hostname + ':' + port + '/serverside/version', 10000, 10, {}, false);

								document.getElementById('beta-plugins').children[counter].innerHTML = '<b>Version: </b>' + versions[id];
							}
							else
							{
								Essentials.showOverlay(btn, Essentials.createErrorSuccessOverlay('update-result', 'Homebridge Startet Nicht!'));
							}

							await Essentials.newTimeout(4000);

							Essentials.removeOverlays(btn, false);

							await Essentials.newTimeout(300);
							
							updating.splice(updating.indexOf(id), 1);
						}
					}
				}
			
				function copyConfig()
				{
					var textarea = document.getElementById('config-container');

					textarea.select();
					document.execCommand('copy');

					alert('Die Config wurde in deine Zwischenablage kopiert!');
				}

				async function saveConfig(btn)
				{
					if(validateJSON(document.getElementById('config-container')))
					{
						var overlays = {
							root : btn,
							id : 'saving',
							pending : { value : 'Hochladen ..' },
							success : { value : 'Aktualisiert!' },
							executeError : { value : 'Hochladen Fehlgeschlagen!' },
							connectionError : { value : 'Keine Verbindung zur Bridge' }
						};

						if(await Query.complexFetch('/serverside/update-config', 5000, 6, overlays, true, document.getElementById('config-container').value) == 'Success')
						{
							Essentials.showOverlay(btn, Essentials.createOverlay(2, 'saving', 'Config Aktualisiert!', 'green'));

							await Essentials.newTimeout(1500);

							document.getElementById('config-restart').style.backgroundColor = 'hsl(350, 75%, 55%)';

							await Essentials.newTimeout(1500);

							Essentials.removeOverlays(btn, true);
						}
					}
				}

				async function restartBridge(btn)
				{
					var overlays = {
						root : btn,
						id : 'restarting',
						pending : { value : 'Neustarten ..' },
						executeError : { value : 'Neustart Fehlgeschlagen!' },
						connectionError : { value : 'Keine Verbindung zur Bridge!' }
					};

					restarting = true;

					if(await Query.complexFetch('/serverside/restart', 5000, 2, overlays, true) == 'Success')
					{
						await Essentials.newTimeout(3000);

						document.getElementById('config-restart').style.backgroundColor = '';

						if(await Essentials.checkRestart('/serverside/check-restart'))
						{
							Essentials.showOverlay(btn, Essentials.createSuccessOverlay('restart-result', 'Neustart Erfolgreich!'));
						}
						else
						{
							Essentials.showOverlay(btn, Essentials.createErrorOverlay('restart-result', 'Neustart Fehlgeschlagen!'));
						}

						await Essentials.newTimeout(4000);

						Essentials.removeOverlays(btn, true);

						restarting = false;
					}
				}

				function validateJSON(textarea)
				{
					console.log('validate JSON');

					try
					{
						if(textarea.value != '')
						{
							JSON.parse(textarea.value);

							document.getElementById('config-save').style.backgroundColor = 'hsl(200, 85%, 55%)';

							return true;
						}
						else
						{
							return false;
						}
					}
					catch(e)
					{
						document.getElementById('config-save').style.backgroundColor = 'hsl(350, 75%, 55%)';

						console.error(e);

						return false;
					}
				}
			
			</script>
		</div>
	</body>
</html>