<html>
    <title>Dashboard: Log</title>
    <body>
        <h1 style="margin-bottom: 0; margin-top: 32px">Dashboard</h1>
        <div class="main" style="margin-top: 10px; margin-bottom: 100px">
            <p style="margin-bottom: 100px; margin-top: 20px">Log</p>
            <div class="main" style="margin-top: 10px; margin-bottom: 20px; display: flex">
                <input class="white" type="button" value="GERÄTE" onclick="window.location.href='/'" style="margin-right: 20px">
                <input class="white" type="button" value="BRIDGE" onclick="window.location.href='/bridge'">
            </div>
            <div class="main" style="margin-top: 10px; display: flex">
                <input class="white" type="button" value="AUTOMATION" id="a" onclick="window.location.href='/automations'" style="margin-right: 20px; display: none">
                <input class="white" type="button" value="LOG" onclick="window.location.href='/log'" disabled>
            </div>
        </div>
        <div class="main" style="margin-bottom: 100px">
            <div id="widgets" style="margin-bottom: 20px; display: grid; grid-template-columns: calc(33% - 13px) calc(34% - 14px) calc(33% - 13px); grid-gap: 20px">
                <div class="widget">
                    <button class="widget-left" disabled>Fehler</button>
                    <button class="widget-right gradient-red" disabled>-</button>
                </div>
                <div class="widget">
                    <button class="widget-left" disabled>Warnung</button>
                    <button class="widget-right gradient-orange" disabled>-</button>
                </div>
                <div class="widget">
                    <button class="widget-left" disabled>Info</button>
                    <button class="widget-right gradient-yellow" disabled>-</button>
                </div>
                <div class="widget">
                    <button class="widget-left" disabled>Lesen</button>
                    <button class="widget-right gradient-blue" disabled>-</button>
                </div>
                <div class="widget">
                    <button class="widget-left" disabled>Update</button>
                    <button class="widget-right gradient-cyan" disabled>-</button>
                </div>
                <div class="widget">
                    <button class="widget-left" disabled>Erfolg</button>
                    <button class="widget-right gradient-green" disabled>-</button>
                </div>
            </div>
            <div class="widget" id="debug-widget" style="display: none">
                <button class="widget-left" disabled>Debug</button>
                <button class="widget-right gradient-purple" disabled>-</button>
            </div>
        </div>
        <form onsubmit="event.preventDefault(); searchLog();" class="main" style="margin-bottom: 32px">
            <input type="submit" value="Absenden" style="display: none">
            <div style="margin-bottom: 20px; display: flex">
                <input id="search-params" type="text" placeholder="Such-Parameter" style="margin-right: 20px">
                <input id="search-btn" class="gradient-blue loading-loop" type="button" value="Suchen" onclick="searchLog()" style="max-width: 200px">
            </div>
            <div style="display: flex">
                <input id="search-level" type="text" placeholder="Such-Level ( 'Info', 'Error', .. )" style="margin-right: 20px">
                <input type="button" value="Ohne Filter" onclick="clearSearch()" style="max-width: 200px">
            </div>
        </form>
        <p id="log-counter" class="loading-loop" style="margin-bottom: 100px"><b>Gefundene Elemente: </b>Laden ..</p>
        <div id="log-container" class="main"></div>
    </body>
</html>
<script type="module" defer>

    import { Query } from '/js/query.js';
    import { Essentials } from '/js/essentials.js';

    Query.SETUP(Essentials);
    Essentials.SETUP(Query);

    window.Query = Query;
    window.Essentials = Essentials;

    window.logJSON = {};
    window.counter = 0;
    window.levelCounter = [0, 0, 0, 0, 0, 0, 0];
    window.countLogs = true;

    fetchLogs();

    Query.complexFetch('/serverside/automations', 10000, 3, {}, false).then(function(automations) {

        if(automations != null && automations.length > 0)
        {
            document.getElementById("a").style.display = "";
        }
    });

</script>
<script>

    function fetchLogs()
    {
        Query.complexFetch('/serverside/log', 10000, 3, {}, false).then(function(l) {

            logJSON = JSON.parse(l);

            for(var i = 0; i < Object.keys(logJSON).length; i++)
            {
                var logTitle = document.createElement('h2');
                var logWindow = document.createElement('textarea');

                logTitle.setAttribute('style', 'width: fit-content');
                logTitle.innerHTML = '• ' + Object.keys(logJSON)[i] + ' Log •';

                if(Object.keys(logJSON)[i] == 'SynTex')
                {
                    logTitle.innerHTML = '• Bridge Log •';
                }
                else if(Object.keys(logJSON)[i] == 'SynTexWebHooks')
                {
                    logTitle.innerHTML = '• WebHooks Log •';
                }
                else if(Object.keys(logJSON)[i] == 'SynTexTuya')
                {
                    logTitle.innerHTML = '• Tuya Log •';
                }

                logWindow.setAttribute('readonly', '');
                logWindow.setAttribute('id', Object.keys(logJSON)[i]);
                logWindow.style.height = '800px'; 
                logWindow.style.maxHeight = '800px'; 

                if(i < Object.keys(logJSON).length - 1)
                {
                    logWindow.style.marginBottom = '40px';    
                }

                document.getElementById('log-container').appendChild(logTitle);
                document.getElementById('log-container').appendChild(logWindow);

                if(logJSON[Object.keys(logJSON)[i]].length > 0)
                {
                    var label = document.createElement('h2');

                    label.innerHTML = '↻ Neu Laden';
                    label.setAttribute('style', 'margin-top: -180px; position: relative; background: rgb(245, 245, 255); border-color: rgb(245, 245, 255); color: rgb(20, 20, 30); cursor: pointer');
                    label.setAttribute('onclick', 'fetchLogs()');

                    document.getElementById(Object.keys(logJSON)[i]).appendChild(label);
                }

                createLog(document.getElementById(Object.keys(logJSON)[i]), logJSON[Object.keys(logJSON)[i]], null);
            }

            countLogs = false;

            document.getElementById('widgets').children[0].getElementsByClassName('widget-right')[0].innerHTML = levelCounter[5];
            document.getElementById('widgets').children[1].getElementsByClassName('widget-right')[0].innerHTML = levelCounter[4];
            document.getElementById('widgets').children[2].getElementsByClassName('widget-right')[0].innerHTML = levelCounter[3];
            document.getElementById('widgets').children[3].getElementsByClassName('widget-right')[0].innerHTML = levelCounter[2];
            document.getElementById('widgets').children[4].getElementsByClassName('widget-right')[0].innerHTML = levelCounter[1];
            document.getElementById('widgets').children[5].getElementsByClassName('widget-right')[0].innerHTML = levelCounter[0];

            if(levelCounter[6] > 0)
            {
                document.getElementById('debug-widget').style.display = '';
                document.getElementById('debug-widget').getElementsByClassName('widget-right')[0].innerHTML = levelCounter[6];
            }
        });
    }

    async function clearSearch()
    {
        document.getElementById('search-btn').value = 'Suchen ..';
        document.getElementById('search-params').value = '';
        document.getElementById('search-level').value = '';

        await Essentials.newTimeout(500);

        for(var i = 0; i < Object.keys(logJSON).length; i++)
        {
            createLog(document.getElementById(Object.keys(logJSON)[i]), logJSON[Object.keys(logJSON)[i]], null);
        }

        document.getElementById('search-btn').value = 'Suchen';
    }

    async function searchLog()
    {
        counter = 0;
        document.getElementById('search-btn').value = 'Suchen ..';

        await Essentials.newTimeout(500);

        var params = document.getElementById('search-params').value;
        var level = document.getElementById('search-level').value;
        var search = null;

        if(level != '' && params != '')
        {
            search = [level, params];
        }
        else if(params != '')
        {
            search = [null, params];
        }
        else if(level != '')
        {
            search = [level, null];
        }

        for(var i = 0; i < Object.keys(logJSON).length; i++)
        {
            createLog(document.getElementById(Object.keys(logJSON)[i]), logJSON[Object.keys(logJSON)[i]], search);

            var lastChars = (document.getElementById(Object.keys(logJSON)[i]).innerHTML.slice(-2).match(/\n/g) || []).length;

            if(lastChars > 0)
            {
                document.getElementById(Object.keys(logJSON)[i]).innerHTML = document.getElementById(Object.keys(logJSON)[i]).innerHTML.slice(0, -(document.getElementById(Object.keys(logJSON)[i]).innerHTML.slice(-2).match(/\n/g) || []).length);
            }
        }

        document.getElementById('log-counter').innerHTML = '<b>Gefundene Elemente: </b>' + counter;
        document.getElementById('search-btn').value = 'Suchen';
    }

    function createLog(element, log, show)
    {
        var filterLog = '';

        log = JSON.parse(log);

        for(var i = 0; i < log.length; i++)
        {
            var levels = ['success', 'update', 'read', 'info', 'warn', 'error', 'debug'];
            var level = log[i].l.toUpperCase();
            var time = new Date(log[i].t * 1000);
            var message = log[i].m;
            var displayEntry = false;

            if(show != null)
            {
                if(show[0] != null && show[1] != null)
                {
                    if(show[0].toUpperCase() == level && message.toUpperCase().includes(show[1].toUpperCase()))
                    {
                        displayEntry = true;
                    }
                }
                else if(show[0] != null && show[0].toUpperCase() == level)
                {
                    displayEntry = true;
                }
                else if(show[1] != null && message.toUpperCase().includes(show[1].toUpperCase()))
                {
                    displayEntry = true;
                }
            }
            else
            {
                displayEntry = true;
            }

            if(displayEntry)
            {
                var weekDays = ['So', 'Mo', 'Di', 'Mi', 'Do', 'Fr', 'Sa'];

                filterLog += weekDays[time.getDay()] + ' ' + ('0' + time.getHours()).slice(-2) + ':' + ('0' + time.getMinutes()).slice(-2) + ':' + ('0' + time.getSeconds()).slice(-2) + ' > [' + level + '] ';
                /*
                if(level == 'UPDATE')
                {
                    filterLog += ' > ' + message.split('$')[0] + "\n'" + message.split('$')[1] + "' geändert zu '" + message.split('$')[2] + "'";
                }
                else if(level == 'READ')
                {
                    filterLog += ' > ' + message.split('$')[0] + "\n'" + message.split('$')[1] + "' Status ist '" + message.split('$')[2] + "'";
                }
                else
                {*/
                    if(message.includes('(') && message.includes(')'))
                    {
                        filterLog += ' > ' + message.split('( ')[1].split(' )')[0] + '\n' + message.replace(new RegExp(/\[/, 'g'), "'").replace(new RegExp(/\]/, 'g'), "'").replace('(' + message.split('(')[1].split(')')[0] + ')', '');
                    }
                    else
                    {
                        filterLog += '\n' + message.replace(new RegExp(/\[/, 'g'), "'").replace(new RegExp(/\]/, 'g'), "'");
                    }
                //}
                
                if(i != log.length - 1)
                {
                    filterLog += '\n\n';
                }

                counter++;
            }

            if(countLogs)
            {
                levelCounter[levels.indexOf(level.toLowerCase())]++;
            }
        }

        element.innerHTML = filterLog;
        document.getElementById('log-counter').innerHTML = '<b>Gefundene Elemente: </b>' + counter;
    }

</script>