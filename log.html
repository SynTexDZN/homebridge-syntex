<html>
	<body ontouchstart="">
		<div id="content" style="padding-bottom: 50px">
			<title>Dashboard: Log</title>
			<script type="module">

				import { PageManager } from '/js/page-manager.js';

				window.PageManager = PageManager;

				PageManager.setHeader('Dashboard', 'Log');

			</script>
			<div class="main" style="margin-bottom: 100px">
				<div class="main" style="margin-bottom: 20px; display: flex">
					<input class="white" type="button" value="GERÄTE" onclick="Essentials.leavePage('/')" style="margin-right: 20px">
					<input class="white" type="button" value="BRIDGE" onclick="Essentials.leavePage('/bridge')">
				</div>
				<div class="main" style="margin-top: 10px; display: flex">
					<input class="white" type="button" value="AUTOMATION" id="a" onclick="Essentials.leavePage('/automation/')" style="margin-right: 20px">
					<input class="white" type="button" value="LOG" onclick="Essentials.leavePage('/log')" disabled>
				</div>
			</div>
			<div class="main" style="margin-bottom: 100px">
				<div id="widgets" style="margin-bottom: 20px; display: grid; grid-template-columns: calc(33% - 13px) calc(34% - 14px) calc(33% - 13px); grid-gap: 20px">
					<div class="widget">
						<button class="widget-left">Fehler</button>
						<button class="widget-right gradient-red">-</button>
					</div>
					<div class="widget">
						<button class="widget-left">Warnung</button>
						<button class="widget-right gradient-orange">-</button>
					</div>
					<div class="widget">
						<button class="widget-left">Info</button>
						<button class="widget-right gradient-yellow">-</button>
					</div>
					<div class="widget">
						<button class="widget-left">Lesen</button>
						<button class="widget-right gradient-blue">-</button>
					</div>
					<div class="widget">
						<button class="widget-left">Update</button>
						<button class="widget-right gradient-cyan">-</button>
					</div>
					<div class="widget">
						<button class="widget-left">Erfolg</button>
						<button class="widget-right gradient-green">-</button>
					</div>
				</div>
				<div class="widget" id="debug-widget" style="display: none">
					<button class="widget-left">Debug</button>
					<button class="widget-right gradient-purple">-</button>
				</div>
			</div>
			<form onsubmit="event.preventDefault(); searchLog();" class="main" style="margin-bottom: 32px">
				<input type="submit" value="Absenden" style="display: none">
				<div style="margin-bottom: 20px; display: flex">
					<input id="search-params" type="text" placeholder="Such-Parameter" style="margin-right: 20px">
					<input id="search-btn" class="gradient-blue loading-loop" type="button" value="Suchen" onclick="searchLog()" style="max-width: 200px">
				</div>
				<div style="display: flex">
					<input id="search-level" type="text" placeholder="Such-Level ( 'Info', 'Error', .. )" style="margin-right: 20px">
					<input type="button" value="Ohne Filter" onclick="clearSearch()" style="max-width: 200px">
				</div>
			</form>
			<p id="log-counter" class="loading-loop" style="margin-bottom: 100px"><b>Gefundene Elemente: </b>Laden ..</p>
			<div id="log-container" class="main"></div>
			<script type="module" defer>

				import { Query } from '/js/query.js';
				import { Essentials } from '/js/essentials.js';

				Query.SETUP(Essentials);
				Essentials.SETUP(Query, Preloader);

				window.Query = Query;
				window.Essentials = Essentials;

				window.logJSON = {};
				window.counter = 0;
				window.levelCounter = [0, 0, 0, 0, 0, 0, 0];
				window.countLogs = true;
				window.plugins = [];

				Query.complexFetch('/serverside/plugins', 5000, 2, {}, false).then(function(P) {

					try
					{
						plugins = JSON.parse(P);
					}
					catch(e)
					{
						plugins = [];

						console.error(e);
					}
					
					var counter = 0;

					for(const id in plugins)
					{
						if(plugins[id].config != null && plugins[id].config.logDirectory != null)
						{
							var logTitle = document.createElement('h2');
							var logWindow = document.createElement('textarea');

							logTitle.setAttribute('style', 'width: fit-content');
							logTitle.innerHTML = '• ' + (plugins[id].alias != 'SynTex' ? plugins[id].alias.replace('SynTex', 'SynTex ') : 'SynTex') + ' Log •';

							if(plugins[id].alias == 'SynTex')
							{
								logTitle.innerHTML = '• Bridge Log •';
							}
							else if(plugins[id].alias == 'SynTexWebHooks')
							{
								logTitle.innerHTML = '• WebHooks Log •';
							}
							else if(plugins[id].alias == 'SynTexTuya')
							{
								logTitle.innerHTML = '• Tuya Log •';
							}
							else if(plugins[id].alias == 'SynTexMagicHome')
							{
								logTitle.innerHTML = '• MagicHome Log •';
							}

							logWindow.setAttribute('readonly', '');
							logWindow.setAttribute('id', plugins[id].alias);
							logWindow.style.height = '700px'; 
							logWindow.style.maxHeight = '700px'; 

							if(counter < plugins.length - 1)
							{
								logWindow.style.marginBottom = '40px';    
							}

							document.getElementById('log-container').appendChild(logTitle);
							document.getElementById('log-container').appendChild(logWindow);
						
							counter++;
						}
					}

					fetchLogs();
				});

			</script>
			<script>

				function fetchLogs(id)
				{
					Query.complexFetch('/serverside/log' + (id != null ? '?id=' + id : ''), 10000, 2, {}, false).then(function(l) {

						try
						{
							logJSON = JSON.parse(l);
						}
						catch(e)
						{
							logJSON = [];

							console.error(e);
						}
						
						for(const id in plugins)
						{
							if(plugins[id].config != null && plugins[id].config.logDirectory != null)
							{
								if(logJSON[plugins[id].alias] == null || logJSON[plugins[id].alias].length == 0)
								{
									var label = document.createElement('h2');

									label.innerHTML = '↻ Neu Laden';
									label.setAttribute('style', 'margin-top: -180px; position: relative; background: rgb(245, 245, 255); border-color: rgb(245, 245, 255); color: rgb(20, 20, 30); cursor: pointer');
									label.setAttribute('onclick', 'fetchLogs("' + plugins[id].alias + '")');

									document.getElementById(plugins[id].alias).appendChild(label);
								}
								else
								{
									createLog(document.getElementById(plugins[id].alias), logJSON[plugins[id].alias], null);
								}
							}
						}

						countLogs = false;

						document.getElementById('widgets').children[0].getElementsByClassName('widget-right')[0].innerHTML = levelCounter[5];
						document.getElementById('widgets').children[1].getElementsByClassName('widget-right')[0].innerHTML = levelCounter[4];
						document.getElementById('widgets').children[2].getElementsByClassName('widget-right')[0].innerHTML = levelCounter[3];
						document.getElementById('widgets').children[3].getElementsByClassName('widget-right')[0].innerHTML = levelCounter[2];
						document.getElementById('widgets').children[4].getElementsByClassName('widget-right')[0].innerHTML = levelCounter[1];
						document.getElementById('widgets').children[5].getElementsByClassName('widget-right')[0].innerHTML = levelCounter[0];

						if(levelCounter[6] > 0)
						{
							document.getElementById('debug-widget').style.display = '';
							document.getElementById('debug-widget').getElementsByClassName('widget-right')[0].innerHTML = levelCounter[6];
						}

						Preloader.finish();
					});
				}

				async function clearSearch()
				{
					document.getElementById('search-btn').value = 'Suchen ..';
					document.getElementById('search-params').value = '';
					document.getElementById('search-level').value = '';

					await Essentials.newTimeout(500);

					for(var i = 0; i < Object.keys(logJSON).length; i++)
					{
						createLog(document.getElementById(Object.keys(logJSON)[i]), logJSON[Object.keys(logJSON)[i]], null);
					}

					document.getElementById('search-btn').value = 'Suchen';
				}

				async function searchLog()
				{
					var params = document.getElementById('search-params').value;
					var level = document.getElementById('search-level').value;
					var search = null;

					counter = 0;
					document.getElementById('search-btn').value = 'Suchen ..';

					await Essentials.newTimeout(500);

					if(level != '' && params != '')
					{
						search = [level, params];
					}
					else if(params != '')
					{
						search = [null, params];
					}
					else if(level != '')
					{
						search = [level, null];
					}

					for(var i = 0; i < Object.keys(logJSON).length; i++)
					{
						createLog(document.getElementById(Object.keys(logJSON)[i]), logJSON[Object.keys(logJSON)[i]], search);

						var lastChars = (document.getElementById(Object.keys(logJSON)[i]).innerHTML.slice(-2).match(/\n/g) || []).length;

						if(lastChars > 0)
						{
							document.getElementById(Object.keys(logJSON)[i]).innerHTML = document.getElementById(Object.keys(logJSON)[i]).innerHTML.slice(0, -(document.getElementById(Object.keys(logJSON)[i]).innerHTML.slice(-2).match(/\n/g) || []).length);
						}
					}

					document.getElementById('log-counter').innerHTML = '<b>Gefundene Elemente: </b>' + counter;
					document.getElementById('search-btn').value = 'Suchen';
				}

				function createLog(element, log, show)
				{
					var filterLog = '';

					try
					{
						log = JSON.parse(log);
					}
					catch(e)
					{
						log = [];

						console.error(e);
					}

					for(var i = 0; i < log.length; i++)
					{
						var levels = ['success', 'update', 'read', 'info', 'warn', 'error', 'debug'];
						var level = log[i].l.toUpperCase();
						var time = new Date(log[i].t * 1000);
						var message = log[i].m;
						var displayEntry = false;

						if(show != null)
						{
							if(show[0] != null && show[1] != null)
							{
								if(show[0].toUpperCase() == level && message.toUpperCase().includes(show[1].toUpperCase()))
								{
									displayEntry = true;
								}
							}
							else if(show[0] != null && show[0].toUpperCase() == level)
							{
								displayEntry = true;
							}
							else if(show[1] != null && message.toUpperCase().includes(show[1].toUpperCase()))
							{
								displayEntry = true;
							}
						}
						else
						{
							displayEntry = true;
						}

						if(displayEntry)
						{
							var weekDays = ['So', 'Mo', 'Di', 'Mi', 'Do', 'Fr', 'Sa'];

							filterLog += weekDays[time.getDay()] + ' ' + ('0' + time.getHours()).slice(-2) + ':' + ('0' + time.getMinutes()).slice(-2) + ':' + ('0' + time.getSeconds()).slice(-2) + ' > [' + level + '] ';
							/*
							if(level == 'UPDATE')
							{
								filterLog += ' > ' + message.split('$')[0] + "\n'" + message.split('$')[1] + "' geändert zu '" + message.split('$')[2] + "'";
							}
							else if(level == 'READ')
							{
								filterLog += ' > ' + message.split('$')[0] + "\n'" + message.split('$')[1] + "' Status ist '" + message.split('$')[2] + "'";
							}
							else
							{*/
								if(message.includes('( ') && message.includes(' )'))
								{
									filterLog += ' > ' + message.split('( ')[1].split(' )')[0] + '\n' + message.replace(new RegExp(/\[/, 'g'), "'").replace(new RegExp(/\]/, 'g'), "'").replace('(' + message.split('(')[1].split(')')[0] + ')', '');
								}
								else
								{
									filterLog += '\n' + message.replace(new RegExp(/\[/, 'g'), "'").replace(new RegExp(/\]/, 'g'), "'");
								}
							//}
							
							if(i != log.length - 1)
							{
								filterLog += '\n\n';
							}

							counter++;
						}

						if(countLogs)
						{
							levelCounter[levels.indexOf(level.toLowerCase())]++;
						}
					}

					element.innerHTML = filterLog;
					document.getElementById('log-counter').innerHTML = '<b>Gefundene Elemente: </b>' + counter;
				}

			</script>
		</div>
	</body>
</html>