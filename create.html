<html>
    <title>Gerät Erstellen</title>
    <body>
        <div id="content">
            <div id="create" style="transition: .2s ease-in-out">
                <h1>Schalter Erstellen</h1>
                <p>( Ein virtuelles Gerät )</p>
                <form class="main" style="margin-top: 100px" onsubmit="event.preventDefault(); createSwitch(this);">
                    <p><b>Mac: <input id="form-mac" pattern="[a-zA-Z0-9-]+" title="Bitte benutze nur Buchstaben, Zahlen und dieses Sonderzeichen: -" required name="mac" type="text" style="max-width: 325px"></b></p>
                    <p><b>Name: <input id="form-name" pattern="[a-zA-ZäÄöÖüÜ0-9-#()&/ ]+" title="Bitte benutze nur Buchstaben, Zahlen, Leerzeichen und diese Sonderzeichen: # / ( )" required name="name" type="text" style="max-width: 325px"></b></p>
                    <div class="widget" id="infobox" style="margin-left: 0; margin-top: 100px">
                        <button class="widget-left gradient-red" disabled>Wichtig</button>
                        <button class="widget-right" disabled>Mac Adresse und Name muss eindeutig sein<br>Diese können frei gewählt werden</button>
                    </div>
                    <div class="navigation-panel">
                        <div class="sticky-inset">
                            <div style="display: flex">
                                <input type="button" value="Zurück" onclick="Essentials.leavePage('/');">
                                <div style="display: block; width: 100%; margin-left: 20px">
                                    <input id="create-btn" type="submit" value="Erstellen">
                                </div>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div id="success" style="display: none; opacity: 0; transition: .2s ease-in-out">
                <h1>Erfolgreich Erstellt</h1>
                <div class="main" style="margin-top: 100px">
                    <img src="img/success.png" class="setup-png">
                    <input class="gradient-green loading-loop" style="margin: 100px auto 100px auto; max-width: 400px!important; display: block" type="button" value="Auf Bridge Warten ..">
                    <p>Das Gerät ist<br>jetzt Einsatzbereit</p>
                </div>
            </div>
            <script type="module">

                import { Query } from '/js/query.js';
                import { Essentials } from '/js/essentials.js';

                Query.SETUP(Essentials);
                Essentials.SETUP(Query);

                window.Query = Query;
                window.Essentials = Essentials;

            </script>
            <script>

                async function createSwitch(form)
                {
                    var overlays = {
                        root : document.getElementById('create-btn'),
                        id : 'create',
                        pending : { value : 'Erstellen ..' },
                        connectionError : { value : 'Keine Verbindung zur Bridge!' }
                    };

                    var created = await Query.complexFetch('serverside/init-switch?mac=' + document.getElementById('form-mac').value + '&name=' + document.getElementById('form-name').value, 10000, 3, overlays, false);

                    await Essentials.newTimeout(1000);

                    if(created == 'Success')
                    {
                        Essentials.switchPage('create', 'success', false);

                        redirectCountdown('/device?mac=' + document.getElementById('form-mac').value);
                    }
                    else
                    {
                        Essentials.showOverlay(document.getElementById('create-btn'), Essentials.createErrorOverlay('create-result', created));

                        await Essentials.newTimeout(4000);

                        Essentials.removeOverlays(document.getElementById('create-btn'), true);
                    }
                }

                function redirectCountdown(url)
                {
                    setTimeout(async function()
                    {
                        if(await Essentials.checkRestart('/serverside/check-restart'))
                        {
                            Essentials.leavePage(url);
                        }
                    }, 3000);
                }

            </script>
        </div>
    </body>
</html>